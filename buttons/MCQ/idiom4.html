<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sniper Duel: IS vs ARE ğŸ¯</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
  background:radial-gradient(circle at bottom,#05060f,#000);
  color:#fff;
  text-align:center;
  overflow:hidden;
}

.container{
  max-width:900px;
  margin:2rem auto;
  padding:2rem;
  background:rgba(255,255,255,0.05);
  border-radius:18px;
  box-shadow:0 0 40px rgba(0,255,255,0.15);
}

.quiz-header-bar{
  display:none;
  background:#0b1025;
  border-bottom:1px solid #222;
  padding:.6rem 1rem;
}

.quiz-header-content{
  display:flex;
  justify-content:space-between;
  font-weight:bold;
  color:#ffd700;
}

#sentenceFlash{
  font-size:1.8rem;
  margin:2.5rem 0;
  padding:1.5rem;
  border-radius:12px;
  background:rgba(0,0,0,0.4);
  box-shadow:0 0 30px rgba(0,224,255,0.3);
  animation:pulseGlow 1.5s infinite;
}

@keyframes pulseGlow{
  0%,100%{box-shadow:0 0 20px rgba(0,224,255,0.4);}
  50%{box-shadow:0 0 40px rgba(0,224,255,0.9);}
}

.sniper-zone{
  display:flex;
  justify-content:space-between;
  gap:2rem;
  margin-top:3rem;
}

.sniper{
  flex:1;
  padding:2rem;
  font-size:2rem;
  border-radius:16px;
  cursor:pointer;
  user-select:none;
  transition:.2s;
}

.sniper:active{transform:scale(.92);}

.sniper.is{background:linear-gradient(135deg,#0077ff,#00e0ff);}
.sniper.are{background:linear-gradient(135deg,#ff0066,#ff5aa5);}

.sniper span{
  display:block;
  font-size:1rem;
  opacity:.8;
}

.hit{animation:hitFlash .4s;}
@keyframes hitFlash{
  50%{box-shadow:0 0 40px #00ff88}
}

.miss{animation:missShake .4s;}
@keyframes missShake{
  25%{transform:translateX(-12px)}
  75%{transform:translateX(12px)}
}

#nameForm select,#nameForm input,#nameForm button{
  width:90%;
  max-width:320px;
  padding:.8rem;
  margin:.6rem auto;
  border-radius:8px;
  border:none;
  font-size:1rem;
}

#nameForm button{
  background:#ffd700;
  font-weight:bold;
  cursor:pointer;
}

#scoreCard{margin-top:2rem;}
</style>
</head>

<body>

<div class="quiz-header-bar" id="quizHeaderBar">
  <div class="quiz-header-content">
    <div>â³ <span id="time-value">0</span>s</div>
    <div>ğŸ’ <span id="gem-value">0</span></div>
    <div>ğŸ”¥ <span id="streak-value">0</span></div>
    <div>ğŸ¯ <span id="current-question">1</span>/<span id="total-questions">0</span></div>
  </div>
</div>

<div class="container">

<div id="nameForm">
  <p style="color:#ffd700">Grammar Duel Mission ğŸš€</p>
  <select id="departmentSelect">
    <option value="">-- Select Department --</option>
    <option>Cyber Security</option>
    <option>CSE-1</option>
    <option>CSE-2</option>
    <option>EIE</option>
  </select>
  <input type="text" id="nameInput" placeholder="Enter your name">
  <button id="startQuizBtn">ğŸš€ Launch Mission</button>
</div>

<div id="quizContent" style="display:none">
  <div id="sentenceFlash">Loadingâ€¦</div>

  <div class="sniper-zone">
    <div class="sniper is" id="sniperIs">IS<span>Singular</span></div>
    <div class="sniper are" id="sniperAre">ARE<span>Plural</span></div>
  </div>

  <div id="scoreCard"></div>
  <button id="restartBtn" style="display:none">Restart</button>
</div>

</div>

<script>
/* ========= LOCAL STORAGE AUTOFILL ========= */
function autoFillFromStorage(){
  try{
    const storedName=localStorage.getItem("playerName");
    const storedDept=localStorage.getItem("playerDept");
    if(storedName) nameInput.value=storedName;
    if(storedDept) departmentSelect.value=storedDept;
  }catch(e){
    console.log("LocalStorage unavailable");
  }
}
window.addEventListener("DOMContentLoaded",autoFillFromStorage);

/* ========= SUPABASE EDGE ========= */
const EDGE_FUNCTION_URL =
  "https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/logQuest";

async function sendViaEdgeFunction(payload){
  try{
    await fetch(EDGE_FUNCTION_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
  }catch(err){
    console.error("Edge function error:",err);
  }
}

/* ========= QUIZ DATA ========= */
const quizData=[
  {q:"He ___ happy today.",options:["is","are"],correct:[0]},
  {q:"They ___ my friends.",options:["is","are"],correct:[1]},
  {q:"He ___ ready.",options:["is","are"],correct:[0]},
  {q:"We ___ late.",options:["is","are"],correct:[1]},
  {q:"She ___ absent.",options:["is","are"],correct:[0]},
  {q:"The students ___ here.",options:["is","are"],correct:[1]},
  {q:"My brother ___ tall.",options:["is","are"],correct:[0]},
  {q:"My pens ___ made of solid gold.",options:["is","are"],correct:[1]},
  {q:"My friends ___ upset.",options:["is","are"],correct:[1]},
  {q:"My cats ___ sad.",options:["is","are"],correct:[1]},
  {q:"My parents ___ proud.",options:["is","are"],correct:[1]}
];

let current=0,currentGems=0,currentStreak=0,highestStreak=0;
let questionLocked=false,startTime,timerInterval;
let playerName="",playerDepartment="";

/* ========= START ========= */
startQuizBtn.onclick=()=>{
  playerName=nameInput.value.trim();
  playerDepartment=departmentSelect.value;
  if(!playerName||!playerDepartment)return alert("Enter name & department");

  localStorage.setItem("playerName",playerName);
  localStorage.setItem("playerDept",playerDepartment);

  nameForm.style.display="none";
  quizContent.style.display="block";
  quizHeaderBar.style.display="block";
  totalQ.innerText=quizData.length;

  startTime=Date.now();
  startTimer();
  loadQuestion();
};

function loadQuestion(){
  if(current>=quizData.length)return showScore();
  questionLocked=false;
  sentenceFlash.innerHTML=quizData[current].q;
  currentQ.innerText=current+1;
}

sniperIs.onclick=()=>fire("is");
sniperAre.onclick=()=>fire("are");

function fire(word){
  if(questionLocked)return;
  const data=quizData[current];
  handleAnswer(data.options.indexOf(word),data.correct,word);
}

function handleAnswer(idx,correct,word){
  if(questionLocked)return;
  if(correct.includes(idx)){
    questionLocked=true;
    sentenceFlash.innerHTML=
      quizData[current].q.replace("___",
        `<span style="color:#00ff88;font-weight:bold">${word}</span>`);

    currentGems++; gemValue.innerText=currentGems;
    currentStreak++; streakValue.innerText=currentStreak;
    highestStreak=Math.max(highestStreak,currentStreak);

    setTimeout(()=>{current++;loadQuestion();},700);
  }else{
    currentGems--; gemValue.innerText=currentGems;
    currentStreak=0; streakValue.innerText=0;
  }
}

function startTimer(){
  timerInterval=setInterval(()=>{
    timeValue.innerText=Math.floor((Date.now()-startTime)/1000);
  },1000);
}

function showScore(){
  clearInterval(timerInterval);
  quizHeaderBar.style.display="none";

  sendViaEdgeFunction({
    student_name:playerName,
    department:playerDepartment,
    score:currentGems,
    streak:highestStreak,
    quest_id:"IS-ARE-SNIPER"
  });

  sentenceFlash.innerText="ğŸ‰ Mission Complete!";
  scoreCard.innerHTML=`
    <p>ğŸ‘¤ ${playerName}</p>
    <p>ğŸ¢ ${playerDepartment}</p>
    <p>ğŸ’ Gems: ${currentGems}</p>
    <p>ğŸ”¥ Best Streak: ${highestStreak}</p>`;
  restartBtn.style.display="block";
}

restartBtn.onclick=()=>location.reload();
</script>
</body>
</html>
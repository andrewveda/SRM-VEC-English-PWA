<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tap-to-Match Quiz üåå</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(ellipse at bottom, #0b0c1b 0%, #000000 100%);
    color: white;
    text-align: center;
  }
    .container {
    position: relative;
    max-width: 900px;
    margin: 2rem auto;
    background: rgba(255, 255, 255, 0.05);
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
  }
  .question {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }
  .drag-options {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
    margin-bottom: 2rem;
    justify-content: center;
  }
  .drag-item {
    padding: 0.6rem 1rem;
    background: #1f1f2e;
    border-radius: 10px;
    cursor: pointer;
    user-select: none;
  }
  .drag-item.selected {
    border: 2px solid #ffd700;
  }
  .drop-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
    position: relative;
  }
  .drop-zone {
    border: 2px dashed #ffd700;
    min-width: 200px;
    min-height: 40px;
    padding: 0.6rem;
    border-radius: 8px;
    margin: 0.5rem 0;
    cursor: pointer;
  }
  .drop-zone.filled {
    background-color: #343454;
  }
  .correct {
    background-color: green !important;
  }
  .wrong {
    background-color: red !important;
  }
  @keyframes sparkle {
    0% {
      transform: translate(0, 0) scale(1);
      opacity: 1;
    }
    100% {
      transform: translate(var(--random-x, 0), -100px) scale(1.5);
      opacity: 0;
    }
  }
  @keyframes gemPulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.3);
    }
  }
  .gem-spark {
    position: absolute;
    pointer-events: none;
    font-size: 1.5rem;
    animation: sparkle 1s ease-out forwards;
  }
  .gem-counter-pulse {
    animation: gemPulse 0.4s ease-in-out;
  }
  #scoreCard {
    margin-top: 2rem;
    font-size: 1.2rem;
  }
  #timer, #gemsCounter, #progressTracker {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: #ffd700;
  }
  #restartBtn {
    margin-top: 2rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #444466;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    color: white;
  }
  #nameForm {
    margin-bottom: 1.5rem;
  }
  #nameInput {
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 5px;
    border: none;
    margin-right: 0.5rem;
  }
   .quiz-header {
    position: absolute;
    top: 10px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 1rem;
    font-size: 1rem;
    color: #ffd700;
    z-index: 10;
  }
.quiz-header #timer {
  text-align: left;
  flex: 1;
}
.quiz-header #gemsCounter {
  text-align: center;
  flex: 1;
}
.quiz-header #progressTracker {
  text-align: right;
  flex: 1;
}

/* Falling gem animation */
.falling-gem {
  position: absolute;
  font-size: 1.4rem;
  pointer-events: none;
  animation: fallGem 0.9s ease-in forwards;
}

@keyframes fallGem {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  70% { transform: translateY(70vh) scale(1.4); opacity: 1; }
  100% { transform: translateY(100vh) scale(0.8); opacity: 0; }
}

#gemPile {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 35vh;  /* Where gems accumulate */
  pointer-events: none;
  overflow: visible;
  z-index: 5;
}
/* Falling gems */
.falling-gem {
  position: fixed;
  font-size: 1.6rem;
  animation: fallToBottom 1.2s ease-in forwards;
  z-index: 10;
}

/* Permanent stacked gems */
.piled-gem {
  position: absolute;
  font-size: 1.8rem;
  user-select: none;
  transform: translateX(-50%);
  animation: gemLand 0.4s ease-out;
}

/* full-screen fall */
@keyframes fallToBottom {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  80% { transform: translateY(70vh) scale(1.4); opacity: 1; }
  100% { transform: translateY(90vh) scale(0.9); opacity: 0; }
}

/* small bounce when landing */
@keyframes gemLand {
  0% { transform: scale(0.2); opacity: 0; }
  60% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

</style>
</head>
<body>
<div class="container" id="quizContainer">
 <div id="nameForm">
  <input type="text" id="nameInput" placeholder="Enter your name" />
  
  <!-- Department Selector -->
  <select id="departmentSelect" style="display: block; width: 90%; max-width: 300px; margin: 0.5rem auto; padding: 0.7rem; font-size: 1rem; border-radius: 5px; border: none;">
    <option value="">-- Select Department --</option>
    <option value="Cyber Security">Cyber Security</option>
    <option value="CSE-1">CSE-1</option>
    <option value="CSE-2">CSE-2</option>
    <option value="CSE-3">CSE-3</option>
    <option value="Mechanical Engineering">Mechanical Engineering</option>
    <option value="ECE-1">ECE-1</option>
    <option value="ECE-2">ECE-2</option>
    <option value="ECE-3">ECE-3</option>
    <option value="AI DS-1">AI DS-1</option>
    <option value="AI DS-2">AI DS-2</option>
    <option value="Civil">Civil</option>
    <option value="Agri">Agri</option>
    <option value="EEE">EEE</option>
    <option value="EIE">EIE</option>
    <option value="Medical Electronics">Medical Electronics</option>
    <option value="IT-1">IT-1</option>
    <option value="IT-2">IT-2</option>
  </select>

  <button onclick="beginQuiz()">Start Quiz</button>
</div>


  <div id="quizContent" style="display:none;">
   <div class="quiz-header">
  <div id="timer">‚è≥ 0s</div>
  <div id="gemsCounter">üíé 0</div>
  <div id="progressTracker">üìç 1 of 1</div>
</div>
    <div class="question" id="question"></div>
    <div class="drag-options" id="dragOptions"></div>
    <div class="drop-container" id="dropContainer"></div>
    <div id="scoreCard"></div>
    <button id="restartBtn" style="display: none;">Restart</button>
  </div>


</div>
<div id="gemPile"></div>

<script>
const quizData = [
  {
    "questionItems": [
      { "word": "I ___ very happy today.", "answer": "am" },
      { "word": "We ___ very happy today.", "answer": "are" }
    ],
    "answers": ["am", "are"],
   },
  {
    "questionItems": [
      { "word": "We ___ very happy yesterday.", "answer": "were" },
      { "word": "He ___ on time last week.", "answer": "was" }
    ],
    "answers": ["was", "were"],
    },
  {
    "questionItems": [
      { "word": "You ___ always on time.", "answer": "are" },
      { "word": "He ___ always on time.", "answer": "is" },
      { "word": "I ___ in the lab.", "answer": "am" }
    ],
    "answers": ["is", "are", "am"],
   },
  {
    "questionItems": [
      { "word": "They ___ my lab partners.", "answer": "are" },
      { "word": "They ___ my lab partners last semester.", "answer": "were" }
    ],
    "answers": ["is", "are", "was", "were"],
    },
  {
    "questionItems": [
      { "word": "He ___ late for class today.", "answer": "is" },
      { "word": "They ___ late for class today.", "answer": "are" },
      { "word": "They ___ late for class yesterday.", "answer": "were" }
    ],
    "answers": ["is", "are", "was", "were"],
   },
  {
    "questionItems": [
      { "word": "She ___ not feeling well today.", "answer": "is" },
      { "word": "They ___ not feeling well today.", "answer": "are" },
      { "word": "They ___ not feeling well yesterday.", "answer": "were" }
    ],
    "answers": ["is", "are", "was", "were"],
   },
  {
    "questionItems": [
      { "word": "I ___ at the park now.", "answer": "am" },
      { "word": "We ___ at the park now.", "answer": "are" },
      { "word": "We ___ at the park yesterday.", "answer": "were" }
    ],
    "answers": ["am", "is", "are", "was", "were"],
   },
  {
    "questionItems": [
      { "word": "You ___ my best friend.", "answer": "are" },
      { "word": "He ___ my best friend.", "answer": "is" },
      { "word": "They ___ my best friends in school.", "answer": "were" }
    ],
    "answers": ["is", "are", "was", "were"],
   },
  {
    "questionItems": [
      { "word": "She ___ in class now.", "answer": "is" },
      { "word": "They ___ in class now.", "answer": "are" },
      { "word": "They ___ in class yesterday.", "answer": "were" }
    ],
    "answers": ["is", "are", "was", "were"],
   },
  {
    "questionItems": [
      { "word": "He ___ not at home right now.", "answer": "is" },
      { "word": "They ___ not at home right now.", "answer": "are" },
      { "word": "They ___ not at home last night.", "answer": "were" }
    ],
    "answers": ["is", "are", "was", "were"],
   },
  {
    "questionItems": [
      { "word": "I ___ very tired after the match.", "answer": "was" },
      { "word": "We ___ very tired after the match.", "answer": "were" },
      { "word": "I ___ very tired.", "answer": "am" }
    ],
    "answers": ["was", "were", "am"],
   }

];

let current = 0;
let wrongQuestions = [];
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;

const questionEl = document.getElementById("question");
const dragOptionsEl = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl = document.getElementById("timer");
const gemsCounterEl = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard = document.getElementById("scoreCard");
const restartBtn = document.getElementById("restartBtn");
  
window.addEventListener("load", () => {
  const savedName = localStorage.getItem("questPlayerName");
  const savedDept = localStorage.getItem("questPlayerDept");

  if (savedName) document.getElementById("nameInput").value = savedName;
  if (savedDept) document.getElementById("departmentSelect").value = savedDept;
});


function beginQuiz() {
  const nameField = document.getElementById("nameInput");
  const deptField = document.getElementById("departmentSelect");

  if (!nameField.value.trim()) { alert("Please enter your name!"); return; }
  if (!deptField.value) { alert("Please select your department!"); return; }

  playerName = nameField.value.trim();
  playerDept = deptField.value;
localStorage.setItem("questPlayerName", playerName);
localStorage.setItem("questPlayerDept", playerDept);


  document.getElementById("nameForm").style.display = "none";
  document.getElementById("quizContent").style.display = "block";
  startQuiz();
}

function startQuiz() {
  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();
  timerEl.innerText = "‚è≥ 0s";
  gemsCounterEl.innerText = `üíé 0`;
  scoreCard.innerHTML = "";
  restartBtn.style.display = "none";
  loadQuestion();
  startTimer();
}

function loadQuestion() {
  if (current >= quizData.length) return showScore();
  selectedOption = null;
  const data = quizData[current];
  progressTracker.innerText = `üìç  ${current + 1} of ${quizData.length}`;

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";

  const shuffledAnswers = [...data.answers].sort(() => Math.random() - 0.5);

  shuffledAnswers.forEach((ans) => {
    const div = document.createElement("div");
    div.classList.add("drag-item");
    div.innerText = ans;
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  data.questionItems.forEach((item) => {
    const drop = document.createElement("div");
    drop.classList.add("drop-zone");
    drop.innerText = item.word;
    drop.dataset.answer = item.answer;
    drop.onclick = () => placeOption(drop);
    dropContainerEl.appendChild(drop);
  });
}

function selectOption(div) {
  if (div.style.display === "none") return;
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

function placeOption(dropZone) {
  if (!selectedOption) return;

  const answer = selectedOption.innerText;
  const correctAnswer = dropZone.dataset.answer;
  const currentText = dropZone.innerText;

  if (correctAnswer === answer) {
    correctCount++;
    gemsCount++;
    
    // Create sparkle effect
    createSparkleEffect(dropZone);
    createFallingGems(dropZone);

    // Pulse the gem counter
    gemsCounterEl.classList.add('gem-counter-pulse');
    setTimeout(() => gemsCounterEl.classList.remove('gem-counter-pulse'), 400);
    
    gemsCounterEl.innerText = `üíé ${gemsCount}`;

    // Replace blank with correct answer visually
    if (currentText.includes("___")) {
      dropZone.innerHTML = currentText.replace("___", `<strong style="color:#00ff88;">${answer}</strong>`);
    } else {
      dropZone.innerHTML = `${currentText} <strong style="color:#00ff88;">${answer}</strong>`;
    }

    dropZone.classList.add("correct", "filled");
    selectedOption.style.display = "none";
  } else {
    totalWrongGuesses++;
    gemsCount--;
    removeGemFromPile();
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    dropZone.classList.add("wrong");
    setTimeout(() => dropZone.classList.remove("wrong"), 600);

    // Add the entire current question back to wrongQuestions if not already added
    const currentData = quizData[current];
    if (!wrongQuestions.includes(currentData)) {
      wrongQuestions.push(currentData);
    }
  }

  selectedOption.classList.remove("selected");
  selectedOption = null;

  // Check if all blanks for current question are filled
  const remaining = document.querySelectorAll(".drop-zone:not(.filled)").length;
  if (remaining === 0) {
    setTimeout(() => {
      current++;
      // When we finish all questions, check for wrong ones
      if (current >= quizData.length) {
        if (wrongQuestions.length > 0) {
          quizData.push(...wrongQuestions);
          wrongQuestions = [];
        }
      }
      loadQuestion();
    }, 800);
  }
}
function removeGemFromPile() {
  const pile = document.querySelectorAll("#gemPile .piled-gem");
  if (pile.length === 0) return;

  const lastGem = pile[pile.length - 1];
  lastGem.remove();
}

function createSparkleEffect(element) {
  const rect = element.getBoundingClientRect();
  const container = document.getElementById('dropContainer');
  
  // Create multiple sparks
  const sparkCount = 8;
  for (let i = 0; i < sparkCount; i++) {
    const spark = document.createElement('div');
    spark.className = 'gem-spark';
    spark.innerText = ['üíé', '‚ú®', '‚≠ê'][Math.floor(Math.random() * 3)];
    
    // Position relative to the drop zone
    spark.style.position = 'absolute';
    spark.style.left = `${rect.left - container.getBoundingClientRect().left + rect.width / 2}px`;
    spark.style.top = `${rect.top - container.getBoundingClientRect().top + rect.height / 2}px`;
    
    // Random horizontal spread
    const randomX = (Math.random() - 0.5) * 100;
    spark.style.setProperty('--random-x', `${randomX}px`);
    
    container.appendChild(spark);
    
    // Remove after animation
    setTimeout(() => spark.remove(), 1000);
  }
}
function createFallingGems(element) {
  const rect = element.getBoundingClientRect();
  const gemCount = 12; // how many gems rain per correct answer

  for (let i = 0; i < gemCount; i++) {
    const gem = document.createElement("div");
    gem.className = "falling-gem";
    gem.innerText = "üíé";

    // Random scatter across full screen
    const horizontalSpread = (Math.random() - 0.5) * window.innerWidth * 0.9;

    gem.style.left = `${rect.left + rect.width / 2 + horizontalSpread}px`;
    gem.style.top = `${rect.top + rect.height / 2}px`;

    document.body.appendChild(gem);

    // When animation finishes ‚Üí turn into a "stacked gem"
    gem.addEventListener("animationend", () => {
      gem.remove();

      const pileGem = document.createElement("div");
      pileGem.className = "piled-gem";
      pileGem.innerText = "üíé";

      // Random position inside the bottom pile area
      pileGem.style.left = `${Math.random() * 100}%`;
      pileGem.style.bottom = `${Math.random() * 30}vh`;

      document.getElementById("gemPile").appendChild(pileGem);
    });
  }
}

const EDGE_FUNCTION_URL =
  "https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/logQuest";
function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  questionEl.innerText = "üéâ Quiz Completed!";
  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  progressTracker.innerText = "";
  scoreCard.innerHTML = `
    <p>üë§ Player: ${playerName}</p>
    <button onclick="downloadPDFReport()" 
      style="margin-top: 1rem; padding: 0.7rem 2rem; background-color: #4CAF50; 
      border: none; border-radius: 10px; cursor: pointer; color: white; 
      font-size: 1rem;">
      üì• Download PDF Report
    </button>
    <p>‚úÖ All Questions: Answered Correctly on First Attempt!</p>
    <p>‚úÖ Correct Answers: ${correctCount}</p>
    <p>‚ùå Wrong Attempts: ${totalWrongGuesses}</p>
    <p>üíé Final Gems: ${gemsCount}</p>
    <p>‚è±Ô∏è Time Taken: ${totalTime} seconds</p>
  `;
  
  restartBtn.style.display = "inline-block";

  // Send to Supabase Edge Function
  sendViaEdgeFunction({
    student_name: playerName,
    department: playerDept,
    correct: correctCount,
    wrong: totalWrongGuesses,
    time_spent: totalTime,
    quest_id: "Quest 120"
  });
}

async function sendViaEdgeFunction(payload) {
  try {
    const response = await fetch(EDGE_FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      console.error("‚ùå Edge function error:", await response.text());
      return false;
    }

    const data = await response.json().catch(() => ({}));
    console.log("‚úÖ Saved to Supabase:", data);
    return true;
  } catch (err) {
    console.error("‚ö†Ô∏è Error calling edge function:", err);
    return false;
  }
}

function startTimer() {
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime)/1000);
    timerEl.innerText = `‚è≥ ${elapsed}s`;
  }, 1000);
}

function downloadPDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

  // --- HEADER ---
  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('times', 'bold');
  doc.setFontSize(18);
  doc.text('SRM VALLIAMMAI ENGINEERING COLLEGE', 105, 16, { align: 'center' });
  doc.setFontSize(12);
  doc.setFont('times', 'italic');
  doc.text('(Autonomous)', 105, 23, { align: 'center' });
  doc.setFontSize(15);
  doc.setFont('times', 'normal');
  doc.text('Department of English', 105, 31, { align: 'center' });
  doc.setFontSize(14);
  doc.setFont('times', 'bold');
  doc.setTextColor(212, 175, 55);
  doc.text('Quest Performance Report', 105, 39, { align: 'center' });

  // --- STUDENT INFO ---
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text('CANDIDATE INFORMATION', 20, 55);
  doc.autoTable({
    startY: 58,
    body: [
      ['Student Name', playerName],
      ['Department', playerDept],
      ['Quest ID', 'Quest 20'],
      ['Completed On', reportDate]
    ],
    theme: 'plain',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: 'bold', cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 }
    },
    margin: { left: 20, right: 20 }
  });

  // --- PERFORMANCE SUMMARY ---
  let y = doc.lastAutoTable.finalY + 10;
  doc.setFont('times', 'bold');
  doc.text('PERFORMANCE SUMMARY', 20, y);
  y += 4;
  doc.autoTable({
    startY: y + 3,
    body: [
      ['Total Questions', quizData.length.toString()],
      ['Correct Answers', correctCount.toString()],
      ['Wrong Attempts', totalWrongGuesses.toString()],
      ['Final Gems Earned', gemsCount.toString()],
      ['Total Time', `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`]
    ],
    theme: 'grid',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    margin: { left: 20, right: 20 }
  });

  // --- QUESTION BANK SECTION ---
  y = doc.lastAutoTable.finalY + 12;
  if (y > 250) { doc.addPage(); y = 20; }
  doc.setFont('times', 'bold');
  doc.text('QUESTION BANK WITH CORRECT ANSWERS', 20, y);
  y += 6;

  quizData.forEach((item, i) => {
    if (y > 260) { doc.addPage(); y = 20; }
    doc.setFontSize(11);
    doc.setFont('times', 'bold');
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, 20, y);
    y += 6;
    doc.setTextColor(0, 0, 0);
    doc.setFont('times', 'normal');
    item.questionItems.forEach((qItem, j) => {
      const questionText = `${j + 1}. ${qItem.word.replace('___', '____')} `;
      const answerText = `Answer: ${qItem.answer}`;
      const lines = doc.splitTextToSize(questionText, 160);
      doc.text(lines, 25, y);
      y += lines.length * 5;
      doc.setTextColor(0, 128, 0);
      doc.text(answerText, 30, y);
      doc.setTextColor(0, 0, 0);
      y += 7;
    });
    y += 3;
    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.3);
    doc.line(20, y, 190, y);
    y += 5;
  });

  // --- FOOTER ---
  doc.setDrawColor(184, 134, 11);
  doc.setLineWidth(0.5);
  doc.line(20, 280, 190, 280);
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.setFont('times', 'italic');
  doc.text('This is a system-generated report', 105, 287, { align: 'center' });

  const cleanName = playerName.replace(/[^a-zA-Z0-9]/g, '_');
  doc.save(`${cleanName}_Quest20_Report.pdf`);
}

restartBtn.onclick = () => {
  document.getElementById("quizContent").style.display = "none";
  document.getElementById("nameForm").style.display = "block";
  document.getElementById("nameInput").value = "";
};
</script>
</body>
</html>

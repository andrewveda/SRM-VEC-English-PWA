<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tap-to-Match Quiz üåå</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(ellipse at bottom, #0b0c1b 0%, #000000 100%);
    color: white;
    text-align: center;
  }
  .container {
    position: relative;
    max-width: 900px;
    margin: 2rem auto;
    background: rgba(255, 255, 255, 0.05);
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
  }
  .question { font-size: 1.5rem; margin-bottom: 1rem; }
  .drag-options {
    display: flex; flex-wrap: wrap; gap: 0.8rem;
    margin-bottom: 2rem; justify-content: center;
  }
  .drag-item {
    padding: 0.6rem 1rem;
    background: #1f1f2e;
    border-radius: 10px;
    cursor: pointer; user-select: none;
  }
  .drag-item.selected { border: 2px solid #ffd700; }
  .drop-container {
    display: flex; flex-direction: column; gap: 1rem;
    align-items: center; position: relative;
  }
  .drop-zone {
    border: 2px dashed #ffd700;
    min-width: 200px; min-height: 40px;
    padding: 0.6rem; border-radius: 8px;
    margin: 0.5rem 0; cursor: pointer;
  }
  .drop-zone.filled { background-color: #343454; }
  .correct { background-color: green !important; }
  .wrong { background-color: red !important; }

  /* Sparkles */
  @keyframes sparkle {
    0% { transform: translate(0,0) scale(1); opacity: 1; }
    100% { transform: translate(var(--random-x,0), -100px) scale(1.5); opacity: 0; }
  }
  .gem-spark {
    position: absolute; pointer-events: none;
    font-size: 1.5rem; animation: sparkle 1s ease-out forwards;
  }
  .gem-counter-pulse { animation: gemPulse 0.4s ease-in-out; }

  @keyframes gemPulse {
    0%,100% { transform: scale(1); }
    50% { transform: scale(1.3); }
  }

  .quiz-header {
    position: absolute; top: 10px; left: 0; right: 0;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 1rem; font-size: 1rem; color: #ffd700; z-index: 10;
  }

#motivationBox {
    margin-top: 2rem;
    min-height: 120px;
    padding: 1.5rem;
    color: #ffd700;
    font-size: 1.9rem;
    font-weight: 800;
    text-align: center;

    font-family: 'Trebuchet MS', 'Segoe UI', sans-serif;

    opacity: 1;  /* Always visible */
    transition: transform 0.4s ease;

    text-shadow: 0 0 10px rgba(255, 215, 0, 0.7),
                 0 0 20px rgba(255, 215, 0, 0.5);

    transform: scale(0.9);
}
.hero-quote {
  max-width: 90%;
  margin: 1rem auto 2rem auto;
  padding: 2rem 1.5rem;
  background: rgba(255, 255, 255, 0.8);
  border: 2px solid #c9ab6d;
  border-radius: 15px;
  box-shadow: 0 0 25px rgba(180, 150, 90, 0.45);
  text-align: center;
}

/* BIG, BEAUTIFUL, HEROIC TEXT */
.hero-text {
  font-family: "Cinzel", Georgia, serif;
  font-size: 1.65rem;         /* mobile-friendly big */
  font-weight: 700;
  line-height: 1.35;
  color: #4a3315;
  text-shadow: 
    0 0 10px rgba(255, 230, 170, 0.7),
    0 0 20px rgba(255, 210, 120, 0.5);
  margin-bottom: 0.7rem;
}

/* AUTHOR */
.hero-author {
  font-family: "Cinzel", serif;
  font-size: 1rem;
  font-weight: bold;
  color: #6b4b1b;
  opacity: 0.9;
}

</style>
</head>

<body>
  <div class="container" id="quizContainer">
   <div id="nameForm">
<div class="hero-quote">
  <div class="hero-text">
    ‚ÄúEver tried. <br> Ever failed. <br> No matter. <br>
    Try again. <br> Fail again. <br> Fail better!‚Äù
  </div>
  <div class="hero-author">‚Äî Samuel Beckett</div>
</div>

  
  <!-- NAME + DEPT FORM -->
  <div id="nameForm">
    <input type="text" id="nameInput" placeholder="Enter your name" />

    <select id="departmentSelect"
      style="display: block; width: 90%; max-width: 300px; margin: 0.5rem auto; padding: 0.7rem; font-size:1rem; border-radius:5px; border:none;">
      <option value="">-- Select Department --</option>
      <option value="Cyber Security">Cyber Security</option>
      <option value="CSE-1">CSE-1</option>
      <option value="CSE-2">CSE-2</option>
      <option value="CSE-3">CSE-3</option>
      <option value="Mechanical Engineering">Mechanical Engineering</option>
      <option value="ECE-1">ECE-1</option>
      <option value="ECE-2">ECE-2</option>
      <option value="ECE-3">ECE-3</option>
      <option value="AI DS-1">AI DS-1</option>
      <option value="AI DS-2">AI DS-2</option>
      <option value="Civil">Civil</option>
      <option value="Agri">Agri</option>
      <option value="EEE">EEE</option>
      <option value="EIE">EIE</option>
      <option value="Medical Electronics">Medical Electronics</option>
      <option value="IT-1">IT-1</option>
      <option value="IT-2">IT-2</option>
    </select>

    <button onclick="beginQuiz()">Start Quiz</button>
  </div>

  <!-- QUIZ SCREEN -->
  <div id="quizContent" style="display:none;">
    <div class="quiz-header">
      <div id="timer">‚è≥ 0s</div>
      <div id="gemsCounter">üíé 0</div>
      <div id="progressTracker">üìç 1 of 1</div>
    </div>

    <div class="question" id="question"></div>
    <div class="drag-options" id="dragOptions"></div>
    <div class="drop-container" id="dropContainer"></div>

    <div id="scoreCard"></div>
    <button id="restartBtn" style="display:none;">Restart</button>
  </div>

</div>

<!-- MOTIVATION BOX BELOW QUIZ -->
<div id="motivationBox"></div>

<script>
/* AUTO-RESTORE NAME + DEPT */
window.addEventListener("load", () => {
  const savedName = localStorage.getItem("questPlayerName");
  const savedDept = localStorage.getItem("questPlayerDept");
  if (savedName) document.getElementById("nameInput").value = savedName;
  if (savedDept) document.getElementById("departmentSelect").value = savedDept;
});

/* MOTIVATION MESSAGES */
const rightMessages = [
  "‚Äòname‚Äô is unstoppable!",
  "‚Äòname‚Äô is awesome because ‚Äòname‚Äô has grit!",
  "‚Äòname‚Äô has got the right answer because ‚Äòname‚Äô loves trying!",
  "Nothing can slow ‚Äòname‚Äô down today!",
  "‚Äòname‚Äô learns fast because ‚Äòname‚Äô never gives up!",
  "Who is awesome? ‚Äòname‚Äô!",
  "‚Äòname‚Äô proves that effort beats talent every time!",
  "Every correct answer takes ‚Äòname‚Äô one step closer to greatness!",
  "‚Äòname‚Äô shines brighter with every question!"
];


const wrongMessages = [
  "‚Äòname‚Äô loves failures because ‚Äòname‚Äô, like Edison, knows failure is the stepping stone to success.",
  "‚Äòname‚Äô‚Äôs favourite quote: ‚ÄúEver tried. Ever failed. No matter. Try again. Fail again. Fail better.‚Äù",
  "Every mistake makes ‚Äòname‚Äô stronger.",
  "Mistakes guide ‚Äòname‚Äô towards victory!",
  "Failure is feedback, and ‚Äòname‚Äô takes feedback like a champion.",
  "Every wrong attempt brings ‚Äòname‚Äô closer to the right one.",
  "‚Äòname‚Äô believes in trying again and again and again!"
];

/* SHOW MOTIVATION */
function showMotivation(isCorrect) {
  const box = document.getElementById("motivationBox");
  const list = isCorrect ? rightMessages : wrongMessages;

  let msg = list[Math.floor(Math.random() * list.length)];
  msg = msg.replace(/‚Äòname‚Äô/g, playerName);

  box.innerHTML = msg;
  box.style.opacity = 1;

}

/* QUIZ DATA */
const quizData = [
  {
    "questionItems": [
      { "word": "I ___ very happy today.", "answer": "am" },
      { "word": "We ___ very happy today.", "answer": "are" }
    ],
    "answers": ["am", "are"],
  },
  {
    "questionItems": [
      { "word": "We ___ very happy yesterday.", "answer": "were" },
      { "word": "He ___ on time last week.", "answer": "was" }
    ],
    "answers": ["was", "were"],
  },
  {
    "questionItems": [
      { "word": "You ___ always on time.", "answer": "are" },
      { "word": "He ___ always on time.", "answer": "is" },
      { "word": "I ___ in the lab.", "answer": "am" }
    ],
    "answers": ["is", "are", "am"],
  }
];

let current = 0;
let wrongQuestions = [];
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;

const questionEl = document.getElementById("question");
const dragOptionsEl = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl = document.getElementById("timer");
const gemsCounterEl = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard = document.getElementById("scoreCard");
const restartBtn = document.getElementById("restartBtn");

/* START QUIZ */
function beginQuiz() {
  const nameField = document.getElementById("nameInput");
  const deptField = document.getElementById("departmentSelect");

  if (!nameField.value.trim()) { alert("Please enter your name!"); return; }
  if (!deptField.value) { alert("Please select your department!"); return; }

  playerName = nameField.value.trim();
  playerDept = deptField.value;

  // save
  localStorage.setItem("questPlayerName", playerName);
  localStorage.setItem("questPlayerDept", playerDept);

  document.getElementById("nameForm").style.display = "none";
  document.getElementById("quizContent").style.display = "block";

  startQuiz();
}

function startQuiz() {
  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();

  gemsCounterEl.innerText = "üíé 0";
  scoreCard.innerHTML = "";
  restartBtn.style.display = "none";
  loadQuestion();
  startTimer();
}

function loadQuestion() {
  if (current >= quizData.length) return showScore();

  selectedOption = null;
  const data = quizData[current];
  progressTracker.innerText = `üìç ${current + 1} of ${quizData.length}`;

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";

  const shuffled = [...data.answers].sort(() => Math.random() - 0.5);

  shuffled.forEach((ans) => {
    const div = document.createElement("div");
    div.classList.add("drag-item");
    div.innerText = ans;
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  data.questionItems.forEach((item) => {
    const drop = document.createElement("div");
    drop.classList.add("drop-zone");
    drop.innerText = item.word;
    drop.dataset.answer = item.answer;
    drop.onclick = () => placeOption(drop);
    dropContainerEl.appendChild(drop);
  });
}

function selectOption(div) {
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

function placeOption(dropZone) {
  if (!selectedOption) return;

  const answer = selectedOption.innerText;
  const correctAnswer = dropZone.dataset.answer;

  if (answer === correctAnswer) {
    correctCount++;
    gemsCount++;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    showMotivation(true);

    dropZone.innerHTML = dropZone.innerText.replace("___", `<strong>${answer}</strong>`);
    dropZone.classList.add("correct", "filled");
    selectedOption.style.display = "none";

  } else {
    totalWrongGuesses++;
    gemsCount--;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    showMotivation(false);

    dropZone.classList.add("wrong");
    setTimeout(() => dropZone.classList.remove("wrong"), 600);

    const currentQ = quizData[current];
    if (!wrongQuestions.includes(currentQ)) wrongQuestions.push(currentQ);
  }

  selectedOption.classList.remove("selected");
  selectedOption = null;

  if (document.querySelectorAll(".drop-zone:not(.filled)").length === 0) {
    setTimeout(() => {
      current++;
      if (current >= quizData.length && wrongQuestions.length > 0) {
        quizData.push(...wrongQuestions);
        wrongQuestions = [];
      }
      loadQuestion();
    }, 800);
  }
}

/* TIMER */
function startTimer() {
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    timerEl.innerText = `‚è≥ ${elapsed}s`;
  }, 1000);
}

/* SCORE SCREEN */
const EDGE_FUNCTION_URL =
  "https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/logQuest";

function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  questionEl.innerText = "üéâ Quiz Completed!";
  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  progressTracker.innerText = "";

  scoreCard.innerHTML = `
    <p>üë§ Player: ${playerName}</p>
        <button onclick="downloadPDFReport()" 
      style="margin-top: 1rem; padding: 0.7rem 2rem; background-color: #4CAF50; 
      border: none; border-radius: 10px; cursor: pointer; color: white; 
      font-size: 1rem;">
      üì• Download PDF Report
    </button>
    <p>Correct: ${correctCount}</p>
    <p>Wrong: ${totalWrongGuesses}</p>
    <p>Gems: ${gemsCount}</p>
    <p>Time: ${totalTime} seconds</p>
  `;

  restartBtn.style.display = "inline-block";

  sendViaEdgeFunction({
    student_name: playerName,
    department: playerDept,
    correct: correctCount,
    wrong: totalWrongGuesses,
    time_spent: totalTime,
    quest_id: "Quest 20"
  });
}

async function sendViaEdgeFunction(payload) {
  try {
    const response = await fetch(EDGE_FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      console.error("‚ùå Edge Function Error:", await response.text());
      return;
    }
    console.log("‚úÖ Saved to Supabase");
  } catch (err) {
    console.error("‚ö†Ô∏è Edge Function Error:", err);
  }
}


function downloadPDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

  // --- HEADER ---
  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('times', 'bold');
  doc.setFontSize(18);
  doc.text('SRM VALLIAMMAI ENGINEERING COLLEGE', 105, 16, { align: 'center' });
  doc.setFontSize(12);
  doc.setFont('times', 'italic');
  doc.text('(Autonomous)', 105, 23, { align: 'center' });
  doc.setFontSize(15);
  doc.setFont('times', 'normal');
  doc.text('Department of English', 105, 31, { align: 'center' });
  doc.setFontSize(14);
  doc.setFont('times', 'bold');
  doc.setTextColor(212, 175, 55);
  doc.text('Quest Performance Report', 105, 39, { align: 'center' });

  // --- STUDENT INFO ---
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text('CANDIDATE INFORMATION', 20, 55);
  doc.autoTable({
    startY: 58,
    body: [
      ['Student Name', playerName],
      ['Department', playerDept],
      ['Quest ID', 'Quest 20'],
      ['Completed On', reportDate]
    ],
    theme: 'plain',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: 'bold', cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 }
    },
    margin: { left: 20, right: 20 }
  });

  // --- PERFORMANCE SUMMARY ---
  let y = doc.lastAutoTable.finalY + 10;
  doc.setFont('times', 'bold');
  doc.text('PERFORMANCE SUMMARY', 20, y);
  y += 4;
  doc.autoTable({
    startY: y + 3,
    body: [
      ['Total Questions', quizData.length.toString()],
      ['Correct Answers', correctCount.toString()],
      ['Wrong Attempts', totalWrongGuesses.toString()],
      ['Final Gems Earned', gemsCount.toString()],
      ['Total Time', `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`]
    ],
    theme: 'grid',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    margin: { left: 20, right: 20 }
  });

  // --- QUESTION BANK SECTION ---
  y = doc.lastAutoTable.finalY + 12;
  if (y > 250) { doc.addPage(); y = 20; }
  doc.setFont('times', 'bold');
  doc.text('QUESTION BANK WITH CORRECT ANSWERS', 20, y);
  y += 6;

  quizData.forEach((item, i) => {
    if (y > 260) { doc.addPage(); y = 20; }
    doc.setFontSize(11);
    doc.setFont('times', 'bold');
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, 20, y);
    y += 6;
    doc.setTextColor(0, 0, 0);
    doc.setFont('times', 'normal');
    item.questionItems.forEach((qItem, j) => {
      const questionText = `${j + 1}. ${qItem.word.replace('___', '____')} `;
      const answerText = `Answer: ${qItem.answer}`;
      const lines = doc.splitTextToSize(questionText, 160);
      doc.text(lines, 25, y);
      y += lines.length * 5;
      doc.setTextColor(0, 128, 0);
      doc.text(answerText, 30, y);
      doc.setTextColor(0, 0, 0);
      y += 7;
    });
    y += 3;
    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.3);
    doc.line(20, y, 190, y);
    y += 5;
  });

  // --- FOOTER ---
  doc.setDrawColor(184, 134, 11);
  doc.setLineWidth(0.5);
  doc.line(20, 280, 190, 280);
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.setFont('times', 'italic');
  doc.text('This is a system-generated report', 105, 287, { align: 'center' });

  const cleanName = playerName.replace(/[^a-zA-Z0-9]/g, '_');
  doc.save(`${cleanName}_Quest20_Report.pdf`);
}

restartBtn.onclick = () => {
  document.getElementById("quizContent").style.display = "none";
  document.getElementById("nameForm").style.display = "block";
  document.getElementById("nameInput").value = "";
};
</script>
</body>
</html>

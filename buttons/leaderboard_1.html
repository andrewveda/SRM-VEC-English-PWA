<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission: Veni, Vidi, Vici! ‚Äî Command Deck Leaderboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://ahezssoczvpbkteffcgz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE"
    );

    let filteredData = [];
    let currentDepartment = "ALL";
    let reportData = [];
    let currentSort = "last_test_taken";
    let sortAscending = false;
    let lastTestInfo = { name: "", date: "" };
    let showSecondsOnly = false;

    async function loadData() {
      const loader = document.getElementById("loader");
      loader.style.display = "flex";

      const { data, error } = await supabase.from("report_card_view").select("*");

      loader.style.display = "none";

      if (error) {
        console.error(error);
        document.getElementById("error").textContent = "‚ö†Ô∏è Unable to load data.";
        return;
      }

      reportData = data || [];
      filteredData = [...reportData];

      filteredData.sort((a, b) => new Date(b.last_test_taken || 0) - new Date(a.last_test_taken || 0));

      populateDepartmentDropdown(reportData);

      if (reportData.length > 0) {
        const sorted = [...reportData].sort((a, b) => new Date(b.last_test_taken) - new Date(a.last_test_taken));
        lastTestInfo = { name: sorted[0].name, date: formatDate(sorted[0].last_test_taken) };
        document.getElementById("last-test-info").textContent = `‚ú® ${lastTestInfo.name} ¬∑ ${lastTestInfo.date}`;
      } else {
        document.getElementById("last-test-info").textContent = "Awaiting first mission log...";
      }

      const savedDept = localStorage.getItem("leaderboard_department");
      if (savedDept) {
        const sel = document.getElementById("departmentSelect");
        if (sel) { sel.value = savedDept; applyDepartmentFilter(savedDept); return; }
      }

      sortData(currentSort);
    }

    function formatDate(dateStr) {
      if (!dateStr) return "N/A";
      return new Date(dateStr).toLocaleString('en-IN', {
        timeZone: 'Asia/Kolkata',
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: true
      });
    }

    function formatSecondsOnly(seconds) {
      if (!seconds) return "0s";
      return `${Math.round(seconds)}s`;
    }

    function formatTime(seconds) {
      if (!seconds && seconds !== 0) return `<span class="time-block"><span class="time-num">0</span><span class="time-unit h">h</span></span><span class="time-block"><span class="time-num">0</span><span class="time-unit m">m</span></span><span class="time-block"><span class="time-num">0</span><span class="time-unit s">s</span></span>`;
      seconds = Math.round(seconds);
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `<span class="time-block"><span class="time-num">${h}</span><span class="time-unit h">h</span></span><span class="time-block"><span class="time-num">${m}</span><span class="time-unit m">m</span></span><span class="time-block"><span class="time-num">${s}</span><span class="time-unit s">s</span></span>`;
    }

    function populateDepartmentDropdown(data) {
      const select = document.getElementById("departmentSelect");
      if (!select) return;
      select.innerHTML = `<option value="ALL">All Departments</option>`;
      const departments = [...new Set(data.map(s => (s.department || "").trim().toUpperCase()).filter(Boolean))].sort();
      departments.forEach(dept => {
        const opt = document.createElement("option");
        opt.value = dept; opt.textContent = dept;
        select.appendChild(opt);
      });
    }

    function applyDepartmentFilter(dept) {
      currentDepartment = dept;
      localStorage.setItem("leaderboard_department", dept);
      filteredData = dept === "ALL" ? [...reportData] : reportData.filter(s => (s.department || "").trim().toUpperCase() === dept.trim().toUpperCase());
      sortAscending = false;
      filteredData.sort((a, b) => new Date(b.last_test_taken || 0) - new Date(a.last_test_taken || 0));
      renderLeaderboard();
    }

    function sortData(key) {
      if (currentSort === key && reportData.length > 0 && document.getElementById("leaderboard").children.length > 1) {
        sortAscending = !sortAscending;
      } else {
        currentSort = key;
        sortAscending = false;
      }

      filteredData.sort((a, b) => {
        let A = a[key], B = b[key];
        if (A === null || A === undefined) A = sortAscending ? Infinity : -Infinity;
        if (B === null || B === undefined) B = sortAscending ? Infinity : -Infinity;
        if (key === 'last_test_taken') { A = new Date(a.last_test_taken).getTime(); B = new Date(b.last_test_taken).getTime(); }
        return sortAscending ? A - B : B - A;
      });

      updateActiveButton();
      renderLeaderboard();
    }

    function updateActiveButton() {
      document.querySelectorAll(".sort-btn").forEach(btn => {
        btn.classList.remove("active");
        const ind = btn.querySelector('.sort-indicator');
        if (ind) ind.textContent = "";
      });
      const toggle = document.getElementById("time-toggle");
      if (toggle) toggle.style.display = (currentSort === "total_time") ? "inline-flex" : "none";
      const active = document.querySelector(`[data-sort="${currentSort}"]`);
      if (active) {
        active.classList.add("active");
        let ind = active.querySelector('.sort-indicator');
        if (!ind) { ind = document.createElement('span'); ind.className = 'sort-indicator'; active.appendChild(ind); }
        ind.textContent = sortAscending ? " ‚ñ≤" : " ‚ñº";
      }
    }

    function renderLeaderboard() {
      const container = document.getElementById("leaderboard");
      container.innerHTML = "";

      filteredData.forEach((s, idx) => {
        const row = document.createElement("div");
        row.className = "leaderboard-row";
        if (idx === 0) row.classList.add("gold");
        else if (idx === 1) row.classList.add("silver");
        else if (idx === 2) row.classList.add("bronze");

        const rank = idx + 1;
        let value = s[currentSort];
        if (value === null || value === undefined) value = (currentSort === "last_test_taken") ? null : 0;

        const displayValue =
          currentSort === "accuracy" ? `${Math.round((value || 0) * 100)}%` :
          currentSort === "total_time" ? (showSecondsOnly ? formatSecondsOnly(value) : formatTime(value)) :
          currentSort === "last_test_taken" ? formatDate(value) :
          value;

        if (currentSort === "last_test_taken") {
          row.innerHTML = `
            <div class="rank">${idx < 3 ? getMedalEmoji(idx) : rank}</div>
            <div class="name name-two-line">
              <div class="full-name">${s.name}</div>
              <div class="last-test-small">${formatDate(s.last_test_taken)}</div>
            </div>
            <div class="score"></div>`;
        } else if (currentSort === "total_time") {
          if (showSecondsOnly) {
            row.innerHTML = `
              <div class="rank">${idx < 3 ? getMedalEmoji(idx) : rank}</div>
              <div class="name"><div class="full-name">${s.name}</div></div>
              <div class="score score-time">${formatSecondsOnly(s.total_time)}</div>`;
          } else {
            const totalSeconds = s.total_time ?? 0;
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2, "0");
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, "0");
            const s_val = (totalSeconds % 60).toString().padStart(2, "0");
            row.innerHTML = `
              <div class="rank">${idx < 3 ? getMedalEmoji(idx) : rank}</div>
              <div class="name"><div class="full-name">${s.name}</div></div>
              <div class="score score-time">
                <span class="t-block"><span class="t-num">${h}</span><span class="t-unit h">h</span></span>
                <span class="t-block"><span class="t-num">${m}</span><span class="t-unit m">m</span></span>
                <span class="t-block"><span class="t-num">${s_val}</span><span class="t-unit s">s</span></span>
              </div>`;
          }
        } else {
          const metricLabel =
            currentSort === "accuracy" ? "TARGET LOCK" :
            currentSort === "quests_completed" ? "QUESTS" :
            currentSort === "videos_completed" ? "VIDEOS" :
            currentSort === "stories_completed" ? "STORIES" :
            currentSort === "cryptic_completed" ? "CRYPTIC" :
            currentSort === "wordle_completed" ? "WORDLE" : "";

          row.innerHTML = `
            <div class="rank">${idx < 3 ? getMedalEmoji(idx) : rank}</div>
            <div class="name">
              <div class="cadet-name">${s.name} <span class="dept-inline">${s.department ? `¬∑ ${s.department}` : ""}</span></div>
              <div class="metric-tag">${metricLabel}</div>
            </div>
            <div class="score">${displayValue}</div>`;
        }

        row.onclick = () => showDetail(s);
        container.appendChild(row);
      });
    }

    function getMedalEmoji(idx) {
      return idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : "ü•â";
    }

    const START_DATE = new Date("2025-08-25");
    const CALENDAR_VISIBLE_START = new Date("2026-02-01");

    function mapToDate(number) {
      const d = new Date(START_DATE);
      d.setDate(d.getDate() + (number - 1));
      return d;
    }

    function parseItems(rawList) {
      if (!rawList || rawList === "NULL") return [];
      return rawList.split(",").map(item => item.trim()).filter(item => item.length > 0).map(item => {
        const [type, num] = item.split(" ");
        return { type, number: Number(num), label: item };
      });
    }

    function iconFor(label) {
      if (label.startsWith("Quest")) return "‚ô•Ô∏è";
      if (label.startsWith("Video")) return "üòç";
      if (label.startsWith("Story")) return "üìú";
      return "‚Ä¢";
    }

    function groupByDate(quests, videos, stories) {
      const map = {};
      const add = (date, label) => { const key = date.toDateString(); if (!map[key]) map[key] = []; map[key].push(label); };
      quests.forEach(q => add(mapToDate(q.number), q.label));
      videos.forEach(v => add(mapToDate(v.number), v.label));
      stories.forEach(s => add(mapToDate(s.number), s.label));
      return map;
    }

    function renderOneMonth(baseDate, grouped) {
      const year = baseDate.getFullYear(), month = baseDate.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const numDays = new Date(year, month + 1, 0).getDate();
      let html = `<div class="mini-cal-title">${baseDate.toLocaleString('en-IN', { month: 'long', year: 'numeric' })}</div><div class="mini-cal-grid"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>`;
      for (let i = 0; i < firstDay; i++) html += `<div class="mini-cal-empty"></div>`;
      for (let d = 1; d <= numDays; d++) {
        const date = new Date(year, month, d);
        const key = date.toDateString();
        const items = grouped[key];
        if (items) {
          html += `<div class="mini-cal-day marked"><div class="mini-cal-date">${d}</div><div class="mini-cal-items">${items.map(i => `<div>${iconFor(i)}</div>`).join("")}</div></div>`;
        } else {
          html += `<div class="mini-cal-day">${d}</div>`;
        }
      }
      html += "</div>";
      return html;
    }

    function renderMiniCalendar(containerId, grouped) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      let cursor = new Date(CALENDAR_VISIBLE_START.getFullYear(), CALENDAR_VISIBLE_START.getMonth(), 1);
      const today = new Date();
      const end = new Date(today.getFullYear(), today.getMonth(), 1);
      while (cursor <= end) {
        container.innerHTML += renderOneMonth(cursor, grouped);
        cursor.setMonth(cursor.getMonth() + 1);
      }
    }

    function showDetail(s) {
      const modal = document.getElementById("modal");
      const content = document.getElementById("modal-content");
      content.innerHTML = `
        <div class="modal-header">
          <div class="modal-id-tag">Pilot Profile</div>
          <h2>${s.name}</h2>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-dept">${s.department || 'N/A'}</div>
        <div class="stats-grid">
          <div class="stat-box"><div class="stat-label">Total Score</div><div class="stat-value">${s.total_score ?? 0}</div><div class="stat-foot">Mission Points</div></div>
          <div class="stat-box"><div class="stat-label">Accuracy</div><div class="stat-value">${Math.round((s.accuracy ?? 0) * 100)}%</div><div class="stat-foot">Hit Rate</div></div>
          <div class="stat-box"><div class="stat-label">Cryptic</div><div class="stat-value">${s.cryptic_completed ?? 0}</div><div class="stat-foot">Puzzles solved</div></div>
          <div class="stat-box"><div class="stat-label">Wordle</div><div class="stat-value">${s.wordle_completed ?? 0}</div><div class="stat-foot">Puzzles solved</div></div>
          <div class="stat-box"><div class="stat-label">Quests</div><div class="stat-value">${s.total_attempts ?? 0}</div><div class="stat-foot">Quests conquered</div></div>
          <div class="stat-box"><div class="stat-label">Correct</div><div class="stat-value">${s.total_correct ?? 0}</div><div class="stat-foot">Direct Hits</div></div>
          <div class="stat-box"><div class="stat-label">Wrong</div><div class="stat-value">${s.total_wrong ?? 0}</div><div class="stat-foot">Near Misses</div></div>
          <div class="stat-box"><div class="stat-label">Time on Mission</div><div class="stat-value time-stat">${formatTime(s.total_time)}</div><div class="stat-foot">Cumulative</div></div>
        </div>
        <div class="detail-box">
          <h3>üì° Mission Activity Grid</h3>
          <p class="detail-caption">Gold days show completed Quests, Videos, or Stories.</p>
          <div id="mini-calendar" class="mission-calendar"></div>
        </div>
        <div class="detail-box">
          <h3>üïê Last Mission</h3>
          <p>${formatDate(s.last_test_taken)}</p>
        </div>`;

      const quests = parseItems(s.quest_list);
      const videos = parseItems(s.video_list);
      const stories = parseItems(s.story_list);
      const grouped = groupByDate(quests, videos, stories);
      renderMiniCalendar("mini-calendar", grouped);

      const pdfBtn = document.createElement("button");
      pdfBtn.textContent = "üìÑ Download PDF Report";
      pdfBtn.className = "pdf-btn";
      pdfBtn.onclick = () => downloadProfilePDF(s);
      content.appendChild(pdfBtn);

      modal.style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    function showClassStats() {
      if (reportData.length === 0) return;
      const totalStudents = reportData.length;
      const avgScore = Math.round(reportData.reduce((sum, s) => sum + (s.total_score || 0), 0) / totalStudents);
      const avgAccuracy = Math.round((reportData.reduce((sum, s) => sum + (s.accuracy || 0), 0) / totalStudents) * 100);
      const totalAttempts = reportData.reduce((sum, s) => sum + (s.total_attempts || 0), 0);
      const totalTime = reportData.reduce((sum, s) => sum + (s.total_time || 0), 0);
      const totalVideos = reportData.reduce((sum, s) => sum + (s.videos_completed || 0), 0);
      const totalStories = reportData.reduce((sum, s) => sum + (s.stories_completed || 0), 0);
      const totalQuests = reportData.reduce((sum, s) => sum + (s.quests_completed || 0), 0);
      const totalCryptic = reportData.reduce((sum, s) => sum + (s.cryptic_completed || 0), 0);

      const modal = document.getElementById("modal");
      const content = document.getElementById("modal-content");
      content.innerHTML = `
        <div class="modal-header">
          <div class="modal-id-tag">Class Stats</div>
          <h2>Squad Overview</h2>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div class="stats-grid">
          <div class="stat-box"><div class="stat-label">Avg Score</div><div class="stat-value">${avgScore}</div><div class="stat-foot">Per Pilot</div></div>
          <div class="stat-box"><div class="stat-label">Cryptic</div><div class="stat-value">${totalCryptic}</div><div class="stat-foot">Solved</div></div>
          <div class="stat-box"><div class="stat-label">Avg Accuracy</div><div class="stat-value">${avgAccuracy}%</div><div class="stat-foot">Hit Rate</div></div>
          <div class="stat-box"><div class="stat-label">Total Attempts</div><div class="stat-value">${totalAttempts}</div><div class="stat-foot">Shots Fired</div></div>
          <div class="stat-box"><div class="stat-label">Total Time</div><div class="stat-value time-stat">${formatTime(totalTime)}</div><div class="stat-foot">Cumulative</div></div>
          <div class="stat-box"><div class="stat-label">Videos</div><div class="stat-value">${totalVideos}</div><div class="stat-foot">Completed</div></div>
          <div class="stat-box"><div class="stat-label">Stories</div><div class="stat-value">${totalStories}</div><div class="stat-foot">Completed</div></div>
          <div class="stat-box"><div class="stat-label">Quests</div><div class="stat-value">${totalQuests}</div><div class="stat-foot">Completed</div></div>
        </div>`;
      modal.style.display = "flex";
    }

    window.sortData = sortData;
    window.closeModal = closeModal;
    window.showClassStats = showClassStats;
    window.applyDepartmentFilter = applyDepartmentFilter;
    window.onload = loadData;

    window.toggleTimeFormat = function () {
      showSecondsOnly = !showSecondsOnly;
      document.getElementById("time-toggle").textContent = showSecondsOnly ? "Show h:m:s" : "Show Seconds";
      renderLeaderboard();
    };

    window.onclick = function (event) {
      if (event.target === document.getElementById("modal")) closeModal();
    };

    // PDF library injection
    (function () {
      const s1 = document.createElement("script");
      const s2 = document.createElement("script");
      s1.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
      s2.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
      document.head.appendChild(s1);
      document.head.appendChild(s2);
    })();

    async function downloadProfilePDF(studentObj) {
      if (!window.jspdf) {
        await new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
          s.onload = resolve; s.onerror = reject;
          document.head.appendChild(s);
        });
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 40;
      const contentW = pageW - margin * 2;
      let y = margin;

      function checkPage(needed = 20) { if (y + needed > pageH - margin) { doc.addPage(); y = margin; } }
      function drawHRule(color = [201, 168, 76]) { doc.setDrawColor(...color); doc.setLineWidth(0.5); doc.line(margin, y, pageW - margin, y); y += 8; }
      function centeredText(str, fontSize, style = "normal", color = [30, 30, 30]) { doc.setFont("helvetica", style); doc.setFontSize(fontSize); doc.setTextColor(...color); doc.text(str, pageW / 2, y, { align: "center" }); }

      doc.setFillColor(201, 168, 76); doc.rect(0, 0, pageW, 6, "F");
      y = 36;
      centeredText("SRM VALLIAMMAI ENGINEERING COLLEGE", 14, "bold", [100, 75, 20]);
      y += 18; centeredText("Department of English", 11, "normal", [120, 95, 40]);
      y += 10; drawHRule([201, 168, 76]);
      centeredText("Mission: Veni, Vidi, Vici! ‚Äî Pilot Profile", 9, "normal", [160, 130, 60]);
      y += 18; centeredText(studentObj.name, 22, "bold", [30, 30, 30]);
      y += 8;
      if (studentObj.department) { centeredText(studentObj.department.toUpperCase(), 9, "normal", [150, 120, 60]); y += 6; }
      drawHRule([201, 168, 76]); y += 4;

      const quests = parseItems(studentObj.quest_list);
      const videos = parseItems(studentObj.video_list);
      const stories = parseItems(studentObj.story_list);
      const totalSec = Math.round(studentObj.total_time || 0);
      const h = Math.floor(totalSec / 3600), m = Math.floor((totalSec % 3600) / 60), s = totalSec % 60;
      const accuracy = Math.round((studentObj.accuracy || 0) * 100);
      const stats = [
        { label: "Total Score", value: String(studentObj.total_score ?? 0) },
        { label: "Accuracy", value: `${accuracy}%` },
        { label: "Quests", value: String(quests.length) },
        { label: "Videos", value: String(videos.length) },
        { label: "Stories", value: String(stories.length) },
        { label: "Cryptic", value: String(studentObj.cryptic_completed ?? 0) },
        { label: "Wordle", value: String(studentObj.wordle_completed ?? 0) },
        { label: "Time", value: `${h}h ${m}m ${s}s` },
      ];

      const cols = 4, boxW = contentW / cols, boxH = 52;
      stats.forEach((stat, i) => {
        const col = i % cols, row = Math.floor(i / cols);
        const bx = margin + col * boxW, by = y + row * (boxH + 6);
        doc.setFillColor(250, 245, 235); doc.setDrawColor(201, 168, 76); doc.setLineWidth(0.5);
        doc.roundedRect(bx, by, boxW - 4, boxH, 4, 4, "FD");
        doc.setFont("helvetica", "normal"); doc.setFontSize(8); doc.setTextColor(150, 120, 60);
        doc.text(stat.label.toUpperCase(), bx + 8, by + 14);
        doc.setFont("helvetica", "bold"); doc.setFontSize(stat.value.length > 8 ? 11 : 16); doc.setTextColor(30, 30, 30);
        doc.text(stat.value, bx + 8, by + 36);
      });

      y += Math.ceil(stats.length / cols) * (boxH + 6) + 10;
      doc.setFont("helvetica", "normal"); doc.setFontSize(9); doc.setTextColor(120, 100, 60);
      doc.text(`Last Mission: ${formatDate(studentObj.last_test_taken)}`, margin, y);
      y += 16; drawHRule([201, 168, 76]); y += 4;

      doc.setFont("helvetica", "bold"); doc.setFontSize(11); doc.setTextColor(100, 75, 20);
      doc.text("Activity Calendar", margin, y); y += 12;

      const grouped = groupByDate(quests, videos, stories);
      let cursor = new Date(CALENDAR_VISIBLE_START.getFullYear(), CALENDAR_VISIBLE_START.getMonth(), 1);
      const today = new Date();
      const endMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const calCols = 2, calW = contentW / calCols;
      const daySize = Math.floor((calW - 12) / 7);
      let calCol = 0, calRowY = y;

      while (cursor <= endMonth) {
        const year = cursor.getFullYear(), month = cursor.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const numDays = new Date(year, month + 1, 0).getDate();
        const bx = margin + calCol * calW;
        let cy = calRowY;
        doc.setFont("helvetica", "bold"); doc.setFontSize(8); doc.setTextColor(100, 75, 20);
        const monthLabel = cursor.toLocaleString('en-IN', { month: 'long', year: 'numeric' });
        doc.text(monthLabel, bx + calW / 2 - doc.getTextWidth(monthLabel) / 2, cy + 8); cy += 14;
        const dayNames = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
        doc.setFont("helvetica", "normal"); doc.setFontSize(6); doc.setTextColor(130, 100, 50);
        dayNames.forEach((d, di) => doc.text(d, bx + 4 + di * (daySize + 1) + (daySize - doc.getTextWidth(d)) / 2, cy + 7));
        cy += 10;
        let cellX = firstDay, cellRow = 0;
        for (let d = 1; d <= numDays; d++) {
          const date = new Date(year, month, d);
          const key = date.toDateString();
          const hasActivity = !!grouped[key];
          const dx = bx + 4 + cellX * (daySize + 1), dy = cy + cellRow * (daySize + 1);
          if (hasActivity) { doc.setFillColor(248, 224, 140); doc.setDrawColor(201, 168, 76); }
          else { doc.setFillColor(250, 248, 245); doc.setDrawColor(220, 200, 160); }
          doc.setLineWidth(0.3); doc.rect(dx, dy, daySize, daySize, "FD");
          doc.setFont("helvetica", hasActivity ? "bold" : "normal"); doc.setFontSize(5.5);
          doc.setTextColor(hasActivity ? 80 : 160, hasActivity ? 60 : 130, hasActivity ? 10 : 90);
          const dStr = String(d);
          doc.text(dStr, dx + (daySize - doc.getTextWidth(dStr)) / 2, dy + daySize * 0.65);
          cellX++; if (cellX === 7) { cellX = 0; cellRow++; }
        }
        const thisMonthH = cy + (cellRow + (cellX > 0 ? 1 : 0)) * (daySize + 1) - calRowY + 8;
        calCol++;
        if (calCol >= calCols) { calCol = 0; calRowY += thisMonthH + 10; checkPage(80); }
        cursor.setMonth(cursor.getMonth() + 1);
      }

      doc.setFont("helvetica", "normal"); doc.setFontSize(8); doc.setTextColor(180, 150, 80);
      doc.text(`Generated: ${new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })}`, pageW / 2, pageH - 20, { align: "center" });
      doc.setFillColor(201, 168, 76); doc.rect(0, pageH - 6, pageW, 6, "F");
      doc.save(`${studentObj.name}_Profile.pdf`);
    }
  </script>

  <style>
    /* =============================================
       SINGLE CONSOLIDATED STYLESHEET
       Light Cream + Gold Theme
       ============================================= */

    :root {
      --cream:        #faf7f2;
      --cream-dark:   #f2ece0;
      --cream-mid:    #ede5d5;
      --surface:      #ffffff;

      --gold:         #c9a84c;
      --gold-light:   #e8c97a;
      --gold-deep:    #a07a28;
      --gold-dim:     rgba(201, 168, 76, 0.12);
      --gold-border:  rgba(201, 168, 76, 0.35);

      --rank-gold:    #c9a84c;
      --rank-silver:  #9ca3af;
      --rank-bronze:  #b87333;

      --text-primary:   #1a1714;
      --text-secondary: #7a6a52;
      --text-dim:       #b0a090;

      --border-soft:    rgba(0, 0, 0, 0.07);
      --border-mid:     rgba(0, 0, 0, 0.12);

      --success: #15803D;
      --danger:  #B91C1C;

      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 20px;
    }

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--cream);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px 12px 48px;
      /* subtle linen texture via repeating gradient */
      background-image:
        radial-gradient(circle at 70% 5%, rgba(201,168,76,0.10) 0%, transparent 45%),
        radial-gradient(circle at 10% 95%, rgba(201,168,76,0.08) 0%, transparent 40%);
    }

    /* ‚îÄ‚îÄ FRAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .command-frame {
      max-width: 960px;
      margin: 0 auto;
      border-radius: var(--radius-lg);
      background: var(--surface);
      border: 1px solid var(--gold-border);
      box-shadow:
        0 1px 0 0 rgba(255,255,255,0.9) inset,
        0 24px 60px rgba(0, 0, 0, 0.09),
        0 4px 16px rgba(201,168,76,0.12);
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .header {
      padding: 22px 24px 16px;
      border-bottom: 1px solid var(--border-soft);
      background: linear-gradient(160deg, var(--surface) 60%, var(--cream-dark) 100%);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .mission-title {
      font-size: 11px;
      letter-spacing: 0.20em;
      text-transform: uppercase;
      color: var(--text-dim);
      font-weight: 600;
    }

    .title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 30px;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: var(--gold-deep);
      line-height: 1;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .badge-live {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 8px 16px;
      border-radius: 999px;
      background: var(--gold-dim);
      border: 1px solid var(--gold-border);
      font-size: 12px;
      font-weight: 700;
      color: var(--gold-deep);
      cursor: pointer;
      letter-spacing: 0.04em;
      transition: background 0.2s ease, box-shadow 0.2s ease;
      white-space: nowrap;
    }

    .badge-live:hover {
      background: rgba(201,168,76,0.22);
      box-shadow: 0 2px 12px rgba(201,168,76,0.22);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--gold);
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50%       { opacity: 0.5; transform: scale(0.7); }
    }

    /* ‚îÄ‚îÄ TOP CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .top-controls {
      display: flex;
      gap: 12px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border-soft);
      background: var(--cream);
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .department-filter {
      flex-shrink: 0;
    }

    .department-filter select {
      padding: 9px 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-mid);
      background: var(--surface);
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.06em;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%237a6a52' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
      min-width: 160px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .department-filter select:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(201,168,76,0.15);
    }

    /* ‚îÄ‚îÄ SORT PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .sort-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }

    .sort-label-row {
      display: none; /* hidden as per original */
    }

    .sort-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
    }

    /* standalone buttons OUTSIDE .sort-buttons */
    .sort-btn,
    #time-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-mid);
      background: var(--surface);
      color: var(--text-secondary);
      font-family: 'DM Sans', sans-serif;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.18s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .sort-btn:hover {
      border-color: var(--gold);
      color: var(--gold-deep);
      background: var(--gold-dim);
    }

    .sort-btn.active {
      background: var(--gold);
      color: #fff;
      border-color: var(--gold);
      box-shadow: 0 2px 10px rgba(201,168,76,0.35);
    }

    .sort-btn .sort-indicator {
      font-size: 10px;
    }

    #time-toggle {
      font-size: 10px;
    }

    /* ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #leaderboard {
      margin: 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: var(--surface);
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    .leaderboard-header-row {
      display: grid;
      grid-template-columns: 48px 1fr auto;
      padding: 8px 16px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-dim);
      border-bottom: 1px solid var(--border-soft);
      background: var(--cream);
    }

    .leaderboard-row {
      display: grid;
      grid-template-columns: 48px 1fr auto;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-soft);
      cursor: pointer;
      align-items: center;
      transition: background 0.14s ease;
      position: relative;
    }

    .leaderboard-row:last-child {
      border-bottom: none;
    }

    .leaderboard-row:hover {
      background: var(--cream);
    }

    .leaderboard-row.gold   { border-left: 3px solid var(--rank-gold); }
    .leaderboard-row.silver { border-left: 3px solid var(--rank-silver); }
    .leaderboard-row.bronze { border-left: 3px solid var(--rank-bronze); }

    /* ‚îÄ‚îÄ ROW CONTENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .rank {
      font-size: 14px;
      font-weight: 800;
      text-align: center;
      color: var(--text-dim);
      line-height: 1;
    }

    .leaderboard-row.gold   .rank,
    .leaderboard-row.silver .rank,
    .leaderboard-row.bronze .rank {
      font-size: 20px;
    }

    .name {
      padding: 0 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 3px;
      min-width: 0;
    }

    .cadet-name,
    .full-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .dept-inline {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-dim);
    }

    .metric-tag {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .last-test-small {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .score {
      font-size: 20px;
      font-weight: 800;
      color: var(--gold-deep);
      text-align: right;
      min-width: 80px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      font-variant-numeric: tabular-nums;
      gap: 2px;
    }

    .score-time {
      font-size: 14px;
      gap: 4px;
    }

    /* ‚îÄ‚îÄ TIME DISPLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .time-block {
      display: inline-flex;
      align-items: baseline;
      gap: 2px;
    }

    .time-num {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .time-unit {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-dim);
    }

    .time-unit.h { color: var(--gold-deep); }
    .time-unit.m { color: var(--gold); }
    .time-unit.s { color: var(--text-secondary); }

    .t-block {
      display: inline-flex;
      align-items: baseline;
      gap: 2px;
    }

    .t-num {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .t-unit {
      font-size: 10px;
      font-weight: 600;
    }

    .t-unit.h { color: var(--gold-deep); }
    .t-unit.m { color: var(--gold); }
    .t-unit.s { color: var(--text-secondary); }

    /* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #loader {
      display: none;
      justify-content: center;
      align-items: center;
      padding: 48px 0 24px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 3px solid var(--cream-mid);
      border-top-color: var(--gold);
      animation: spin 0.85s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #error {
      color: var(--danger);
      text-align: center;
      padding: 16px;
      font-weight: 600;
      font-size: 13px;
    }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(26, 23, 20, 0.40);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: flex-start;
      z-index: 1000;
      overflow-y: auto;
      padding: 30px 12px;
    }

    #modal-content {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 22px 20px 24px;
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      border: 1px solid var(--gold-border);
      box-shadow:
        0 30px 70px rgba(0, 0, 0, 0.18),
        0 4px 16px rgba(201,168,76,0.12);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--border-soft);
    }

    .modal-header h2 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
      flex: 1;
    }

    .modal-id-tag {
      position: absolute;
      top: -12px;
      left: 20px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--gold-border);
      color: var(--gold-deep);
    }

    .modal-dept {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 16px;
    }

    .close-btn {
      background: var(--cream);
      border: 1px solid var(--border-mid);
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      line-height: 1;
      transition: all 0.15s ease;
    }

    .close-btn:hover {
      background: var(--gold-dim);
      border-color: var(--gold);
      color: var(--gold-deep);
    }

    /* ‚îÄ‚îÄ STATS GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .stat-box {
      background: var(--cream);
      padding: 12px 12px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-soft);
      text-align: left;
    }

    .stat-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 800;
      color: var(--gold-deep);
      line-height: 1.1;
      font-variant-numeric: tabular-nums;
    }

    .time-stat {
      font-size: 0; /* children handle sizing */
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: baseline;
    }

    .time-stat .time-num { font-size: 16px; }
    .time-stat .time-unit { font-size: 11px; }

    .stat-foot {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    /* ‚îÄ‚îÄ DETAIL BOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .detail-box {
      background: var(--cream);
      padding: 14px 13px 13px;
      border-radius: var(--radius-sm);
      margin-bottom: 12px;
      border: 1px solid var(--border-soft);
    }

    .detail-box h3 {
      color: var(--text-primary);
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 700;
    }

    .detail-box p {
      color: var(--text-secondary);
      line-height: 1.6;
      font-size: 13px;
    }

    .detail-caption {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    /* ‚îÄ‚îÄ MINI CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .mission-calendar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mini-cal-title {
      text-align: center;
      font-weight: 700;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--gold-deep);
      margin-bottom: 6px;
    }

    .mini-cal-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 9px;
    }

    .mini-cal-grid > div:nth-child(-n+7) {
      font-weight: 700;
      text-align: center;
      color: var(--text-dim);
      padding-bottom: 3px;
    }

    .mini-cal-day {
      background: var(--surface);
      border: 1px solid var(--border-soft);
      border-radius: 5px;
      min-height: 38px;
      padding: 3px 3px;
      font-size: 9px;
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .mini-cal-day.marked {
      background: rgba(201,168,76,0.14);
      border-color: rgba(201,168,76,0.50);
    }

    .mini-cal-date {
      font-weight: 700;
      margin-bottom: 2px;
      color: var(--text-primary);
    }

    .mini-cal-items div {
      font-size: 9px;
      line-height: 1.1;
    }

    /* ‚îÄ‚îÄ PDF BUTTON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .pdf-btn {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 0.06em;
      border: 1px solid var(--gold-border);
      border-radius: var(--radius-sm);
      background: var(--gold-dim);
      color: var(--gold-deep);
      cursor: pointer;
      transition: all 0.18s ease;
    }

    .pdf-btn:hover {
      background: var(--gold);
      color: #fff;
      border-color: var(--gold);
    }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 600px) {
      body { padding: 12px 8px 36px; }

      .command-frame { border-radius: 16px; }

      .header { padding: 16px 16px 12px; }

      .title { font-size: 24px; }

      .top-controls {
        flex-direction: column;
        padding: 12px 14px;
      }

      .department-filter select { min-width: 100%; }

      .sort-buttons { gap: 6px; }

      .sort-btn { font-size: 10px; padding: 6px 11px; }

      #leaderboard { margin: 10px; }

      .leaderboard-header-row { display: none; }

      .leaderboard-row { padding: 11px 12px; }

      .cadet-name, .full-name { font-size: 13px; }

      .score { font-size: 17px; min-width: 70px; }

      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>

<body>
  <div class="command-frame">

    <div class="header">
      <div class="header-top">
        <div class="title-block">
          <div class="mission-title">Mission: Veni, Vidi, Vici!</div>
          <div class="title">LEADERBOARD</div>
        </div>
        <button class="badge-live" onclick="showClassStats()">
          <span class="badge-dot"></span>
          Squad Overview
        </button>
      </div>
      <div class="subtitle" id="last-test-info">Initializing mission feed...</div>
    </div>

    <div class="top-controls">
      <div class="department-filter">
        <select id="departmentSelect" onchange="applyDepartmentFilter(this.value)">
          <option value="ALL">All Departments</option>
        </select>
      </div>

      <div class="sort-panel">
        <div class="sort-label-row"></div>
        <div class="sort-buttons">
          <button class="sort-btn" data-sort="cryptic_completed" onclick="sortData('cryptic_completed')">
            Cryptic <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="wordle_completed" onclick="sortData('wordle_completed')">
            Wordle <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="accuracy" onclick="sortData('accuracy')">
            Accuracy <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="total_time" onclick="sortData('total_time')">
            Time <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="quests_completed" onclick="sortData('quests_completed')">
            Quests <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="videos_completed" onclick="sortData('videos_completed')">
            Videos <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="stories_completed" onclick="sortData('stories_completed')">
            Stories <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="last_test_taken" onclick="sortData('last_test_taken')">
            Last Test <span class="sort-indicator"></span>
          </button>
          <button id="time-toggle"
            class="sort-btn"
            style="display:none;"
            onclick="toggleTimeFormat()">
            Show Seconds
          </button>
        </div>
      </div>
    </div>

    <div id="loader">
      <div class="spinner"></div>
    </div>
    <div id="error"></div>

    <div id="leaderboard">
      <div class="leaderboard-header-row">
        <div>Rank</div>
        <div>Pilot</div>
        <div>Metric</div>
      </div>
    </div>

  </div><!-- end .command-frame -->

  <div id="modal">
    <div id="modal-content"></div>
  </div>
</body>
</html>
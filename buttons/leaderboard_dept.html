<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mission Leaderboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://ahezssoczvpbkteffcgz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE"
);

let reportData = [];
let currentDepartment = "ALL";

const START_DATE = new Date("2025-08-25");
const CALENDAR_VISIBLE_START = new Date("2026-02-01");

/* ========================================================= */

async function loadData() {
  document.getElementById("loader").style.display = "block";

  const { data, error } = await supabase
    .from("report_card_view")
    .select("*");

  document.getElementById("loader").style.display = "none";

  if (error) {
    document.getElementById("error").textContent = "âš ï¸ Data load failed";
    return;
  }

  reportData = data || [];

  populateDepartmentDropdown();
  renderClassCalendar();
}

/* ========================================================= */
/* Department Filter */
/* ========================================================= */

function populateDepartmentDropdown() {
  const select = document.getElementById("departmentSelect");

  const departments = [...new Set(
    reportData.map(s => (s.department || "UNKNOWN").toUpperCase())
  )].sort();

  select.innerHTML = `<option value="ALL">All Departments</option>`;

  departments.forEach(dept => {
    const opt = document.createElement("option");
    opt.value = dept;
    opt.textContent = dept;
    select.appendChild(opt);
  });
}

window.changeDepartment = function(dept) {
  currentDepartment = dept;
  renderClassCalendar();
};

/* ========================================================= */
/* Helpers */
/* ========================================================= */

function mapToDate(number) {
  const d = new Date(START_DATE);
  d.setDate(d.getDate() + (number - 1));
  return d;
}

function parseItems(rawList) {
  if (!rawList || rawList === "NULL") return [];

  return rawList.split(",")
    .map(i => i.trim())
    .filter(Boolean)
    .map(item => {
      const [type, num] = item.split(" ");
      return { type, number: Number(num) };
    });
}

/* ========================================================= */
/* Build Map */
/* ========================================================= */

function buildClassDateMap() {
  const map = {};

  reportData.forEach(student => {

    if (
      currentDepartment !== "ALL" &&
      (student.department || "UNKNOWN").toUpperCase() !== currentDepartment
    ) return;

    const quests = parseItems(student.quest_list);
    const videos = parseItems(student.video_list);
    const stories = parseItems(student.story_list);

    const all = [...quests, ...videos, ...stories];

    all.forEach(item => {
      const date = mapToDate(item.number);
      const key = date.toDateString();

      if (!map[key]) map[key] = [];
      map[key].push(student);
    });
  });

  return map;
}

/* ========================================================= */
/* Heatmap */
/* ========================================================= */

function getIntensity(total) {
  if (total > 20) return "peak";
  if (total > 10) return "heavy";
  if (total > 5) return "medium";
  return "light";
}

/* ========================================================= */
/* Calendar Render */
/* ========================================================= */

function renderClassCalendar() {
  const container = document.getElementById("class-calendar");
  container.innerHTML = "";

  const dateMap = buildClassDateMap();
  window.dateMap = dateMap;

  let cursor = new Date(
    CALENDAR_VISIBLE_START.getFullYear(),
    CALENDAR_VISIBLE_START.getMonth(),
    1
  );

  const today = new Date();
  const end = new Date(today.getFullYear(), today.getMonth(), 1);

  while (cursor <= end) {
    container.innerHTML += renderMonth(cursor, dateMap);
    cursor.setMonth(cursor.getMonth() + 1);
  }
}

function renderMonth(baseDate, dateMap) {
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();

  const firstDay = new Date(year, month, 1).getDay();
  const numDays = new Date(year, month + 1, 0).getDate();

  let html = `
    <div class="month-block">
      <div class="month-title">
        ${baseDate.toLocaleString('en-IN', { month: 'long', year: 'numeric' })}
      </div>

      <div class="calendar-grid">
        <div>Sun</div><div>Mon</div><div>Tue</div>
        <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  `;

  for (let i = 0; i < firstDay; i++) {
    html += `<div class="empty"></div>`;
  }

  for (let d = 1; d <= numDays; d++) {
    const date = new Date(year, month, d);
    const key = date.toDateString();
    const entries = dateMap[key];

    if (entries) {
      const intensity = getIntensity(entries.length);

      html += `
        <div class="day marked ${intensity}" onclick="showDateDetail('${key}')">
          <div class="date-num">${d}</div>
          <div class="count">${entries.length}</div>
        </div>
      `;
    } else {
      html += `<div class="day">${d}</div>`;
    }
  }

  html += "</div></div>";
  return html;
}

/* ========================================================= */
/* Date Modal */
/* ========================================================= */

window.showDateDetail = function(dateKey) {
  const entries = window.dateMap[dateKey];
  if (!entries) return;

  const modal = document.getElementById("modal");
  const content = document.getElementById("modal-content");

  const deptMap = {};

  entries.forEach(student => {
    const dept = (student.department || "UNKNOWN").toUpperCase();

    if (!deptMap[dept]) deptMap[dept] = [];
    deptMap[dept].push(student.name);
  });

  let html = `<h2>${dateKey}</h2>`;

  Object.keys(deptMap).sort().forEach(dept => {
    html += `
      <div class="dept-block">
        <div class="dept-title">${dept} (${deptMap[dept].length})</div>
        ${deptMap[dept].sort().map(n => `<div>${n}</div>`).join("")}
      </div>
    `;
  });

  content.innerHTML = html;
  modal.style.display = "flex";
};

window.closeModal = function() {
  document.getElementById("modal").style.display = "none";
};

window.onload = loadData;

</script>

<style>

body {
  background: #0B0B0C;
  color: #F8F7F3;
  font-family: Inter;
  padding: 20px;
}

/* Controls */

select {
  padding: 8px;
  margin-bottom: 20px;
}

/* Calendar */

.month-block {
  margin-bottom: 30px;
}

.month-title {
  text-align: center;
  color: #D4AF37;
  margin-bottom: 8px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  font-size: 12px;
}

.day {
  background: #111;
  border-radius: 8px;
  padding: 6px;
  min-height: 60px;
  border: 1px solid rgba(212,175,55,0.2);
}

.day.marked { cursor: pointer; border-color: #D4AF37; }

.light { background: rgba(212,175,55,0.18); }
.medium { background: rgba(212,175,55,0.28); }
.heavy { background: rgba(212,175,55,0.38); }
.peak { background: rgba(212,175,55,0.6); }

/* Modal */

#modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
}

#modal-content {
  background: #111;
  padding: 20px;
  border-radius: 14px;
  width: 90%;
  max-width: 420px;
}

.dept-title { color: #D4AF37; margin-top: 10px; }

</style>
</head>

<body>

<div id="loader">Loading...</div>
<div id="error"></div>

<select id="departmentSelect" onchange="changeDepartment(this.value)">
  <option>Loading departments...</option>
</select>

<h3>ðŸ“… Class Activity Calendar</h3>
<div id="class-calendar"></div>

<div id="modal" onclick="closeModal()">
  <div id="modal-content" onclick="event.stopPropagation()"></div>
</div>

</body>
</html>
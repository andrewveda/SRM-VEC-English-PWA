<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mission Leaderboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://ahezssoczvpbkteffcgz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE"
);

let reportData = [];
let filteredData = [];
let currentSort = "last_test_taken";
let sortAscending = false;

const START_DATE = new Date("2025-08-25");
const CALENDAR_VISIBLE_START = new Date("2026-02-01");

async function loadData() {
  const loader = document.getElementById("loader");
  loader.style.display = "flex";

  const { data, error } = await supabase
    .from("report_card_view")
    .select("*");

  loader.style.display = "none";

  if (error) {
    document.getElementById("error").textContent =
      "âš ï¸ Unable to load data.";
    return;
  }

  reportData = data || [];
  filteredData = [...reportData];

  filteredData.sort(
    (a, b) =>
      new Date(b.last_test_taken || 0) -
      new Date(a.last_test_taken || 0)
  );

  populateDepartmentDropdown(reportData);
  renderLeaderboard();
  renderClassCalendar();   // âœ… NEW
}

function formatDate(dateStr) {
  if (!dateStr) return "N/A";
  const date = new Date(dateStr);
  return date.toLocaleString('en-IN', {
    timeZone: 'Asia/Kolkata'
  });
}

function formatTime(seconds) {
  seconds = Math.round(seconds || 0);
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;

  return `${h}h ${m}m ${s}s`;
}

function populateDepartmentDropdown(data) {
  const select = document.getElementById("departmentSelect");
  select.innerHTML = `<option value="ALL">All Departments</option>`;

  const departments = [...new Set(
    data.map(s => (s.department || "").toUpperCase()).filter(Boolean)
  )].sort();

  departments.forEach(dept => {
    const opt = document.createElement("option");
    opt.value = dept;
    opt.textContent = dept;
    select.appendChild(opt);
  });
}

window.applyDepartmentFilter = function(dept) {
  if (dept === "ALL") {
    filteredData = [...reportData];
  } else {
    filteredData = reportData.filter(
      s => (s.department || "").toUpperCase() === dept
    );
  }

  renderLeaderboard();
};

window.sortData = function(key) {
  currentSort = key;

  filteredData.sort((a, b) => {
    return (b[key] || 0) - (a[key] || 0);
  });

  renderLeaderboard();
};

function renderLeaderboard() {
  const container = document.getElementById("leaderboard");
  container.innerHTML = "";

  filteredData.forEach((s, idx) => {
    const row = document.createElement("div");
    row.className = "leaderboard-row";

    row.innerHTML = `
      <div class="rank">${idx + 1}</div>
      <div class="name">${s.name}</div>
      <div class="score">${
        currentSort === "last_test_taken"
          ? formatDate(s.last_test_taken)
          : (s[currentSort] || 0)
      }</div>
    `;

    row.onclick = () => showDetail(s);
    container.appendChild(row);
  });
}

/* =========================================================
   STUDENT DETAIL
   ========================================================= */

function mapToDate(number) {
  const d = new Date(START_DATE);
  d.setDate(d.getDate() + (number - 1));
  return d;
}

function parseItems(rawList) {
  if (!rawList || rawList === "NULL") return [];

  return rawList.split(",")
    .map(i => i.trim())
    .filter(Boolean)
    .map(item => {
      const [type, num] = item.split(" ");
      return { type, number: Number(num) };
    });
}

function showDetail(s) {
  const modal = document.getElementById("modal");
  const content = document.getElementById("modal-content");

  content.innerHTML = `
    <div class="modal-header">
      <h2>${s.name}</h2>
      <button class="close-btn" onclick="closeModal()">Ã—</button>
    </div>

    <div class="detail-box">
      <p>Department: ${s.department || "N/A"}</p>
      <p>Accuracy: ${Math.round((s.accuracy || 0) * 100)}%</p>
      <p>Total Time: ${formatTime(s.total_time)}</p>
    </div>
  `;

  modal.style.display = "flex";
}

window.closeModal = function() {
  document.getElementById("modal").style.display = "none";
};

/* =========================================================
   âœ… CLASS CALENDAR
   ========================================================= */

function buildClassDateMap(data) {
  const map = {};

  data.forEach(student => {
    const quests = parseItems(student.quest_list);
    const videos = parseItems(student.video_list);
    const stories = parseItems(student.story_list);

    const all = [...quests, ...videos, ...stories];

    all.forEach(item => {
      const date = mapToDate(item.number);
      const key = date.toDateString();
      const dept = (student.department || "UNKNOWN").toUpperCase();

      if (!map[key]) map[key] = {};
      if (!map[key][dept]) map[key][dept] = [];

      map[key][dept].push(student.name);
    });
  });

  return map;
}

function getIntensity(total) {
  if (total > 20) return "peak";
  if (total > 10) return "heavy";
  if (total > 5) return "medium";
  return "light";
}

function renderClassCalendar() {
  const container = document.getElementById("class-calendar");
  if (!container) return;

  const dateMap = buildClassDateMap(reportData);
  window.classDateMap = dateMap;

  let cursor = new Date(
    CALENDAR_VISIBLE_START.getFullYear(),
    CALENDAR_VISIBLE_START.getMonth(),
    1
  );

  const today = new Date();
  const end = new Date(today.getFullYear(), today.getMonth(), 1);

  container.innerHTML = "";

  while (cursor <= end) {
    container.innerHTML += renderClassMonth(cursor, dateMap);
    cursor.setMonth(cursor.getMonth() + 1);
  }
}

function renderClassMonth(baseDate, dateMap) {
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();

  const firstDay = new Date(year, month, 1).getDay();
  const numDays = new Date(year, month + 1, 0).getDate();

  let html = `
    <div>
      <div class="mini-cal-title">
        ${baseDate.toLocaleString('en-IN', { month: 'long', year: 'numeric' })}
      </div>

      <div class="calendar-grid">
        <div>Sun</div><div>Mon</div><div>Tue</div>
        <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  `;

  for (let i = 0; i < firstDay; i++) {
    html += `<div></div>`;
  }

  for (let d = 1; d <= numDays; d++) {
    const date = new Date(year, month, d);
    const key = date.toDateString();
    const entry = dateMap[key];

    if (entry) {
      const total = Object.values(entry)
        .reduce((sum, arr) => sum + arr.length, 0);

      const intensity = getIntensity(total);

      html += `
        <div class="day marked ${intensity}" onclick="showDateBreakdown('${key}')">
          <div class="date-num">${d}</div>
          <div class="count">${total}</div>
        </div>
      `;
    } else {
      html += `<div class="day">${d}</div>`;
    }
  }

  html += "</div></div>";
  return html;
}

window.showDateBreakdown = function(dateKey) {
  const entry = window.classDateMap[dateKey];
  if (!entry) return;

  const modal = document.getElementById("modal");
  const content = document.getElementById("modal-content");

  let html = `
    <div class="modal-header">
      <h2>${dateKey}</h2>
      <button class="close-btn" onclick="closeModal()">Ã—</button>
    </div>
  `;

  Object.keys(entry).sort().forEach(dept => {
    html += `
      <div class="detail-box">
        <h3>${dept} (${entry[dept].length})</h3>
        ${entry[dept].map(n => `<p>â€¢ ${n}</p>`).join("")}
      </div>
    `;
  });

  content.innerHTML = html;
  modal.style.display = "flex";
};

window.onload = loadData;

</script>

<style>

body {
  background: #0B0B0C;
  color: #F8F7F3;
  font-family: Inter;
  padding: 20px;
}

/* Leaderboard */

.leaderboard-row {
  display: grid;
  grid-template-columns: 50px 1fr auto;
  padding: 10px;
  border-bottom: 1px solid rgba(212,175,55,0.2);
  cursor: pointer;
}

.score { color: #D4AF37; }

/* Calendar */

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
}

.day {
  background: #111;
  border-radius: 8px;
  padding: 6px;
  min-height: 60px;
}

.day.marked { border: 1px solid #D4AF37; }

.day.light { background: rgba(212,175,55,0.18); }
.day.medium { background: rgba(212,175,55,0.28); }
.day.heavy { background: rgba(212,175,55,0.38); }
.day.peak { background: rgba(212,175,55,0.6); }

.count {
  font-size: 18px;
  color: #D4AF37;
}

/* Modal */

#modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
}

#modal-content {
  background: #111;
  padding: 20px;
  border-radius: 14px;
  width: 90%;
  max-width: 420px;
}

.close-btn { cursor: pointer; }

</style>
</head>

<body>

<h2>Leaderboard</h2>
<div id="leaderboard"></div>

<div class="detail-box">
  <h3>ðŸ“… Class Activity Calendar</h3>
  <div id="class-calendar"></div>
</div>

<div id="loader">Loading...</div>
<div id="error"></div>

<div id="modal">
  <div id="modal-content"></div>
</div>

</body>
</html>
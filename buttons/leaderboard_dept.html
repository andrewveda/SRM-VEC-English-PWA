<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mission Leaderboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/* ‚úÖ Supabase */
const supabase = createClient(
  "https://ahezssoczvpbkteffcgz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE"
);

let reportData = [];
let filteredData = [];

const START_DATE = new Date("2025-08-25");
const CALENDAR_VISIBLE_START = new Date("2026-02-01");

/* ========================================================= */

function safeLoader(show) {
  const loader = document.getElementById("loader");
  if (!loader) return;
  loader.style.display = show ? "block" : "none";
}

function showError(msg) {
  const errorBox = document.getElementById("error");
  if (!errorBox) return;
  errorBox.textContent = msg;
}

/* ========================================================= */

async function loadData() {
  console.log("‚ñ∂ Loading data...");

  safeLoader(true);

  try {
    const { data, error } = await supabase
      .from("report_card_view")
      .select("*");

    safeLoader(false);

    if (error) {
      console.error("‚ùå Supabase error:", error);
      showError("‚ö†Ô∏è Data fetch failed");
      return;
    }

    reportData = data || [];
    filteredData = [...reportData];

    console.log("‚úÖ Rows loaded:", reportData.length);

    renderLeaderboard();
    renderClassCalendar();

  } catch (err) {
    safeLoader(false);
    console.error("‚ùå Fatal error:", err);
    showError("‚ö†Ô∏è Unexpected crash ‚Äî check console");
  }
}

/* ========================================================= */

function renderLeaderboard() {
  const container = document.getElementById("leaderboard");
  if (!container) return;

  if (filteredData.length === 0) {
    container.innerHTML = "<p>No data</p>";
    return;
  }

  container.innerHTML = filteredData.map((s, idx) => `
    <div class="leaderboard-row">
      <div>${idx + 1}</div>
      <div>${s.name}</div>
      <div>${Math.round((s.accuracy || 0) * 100)}%</div>
    </div>
  `).join("");
}

/* ========================================================= */

function mapToDate(number) {
  const d = new Date(START_DATE);
  d.setDate(d.getDate() + (number - 1));
  return d;
}

function parseItems(rawList) {
  if (!rawList || rawList === "NULL") return [];

  return rawList.split(",")
    .map(i => i.trim())
    .filter(Boolean)
    .map(item => {
      const [type, num] = item.split(" ");
      return { type, number: Number(num) };
    });
}

/* ========================================================= */
/* ‚úÖ CLASS CALENDAR */
/* ========================================================= */

function buildClassDateMap(data) {
  const map = {};

  data.forEach(student => {
    const quests = parseItems(student.quest_list);
    const videos = parseItems(student.video_list);
    const stories = parseItems(student.story_list);

    const all = [...quests, ...videos, ...stories];

    all.forEach(item => {
      const date = mapToDate(item.number);
      const key = date.toDateString();
      const dept = (student.department || "UNKNOWN").toUpperCase();

      if (!map[key]) map[key] = {};
      if (!map[key][dept]) map[key][dept] = [];

      map[key][dept].push(student.name);
    });
  });

  return map;
}

function getIntensity(total) {
  if (total > 20) return "peak";
  if (total > 10) return "heavy";
  if (total > 5) return "medium";
  return "light";
}

function renderClassCalendar() {
  const container = document.getElementById("class-calendar");
  if (!container) return;

  if (reportData.length === 0) {
    container.innerHTML = "<p>No activity</p>";
    return;
  }

  const dateMap = buildClassDateMap(reportData);

  let html = "";

  Object.keys(dateMap).slice(-30).forEach(dateKey => {
    const total = Object.values(dateMap[dateKey])
      .reduce((sum, arr) => sum + arr.length, 0);

    const intensity = getIntensity(total);

    html += `
      <div class="calendar-day ${intensity}">
        <div>${dateKey}</div>
        <div>${total}</div>
      </div>
    `;
  });

  container.innerHTML = html;
}

/* ========================================================= */

window.onload = loadData;

</script>

<style>

body {
  background: #0B0B0C;
  color: #F8F7F3;
  font-family: Inter;
  padding: 20px;
}

#loader {
  display: none;
  color: #D4AF37;
  margin-bottom: 10px;
}

#error {
  color: red;
  margin-bottom: 10px;
}

.leaderboard-row {
  display: grid;
  grid-template-columns: 40px 1fr auto;
  padding: 10px;
  border-bottom: 1px solid rgba(212,175,55,0.2);
}

.calendar-day {
  padding: 10px;
  margin: 6px 0;
  border-radius: 8px;
}

.light { background: rgba(212,175,55,0.18); }
.medium { background: rgba(212,175,55,0.28); }
.heavy { background: rgba(212,175,55,0.38); }
.peak { background: rgba(212,175,55,0.6); }

</style>
</head>

<body>

<div id="loader">Loading...</div>
<div id="error"></div>

<h2>Leaderboard</h2>
<div id="leaderboard"></div>

<h3>üìÖ Class Activity Calendar</h3>
<div id="class-calendar"></div>

</body>
</html>
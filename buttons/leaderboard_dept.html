<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Class Activity Console</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://ahezssoczvpbkteffcgz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE"
);

let reportData = [];
let currentDepartment = "ALL";

const START_DATE = new Date("2025-08-25");
const CALENDAR_VISIBLE_START = new Date("2026-02-01");

/* ========================================================= */

async function loadData() {
  document.getElementById("loader").style.display = "block";

  const { data, error } = await supabase
    .from("report_card_view")
    .select("*");

  document.getElementById("loader").style.display = "none";

  if (error) {
    document.getElementById("error").textContent = "âš ï¸ Data load failed";
    return;
  }

  reportData = data || [];

  populateDepartmentDropdown();
  renderClassCalendar();
}

/* ========================================================= */

function populateDepartmentDropdown() {
  const select = document.getElementById("departmentSelect");

  const departments = [...new Set(
    reportData.map(s => (s.department || "UNKNOWN").toUpperCase())
  )].sort();

  select.innerHTML = `<option value="ALL">All Departments</option>`;

  departments.forEach(dept => {
    const opt = document.createElement("option");
    opt.value = dept;
    opt.textContent = dept;
    select.appendChild(opt);
  });
}

window.changeDepartment = function(dept) {
  currentDepartment = dept;
  clearBreakdown();
  renderClassCalendar();
};

/* ========================================================= */

function mapToDate(number) {
  const d = new Date(START_DATE);
  d.setDate(d.getDate() + (number - 1));
  return d;
}

function parseItems(rawList) {
  if (!rawList || rawList === "NULL") return [];

  return rawList.split(",")
    .map(i => i.trim())
    .filter(Boolean)
    .map(item => {
      const [type, num] = item.split(" ");
      return { type, number: Number(num) };
    });
}

/* ========================================================= */

function buildClassDateMap() {
  const map = {};

  reportData.forEach(student => {

    if (
      currentDepartment !== "ALL" &&
      (student.department || "UNKNOWN").toUpperCase() !== currentDepartment
    ) return;

    const all = [
      ...parseItems(student.quest_list),
      ...parseItems(student.video_list),
      ...parseItems(student.story_list)
    ];

    all.forEach(item => {
      const date = mapToDate(item.number);
      const key = date.toDateString();

      if (!map[key]) map[key] = [];
      map[key].push(student);
    });
  });

  return map;
}

/* ========================================================= */

function getIntensity(total) {
  if (total > 20) return "peak";
  if (total > 10) return "heavy";
  if (total > 5) return "medium";
  return "light";
}

/* ========================================================= */

function renderClassCalendar() {
  const container = document.getElementById("class-calendar");
  container.innerHTML = "";

  const dateMap = buildClassDateMap();
  window.dateMap = dateMap;

  let cursor = new Date(
    CALENDAR_VISIBLE_START.getFullYear(),
    CALENDAR_VISIBLE_START.getMonth(),
    1
  );

  const today = new Date();
  const end = new Date(today.getFullYear(), today.getMonth(), 1);

  while (cursor <= end) {
    container.innerHTML += renderMonth(cursor, dateMap);
    cursor.setMonth(cursor.getMonth() + 1);
  }
}

function renderMonth(baseDate, dateMap) {
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();

  const firstDay = new Date(year, month, 1).getDay();
  const numDays = new Date(year, month + 1, 0).getDate();

  let html = `
    <div class="month-block">
      <div class="month-title">
        ${baseDate.toLocaleString('en-IN', { month: 'long', year: 'numeric' })}
      </div>

      <div class="calendar-grid">
        <div>Sun</div><div>Mon</div><div>Tue</div>
        <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  `;

  for (let i = 0; i < firstDay; i++) {
    html += `<div class="empty"></div>`;
  }

  for (let d = 1; d <= numDays; d++) {
    const date = new Date(year, month, d);
    const key = date.toDateString();
    const entries = dateMap[key];

    if (entries) {
      const intensity = getIntensity(entries.length);

      html += `
        <div class="day marked ${intensity}" onclick="showDateDetail('${key}')">
          <div class="date-num">${d}</div>
          <div class="count">${entries.length}</div>
        </div>
      `;
    } else {
      html += `<div class="day">${d}</div>`;
    }
  }

  html += "</div></div>";
  return html;
}

/* ========================================================= */
/* âœ… INLINE BREAKDOWN */
/* ========================================================= */

window.showDateDetail = function(dateKey) {
  const entries = window.dateMap[dateKey];
  if (!entries) return;

  const panel = document.getElementById("date-breakdown");

  const deptMap = {};

  entries.forEach(student => {
    const dept = (student.department || "UNKNOWN").toUpperCase();

    if (!deptMap[dept]) deptMap[dept] = [];
    deptMap[dept].push(student.name);
  });

  let html = `
    <div class="breakdown-header">
      ðŸ“… ${dateKey}
    </div>
  `;

  Object.keys(deptMap).sort().forEach(dept => {
    html += `
      <div class="dept-card">
        <div class="dept-card-title">
          ${dept} <span>${deptMap[dept].length}</span>
        </div>
        <div class="student-list">
          ${deptMap[dept].sort().map(n => `<div>${n}</div>`).join("")}
        </div>
      </div>
    `;
  });

  panel.innerHTML = html;
  panel.style.display = "block";
};

function clearBreakdown() {
  const panel = document.getElementById("date-breakdown");
  panel.style.display = "none";
}

/* ========================================================= */

window.onload = loadData;

</script>

<style>

body {
  background: radial-gradient(circle at top, rgba(212,175,55,0.15), transparent 55%), #0B0B0C;
  color: #F8F7F3;
  font-family: Inter;
  padding: 20px;
}

/* HEADER */

.title {
  text-align: center;
  font-size: 26px;
  font-weight: 900;
  letter-spacing: 0.12em;
  color: #D4AF37;
  margin-bottom: 20px;
}

/* FILTER */

select {
  padding: 10px 14px;
  border-radius: 12px;
  background: #111;
  color: #D4AF37;
  border: 1px solid rgba(212,175,55,0.4);
  font-weight: 700;
  margin-bottom: 25px;
}

/* MONTH */

.month-block {
  margin-bottom: 30px;
  padding: 14px;
  border-radius: 16px;
  background: rgba(17,17,19,0.9);
  border: 1px solid rgba(212,175,55,0.25);
}

.month-title {
  text-align: center;
  color: #D4AF37;
  font-weight: 700;
  margin-bottom: 10px;
  letter-spacing: 0.08em;
}

/* GRID */

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  font-size: 12px;
}

.day {
  background: #0F0F10;
  border-radius: 10px;
  padding: 8px;
  min-height: 65px;
  border: 1px solid rgba(212,175,55,0.12);
  position: relative;
  transition: 0.2s;
}

.day:hover {
  transform: translateY(-2px);
}

.day.marked {
  border-color: rgba(212,175,55,0.6);
  cursor: pointer;
}

/* INTENSITY */

.light { background: rgba(212,175,55,0.12); }
.medium { background: rgba(212,175,55,0.22); }
.heavy { background: rgba(212,175,55,0.32); }
.peak {
  background: rgba(212,175,55,0.55);
  box-shadow: 0 0 14px rgba(212,175,55,0.7);
}

.count {
  position: absolute;
  bottom: 6px;
  right: 8px;
  font-size: 18px;
  font-weight: 900;
  color: #D4AF37;
}

/* BREAKDOWN PANEL */

#date-breakdown {
  margin-top: 20px;
  display: none;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.breakdown-header {
  font-size: 16px;
  font-weight: 800;
  color: #D4AF37;
  margin-bottom: 12px;
}

.dept-card {
  background: rgba(17,17,19,0.95);
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid rgba(212,175,55,0.25);
}

.dept-card-title {
  font-weight: 800;
  color: #D4AF37;
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.student-list {
  font-size: 13px;
  opacity: 0.9;
  display: grid;
  gap: 4px;
}

</style>
</head>

<body>

<div class="title">CLASS ACTIVITY CONSOLE</div>

<div id="loader">Loading...</div>
<div id="error"></div>

<select id="departmentSelect" onchange="changeDepartment(this.value)"></select>

<div id="class-calendar"></div>

<div id="date-breakdown"></div>

</body>
</html>
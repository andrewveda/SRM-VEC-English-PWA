<div id="leaderboard"></div>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(
    "https://ahezssoczvpbkteffcgz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE"
  );

  async function loadLeaderboard() {
    const container = document.getElementById("leaderboard");

    // ‚úÖ Instant heuristics carousel while loading
    container.innerHTML = `
    <style>
      @keyframes starfield {
        from {background-position: 0 0, 0 0, 0 0;}
        to {background-position: 10000px 5000px, 8000px 4000px, 6000px 3000px;}
      }
      @keyframes glowText {
        0%,100% { text-shadow: 0 0 10px #0ff, 0 0 20px #00f, 0 0 40px #0ff; }
        50% { text-shadow: 0 0 20px #00f, 0 0 40px #0ff, 0 0 80px #00f; }
      }
      @keyframes fadeQuote {
        0% { opacity: 0; transform: scale(0.95);}
        10%,90% { opacity: 1; transform: scale(1);}
        100% { opacity: 0; transform: scale(1.05);}
      }
      #quoteCarousel {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: #0ff;
        font-family: 'Segoe UI', 'Orbitron', sans-serif;
        background:
          radial-gradient(circle at 50% 50%, rgba(10,10,25,0.9), #000 80%),
          url('https://www.transparenttextures.com/patterns/stardust.png'),
          radial-gradient(circle at 20% 80%, #001133, #000);
        background-size: cover, 1000px 1000px, cover;
        background-blend-mode: screen;
        animation: starfield 200s linear infinite;
        overflow: hidden;
        transition: opacity 1s ease;
        padding: 30px;
      }
      #quoteText {
        font-size: 1.5em;
        line-height: 1.6;
        max-width: 90%;
        animation: glowText 3s ease-in-out infinite;
        letter-spacing: 1px;
        text-shadow: 0 0 10px #00ffff;
        border-left: 2px solid #0ff;
        border-right: 2px solid #0ff;
        padding: 10px 20px;
        backdrop-filter: blur(6px);
        background: rgba(0,20,40,0.2);
        border-radius: 10px;
      }
      #quoteText.fade { animation: fadeQuote 2s ease-in-out; }
      @media (max-width: 600px) { #quoteText { font-size: 1.1em; } }
    </style>
    <div id="quoteCarousel">
      <div id="quoteText" class="fade">
        "Heuristics are mental shortcuts for making instant judgments. Leaderboard loading."
      </div>
    </div>`;

    // üîÅ Quote rotation while loading
    const quotes = [
      `Appearance is a heuristic. Leaderboard loading..`,
      `Heuristics shape perception. Leaderboard loading...`,
      `The observer's perception becomes their reality. Leaderboard loading.`,
      `Appearance is everything! Leaderboard loading..`
    ];
    let q = 0;
    setInterval(() => {
      const el = document.getElementById("quoteText");
      if (!el) return;
      el.classList.remove("fade");
      setTimeout(() => {
        q = (q + 1) % quotes.length;
        el.innerText = quotes[q];
        el.classList.add("fade");
      }, 200);
    }, 1200);

    // ‚è≥ Fetch leaderboard data from Supabase
    const { data, error } = await supabase
      .from("leaderboard")
      .select("*");

    if (error) {
      console.error("‚ùå Supabase fetch error:", error);
      container.innerHTML = `<p style="color:white;text-align:center;">Error loading leaderboard.</p>`;
      return;
    }

    // ‚ú® Fade out carousel
    const carousel = document.getElementById("quoteCarousel");
    if (carousel) {
      carousel.style.opacity = "0";
      setTimeout(() => renderLeaderboard(data, container), 1000);
    }
  }

  // üé® Core render function for leaderboard table and stats
  function renderLeaderboard(data, container) {
    const columnDisplayNames = {
      MainQuests: "Videos",
      Wrong: "ELLL"
    };

    let currentSort = "Score";
    let ascending = false;
    let showTimeInHrs = false;
    let showStatsPage = false;

    // üßÆ Class totals
    const classStats = {
      totalQuests: data.reduce((s, p) => s + Number(p.Quests || 0), 0),
      totalCorrect: data.reduce((s, p) => s + Number(p.Correct || 0), 0),
      totalWrong: data.reduce((s, p) => s + Number(p.Wrong || 0), 0),
      totalTime: data.reduce((s, p) => s + Number(p.TotalTime || 0), 0),
      totalScore: data.reduce((s, p) => s + Number(p.Score || 0), 0)
    };

    container.innerHTML = `
      <style>
        @keyframes fadeSlideUp { from { opacity:0; transform: translateY(20px);} to { opacity:1; transform: translateY(0);} }
        body { background: radial-gradient(circle at 20% 20%, #0f2027, #203a43, #2c5364); color:#fff; font-family:'Segoe UI',sans-serif; margin:0;padding:10px; }
        .leaderboard-heading { text-align: center; font-size: 28px; font-weight: bold; margin: 20px 0; line-height: 1.3; letter-spacing: 2px; animation: fadeSlideUp 1s ease; }
        .emoji { display:inline-block; animation: spin 30.3s linear infinite, sparkle 30.5s ease-in-out infinite alternate; }
        @keyframes spin { 0% {transform: rotate(0deg) scale(1);} 50% {transform: rotate(180deg) scale(1.2);} 100% {transform: rotate(360deg) scale(1);} }
        @keyframes sparkle { 0% { text-shadow: 0 0 2px #fff, 0 0 5px #ffd700; } 50% { text-shadow: 0 0 4px #fff, 0 0 10px #ff0; } 100% { text-shadow: 0 0 2px #fff, 0 0 5px #ffd700; } }
        table { width:100%; border-collapse:collapse; background: rgba(20,20,40,0.95); border-radius:15px; }
        th, td { padding:10px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.1); }
        th { background: linear-gradient(135deg,#1e3c72,#2a5298); color:#fff; cursor:pointer; }
        tr:hover { background: linear-gradient(135deg,#6a11cb,#2575fc); color:#fff; }
        tr.rank-1 td { background: gold; color:#000; font-weight:bold; }
        tr.rank-2 td { background: silver; color:#000; font-weight:bold; }
        tr.rank-3 td { background: #cd7f32; color:#fff; font-weight:bold; }
        button { margin:3px; padding:6px 12px; background:linear-gradient(135deg,#1e3c72,#2a5298); border:none; border-radius:8px; color:#fff; cursor:pointer; }
        button:hover { opacity:0.85; }
      </style>

      <div class="leaderboard-heading">
        Mission: Veni, Vidi, Vici! <br>
        <span class="emoji">‚ú®</span><span class="emoji">üöÄ</span> Leaderboard <span class="emoji">üèÜ</span>
      </div>

      <div style="text-align:center;margin-bottom:15px;">
        <button id="pageToggleBtn">Show Class Stats</button>
      </div>
      <div id="sortButtons" style="text-align:center;margin-bottom:15px;"></div>
      <div class="table-container" id="leaderboardTableContainer"></div>
      <div class="table-container" id="classStatsContainer" style="display:none;"></div>
    `;

    const sortOptions = ["Score","Correct","Wrong","TotalTime","Quests","MainQuests"];
    const sortButtons = document.getElementById("sortButtons");
    sortOptions.forEach(col => {
      const btn = document.createElement("button");
      btn.innerText = `Sort by ${columnDisplayNames[col] || col}`;
      btn.addEventListener("click", () => {
        if (currentSort === col) ascending = !ascending;
        else { currentSort = col; ascending = false; }
        renderTable();
      });
      sortButtons.appendChild(btn);
    });

    function renderTable() {
      const sorted = [...data].sort((a,b) => {
        const A = Number(a[currentSort]) || 0;
        const B = Number(b[currentSort]) || 0;
        return ascending ? A - B : B - A;
      });
      sorted.forEach((p,i) => p.Rank = i+1);
      let html = `<table><thead><tr><th>Rank</th><th>Name</th><th>${columnDisplayNames[currentSort] || currentSort}</th></tr></thead><tbody>`;
      sorted.forEach(p => {
        const rank = p.Rank === 1 ? "ü•á" : p.Rank === 2 ? "ü•à" : p.Rank === 3 ? "ü•â" : p.Rank;
        html += `<tr class="rank-${p.Rank}"><td>${rank}</td><td>${p.Name}</td><td>${p[currentSort]}</td></tr>`;
      });
      html += "</tbody></table>";
      document.getElementById("leaderboardTableContainer").innerHTML = html;
    }

    function renderStats() {
      document.getElementById("classStatsContainer").innerHTML = `
        <div style="text-align:center;">
          <p>Total Quests: ${classStats.totalQuests}</p>
          <p>Total Correct: ${classStats.totalCorrect}</p>
          <p>Total Wrong: ${classStats.totalWrong}</p>
          <p>Total Time: ${classStats.totalTime}s</p>
          <p>Total Score: ${classStats.totalScore}</p>
        </div>`;
    }

    renderTable();
    renderStats();

    document.getElementById("pageToggleBtn").addEventListener("click", () => {
      showStatsPage = !showStatsPage;
      document.getElementById("leaderboardTableContainer").style.display = showStatsPage ? "none" : "block";
      document.getElementById("sortButtons").style.display = showStatsPage ? "none" : "block";
      document.getElementById("classStatsContainer").style.display = showStatsPage ? "block" : "none";
      document.getElementById("pageToggleBtn").innerText = showStatsPage ? "Show Leaderboard" : "Show Class Stats";
    });
  }

  loadLeaderboard();
</script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission: Veni, Vidi, Vici! ‚Äî Command Deck Leaderboard</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://yellow-lab-4999.andrewveda.workers.dev",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE"
    );

    let filteredData = [];
    let currentDepartment = "ALL";
    let reportData = [];
    let currentSort = "last_test_taken";
    let sortAscending = false;
    let lastTestInfo = { name: "", date: "" };
    let showSecondsOnly = false;

    // ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const START_DATE = new Date("2025-08-25");
    const CALENDAR_VISIBLE_START = new Date("2026-02-01");

    // ‚îÄ‚îÄ LOAD DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadData() {
      const loader = document.getElementById("loader");
      loader.style.display = "flex";

      const { data, error } = await supabase
        .from("report_card_view")
        .select("*");

      console.log("RAW ROW SAMPLE:", data?.[0]);
      console.log("COLUMNS:", Object.keys(data?.[0] || {}));

      loader.style.display = "none";

      if (error) {
        console.error(error);
        document.getElementById("error").textContent =
          "‚ö†Ô∏è Telemetry link lost: unable to load data.";
        return;
      }

      reportData = data || [];
      filteredData = [...reportData];

      filteredData.sort(
        (a, b) => new Date(b.last_test_taken || 0) - new Date(a.last_test_taken || 0)
      );

      populateDepartmentDropdown(reportData);

      if (reportData.length > 0) {
        const sorted = [...reportData].sort(
          (a, b) => new Date(b.last_test_taken) - new Date(a.last_test_taken)
        );
        lastTestInfo = {
          name: sorted[0].name,
          date: formatDate(sorted[0].last_test_taken)
        };
        document.getElementById("last-test-info").textContent =
          `‚è± ‚ú®${lastTestInfo.name} at ${lastTestInfo.date}`;
      } else {
        document.getElementById("last-test-info").textContent =
          "Awaiting first mission log...";
      }

      const savedDept = localStorage.getItem("leaderboard_department");
      if (savedDept) {
        const sel = document.getElementById("departmentSelect");
        if (sel) {
          sel.value = savedDept;
          applyDepartmentFilter(savedDept);
          return;
        }
      }

      sortData(currentSort);
      renderAnalyticsPanel();
    }

    // ‚îÄ‚îÄ FORMAT HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function formatDate(dateStr) {
      if (!dateStr) return "N/A";
      const date = new Date(dateStr);
      return date.toLocaleString('en-IN', {
        timeZone: 'Asia/Kolkata',
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    }

    function formatSecondsOnly(seconds) {
      if (!seconds) return "0s";
      return `${Math.round(seconds)}s`;
    }

    function formatTime(seconds) {
      if (!seconds && seconds !== 0) return `
        <span class="time-block"><span class="time-num">0</span><span class="time-unit h">h</span></span>
        <span class="time-block"><span class="time-num">0</span><span class="time-unit m">m</span></span>
        <span class="time-block"><span class="time-num">0</span><span class="time-unit s">s</span></span>
      `;
      seconds = Math.round(seconds);
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `
        <span class="time-block"><span class="time-num">${h}</span><span class="time-unit h">h</span></span>
        <span class="time-block"><span class="time-num">${m}</span><span class="time-unit m">m</span></span>
        <span class="time-block"><span class="time-num">${s}</span><span class="time-unit s">s</span></span>
      `;
    }

    // ‚îÄ‚îÄ DEPARTMENT FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function populateDepartmentDropdown(data) {
      const select = document.getElementById("departmentSelect");
      if (!select) return;
      select.innerHTML = `<option value="ALL">All Departments</option>`;
      const departments = [...new Set(
        data.map(s => (s.department || "").trim().toUpperCase()).filter(Boolean)
      )].sort();
      departments.forEach(dept => {
        const opt = document.createElement("option");
        opt.value = dept;
        opt.textContent = dept;
        select.appendChild(opt);
      });
    }

    function applyDepartmentFilter(dept) {
      console.log("‚ñ∂ Dropdown changed to:", dept);
      currentDepartment = dept;
      localStorage.setItem("leaderboard_department", dept);
      if (dept === "ALL") {
        filteredData = [...reportData];
      } else {
        const target = dept.trim().toUpperCase();
        filteredData = reportData.filter(s =>
          (s.department || "").trim().toUpperCase() === target
        );
      }
      sortAscending = false;
      filteredData.sort(
        (a, b) => new Date(b.last_test_taken || 0) - new Date(a.last_test_taken || 0)
      );
      renderLeaderboard();
      renderAnalyticsPanel();
    }

    // ‚îÄ‚îÄ SORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function sortData(key) {
      if (currentSort === key && reportData.length > 0 && document.getElementById("leaderboard").children.length > 1) {
        sortAscending = !sortAscending;
      } else {
        currentSort = key;
        sortAscending = false;
      }
      filteredData.sort((a, b) => {
        let A = a[key];
        let B = b[key];
        if (A === null || A === undefined) A = sortAscending ? Infinity : -Infinity;
        if (B === null || B === undefined) B = sortAscending ? Infinity : -Infinity;
        if (key === 'last_test_taken') {
          A = new Date(a.last_test_taken).getTime();
          B = new Date(b.last_test_taken).getTime();
        }
        return sortAscending ? A - B : B - A;
      });
      updateActiveButton();
      renderLeaderboard();
    }

    function updateActiveButton() {
      document.querySelectorAll(".sort-btn").forEach(btn => {
        btn.classList.remove("active");
        const indicator = btn.querySelector('.sort-indicator');
        if (indicator) indicator.textContent = "";
      });
      const toggle = document.getElementById("time-toggle");
      if (toggle) toggle.style.display = (currentSort === "total_time") ? "inline-flex" : "none";
      const activeButton = document.querySelector(`[data-sort="${currentSort}"]`);
      if (activeButton) {
        activeButton.classList.add("active");
        let indicator = activeButton.querySelector('.sort-indicator');
        if (!indicator) {
          indicator = document.createElement('span');
          indicator.className = 'sort-indicator';
          activeButton.appendChild(indicator);
        }
        indicator.textContent = sortAscending ? "‚ñ≤" : "‚ñº";
      }
    }

    // ‚îÄ‚îÄ RENDER LEADERBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderLeaderboard() {
      const container = document.getElementById("leaderboard");
      container.innerHTML = "";
      filteredData.forEach((s, idx) => {
        const row = document.createElement("div");
        row.className = "leaderboard-row";
        const rank = idx + 1;
        if (idx === 0) row.classList.add("gold");
        else if (idx === 1) row.classList.add("silver");
        else if (idx === 2) row.classList.add("bronze");

        let value = s[currentSort];
        if (value === null || value === undefined) {
          value = (currentSort === "last_test_taken") ? null : 0;
        }

        const displayValue =
          currentSort === "accuracy"
            ? `${Math.round((value || 0) * 100)}%` :
          currentSort === "total_time"
            ? (showSecondsOnly ? formatSecondsOnly(value) : formatTime(value)) :
          currentSort === "last_test_taken"
            ? formatDate(value) :
          value;

        if (currentSort === "last_test_taken") {
          row.innerHTML = `
            <div class="rank">${idx < 3 ? getMedalEmoji(idx) : rank}</div>
            <div class="name name-two-line">
              <div class="full-name">${s.name}</div>
              <div class="last-test-small time-colored">${formatDate(s.last_test_taken)}</div>
            </div>
            <div class="score"></div>
          `;
        } else if (currentSort === "total_time") {
          if (showSecondsOnly) {
            row.innerHTML = `
              <div class="rank">${idx < 3 ? getMedalEmoji(idx) : rank}</div>
              <div class="name name-two-line"><div class="full-name">${s.name}</div></div>
              <div class="score score-seconds">${formatSecondsOnly(s.total_time)}</div>
            `;
          } else {
            const totalSeconds = s.total_time ?? 0;
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2, "0");
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, "0");
            const s_val = (totalSeconds % 60).toString().padStart(2, "0");
            row.innerHTML = `
              <div class="rank">${idx < 3 ? getMedalEmoji(idx) : rank}</div>
              <div class="name name-two-line"><div class="full-name">${s.name}</div></div>
              <div class="score name-two-line aligned-time">
                <div class="time-row">
                  <span class="t-block"><span class="t-num">${h}</span><span class="t-unit h">h</span></span>
                  <span class="t-block"><span class="t-num">${m}</span><span class="t-unit m">m</span></span>
                  <span class="t-block"><span class="t-num">${s_val}</span><span class="t-unit s">s</span></span>
                </div>
              </div>
            `;
          }
        } else {
          row.innerHTML = `
            <div class="rank">${idx < 3 ? getMedalEmoji(idx) : rank}</div>
            <div class="name">
              <div class="cadet-name">
                ${s.name}
                <span class="dept-inline">${s.department ? `¬∑ ${s.department}` : ""}</span>
              </div>
              <div class="metric-tag">
                ${currentSort === "accuracy" ? "TARGET LOCK" :
                  currentSort === "quests_completed" ? "QUESTS" :
                  currentSort === "videos_completed" ? "VIDEOS" :
                  currentSort === "stories_completed" ? "STORIES" : ""}
              </div>
            </div>
            <div class="score">${displayValue}</div>
          `;
        }
        row.onclick = () => showDetail(s);
        container.appendChild(row);
      });
    }

    function getMedalEmoji(idx) {
      return idx === 0 ? "üöÄ" : idx === 1 ? "üõ∞Ô∏è" : "üåå";
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ANALYTICS ENGINE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚îÄ‚îÄ Tier classification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Elite:      accuracy ‚â• 80% AND activity in last 3 days
    // Active:     activity in last 7 days  (but not Elite)
    // Developing: activity in last 14 days (but not Active)
    // At-Risk:    no activity for 14+ days OR never active
    function getTier(s) {
      const acc       = (s.accuracy ?? 0);
      const daysSince = getDaysSince(s.last_test_taken);
      if (acc >= 0.80 && daysSince <= 3)  return { label: "Elite",      icon: "‚ö°", color: "#F5E6A8", bg: "rgba(212,175,55,0.25)",  border: "rgba(212,175,55,0.8)" };
      if (daysSince <= 7)                  return { label: "Active",     icon: "üü¢", color: "#4ADE80", bg: "rgba(74,222,128,0.15)",  border: "rgba(74,222,128,0.7)"  };
      if (daysSince <= 14)                 return { label: "Developing", icon: "üîµ", color: "#38BDF8", bg: "rgba(56,189,248,0.15)",  border: "rgba(56,189,248,0.6)"  };
      return                                        { label: "At-Risk",  icon: "üî¥", color: "#F87171", bg: "rgba(248,113,113,0.15)", border: "rgba(248,113,113,0.6)" };
    }

    function getDaysSince(dateStr) {
      if (!dateStr) return 9999;
      const diff = Date.now() - new Date(dateStr).getTime();
      return Math.floor(diff / 86400000);
    }

    // ‚îÄ‚îÄ Streak calculation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // A "streak day" = any calendar day (IST) with at least one quest/video/story
    function calcStreak(s) {
      const quests  = parseItems(s.quest_list);
      const videos  = parseItems(s.video_list);
      const stories = parseItems(s.story_list);
      const grouped = groupByDate(quests, videos, stories);
      const activeDays = new Set(Object.keys(grouped)); // "Mon Jan 01 2026" strings

      if (activeDays.size === 0) return { current: 0, longest: 0 };

      // Walk backwards from today counting consecutive active days
      let current = 0;
      const todayIST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
      let cursor = new Date(todayIST.getFullYear(), todayIST.getMonth(), todayIST.getDate());

      // Allow a 1-day grace: if today has no activity, still start from yesterday
      if (!activeDays.has(cursor.toDateString())) {
        cursor.setDate(cursor.getDate() - 1);
      }

      while (activeDays.has(cursor.toDateString())) {
        current++;
        cursor.setDate(cursor.getDate() - 1);
      }

      // Longest streak ‚Äî scan all active days
      const sorted = [...activeDays]
        .map(d => new Date(d).getTime())
        .sort((a, b) => a - b);

      let longest = 1, run = 1;
      for (let i = 1; i < sorted.length; i++) {
        const gap = (sorted[i] - sorted[i-1]) / 86400000;
        if (gap === 1) { run++; longest = Math.max(longest, run); }
        else run = 1;
      }

      return { current, longest };
    }

    // ‚îÄ‚îÄ Rank within all students (by total_score desc) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getRank(s) {
      const sorted = [...reportData].sort((a, b) => (b.total_score || 0) - (a.total_score || 0));
      const pos    = sorted.findIndex(r => r.name === s.name) + 1;
      const total  = reportData.length;
      const pct    = total > 0 ? Math.round((pos / total) * 100) : 100;
      return { pos, total, pct };
    }

    // ‚îÄ‚îÄ Rank within student's own department ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getDeptRank(s) {
      const dept   = (s.department || "").trim().toUpperCase();
      const deptList = reportData
        .filter(r => (r.department || "").trim().toUpperCase() === dept)
        .sort((a, b) => (b.total_score || 0) - (a.total_score || 0));
      const pos   = deptList.findIndex(r => r.name === s.name) + 1;
      const total = deptList.length;
      return { pos, total };
    }

    // ‚îÄ‚îÄ Department comparison table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getDeptStats() {
      const depts = {};
      reportData.forEach(s => {
        const key = (s.department || "Unknown").trim().toUpperCase();
        if (!depts[key]) depts[key] = { name: key, students: [], totalAcc: 0, totalActivity: 0, atRisk: 0 };
        depts[key].students.push(s);
        depts[key].totalAcc += (s.accuracy || 0);
        const tier = getTier(s);
        if (tier.label === "At-Risk") depts[key].atRisk++;
      });
      return Object.values(depts).map(d => ({
        name:     d.name,
        count:    d.students.length,
        avgAcc:   Math.round((d.totalAcc / d.students.length) * 100),
        atRisk:   d.atRisk,
        tier:     getTier(d.students.sort((a,b) => (b.total_score||0) - (a.total_score||0))[0])
      })).sort((a, b) => b.avgAcc - a.avgAcc);
    }

    // ‚îÄ‚îÄ Render the analytics panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderAnalyticsPanel() {
      const panel = document.getElementById("analytics-panel");
      if (!panel || reportData.length === 0) return;

      // ‚îÄ‚îÄ Tier counts ‚îÄ‚îÄ
      const tiers = { Elite: 0, Active: 0, Developing: 0, "At-Risk": 0 };
      reportData.forEach(s => tiers[getTier(s).label]++);

      // ‚îÄ‚îÄ At-risk list (inactive 14+ days), sorted by days since ‚îÄ‚îÄ
      const atRiskList = reportData
        .filter(s => getTier(s).label === "At-Risk")
        .map(s => ({ ...s, daysSince: getDaysSince(s.last_test_taken) }))
        .sort((a, b) => b.daysSince - a.daysSince)
        .slice(0, 12); // cap at 12

      // ‚îÄ‚îÄ Department stats ‚îÄ‚îÄ
      const deptStats = getDeptStats();

      const tierColors = {
        "Elite":      { color: "#F5E6A8", bg: "rgba(212,175,55,0.2)",  border: "rgba(212,175,55,0.7)", icon: "‚ö°" },
        "Active":     { color: "#4ADE80", bg: "rgba(74,222,128,0.15)", border: "rgba(74,222,128,0.6)", icon: "üü¢" },
        "Developing": { color: "#38BDF8", bg: "rgba(56,189,248,0.15)", border: "rgba(56,189,248,0.5)", icon: "üîµ" },
        "At-Risk":    { color: "#F87171", bg: "rgba(248,113,113,0.12)",border: "rgba(248,113,113,0.5)", icon: "üî¥" }
      };

      panel.innerHTML = `
        <!-- ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ -->
        <div class="ap-header">
          <div class="ap-title">Intelligence Report</div>
          <div class="ap-sub">Auto-computed from live data ¬∑ Updated on load</div>
        </div>

        <!-- ‚îÄ‚îÄ TIER DISTRIBUTION ‚îÄ‚îÄ -->
        <div class="ap-section">
          <div class="ap-section-label">‚ñ∏ Pilot Tier Distribution</div>
          <div class="ap-tier-row">
            ${Object.entries(tiers).map(([label, count]) => {
              const tc = tierColors[label];
              const pct = reportData.length ? Math.round((count / reportData.length) * 100) : 0;
              return `
                <div class="ap-tier-card" style="border-color:${tc.border};background:${tc.bg};">
                  <div class="ap-tier-icon">${tc.icon}</div>
                  <div class="ap-tier-count" style="color:${tc.color};">${count}</div>
                  <div class="ap-tier-label" style="color:${tc.color};">${label}</div>
                  <div class="ap-tier-pct">${pct}%</div>
                </div>`;
            }).join("")}
          </div>
        </div>

        <!-- ‚îÄ‚îÄ DEPARTMENT COMPARISON ‚îÄ‚îÄ -->
        <div class="ap-section">
          <div class="ap-section-label">‚ñ∏ Department Intel</div>
          <div class="ap-dept-table">
            <div class="ap-dept-head">
              <span>Department</span>
              <span>Pilots</span>
              <span>Avg Accuracy</span>
              <span>At-Risk</span>
            </div>
            ${deptStats.map((d, i) => `
              <div class="ap-dept-row ${i === 0 ? "ap-dept-top" : ""}">
                <span class="ap-dept-name">${d.name}</span>
                <span class="ap-dept-val">${d.count}</span>
                <span class="ap-dept-val">
                  <span class="ap-acc-bar-wrap">
                    <span class="ap-acc-bar-fill" style="width:${d.avgAcc}%;"></span>
                  </span>
                  <span class="ap-acc-num">${d.avgAcc}%</span>
                </span>
                <span class="ap-dept-val ${d.atRisk > 0 ? "ap-at-risk-num" : ""}">${d.atRisk > 0 ? "‚ö† " + d.atRisk : "‚Äî"}</span>
              </div>`).join("")}
          </div>
        </div>

        <!-- ‚îÄ‚îÄ AT-RISK PILOTS ‚îÄ‚îÄ -->
        <div class="ap-section">
          <div class="ap-section-label">‚ñ∏ At-Risk Pilots
            <span class="ap-section-sub">No activity for 14+ days</span>
          </div>
          ${atRiskList.length === 0
            ? `<div class="ap-empty">‚úÖ No at-risk pilots ‚Äî all hands active!</div>`
            : `<div class="ap-risk-grid">
                ${atRiskList.map(s => `
                  <div class="ap-risk-card" onclick="showDetail(reportData.find(r=>r.name==='${s.name.replace(/'/g,"\\'")}'))">
                    <div class="ap-risk-name">${s.name}</div>
                    <div class="ap-risk-dept">${s.department || "‚Äî"}</div>
                    <div class="ap-risk-days">
                      ${s.daysSince === 9999 ? "Never active" : s.daysSince + "d ago"}
                    </div>
                  </div>`).join("")}
              </div>`}
        </div>
      `;
    }

    // ‚îÄ‚îÄ CALENDAR HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function mapToDate(number) {
      const d = new Date(START_DATE);
      d.setDate(d.getDate() + (number - 1));
      return d;
    }

    function parseItems(rawList) {
      if (!rawList || rawList === "NULL") return [];
      return rawList
        .split(",")
        .map(item => item.trim())
        .filter(item => item.length > 0)
        .map(item => {
          const [type, num] = item.split(" ");
          return { type, number: Number(num), label: item };
        });
    }

    function iconFor(label) {
      if (label.startsWith("Quest")) return "‚ô•Ô∏è";
      if (label.startsWith("Video")) return "üòç";
      if (label.startsWith("Story")) return "üìú";
      return "‚Ä¢";
    }

    function groupByDate(quests, videos, stories) {
      const map = {};
      const add = (date, label) => {
        const key = date.toDateString();
        if (!map[key]) map[key] = [];
        map[key].push(label);
      };
      quests.forEach(q => add(mapToDate(q.number), q.label));
      videos.forEach(v => add(mapToDate(v.number), v.label));
      stories.forEach(s => add(mapToDate(s.number), s.label));
      return map;
    }

    function renderOneMonth(baseDate, grouped) {
      const year = baseDate.getFullYear();
      const month = baseDate.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const numDays = new Date(year, month + 1, 0).getDate();

      let html = `
        <div class="mini-cal-title">
          ${baseDate.toLocaleString('en-IN', { month: 'long', year: 'numeric' })}
        </div>
        <div class="mini-cal-grid">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
          <div>Thu</div><div>Fri</div><div>Sat</div>
      `;
      for (let i = 0; i < firstDay; i++) html += `<div class="mini-cal-empty"></div>`;
      for (let d = 1; d <= numDays; d++) {
        const date = new Date(year, month, d);
        const key = date.toDateString();
        const items = grouped[key];
        if (items) {
          html += `
            <div class="mini-cal-day marked">
              <div class="mini-cal-date">${d}</div>
              <div class="mini-cal-items">${items.map(i => `<div>${iconFor(i)}</div>`).join("")}</div>
            </div>
          `;
        } else {
          html += `<div class="mini-cal-day">${d}</div>`;
        }
      }
      html += "</div>";
      return html;
    }

    function renderMiniCalendar(containerId, grouped) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      let cursor = new Date(CALENDAR_VISIBLE_START.getFullYear(), CALENDAR_VISIBLE_START.getMonth(), 1);
      const today = new Date();
      const end = new Date(today.getFullYear(), today.getMonth(), 1);
      while (cursor <= end) {
        container.innerHTML += renderOneMonth(cursor, grouped);
        cursor.setMonth(cursor.getMonth() + 1);
      }
    }

    // ‚îÄ‚îÄ DETAIL MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showDetail(s) {
      const modal   = document.getElementById("modal");
      const content = document.getElementById("modal-content");

      const tier      = getTier(s);
      const rank      = getRank(s);
      const deptRank  = getDeptRank(s);
      const streak    = calcStreak(s);
      const daysSince = getDaysSince(s.last_test_taken);
      const topPct    = rank.pct <= 10 ? "üèÖ Top 10%" : rank.pct <= 25 ? "Top 25%" : rank.pct <= 50 ? "Top 50%" : "";

      content.innerHTML = `
        <div class="modal-header">
          <div class="modal-id-tag">Pilot Profile</div>
          <h2>${s.name}</h2>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>

        <!-- Dept + Tier badge row -->
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;
                    margin-top:-6px;margin-bottom:14px;flex-wrap:wrap;">
          <div style="font-size:11px;color:rgba(212,175,55,0.7);text-transform:uppercase;
                      letter-spacing:.12em;">${s.department || 'N/A'}</div>
          <div style="display:inline-flex;align-items:center;gap:5px;padding:3px 10px;
                      border-radius:999px;font-size:11px;font-weight:700;
                      background:${tier.bg};border:1px solid ${tier.border};color:${tier.color};">
            ${tier.icon} ${tier.label}
          </div>
          ${topPct ? `<div style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;
                      border-radius:999px;font-size:11px;font-weight:700;
                      background:rgba(212,175,55,0.12);border:1px solid rgba(212,175,55,0.4);
                      color:rgba(212,175,55,0.9);">${topPct}</div>` : ""}
        </div>

        <!-- Rank + Streak mini-cards -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;">
          <div class="stat-box" style="text-align:center;">
            <div class="stat-label">Class Rank</div>
            <div class="stat-value">#${rank.pos}</div>
            <div class="stat-foot">of ${rank.total}</div>
          </div>
          <div class="stat-box" style="text-align:center;">
            <div class="stat-label">Dept Rank</div>
            <div class="stat-value">#${deptRank.pos}</div>
            <div class="stat-foot">of ${deptRank.total}</div>
          </div>
          <div class="stat-box" style="text-align:center;">
            <div class="stat-label">üî• Streak</div>
            <div class="stat-value" style="color:${streak.current > 0 ? '#F97316' : 'rgba(212,175,55,0.5)'};">${streak.current}d</div>
            <div class="stat-foot">Current</div>
          </div>
          <div class="stat-box" style="text-align:center;">
            <div class="stat-label">Best Streak</div>
            <div class="stat-value">${streak.longest}d</div>
            <div class="stat-foot">All-time</div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">Total Score</div>
            <div class="stat-value">${s.total_score ?? 0}</div>
            <div class="stat-foot">Mission Points</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Accuracy</div>
            <div class="stat-value">${Math.round((s.accuracy ?? 0) * 100)}%</div>
            <div class="stat-foot">Hit Rate</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Quests</div>
            <div class="stat-value">${s.total_attempts ?? 0}</div>
            <div class="stat-foot">Quests conquered</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Correct</div>
            <div class="stat-value">${s.total_correct ?? 0}</div>
            <div class="stat-foot">Direct Hits</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Wrong</div>
            <div class="stat-value">${s.total_wrong ?? 0}</div>
            <div class="stat-foot">Near Misses</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Time on Mission</div>
            <div class="stat-value time-stat">${formatTime(s.total_time)}</div>
            <div class="stat-foot">Cumulative</div>
          </div>
        </div>

        <div class="detail-box">
          <h3>üì° Mission Activity Grid</h3>
          <p class="detail-caption">Gold sectors = active days. Quests ‚ô•Ô∏è ¬∑ Videos üòç ¬∑ Stories üìú</p>
          <div id="mini-calendar" class="mission-calendar"></div>
        </div>

        <div class="detail-box">
          <h3>üïê Last Mission Timestamp</h3>
          <p>${formatDate(s.last_test_taken)}
            <span style="margin-left:8px;font-size:10px;opacity:.6;">
              (${daysSince === 9999 ? "never" : daysSince + "d ago"})
            </span>
          </p>
        </div>
      `;

      const quests  = parseItems(s.quest_list);
      const videos  = parseItems(s.video_list);
      const stories = parseItems(s.story_list);
      const grouped = groupByDate(quests, videos, stories);
      renderMiniCalendar("mini-calendar", grouped);

      // ‚îÄ‚îÄ PDF download button ‚îÄ‚îÄ
      const pdfBtn = document.createElement("button");
      pdfBtn.innerHTML = "üìÑ Download Mission Report";
      pdfBtn.style.cssText = `
        width:100%; padding:12px; margin-top:14px;
        font-weight:800; font-size:13px; letter-spacing:0.12em;
        text-transform:uppercase; cursor:pointer; border-radius:10px;
        background:linear-gradient(135deg,#D4AF37,#B8962E);
        color:#0B0B0C; border:1px solid #F5E6A8;
        box-shadow:0 0 16px rgba(212,175,55,0.5);
        transition:transform 0.12s ease, box-shadow 0.12s ease;
      `;
      pdfBtn.onmouseover = () => { pdfBtn.style.transform = "translateY(-1px)"; pdfBtn.style.boxShadow = "0 0 24px rgba(212,175,55,0.7)"; };
      pdfBtn.onmouseout  = () => { pdfBtn.style.transform = ""; pdfBtn.style.boxShadow = "0 0 16px rgba(212,175,55,0.5)"; };
      pdfBtn.onclick = () => downloadProfilePDF(s);
      document.getElementById("modal-content").appendChild(pdfBtn);

      modal.style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    // ‚îÄ‚îÄ CLASS STATS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showClassStats() {
      if (reportData.length === 0) return;
      const totalStudents = reportData.length;
      const avgScore = Math.round(reportData.reduce((sum, s) => sum + (s.total_score || 0), 0) / totalStudents);
      const avgAccuracy = Math.round((reportData.reduce((sum, s) => sum + (s.accuracy || 0), 0) / totalStudents) * 100);
      const totalAttempts = reportData.reduce((sum, s) => sum + (s.total_attempts || 0), 0);
      const totalTime = reportData.reduce((sum, s) => sum + (s.total_time || 0), 0);
      const totalVideos = reportData.reduce((sum, s) => sum + (s.videos_completed || 0), 0);
      const totalStories = reportData.reduce((sum, s) => sum + (s.stories_completed || 0), 0);
      const totalQuests = reportData.reduce((sum, s) => sum + (s.quests_completed || 0), 0);

      const modal = document.getElementById("modal");
      const content = document.getElementById("modal-content");
      content.innerHTML = `
        <div class="modal-header">
          <div class="modal-id-tag">Class Stats</div>
          <h2>Squad Overview</h2>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">Avg Score</div>
            <div class="stat-value">${avgScore}</div>
            <div class="stat-foot">Per Pilot</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Avg Accuracy</div>
            <div class="stat-value">${avgAccuracy}%</div>
            <div class="stat-foot">Hit Rate</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Total Attempts</div>
            <div class="stat-value">${totalAttempts}</div>
            <div class="stat-foot">Shots Fired</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Total Time</div>
            <div class="stat-value time-stat">${formatTime(totalTime)}</div>
            <div class="stat-foot">Cumulative</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Videos</div>
            <div class="stat-value">${totalVideos}</div>
            <div class="stat-foot">Completed</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Stories</div>
            <div class="stat-value">${totalStories}</div>
            <div class="stat-foot">Completed</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Quests</div>
            <div class="stat-value">${totalQuests}</div>
            <div class="stat-foot">Completed</div>
          </div>
        </div>
      `;
      modal.style.display = "flex";
    }

    // ‚îÄ‚îÄ GLOBAL BINDINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.sortData = sortData;
    window.closeModal = closeModal;
    window.showClassStats = showClassStats;
    window.applyDepartmentFilter = applyDepartmentFilter;
    window.showDetail = showDetail;
    window.onload = loadData;
    // expose reportData for inline onclick in analytics panel
    Object.defineProperty(window, 'reportData', { get: () => reportData });

    window.toggleTimeFormat = function () {
      showSecondsOnly = !showSecondsOnly;
      const btn = document.getElementById("time-toggle");
      btn.textContent = showSecondsOnly ? "Show h:m:s" : "Show Seconds";
      renderLeaderboard();
    };

    window.onclick = function (event) {
      const modal = document.getElementById("modal");
      if (event.target === modal) closeModal();
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PDF GENERATION ‚Äî PREMIUM BLACK & GOLD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Robust script loader ‚Äî returns a Promise that resolves when the script loads
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        // Already loaded?
        if (document.querySelector(`script[src="${src}"]`)) {
          resolve(); return;
        }
        const s = document.createElement("script");
        s.src = src;
        s.onload = resolve;
        s.onerror = () => reject(new Error("Failed to load: " + src));
        document.head.appendChild(s);
      });
    }

    async function downloadProfilePDF(studentObj) {
      // Show a loading indicator on the button
      const btn = document.querySelector("#modal-content button:last-child");
      const origText = btn ? btn.innerHTML : "";
      if (btn) { btn.innerHTML = "‚è≥ Generating PDF..."; btn.disabled = true; }

      try {
        // Ensure libraries are loaded before proceeding
        await loadScript("https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js");
        await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
      } catch (e) {
        alert("Could not load PDF libraries. Check your internet connection.");
        if (btn) { btn.innerHTML = origText; btn.disabled = false; }
        return;
      }

      const { jsPDF } = window.jspdf;

      // ‚îÄ‚îÄ 1. Parse activity lists ‚îÄ‚îÄ
      const quests  = parseItems(studentObj.quest_list);
      const videos  = parseItems(studentObj.video_list);
      const stories = parseItems(studentObj.story_list);

      const questCount  = quests.length;
      const videoCount  = videos.length;
      const storyCount  = stories.length;

      // ‚îÄ‚îÄ 2. Format time ‚îÄ‚îÄ
      const totalSec    = Math.round(studentObj.total_time ?? 0);
      const th          = Math.floor(totalSec / 3600);
      const tm          = Math.floor((totalSec % 3600) / 60);
      const ts          = totalSec % 60;
      const formattedTime = `${th}h ${tm}m ${ts}s`;

      // ‚îÄ‚îÄ 3. Derived stats ‚îÄ‚îÄ
      const accuracy      = Math.round((studentObj.accuracy ?? 0) * 100);
      const totalScore    = studentObj.total_score    ?? 0;
      const totalCorrect  = studentObj.total_correct  ?? 0;
      const totalWrong    = studentObj.total_wrong    ?? 0;
      const totalAttempts = studentObj.total_attempts ?? 0;
      const department    = studentObj.department     ?? "N/A";
      const lastTest      = formatDate(studentObj.last_test_taken);

      // ‚îÄ‚îÄ 3b. Analytics stats ‚îÄ‚îÄ
      const tier      = getTier(studentObj);
      const rank      = getRank(studentObj);
      const deptRank  = getDeptRank(studentObj);
      const streak    = calcStreak(studentObj);
      const daysSince = getDaysSince(studentObj.last_test_taken);
      const topPct    = rank.pct <= 10 ? "üèÖ Top 10%" : rank.pct <= 25 ? "Top 25%" : rank.pct <= 50 ? "Top 50%" : `Top ${rank.pct}%`;

      // ‚îÄ‚îÄ 4. Calendar data ‚îÄ‚îÄ
      const grouped = groupByDate(quests, videos, stories);

      // ‚îÄ‚îÄ 5. Off-screen container ‚îÄ‚îÄ
      // Use top:-99999px (not left:-9999px) to avoid horizontal overflow clipping
      const wrap = document.createElement("div");
      wrap.style.cssText = `
        position:absolute; left:0; top:-99999px;
        width:794px; font-family:'Inter',Arial,sans-serif;
        background:#0B0B0C; color:#F8F7F3;
      `;
      document.body.appendChild(wrap);

      // ‚îÄ‚îÄ Helper: stat card ‚îÄ‚îÄ
      const card = (label, value, sub) => `
        <div style="
          background:linear-gradient(135deg,rgba(212,175,55,0.14),rgba(11,11,12,0.98));
          border:1px solid rgba(212,175,55,0.55);
          border-radius:10px; padding:12px 14px; flex:1; min-width:0;
        ">
          <div style="font-size:9px;letter-spacing:.18em;text-transform:uppercase;
                      color:rgba(212,175,55,0.7);margin-bottom:4px;">${label}</div>
          <div style="font-size:22px;font-weight:900;color:#D4AF37;line-height:1.1;">${value}</div>
          <div style="font-size:9px;color:rgba(248,247,243,0.5);margin-top:4px;">${sub}</div>
        </div>`;

      // ‚îÄ‚îÄ Accuracy progress bar ‚îÄ‚îÄ
      const accBarPx = Math.round(accuracy * 5.3); // 100% ‚âà 530px
      const accBar = `
        <div style="margin-bottom:18px;">
          <div style="display:flex;justify-content:space-between;font-size:10px;
                      letter-spacing:.12em;text-transform:uppercase;
                      color:rgba(212,175,55,0.8);margin-bottom:6px;">
            <span>Accuracy</span><span>${accuracy}%</span>
          </div>
          <div style="height:8px;background:rgba(212,175,55,0.15);border-radius:999px;
                      overflow:hidden;border:1px solid rgba(212,175,55,0.3);">
            <div style="height:100%;width:${accBarPx}px;
                        background:linear-gradient(90deg,#B8962E,#F5E6A8);
                        border-radius:999px;"></div>
          </div>
        </div>`;

      // ‚îÄ‚îÄ Correct vs Wrong split bar ‚îÄ‚îÄ
      const totalQ      = totalCorrect + totalWrong || 1;
      const correctPct  = Math.round((totalCorrect / totalQ) * 100);
      const wrongPct    = 100 - correctPct;
      const splitBar = `
        <div style="margin-bottom:22px;">
          <div style="display:flex;justify-content:space-between;font-size:10px;
                      letter-spacing:.12em;text-transform:uppercase;
                      color:rgba(248,247,243,0.55);margin-bottom:6px;">
            <span style="color:rgba(74,222,128,0.9);">‚úî Correct ${totalCorrect} (${correctPct}%)</span>
            <span style="color:rgba(248,113,113,0.9);">‚úò Wrong ${totalWrong} (${wrongPct}%)</span>
          </div>
          <div style="height:10px;background:rgba(248,113,113,0.35);border-radius:999px;
                      overflow:hidden;display:flex;border:1px solid rgba(248,247,243,0.15);">
            <div style="width:${correctPct}%;background:rgba(74,222,128,0.75);"></div>
          </div>
        </div>`;

      // ‚îÄ‚îÄ PDF calendar renderer ‚îÄ‚îÄ
      function renderCalMonth(baseDate, grouped) {
        const year     = baseDate.getFullYear();
        const month    = baseDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const numDays  = new Date(year, month + 1, 0).getDate();
        const monthLabel = baseDate.toLocaleString("en-IN", { month: "long", year: "numeric" });

        const dayHeaders = ["Su","Mo","Tu","We","Th","Fr","Sa"]
          .map(d => `<div style="font-size:8px;text-align:center;color:rgba(212,175,55,0.7);
                                 font-weight:700;padding-bottom:3px;">${d}</div>`)
          .join("");

        let cells = "";
        for (let i = 0; i < firstDay; i++) cells += `<div></div>`;
        for (let d = 1; d <= numDays; d++) {
          const key    = new Date(year, month, d).toDateString();
          const marked = !!grouped[key];
          cells += `
            <div style="
              background:${marked
                ? "linear-gradient(135deg,rgba(212,175,55,0.28),rgba(11,11,12,0.9))"
                : "rgba(17,17,19,0.9)"};
              border:1px solid ${marked ? "rgba(212,175,55,0.7)" : "rgba(212,175,55,0.18)"};
              border-radius:5px; min-height:26px;
              display:flex;flex-direction:column;align-items:center;
              justify-content:center; padding:2px;
              ${marked ? "box-shadow:0 0 6px rgba(212,175,55,0.35);" : ""}
            ">
              <span style="font-size:8px;font-weight:700;
                           color:${marked ? "#F5E6A8" : "rgba(248,247,243,0.35)"};">${d}</span>
              ${marked ? `<span style="font-size:7px;line-height:1;color:#D4AF37;">‚ú¶</span>` : ""}
            </div>`;
        }

        return `
          <div style="width:47%;margin-bottom:12px;">
            <div style="font-size:9px;font-weight:700;letter-spacing:.16em;text-transform:uppercase;
                        color:rgba(212,175,55,0.85);text-align:center;margin-bottom:6px;
                        border-bottom:1px solid rgba(212,175,55,0.3);padding-bottom:4px;">
              ${monthLabel}
            </div>
            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;">
              ${dayHeaders}${cells}
            </div>
          </div>`;
      }

      // Build calendar HTML
      let calHTML = "";
      let cursor  = new Date(CALENDAR_VISIBLE_START.getFullYear(), CALENDAR_VISIBLE_START.getMonth(), 1);
      const calEnd = new Date(); calEnd.setDate(1);
      while (cursor <= calEnd) {
        calHTML += renderCalMonth(new Date(cursor), grouped);
        cursor.setMonth(cursor.getMonth() + 1);
      }

      // ‚îÄ‚îÄ Full page HTML ‚îÄ‚îÄ
      wrap.innerHTML = `
        <div style="
          width:794px; min-height:1123px; background:#0B0B0C;
          padding:0 0 32px 0; position:relative;
        ">

          <!-- TOP GOLD BAND -->
          <div style="
            background:linear-gradient(90deg,#8B6914,#B8962E,#D4AF37,#F5E6A8,#D4AF37,#B8962E,#8B6914);
            height:6px; width:100%;
          "></div>

          <!-- HEADER -->
          <div style="
            padding:22px 40px 18px;
            border-bottom:1px solid rgba(212,175,55,0.4);
            display:flex; align-items:center; justify-content:space-between;
          ">
            <div>
              <div style="font-size:9px;letter-spacing:.26em;text-transform:uppercase;
                          color:rgba(212,175,55,0.6);margin-bottom:5px;">
                Mission: Veni, Vidi, Vici!
              </div>
              <div style="font-size:19px;font-weight:900;letter-spacing:.05em;text-transform:uppercase;color:#D4AF37;">
                SRM Valliammai Engineering College
              </div>
              <div style="font-size:11px;letter-spacing:.14em;text-transform:uppercase;
                          color:rgba(212,175,55,0.55);margin-top:4px;">
                Department of English
              </div>
            </div>
            <div style="text-align:right;font-size:9px;letter-spacing:.12em;
                        text-transform:uppercase;color:rgba(212,175,55,0.4);line-height:1.8;">
              Pilot Report<br>
              ${new Date().toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"})}
            </div>
          </div>

          <!-- PILOT BANNER -->
          <div style="
            margin:20px 40px 0; padding:16px 22px;
            background:linear-gradient(135deg,rgba(212,175,55,0.18),rgba(11,11,12,0.98));
            border:1px solid rgba(212,175,55,0.6); border-radius:12px;
            border-left:4px solid #D4AF37;
          ">
            <div style="font-size:9px;letter-spacing:.24em;text-transform:uppercase;
                        color:rgba(212,175,55,0.6);margin-bottom:5px;">Pilot Profile</div>
            <div style="font-size:26px;font-weight:900;color:#F8F7F3;letter-spacing:.02em;">
              ${studentObj.name}
            </div>
            <div style="font-size:10px;letter-spacing:.18em;text-transform:uppercase;
                        color:rgba(212,175,55,0.65);margin-top:5px;">
              ${department}
            </div>
          </div>

          <!-- TIER / RANK / STREAK STRIP -->
          <div style="display:flex;gap:10px;margin:12px 40px 0;">
            <!-- Tier badge -->
            <div style="flex:1;padding:10px 14px;border-radius:10px;
                        background:${tier.bg};border:1px solid ${tier.border};text-align:center;">
              <div style="font-size:18px;line-height:1;">${tier.icon}</div>
              <div style="font-size:13px;font-weight:900;color:${tier.color};margin-top:3px;">${tier.label}</div>
              <div style="font-size:8px;letter-spacing:.14em;color:rgba(248,247,243,0.4);margin-top:2px;">TIER</div>
            </div>
            <!-- Class rank -->
            <div style="flex:1;padding:10px 14px;border-radius:10px;text-align:center;
                        background:rgba(17,17,19,0.97);border:1px solid rgba(212,175,55,0.4);">
              <div style="font-size:18px;font-weight:900;color:#D4AF37;">#${rank.pos}</div>
              <div style="font-size:8px;letter-spacing:.14em;color:rgba(248,247,243,0.4);margin-top:2px;">CLASS RANK</div>
              <div style="font-size:9px;color:rgba(212,175,55,0.6);">${topPct}</div>
            </div>
            <!-- Dept rank -->
            <div style="flex:1;padding:10px 14px;border-radius:10px;text-align:center;
                        background:rgba(17,17,19,0.97);border:1px solid rgba(212,175,55,0.4);">
              <div style="font-size:18px;font-weight:900;color:#D4AF37;">#${deptRank.pos}</div>
              <div style="font-size:8px;letter-spacing:.14em;color:rgba(248,247,243,0.4);margin-top:2px;">DEPT RANK</div>
              <div style="font-size:9px;color:rgba(212,175,55,0.6);">of ${deptRank.total}</div>
            </div>
            <!-- Streak -->
            <div style="flex:1;padding:10px 14px;border-radius:10px;text-align:center;
                        background:rgba(17,17,19,0.97);border:1px solid rgba(212,175,55,0.4);">
              <div style="font-size:18px;font-weight:900;color:${streak.current > 0 ? '#F97316' : 'rgba(212,175,55,0.4)'};">${streak.current}d</div>
              <div style="font-size:8px;letter-spacing:.14em;color:rgba(248,247,243,0.4);margin-top:2px;">üî• STREAK</div>
              <div style="font-size:9px;color:rgba(212,175,55,0.6);">Best: ${streak.longest}d</div>
            </div>
          </div>

          <!-- STAT CARDS ROW 1: Score ¬∑ Accuracy ¬∑ Time -->
          <div style="display:flex;gap:12px;margin:16px 40px 0;">
            ${card("Total Score",       totalScore,     "Mission Points")}
            ${card("Accuracy",          accuracy + "%", "Hit Rate")}
            ${card("Time on Mission",   formattedTime,  "Cumulative")}
          </div>

          <!-- STAT CARDS ROW 2: Quests ¬∑ Videos ¬∑ Stories ¬∑ Attempts -->
          <div style="display:flex;gap:12px;margin:10px 40px 0;">
            ${card("Quests",    questCount,   "Completed")}
            ${card("Videos",    videoCount,   "Watched")}
            ${card("Stories",   storyCount,   "Read")}
            ${card("Attempts",  totalAttempts,"Total")}
          </div>

          <!-- PERFORMANCE BREAKDOWN -->
          <div style="
            margin:18px 40px 0; padding:18px 22px;
            background:rgba(17,17,19,0.97);
            border:1px solid rgba(212,175,55,0.4); border-radius:10px;
          ">
            <div style="font-size:9px;letter-spacing:.22em;text-transform:uppercase;
                        color:rgba(212,175,55,0.7);margin-bottom:16px;font-weight:800;">
              Performance Breakdown
            </div>
            ${accBar}
            ${splitBar}
            <div style="display:flex;gap:8px;font-size:9px;letter-spacing:.12em;
                        text-transform:uppercase;color:rgba(248,247,243,0.4);">
              <span>Last Test:</span>
              <span style="color:rgba(212,175,55,0.75);">${lastTest}</span>
            </div>
          </div>

          <!-- ACTIVITY CALENDAR -->
          <div style="
            margin:18px 40px 0; padding:18px 22px 12px;
            background:rgba(11,11,12,0.98);
            border:1px solid rgba(212,175,55,0.4); border-radius:10px;
          ">
            <div style="font-size:9px;letter-spacing:.22em;text-transform:uppercase;
                        color:rgba(212,175,55,0.7);margin-bottom:14px;font-weight:800;">
              üìÖ Mission Activity Grid
              <span style="color:rgba(248,247,243,0.28);font-size:8px;
                           letter-spacing:.1em;margin-left:10px;font-weight:400;">
                ‚ú¶ = active day
              </span>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:14px;justify-content:space-between;">
              ${calHTML}
            </div>
          </div>

          <!-- BOTTOM GOLD BAND -->
          <div style="
            background:linear-gradient(90deg,#8B6914,#B8962E,#D4AF37,#F5E6A8,#D4AF37,#B8962E,#8B6914);
            height:4px; width:100%; margin-top:28px;
          "></div>

        </div>`;

      // ‚îÄ‚îÄ 6. Render ‚Üí canvas ‚Üí multi-page PDF ‚îÄ‚îÄ
      try {
        await new Promise(r => setTimeout(r, 450));

        const canvas = await html2canvas(wrap.firstElementChild, {
          scale: 2,
          backgroundColor: "#0B0B0C",
          useCORS: true,
          logging: false,
          allowTaint: true,
        });

        const imgW      = canvas.width;
        const imgH      = canvas.height;
        const pdf       = new jsPDF("p", "pt", "a4");
        const pageW     = pdf.internal.pageSize.getWidth();
        const pageH     = pdf.internal.pageSize.getHeight();
        const ratio     = pageW / imgW;
        const rendered  = imgH * ratio;

        let yOffset   = 0;
        let remaining = rendered;

        while (remaining > 0) {
          const sliceH   = Math.min(remaining, pageH);
          const srcY     = yOffset / ratio;
          const srcH     = sliceH / ratio;

          const pg       = document.createElement("canvas");
          pg.width       = imgW;
          pg.height      = Math.ceil(srcH);
          pg.getContext("2d").drawImage(canvas, 0, srcY, imgW, srcH, 0, 0, imgW, Math.ceil(srcH));

          if (yOffset > 0) pdf.addPage();
          pdf.addImage(pg.toDataURL("image/png"), "PNG", 0, 0, pageW, sliceH);

          yOffset   += sliceH;
          remaining -= sliceH;
        }

        pdf.save(`${studentObj.name}_MissionReport.pdf`);
      } catch (err) {
        console.error("PDF generation failed:", err);
        alert("PDF generation failed: " + err.message);
      } finally {
        wrap.remove();
        if (btn) { btn.innerHTML = origText; btn.disabled = false; }
      }
    }

  </script>

  <style>
    :root {
      --bg-deep: #0B0B0C;
      --bg-surface: rgba(17,17,19,0.94);
      --bg-surface-strong: rgba(11,11,12,0.98);
      --bg-muted: rgba(24,24,27,0.9);
      --text-primary: #F8F7F3;
      --text-secondary: rgba(212,175,55,0.65);
      --accent-primary: #D4AF37;
      --accent-secondary: #E6C45A;
      --accent-warm: #F5E6A8;
      --gold: #D4AF37;
      --silver: #C7C7C7;
      --bronze: #B87333;
      --danger: #B91C1C;
      --success: #15803D;
      --border-color: rgba(212,175,55,0.4);
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      background:
        radial-gradient(circle at top, rgba(212,175,55,0.18), transparent 55%),
        radial-gradient(circle at bottom, rgba(255,215,0,0.12), transparent 60%),
        #0B0B0C;
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
      padding: 14px 10px 32px;
      overflow-x: hidden;
    }

    body::before {
      content:""; position:fixed; inset:0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, rgba(245,230,168,0.9), transparent),
        radial-gradient(1px 1px at 30% 80%, rgba(212,175,55,0.8), transparent),
        radial-gradient(1px 1px at 50% 40%, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 70% 10%, rgba(212,175,55,0.7), transparent),
        radial-gradient(1px 1px at 90% 60%, rgba(245,230,168,0.85), transparent),
        radial-gradient(1px 1px at 20% 50%, rgba(255,255,255,0.5), transparent),
        radial-gradient(1px 1px at 80% 90%, rgba(212,175,55,0.6), transparent);
      animation: twinkle-small 9s infinite ease-in-out;
      pointer-events:none; z-index:-2;
    }

    body::after {
      content:""; position:fixed; inset:0;
      background-image:
        radial-gradient(2px 2px at 15% 35%, rgba(245,230,168,0.9), transparent),
        radial-gradient(2px 2px at 45% 65%, rgba(212,175,55,0.85), transparent),
        radial-gradient(2px 2px at 75% 25%, rgba(255,255,255,0.7), transparent),
        radial-gradient(2px 2px at 85% 75%, rgba(245,230,168,0.8), transparent);
      animation: twinkle-medium 14s infinite ease-in-out;
      opacity:0.65; pointer-events:none; z-index:-2;
    }

    @keyframes twinkle-small { 0%,100%{opacity:.6} 50%{opacity:1} }
    @keyframes twinkle-medium { 0%,100%{opacity:.4} 50%{opacity:.85} }

    .command-frame {
      max-width:960px; margin:0 auto; border-radius:18px;
      border:1px solid rgba(212,175,55,0.65);
      background:linear-gradient(135deg,rgba(11,11,12,0.96),rgba(17,17,19,0.98));
      box-shadow:
        0 0 0 1px rgba(0,0,0,0.9),
        0 30px 80px rgba(0,0,0,0.95),
        0 0 28px rgba(212,175,55,0.35);
      overflow:hidden; position:relative;
    }

    .command-frame::before {
      content:"SRM VEC ¬∑ ENGLISH COMMAND";
      position:absolute; top:10px; right:18px;
      font-size:9px; letter-spacing:.16em; text-transform:uppercase;
      color:rgba(212,175,55,0.4);
    }

    .command-frame::after {
      content:""; position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 30% 20%, rgba(212,175,55,0.08), transparent 55%),
        radial-gradient(circle at 70% 80%, rgba(245,230,168,0.06), transparent 60%);
      pointer-events:none; z-index:-1;
    }

    /* HEADER */
    .header {
      padding:18px 18px 10px;
      border-bottom:1px solid rgba(212,175,55,0.4);
    }

    .header-top {
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; margin-bottom:10px;
    }

    .title-block { display:flex; flex-direction:column; gap:4px; }

    .mission-title {
      font-size:12px; letter-spacing:.18em; text-transform:uppercase;
      color:rgba(212,175,55,0.65); white-space:nowrap;
    }

    .title {
      font-size:22px; font-weight:900; letter-spacing:.06em; text-transform:uppercase;
      background:linear-gradient(120deg,#F5E6A8,#D4AF37,#B8962E);
      -webkit-background-clip:text; color:transparent; white-space:nowrap;
    }

    .subtitle {
      font-size:11px; color:rgba(212,175,55,0.7); min-height:1.2em;
    }

    .badge-live {
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background:rgba(11,11,12,0.95);
      border:1px solid rgba(212,175,55,0.6);
      box-shadow:0 0 12px rgba(212,175,55,0.5);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }

    .badge-live:hover {
      transform:translateY(-1px);
      box-shadow:0 0 18px rgba(212,175,55,0.7);
    }

    .badge-dot {
      width:6px; height:6px; border-radius:999px;
      background:var(--accent-primary);
      box-shadow:0 0 10px var(--accent-primary);
      animation:pulse 1.2s infinite;
    }

    @keyframes pulse {
      0%{transform:scale(1);opacity:1}
      60%{transform:scale(1.8);opacity:0}
      100%{transform:scale(1.8);opacity:0}
    }

    /* CONTROLS */
    .top-controls {
      display:flex; gap:10px; padding:12px 18px 14px; align-items:stretch;
      border-bottom:1px solid rgba(212,175,55,0.3);
    }

    .department-filter select {
      width:100%; padding:10px 12px; border-radius:14px;
      background:rgba(11,11,12,0.96);
      color:var(--text-primary);
      border:1px solid rgba(212,175,55,0.6);
      font-size:12px; font-weight:700; letter-spacing:.1em;
      text-transform:uppercase; cursor:pointer;
    }

    .department-filter select option { background:#0B0B0C; color:#F8F7F3; }

    .sort-panel { flex:1; display:flex; flex-direction:column; gap:6px; }
    .sort-label-row { display:none !important; }

    .sort-buttons {
      flex:1; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px;
    }

    .sort-btn, #time-toggle {
      display:inline-flex; align-items:center; justify-content:center; gap:5px;
      background:radial-gradient(circle at 0 0,rgba(212,175,55,0.35),transparent 55%),
                 rgba(11,11,12,0.96);
      color:var(--text-primary);
      border:1px solid rgba(212,175,55,0.55);
      padding:7px 8px; border-radius:999px;
      font-size:11px; font-weight:700; cursor:pointer;
      white-space:nowrap; text-transform:uppercase; letter-spacing:.1em;
      transition:all .14s ease; min-height:30px;
    }

    .sort-btn .sort-indicator { font-size:9px; opacity:.8; }

    .sort-btn.active {
      background:linear-gradient(135deg,#D4AF37,#B8962E);
      color:#0B0B0C; border-color:#F5E6A8;
      box-shadow:0 0 16px rgba(212,175,55,0.6);
    }

    #time-toggle { font-size:10px; padding-inline:10px; justify-self:flex-end; }

    /* LEADERBOARD */
    #leaderboard {
      margin:12px; border-radius:14px;
      border:1px solid rgba(212,175,55,0.55);
      background:rgba(11,11,12,0.97); overflow:hidden;
    }

    .leaderboard-header-row {
      display:grid; grid-template-columns:48px 1fr auto;
      padding:6px 12px; font-size:10px; text-transform:uppercase;
      letter-spacing:.14em; color:rgba(212,175,55,0.6);
      border-bottom:1px solid rgba(212,175,55,0.3);
    }

    .leaderboard-row {
      display:grid; grid-template-columns:48px 1fr auto;
      padding:10px 12px;
      border-bottom:1px solid rgba(212,175,55,0.25);
      cursor:pointer; align-items:center;
      transition:background .15s ease, transform .12s ease;
    }

    .leaderboard-row:last-child { border-bottom:none; }

    .leaderboard-row:hover { background:rgba(212,175,55,0.08); transform:translateY(-1px); }

    .leaderboard-row.gold   { border-left:3px solid var(--gold); }
    .leaderboard-row.silver { border-left:3px solid var(--silver); }
    .leaderboard-row.bronze { border-left:3px solid var(--bronze); }

    .rank {
      font-size:13px; font-weight:800; text-align:center;
      color:rgba(212,175,55,0.75);
    }

    .leaderboard-row.gold .rank,
    .leaderboard-row.silver .rank,
    .leaderboard-row.bronze .rank { font-size:18px; }

    .name {
      padding:0 10px; display:flex; flex-direction:column; justify-content:center;
    }

    .cadet-name, .full-name {
      font-size:14px; font-weight:700; color:var(--text-primary);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .dept-inline {
      margin-left:6px; font-size:10px; font-weight:600;
      letter-spacing:.12em; text-transform:uppercase;
      color:rgba(212,175,55,0.65); white-space:nowrap;
    }

    .metric-tag {
      margin-top:2px; font-size:9px; text-transform:uppercase;
      letter-spacing:.18em; color:rgba(212,175,55,0.6);
    }

    .last-test-small {
      font-size:10px; color:rgba(212,175,55,0.65); margin-top:3px;
    }

    .score {
      font-size:18px; font-weight:800; color:var(--accent-primary);
      text-align:right; min-width:90px; display:flex;
      align-items:center; justify-content:flex-end;
      font-variant-numeric:tabular-nums;
    }

    .score-seconds { font-size:16px; color:var(--accent-primary); }

    /* TIME BLOCKS */
    .time-block { display:inline-flex; align-items:baseline; gap:3px; margin-right:10px; }
    .time-num { font-size:16px; font-weight:600; color:var(--text-primary); font-variant-numeric:tabular-nums; }
    .time-unit { font-size:12px; font-weight:600; position:relative; top:-1px;
                 background:transparent!important; padding:0!important;
                 margin:0!important; border-radius:0!important; }
    .time-unit.h { color:#A855F7; }
    .time-unit.m { color:#38BDF8; }
    .time-unit.s { color:#34D399; }
    .aligned-time { display:flex; flex-direction:column; }
    .time-row { display:grid; grid-template-columns:repeat(3,1fr); text-align:center; margin-top:2px; }
    .t-block { display:flex; justify-content:center; align-items:baseline; gap:2px; }
    .t-num { font-size:14px; font-weight:700; color:var(--text-primary); font-variant-numeric:tabular-nums; }
    .t-unit { font-size:10px; font-weight:600; position:relative; top:-1px; padding-left:1px; }
    .t-unit.h { color:#A855F7; }
    .t-unit.m { color:#38BDF8; }
    .t-unit.s { color:#34D399; }

    /* LOADER */
    #loader { display:none; justify-content:center; align-items:center; padding:40px 0 20px; }

    .spinner {
      width:46px; height:46px; border-radius:999px;
      border:3px solid rgba(212,175,55,0.3);
      border-top-color:#D4AF37; border-right-color:#F5E6A8;
      animation:spin .9s linear infinite;
      box-shadow:0 0 18px rgba(212,175,55,0.5);
    }

    @keyframes spin { to{transform:rotate(360deg)} }

    #error {
      color:var(--danger); text-align:center;
      padding:12px 16px 18px; font-weight:600; font-size:12px;
    }

    /* MODAL */
    #modal {
      display:none; position:fixed; inset:0;
      background:rgba(11,11,12,0.92); backdrop-filter:blur(6px);
      justify-content:center; align-items:flex-start;
      z-index:1000; overflow-y:auto; padding:25px 12px;
    }

    #modal-content {
      background:rgba(11,11,12,0.98); border-radius:18px;
      padding:18px 16px 20px; width:100%; max-width:520px;
      margin:0 auto; border:1px solid rgba(212,175,55,0.7);
      box-shadow:0 30px 80px rgba(0,0,0,0.95),0 0 26px rgba(212,175,55,0.3);
      position:relative;
    }

    .modal-header {
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:16px; padding-bottom:12px;
      border-bottom:1px solid rgba(212,175,55,0.35);
    }

    .modal-header h2 { font-size:18px; font-weight:800; color:#F8F7F3; }

    .modal-id-tag {
      position:absolute; top:-10px; left:16px;
      font-size:10px; text-transform:uppercase; letter-spacing:.16em;
      padding:3px 8px; border-radius:999px;
      background:rgba(11,11,12,0.95);
      border:1px solid rgba(212,175,55,0.6);
      color:rgba(212,175,55,0.8);
    }

    .close-btn {
      background:rgba(11,11,12,0.95); border:1px solid rgba(212,175,55,0.55);
      color:#F8F7F3; font-size:20px; cursor:pointer;
      width:32px; height:32px; border-radius:999px;
      display:flex; align-items:center; justify-content:center; line-height:1;
      transition:all .1s ease;
    }

    .close-btn:hover { background:rgba(212,175,55,0.2); transform:translateY(-1px); }

    .stats-grid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr));
      gap:10px; margin-bottom:16px;
    }

    .stat-box {
      background:rgba(17,17,19,0.96); padding:10px 10px 9px;
      border-radius:10px; text-align:left;
      border:1px solid rgba(212,175,55,0.55); position:relative; overflow:hidden;
    }

    .stat-label {
      font-size:10px; color:rgba(212,175,55,0.65); text-transform:uppercase;
      margin-bottom:2px; letter-spacing:.16em;
    }

    .stat-value { font-size:20px; font-weight:800; color:var(--accent-primary); line-height:1.2; font-variant-numeric:tabular-nums; }
    .time-stat { font-size:0; }
    .stat-foot { font-size:10px; color:rgba(212,175,55,0.5); margin-top:4px; }

    .detail-box {
      background:rgba(11,11,12,0.98); padding:12px 11px 11px;
      border-radius:10px; margin-bottom:12px;
      border:1px solid rgba(212,175,55,0.45);
    }

    .detail-box h3 {
      color:#F8F7F3; margin-bottom:6px; font-size:14px; font-weight:700;
      display:flex; align-items:center; gap:6px;
    }

    .detail-box p { color:rgba(248,247,243,0.9); line-height:1.5; font-size:12px; word-wrap:break-word; }
    .detail-caption { font-size:10px; color:rgba(212,175,55,0.5); margin-bottom:8px; }

    /* MINI CALENDAR */
    .mission-calendar { display:flex; flex-direction:column; gap:14px; }

    .mini-cal-title {
      text-align:center; font-weight:600; margin-bottom:6px; font-size:11px;
      color:rgba(212,175,55,0.8); text-transform:uppercase; letter-spacing:.12em;
    }

    .mini-cal-grid {
      display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:4px; font-size:9px;
    }

    .mini-cal-grid > div:nth-child(-n+7) {
      font-weight:600; text-align:center; color:rgba(212,175,55,0.6); padding-bottom:2px;
    }

    .mini-cal-day {
      background:rgba(11,11,12,0.96); padding:4px 3px; border-radius:6px;
      min-height:46px; font-size:9px; color:#F8F7F3;
      border:1px solid rgba(212,175,55,0.35);
      display:flex; flex-direction:column; align-items:flex-start;
    }

    .mini-cal-day.marked {
      background:rgba(212,175,55,0.25);
      border-color:var(--accent-primary);
      box-shadow:0 0 12px rgba(212,175,55,0.5);
    }

    .mini-cal-date { font-weight:700; margin-bottom:2px; }
    .mini-cal-items div { font-size:9px; line-height:1.1; }

    /* RESPONSIVE */
    @media (max-width:600px) {
      .top-controls { flex-direction:column; }
      #leaderboard { margin-inline:10px; }
      .leaderboard-header-row { display:none; }
      .dept-inline { display:block; margin-left:0; margin-top:2px; font-size:9px; }
    }
    /* ‚îÄ‚îÄ ANALYTICS PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .analytics-panel {
      margin: 0 12px 24px;
      border-radius: 14px;
      border: 1px solid rgba(212,175,55,0.5);
      background: rgba(11,11,12,0.97);
      overflow: hidden;
    }

    .ap-header {
      padding: 14px 18px 10px;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      background: linear-gradient(90deg, rgba(212,175,55,0.1), transparent);
    }

    .ap-title {
      font-size: 13px; font-weight: 800; text-transform: uppercase;
      letter-spacing: .18em; color: rgba(212,175,55,0.9);
    }

    .ap-sub {
      font-size: 9px; letter-spacing: .12em; text-transform: uppercase;
      color: rgba(212,175,55,0.4); margin-top: 3px;
    }

    .ap-section {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(212,175,55,0.18);
    }

    .ap-section:last-child { border-bottom: none; }

    .ap-section-label {
      font-size: 10px; font-weight: 700; letter-spacing: .18em;
      text-transform: uppercase; color: rgba(212,175,55,0.7);
      margin-bottom: 10px; display: flex; align-items: center; gap: 10px;
    }

    .ap-section-sub {
      font-size: 9px; font-weight: 400; color: rgba(248,247,243,0.3);
      letter-spacing: .1em;
    }

    /* Tier cards */
    .ap-tier-row {
      display: grid; grid-template-columns: repeat(4,1fr); gap: 10px;
    }

    .ap-tier-card {
      border-radius: 10px; border: 1px solid; padding: 12px 8px;
      text-align: center;
    }

    .ap-tier-icon { font-size: 16px; line-height: 1; }
    .ap-tier-count { font-size: 26px; font-weight: 900; line-height: 1.1; margin-top: 4px; }
    .ap-tier-label { font-size: 9px; font-weight: 700; letter-spacing: .14em; text-transform: uppercase; margin-top: 2px; }
    .ap-tier-pct { font-size: 10px; color: rgba(248,247,243,0.35); margin-top: 4px; }

    /* Dept table */
    .ap-dept-table { display: flex; flex-direction: column; gap: 4px; }

    .ap-dept-head {
      display: grid; grid-template-columns: 2fr 1fr 2fr 1fr;
      padding: 5px 10px; font-size: 9px; font-weight: 700;
      letter-spacing: .14em; text-transform: uppercase;
      color: rgba(212,175,55,0.5);
    }

    .ap-dept-row {
      display: grid; grid-template-columns: 2fr 1fr 2fr 1fr;
      padding: 8px 10px; border-radius: 8px; align-items: center;
      background: rgba(17,17,19,0.8);
      border: 1px solid rgba(212,175,55,0.15);
      transition: background .12s ease;
    }

    .ap-dept-row:hover { background: rgba(212,175,55,0.07); }

    .ap-dept-top {
      border-color: rgba(212,175,55,0.4);
      background: rgba(212,175,55,0.08);
    }

    .ap-dept-name {
      font-size: 11px; font-weight: 700; color: #F8F7F3;
      letter-spacing: .06em; text-transform: uppercase;
    }

    .ap-dept-val {
      font-size: 11px; font-weight: 600; color: rgba(212,175,55,0.8);
      display: flex; align-items: center; gap: 6px;
    }

    .ap-at-risk-num { color: #F87171 !important; font-weight: 800; }

    .ap-acc-bar-wrap {
      display: inline-block; width: 50px; height: 5px;
      background: rgba(212,175,55,0.15); border-radius: 999px; overflow: hidden;
      vertical-align: middle;
    }

    .ap-acc-bar-fill {
      display: block; height: 100%;
      background: linear-gradient(90deg, #B8962E, #F5E6A8);
      border-radius: 999px;
    }

    .ap-acc-num { font-size: 11px; color: rgba(212,175,55,0.8); }

    /* At-risk grid */
    .ap-risk-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr));
      gap: 8px;
    }

    .ap-risk-card {
      background: rgba(248,113,113,0.08);
      border: 1px solid rgba(248,113,113,0.35);
      border-radius: 8px; padding: 9px 10px;
      cursor: pointer;
      transition: background .12s ease, transform .12s ease;
    }

    .ap-risk-card:hover {
      background: rgba(248,113,113,0.15);
      transform: translateY(-1px);
    }

    .ap-risk-name {
      font-size: 11px; font-weight: 700; color: #F8F7F3;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .ap-risk-dept {
      font-size: 9px; letter-spacing: .1em; text-transform: uppercase;
      color: rgba(248,113,113,0.6); margin-top: 2px;
    }

    .ap-risk-days {
      font-size: 10px; font-weight: 700; color: #F87171; margin-top: 4px;
    }

    .ap-empty {
      font-size: 12px; color: rgba(74,222,128,0.8); padding: 8px 0;
      letter-spacing: .06em;
    }

    @media (max-width: 600px) {
      .ap-tier-row { grid-template-columns: repeat(2,1fr); }
      .ap-dept-head, .ap-dept-row { grid-template-columns: 2fr 1fr 1.5fr 1fr; }
      .ap-acc-bar-wrap { display: none; }
      .analytics-panel { margin-inline: 10px; }
    }
  </style>
</head>

<body>
  <div class="command-frame">
    <div class="header">
      <div class="header-top">
        <div class="title-block">
          <div class="mission-title">Mission: Veni, Vidi, Vici!</div>
          <div class="title">LEADERBOARD</div>
        </div>
        <button class="badge-live" onclick="showClassStats()">
          <span class="badge-dot"></span>
          üîç
        </button>
      </div>
      <div class="subtitle" id="last-test-info">Initializing mission feed...</div>
    </div>

    <div class="top-controls">
      <div class="department-filter">
        <select id="departmentSelect" onchange="applyDepartmentFilter(this.value)">
          <option value="ALL">All Departments</option>
        </select>
      </div>

      <div class="sort-panel">
        <div class="sort-label-row"></div>
        <div class="sort-buttons">
          <button class="sort-btn" data-sort="accuracy" onclick="sortData('accuracy')">
            Accuracy <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="total_time" onclick="sortData('total_time')">
            Time <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="quests_completed" onclick="sortData('quests_completed')">
            Quests <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="videos_completed" onclick="sortData('videos_completed')">
            Videos <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="stories_completed" onclick="sortData('stories_completed')">
            Stories <span class="sort-indicator"></span>
          </button>
          <button class="sort-btn" data-sort="last_test_taken" onclick="sortData('last_test_taken')">
            Last Test <span class="sort-indicator"></span>
          </button>
        </div>
      </div>
    </div>

    <div style="display:flex; justify-content:flex-end; padding:4px 18px 0;">
      <button id="time-toggle"
        class="sort-btn"
        style="display:none; font-size:10px; padding-inline:12px; min-width:auto;"
        onclick="toggleTimeFormat()">
        Show Seconds
      </button>
    </div>

    <div id="loader"><div class="spinner"></div></div>
    <div id="error"></div>

    <div id="leaderboard">
      <div class="leaderboard-header-row">
        <div>Rank</div>
        <div>Pilot</div>
        <div>Metric</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ANALYTICS PANEL ‚îÄ‚îÄ -->
    <div id="analytics-panel" class="analytics-panel"></div>

    <div id="modal">
      <div id="modal-content"></div>
    </div>
  </div>
</body>
</html>
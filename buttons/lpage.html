<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Tap-to-Match Quiz üåå</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap');

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Inter', sans-serif;
  background: #f8f6f3;
  color: #2d2d2d;
  overflow: hidden;
  width: 100vw;
  height: 100vh;
  position: fixed;
}

/* ========== CONTAINER ========== */
.container {
  width: 100vw;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, #faf9f7 0%, #f0ede8 100%);
}

/* ========== HEADER ========== */
.top-bar {
  height: 3px;
  background: linear-gradient(90deg, #c9a97e, #8b7355, #c9a97e);
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 1rem;
  background: rgba(255, 255, 255, 0.9);
  border-bottom: 1px solid #e6dfd6;
  font-size: 0.85rem;
  font-weight: 600;
  color: #5a4a3a;
}

.header-item {
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

/* ========== MUTE BUTTON ========== */
#muteBtn {
  position: fixed;
  top: 3.5rem;
  right: 0.5rem;
  background: linear-gradient(135deg, #8b7355, #a68968);
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(139, 115, 85, 0.3);
  z-index: 1000;
}

/* ========== MAIN LAYOUT ========== */
.game-area {
  flex: 1;
  display: grid;
  grid-template-columns: 35% 65%;
  gap: 0.5rem;
  padding: 0.5rem;
  overflow: hidden;
}

/* ========== LEFT PANEL - OPTIONS ========== */
.left-panel {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.panel-title {
  font-family: 'Playfair Display', serif;
  font-size: 0.75rem;
  font-weight: 600;
  color: #8b7355;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
  padding: 0.3rem;
}

.options-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  justify-content: center;
  padding: 0.5rem;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 12px;
  border: 1px solid #e6dfd6;
}

.option-btn {
  padding: 1.2rem;
  background: #ffffff;
  border: 2px solid #d4c4b0;
  border-radius: 10px;
  font-size: 1.3rem;
  font-weight: 600;
  color: #2d2d2d;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  text-align: center;
  user-select: none;
}

.option-btn:active {
  transform: scale(0.98);
}

.option-btn.selected {
  background: linear-gradient(135deg, #8b7355, #a68968);
  color: #ffffff;
  border-color: #8b7355;
  box-shadow: 0 4px 12px rgba(139, 115, 85, 0.4);
}

.answer-image {
  max-width: 60px;
  max-height: 60px;
  margin: 0 auto 0.3rem;
  border-radius: 6px;
  display: block;
}

/* ========== RIGHT PANEL ========== */
.right-panel {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.question-box {
  background: rgba(255, 255, 255, 0.8);
  padding: 0.8rem;
  border-radius: 12px;
  border: 1px solid #e6dfd6;
  text-align: center;
}

.question-text {
  font-family: 'Playfair Display', serif;
  font-size: 1rem;
  font-weight: 600;
  color: #3a3a3a;
  line-height: 1.3;
}

.question-image {
  max-width: 100%;
  max-height: 120px;
  margin-top: 0.5rem;
  border-radius: 8px;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.drops-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  justify-content: center;
  padding: 0.8rem;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 12px;
  border: 1px solid #e6dfd6;
}

.drop-zone {
  padding: 1rem;
  background: #ffffff;
  border: 2px dashed #c9a97e;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 500;
  color: #2d2d2d;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
  text-align: left;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.drop-zone:active {
  transform: scale(0.98);
}

.drop-zone.filled {
  border-style: solid;
  border-color: #8b7355;
  background: #faf8f5;
}

.drop-zone.correct {
  background: linear-gradient(135deg, #e8f5e9, #f1f8f2);
  border-color: #4caf50;
  animation: pulse 0.4s ease;
}

.drop-zone.wrong {
  background: linear-gradient(135deg, #ffebee, #fce4e4);
  border-color: #e57373;
  animation: shake 0.4s ease;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.dropzone-image {
  max-width: 40px;
  max-height: 40px;
  border-radius: 6px;
}

/* ========== NEXT BUTTON ========== */
#nextBtn {
  margin-top: 0.5rem;
  padding: 0.7rem 1.5rem;
  background: linear-gradient(135deg, #8b7355, #a68968);
  color: #ffffff;
  border: none;
  border-radius: 10px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 3px 10px rgba(139, 115, 85, 0.3);
  display: none;
}

/* ========== MOTIVATION ========== */
#motivationBox {
  position: fixed;
  bottom: 0.5rem;
  left: 50%;
  transform: translateX(-50%);
  max-width: 90%;
  padding: 0.6rem 1rem;
  font-family: 'Playfair Display', serif;
  font-size: 0.95rem;
  font-weight: 600;
  color: #5a4a3a;
  background: linear-gradient(135deg, #fff9f0, #fef5e7);
  border: 1.5px solid #c9a97e;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  text-align: center;
  z-index: 100;
  opacity: 0;
  transition: opacity 0.3s ease;
}

/* ========== NAME FORM ========== */
#nameForm {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  padding: 2rem;
  background: linear-gradient(135deg, #faf9f7, #f0ede8);
}

.hero-quote {
  width: 100%;
  max-width: 400px;
  padding: 1.5rem;
  background: linear-gradient(135deg, #2d2d2d, #3a3a3a);
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.hero-text {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem;
  font-weight: 600;
  color: #f4e4c1;
  line-height: 1.4;
  font-style: italic;
}

.hero-author {
  margin-top: 0.8rem;
  font-size: 1rem;
  color: #c9a97e;
}

#nameInput,
#departmentSelect {
  width: 100%;
  max-width: 400px;
  padding: 1rem;
  background: #ffffff;
  border: 2px solid #d4c4b0;
  border-radius: 10px;
  font-size: 1rem;
  font-family: 'Inter', sans-serif;
  outline: none;
}

#nameInput:focus,
#departmentSelect:focus {
  border-color: #8b7355;
  box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
}

#nameForm button {
  width: 100%;
  max-width: 400px;
  padding: 1rem;
  background: linear-gradient(135deg, #8b7355, #a68968);
  color: #ffffff;
  font-size: 1rem;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
}

/* ========== SCORE CARD ========== */
#scoreCard {
  background: rgba(255, 255, 255, 0.95);
  padding: 1.5rem;
  border-radius: 12px;
  border: 2px solid #c9a97e;
  font-family: 'Playfair Display', serif;
  text-align: center;
  line-height: 1.8;
}

#scoreCard p {
  margin: 0.3rem 0;
  font-size: 1rem;
}

#scoreCard button {
  margin-top: 1rem;
  padding: 0.8rem 1.5rem;
  background: linear-gradient(135deg, #4caf50, #66bb6a);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
}

#restartBtn {
  margin-top: 1rem;
  padding: 0.8rem 1.5rem;
  background: linear-gradient(135deg, #5a4a3a, #8b7355);
  color: #ffffff;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  display: none;
}

.gem-pop {
  animation: gemPop 0.4s ease;
}

@keyframes gemPop {
  0% { transform: scale(1); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

</style>
</head>

<body>
  <div class="container" id="quizContainer">
    <div class="top-bar"></div>
    
    <!-- NAME FORM -->
    <div id="nameForm">
      <div class="hero-quote">
        <div class="hero-text">
          Ever tried. Ever failed. No matter. Try again. Fail again. Fail better.
        </div>
        <div class="hero-author">ü§ó‚ô•Ô∏è‚ú®</div>
      </div>

      <input 
        type="text" 
        id="nameInput" 
        placeholder="Enter your name"
      />

      <select id="departmentSelect">
        <option value="">-- Select Department --</option>
        <option value="English">English</option>
        <option value="Cyber Security">Cyber Security</option>
        <option value="CSE-1">CSE-1</option>
        <option value="CSE-2">CSE-2</option>
        <option value="CSE-3">CSE-3</option>
        <option value="Mechanical Engineering">Mechanical Engineering</option>
        <option value="ECE-1">ECE-1</option>
        <option value="ECE-2">ECE-2</option>
        <option value="ECE-3">ECE-3</option>
        <option value="AI DS-1">AI DS-1</option>
        <option value="AI DS-2">AI DS-2</option>
        <option value="Civil">Civil</option>
        <option value="Agri">Agri</option>
        <option value="EEE">EEE</option>
        <option value="EIE">EIE</option>
        <option value="Medical Electronics">Medical Electronics</option>
        <option value="IT-1">IT-1</option>
        <option value="IT-2">IT-2</option>
      </select>

      <button onclick="beginQuiz()">Begin Quest</button>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="quizContent" style="display:none;">
      <div class="top-bar"></div>
      
      <div class="header">
        <div class="header-item">
          <span>‚è≥</span>
          <span id="timer">0s</span>
        </div>
        <div class="header-item">
          <span>üíé</span>
          <span id="gemsCounter">0</span>
        </div>
        <div class="header-item">
          <span id="progressTracker">1/1</span>
        </div>
      </div>

      <button id="muteBtn" onclick="toggleMute()" title="Toggle Sound">üîä</button>

      <div class="game-area">
        <!-- LEFT: OPTIONS -->
        <div class="left-panel">
          <div class="panel-title">Tap Answer</div>
          <div class="options-container" id="dragOptions"></div>
        </div>

        <!-- RIGHT: QUESTION & DROPS -->
        <div class="right-panel">
          <div class="question-box">
            <div class="question-text" id="question">Select and Match</div>
            <div id="questionImageContainer"></div>
          </div>
          
          <div class="drops-container" id="dropContainer"></div>
          
          <button id="nextBtn" onclick="goToNextQuestion()">Next ‚Üí</button>
          
          <div id="scoreCard"></div>
          <button id="restartBtn" onclick="restartQuiz()">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MOTIVATION BOX -->
  <div id="motivationBox"></div>

<script>
/* ========== CONFETTI ========== */
function triggerConfetti() {
  confetti({
    particleCount: 50,
    spread: 60,
    origin: { y: 0.6 }
  });
}

function triggerMegaConfetti() {
  const duration = 2000;
  const end = Date.now() + duration;
  
  (function frame() {
    confetti({
      particleCount: 3,
      angle: 60,
      spread: 55,
      origin: { x: 0 },
      colors: ['#8b7355', '#c9a97e', '#a68968']
    });
    confetti({
      particleCount: 3,
      angle: 120,
      spread: 55,
      origin: { x: 1 },
      colors: ['#8b7355', '#c9a97e', '#a68968']
    });
    
    if (Date.now() < end) {
      requestAnimationFrame(frame);
    }
  }());
}

/* ========== AUDIO ========== */
const applauseSound = new Audio('https://www.myinstants.com/media/sounds/smw_coin.mp3');
const wrongSound = new Audio('https://www.myinstants.com/media/sounds/smb_bump.mp3');
applauseSound.volume = 0.5;
wrongSound.volume = 0.5;

let isMuted = false;

function toggleMute() {
  isMuted = !isMuted;
  const muteBtn = document.getElementById('muteBtn');
  muteBtn.innerText = isMuted ? 'üîá' : 'üîä';
  applauseSound.muted = isMuted;
  wrongSound.muted = isMuted;
  localStorage.setItem('questSoundMuted', isMuted);
}

function playApplauseSound() {
  if (!isMuted) {
    applauseSound.currentTime = 0;
    applauseSound.play().catch(() => {});
  }
}

function playWrongSound() {
  if (!isMuted) {
    wrongSound.currentTime = 0;
    wrongSound.play().catch(() => {});
  }
}

/* ========== RESTORE ========== */
window.addEventListener("load", () => {
  const savedName = localStorage.getItem("questPlayerName");
  const savedDept = localStorage.getItem("questPlayerDept");
  if (savedName) document.getElementById("nameInput").value = savedName;
  if (savedDept) document.getElementById("departmentSelect").value = savedDept;
  
  const savedMute = localStorage.getItem('questSoundMuted');
  if (savedMute === 'true') {
    isMuted = true;
    applauseSound.muted = true;
    wrongSound.muted = true;
    setTimeout(() => {
      const btn = document.getElementById('muteBtn');
      if (btn) btn.innerText = 'üîá';
    }, 100);
  }
});

/* ========== MOTIVATION ========== */
const rightMessages = [
  "'name' is unstoppable!",
  "'name' is awesome!",
  "'name' got it right!",
  "Nothing can slow 'name' down!",
  "'name' learns fast!",
  "Who is awesome? 'name'!",
  "'name' proves effort beats talent!",
  "'name' shines brighter!"
];

const wrongMessages = [
  "'name' loves failures!",
  "'name' says: Try again. Fail better.",
  "Every mistake makes 'name' stronger.",
  "Mistakes guide 'name' to victory!",
  "Failure is feedback for 'name'.",
  "'name' tries again and again!"
];

function showMotivation(isCorrect) {
  const box = document.getElementById("motivationBox");
  const list = isCorrect ? rightMessages : wrongMessages;
  let msg = list[Math.floor(Math.random() * list.length)];
  msg = msg.replace(/'name'/g, playerName);
  box.innerHTML = msg;
  box.style.opacity = 1;
  setTimeout(() => { box.style.opacity = 0; }, 3000);
}

/* ========== QUIZ DATA ========== */
const quizData = [
{
  "questionImage": "",
  "questionItems": [
    { "word": "The website ___ showing only the questions.", "answer": "is", "itemImage": "" },
    { "word": "The questions ___ shown after login.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The teacher ___ checking the submissions now.", "answer": "is", "itemImage": "" },
    { "word": "The students ___ waiting for feedback.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The server ___ running slowly today.", "answer": "is", "itemImage": "" },
    { "word": "The pages ___ loading very slowly.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The class ___ ready to start the activity.", "answer": "is", "itemImage": "" },
    { "word": "The students ___ ready with their notebooks.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The app ___ working properly now.", "answer": "is", "itemImage": "" },
    { "word": "The features ___ available after update.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The result page ___ open now.", "answer": "is", "itemImage": "" },
    { "word": "The results ___ visible to students.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The quiz ___ starting in a minute.", "answer": "is", "itemImage": "" },
    { "word": "The students ___ entering the room.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The teacher ___ explaining the rules.", "answer": "is", "itemImage": "" },
    { "word": "The rules ___ easy to understand.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The system ___ updating right now.", "answer": "is", "itemImage": "" },
    { "word": "The files ___ being uploaded.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The classroom ___ quiet now.", "answer": "is", "itemImage": "" },
    { "word": "The students ___ listening carefully.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
}
];

let current = 0;
let wrongQuestions = [];
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;

const questionEl = document.getElementById("question");
const questionImageContainer = document.getElementById("questionImageContainer");
const dragOptionsEl = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl = document.getElementById("timer");
const gemsCounterEl = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard = document.getElementById("scoreCard");
const restartBtn = document.getElementById("restartBtn");
const nextBtn = document.getElementById("nextBtn");

function beginQuiz() {
  const nameField = document.getElementById("nameInput");
  const deptField = document.getElementById("departmentSelect");

  if (!nameField.value.trim()) { alert("Please enter your name!"); return; }
  if (!deptField.value) { alert("Please select your department!"); return; }

  playerName = nameField.value.trim();
  playerDept = deptField.value;

  localStorage.setItem("questPlayerName", playerName);
  localStorage.setItem("questPlayerDept", playerDept);

  document.getElementById("nameForm").style.display = "none";
  document.getElementById("quizContent").style.display = "flex";
  document.getElementById("quizContent").style.flexDirection = "column";

  startQuiz();
}

function startQuiz() {
  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();

  gemsCounterEl.innerText = "0";
  scoreCard.innerHTML = "";
  scoreCard.style.display = "none";
  restartBtn.style.display = "none";
  loadQuestion();
  startTimer();
}

function loadQuestion() {
  if (current >= quizData.length) return showScore();

  selectedOption = null;
  nextBtn.style.display = "none";
  const data = quizData[current];
  progressTracker.innerText = `${current + 1}/${quizData.length}`;

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  questionImageContainer.innerHTML = "";

  if (data.questionImage && data.questionImage.trim() !== "") {
    const img = document.createElement("img");
    img.src = data.questionImage;
    img.classList.add("question-image");
    questionImageContainer.appendChild(img);
  }

  let answersList = [];
  if (data.answers && data.answers.length > 0) {
    if (typeof data.answers[0] === 'string') {
      answersList = data.answers.map(ans => ({ text: ans, image: "" }));
    } else {
      answersList = data.answers;
    }
  }

  const shuffled = [...answersList].sort(() => Math.random() - 0.5);

  shuffled.forEach((ansObj) => {
    const div = document.createElement("div");
    div.classList.add("option-btn");
    div.dataset.answer = ansObj.text;
    
    if (ansObj.image && ansObj.image.trim() !== "") {
      const img = document.createElement("img");
      img.src = ansObj.image;
      img.classList.add("answer-image");
      div.appendChild(img);
    }
    
    const textSpan = document.createElement("span");
    textSpan.innerText = ansObj.text;
    div.appendChild(textSpan);
    
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  data.questionItems.forEach((item) => {
    const drop = document.createElement("div");
    drop.classList.add("drop-zone");
    
    if (item.itemImage && item.itemImage.trim() !== "") {
      const img = document.createElement("img");
      img.src = item.itemImage;
      img.classList.add("dropzone-image");
      drop.appendChild(img);
    }
    
    const textSpan = document.createElement("span");
    textSpan.innerText = item.word;
    drop.appendChild(textSpan);
    
    drop.dataset.answer = item.answer;
    drop.onclick = () => placeOption(drop);
    dropContainerEl.appendChild(drop);
  });
}

function selectOption(div) {
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

function placeOption(dropZone) {
  if (!selectedOption) return;

  const answer = selectedOption.dataset.answer;
  const correctAnswer = dropZone.dataset.answer;

  if (answer === correctAnswer) {
    triggerConfetti();
    playApplauseSound();
    
    correctCount++;
    gemsCount++;
    gemsCounterEl.innerText = `${gemsCount}`;
    gemsCounterEl.classList.add('gem-pop');
    setTimeout(() => gemsCounterEl.classList.remove('gem-pop'), 400);
    
    showMotivation(true);

    const textSpan = dropZone.querySelector('span');
    const originalText = textSpan ? textSpan.innerText : dropZone.innerText;
    
    if (textSpan) {
      textSpan.innerHTML = originalText.replace("___", `<strong>${answer}</strong>`);
    } else {
      dropZone.innerHTML = originalText.replace("___", `<strong>${answer}</strong>`);
    }
    
    dropZone.classList.add("correct", "filled");
    selectedOption.style.display = "none";

  } else {
    playWrongSound();
    
    totalWrongGuesses++;
    gemsCount--;
    gemsCounterEl.innerText = `${gemsCount}`;
    showMotivation(false);

    dropZone.classList.add("wrong");
    setTimeout(() => dropZone.classList.remove("wrong"), 600);

    const currentQ = quizData[current];
    if (!wrongQuestions.includes(currentQ)) wrongQuestions.push(currentQ);
  }

  selectedOption.classList.remove("selected");
  selectedOption = null;

  if (document.querySelectorAll(".drop-zone:not(.filled)").length === 0) {
    nextBtn.style.display = "block";
  }
}

function goToNextQuestion() {
  nextBtn.style.display = "none";
  current++;
  if (current >= quizData.length && wrongQuestions.length > 0) {
    quizData.push(...wrongQuestions);
    wrongQuestions = [];
  }
  loadQuestion();
}

function startTimer() {
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    timerEl.innerText = `${elapsed}s`;
  }, 1000);
}

const EDGE_FUNCTION_URL = "https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/logQuest";

function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  triggerMegaConfetti();

  questionEl.innerText = "üéâ Complete!";
  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  questionImageContainer.innerHTML = "";
  progressTracker.innerText = "";

  scoreCard.style.display = "block";
  scoreCard.innerHTML = `
    <p><strong>${playerName}</strong></p>
    <p>Correct: ${correctCount}</p>
    <p>Wrong: ${totalWrongGuesses}</p>
    <p>Gems: ${gemsCount}</p>
    <p>Time: ${totalTime}s</p>
    <button onclick="downloadPDFReport()">üì• Download PDF</button>
  `;

  restartBtn.style.display = "block";

  sendViaEdgeFunction({
    student_name: playerName,
    department: playerDept,
    correct: correctCount,
    wrong: totalWrongGuesses,
    time_spent: totalTime,
    quest_id: "Quest 130"
  });
}

async function sendViaEdgeFunction(payload) {
  try {
    const response = await fetch(EDGE_FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (response.ok) console.log("‚úÖ Saved");
  } catch (err) {
    console.error("‚ö†Ô∏è Error:", err);
  }
}

function downloadPDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('times', 'bold');
  doc.setFontSize(18);
  doc.text('SRM VALLIAMMAI ENGINEERING COLLEGE', 105, 16, { align: 'center' });
  doc.setFontSize(12);
  doc.setFont('times', 'italic');
  doc.text('(Autonomous)', 105, 23, { align: 'center' });
  doc.setFontSize(15);
  doc.setFont('times', 'normal');
  doc.text('Department of English', 105, 31, { align: 'center' });
  doc.setFontSize(14);
  doc.setFont('times', 'bold');
  doc.setTextColor(212, 175, 55);
  doc.text('Quest Performance Report', 105, 39, { align: 'center' });

  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text('CANDIDATE INFORMATION', 20, 55);
  doc.autoTable({
    startY: 58,
    body: [
      ['Student Name', playerName],
      ['Department', playerDept],
      ['Quest ID', 'Quest 130'],
      ['Completed On', reportDate]
    ],
    theme: 'plain',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: 'bold', cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 }
    },
    margin: { left: 20, right: 20 }
  });

  let y = doc.lastAutoTable.finalY + 10;
  doc.setFont('times', 'bold');
  doc.text('PERFORMANCE SUMMARY', 20, y);
  y += 4;
  doc.autoTable({
    startY: y + 3,
    body: [
      ['Total Questions', quizData.length.toString()],
      ['Correct Answers', correctCount.toString()],
      ['Wrong Attempts', totalWrongGuesses.toString()],
      ['Final Gems Earned', gemsCount.toString()],
      ['Total Time', `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`]
    ],
    theme: 'grid',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    margin: { left: 20, right: 20 }
  });

  y = doc.lastAutoTable.finalY + 12;
  if (y > 250) { doc.addPage(); y = 20; }
  doc.setFont('times', 'bold');
  doc.text('QUESTION BANK WITH CORRECT ANSWERS', 20, y);
  y += 6;

  quizData.forEach((item, i) => {
    if (y > 260) { doc.addPage(); y = 20; }
    doc.setFontSize(11);
    doc.setFont('times', 'bold');
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, 20, y);
    y += 6;
    doc.setTextColor(0, 0, 0);
    doc.setFont('times', 'normal');
    item.questionItems.forEach((qItem, j) => {
      const questionText = `${j + 1}. ${qItem.word.replace('___', '____')} `;
      const answerText = `Answer: ${qItem.answer}`;
      const lines = doc.splitTextToSize(questionText, 160);
      doc.text(lines, 25, y);
      y += lines.length * 5;
      doc.setTextColor(0, 128, 0);
      doc.text(answerText, 30, y);
      doc.setTextColor(0, 0, 0);
      y += 7;
    });
    y += 3;
    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.3);
    doc.line(20, y, 190, y);
    y += 5;
  });

  doc.setDrawColor(184, 134, 11);
  doc.setLineWidth(0.5);
  doc.line(20, 280, 190, 280);
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.setFont('times', 'italic');
  doc.text('This is a system-generated report', 105, 287, { align: 'center' });

  const cleanName = playerName.replace(/[^a-zA-Z0-9]/g, '_');
  doc.save(`${cleanName}_Quest130_Report.pdf`);
}

function restartQuiz() {
  document.getElementById("quizContent").style.display = "none";
  document.getElementById("nameForm").style.display = "flex";
  document.getElementById("nameInput").value = "";
}
</script>
</body>
</html>
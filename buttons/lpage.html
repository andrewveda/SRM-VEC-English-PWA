<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tap-to-Match Quiz üåå</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Montserrat:wght@300;400;600;700&display=swap');

:root {
  --bg-main: linear-gradient(135deg, #f5f7fa 0%, #e8edf2 100%);
  --card-bg: #ffffff;
  --accent-primary: #8b7355;
  --accent-gold: #b8966e;
  --accent-dark: #5a4a3a;
  --text-primary: #2c2c2c;
  --text-secondary: #6c6c6c;
  --border-elegant: #d4c4b0;
  --shadow-soft: rgba(139, 115, 85, 0.08);
  --shadow-medium: rgba(139, 115, 85, 0.15);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Montserrat', sans-serif;
  background: var(--bg-main);
  color: var(--text-primary);
  overflow: hidden;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  margin: 0;
}

/* ========== LANDSCAPE CONTAINER ========== */
.container {
  position: relative;
  width: 100%;
  max-width: 1600px;
  height: 100vh;
  background: var(--card-bg);
  border-radius: 0;
  box-shadow: none;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* ========== DECORATIVE HEADER BAR ========== */
.header-bar {
  height: 3px;
  background: linear-gradient(90deg, var(--accent-gold), var(--accent-primary), var(--accent-gold));
}

/* ========== QUIZ HEADER / HUD ========== */
.quiz-header {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  align-items: center;
  padding: 0.8rem 2rem;
  background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(255,255,255,0.8));
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border-elegant);
}

.hud-item {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1rem;
  font-weight: 600;
  color: var(--accent-dark);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.hud-item:nth-child(2) {
  justify-content: center;
}

.hud-item:nth-child(3) {
  justify-content: flex-end;
}

.hud-icon {
  font-size: 1.2rem;
}

/* ========== MUTE BUTTON ========== */
#muteBtn {
  position: fixed;
  top: 1rem;
  right: 1rem;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-gold));
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  cursor: pointer;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 16px var(--shadow-medium);
  transition: all 0.3s ease;
  z-index: 1000;
}

#muteBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px var(--shadow-medium);
}

#muteBtn:active {
  transform: scale(0.95);
}

/* ========== MAIN CONTENT AREA ========== */
.content-wrapper {
  flex: 1;
  display: grid;
  grid-template-columns: 35% 65%;
  gap: 2rem;
  padding: 1.5rem 2rem;
  overflow: hidden;
  height: 100%;
}

/* ========== LEFT PANEL - OPTIONS ========== */
.left-panel {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  height: 100%;
}

.options-section {
  background: linear-gradient(135deg, #fefefe, #f9f9f9);
  padding: 1.5rem;
  border-radius: 16px;
  border: 1px solid var(--border-elegant);
  box-shadow: 0 4px 12px var(--shadow-soft);
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.section-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1rem;
  font-weight: 600;
  color: var(--accent-primary);
  margin-bottom: 1rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.drag-options {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  justify-content: center;
  flex: 1;
}

.drag-item {
  padding: 1.2rem 1.5rem;
  background: #ffffff;
  border: 2px solid var(--border-elegant);
  border-radius: 12px;
  cursor: pointer;
  user-select: none;
  font-weight: 600;
  font-size: 1.3rem;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  box-shadow: 0 2px 8px var(--shadow-soft);
  text-align: center;
}

.drag-item:hover {
  transform: translateX(-4px);
  box-shadow: 0 6px 18px var(--shadow-medium);
  border-color: var(--accent-gold);
}

.drag-item.selected {
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-gold));
  color: #ffffff;
  border-color: var(--accent-primary);
  box-shadow: 0 8px 24px var(--shadow-medium);
  transform: translateX(-6px);
}

.answer-image {
  max-width: 70px;
  max-height: 70px;
  border-radius: 8px;
  object-fit: cover;
}

/* ========== RIGHT PANEL - QUESTIONS & DROP ZONES ========== */
.right-panel {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  height: 100%;
  overflow: hidden;
}

.question-section {
  background: linear-gradient(135deg, #fefefe, #f9f9f9);
  padding: 1.2rem 1.5rem;
  border-radius: 16px;
  border: 1px solid var(--border-elegant);
  box-shadow: 0 4px 12px var(--shadow-soft);
  text-align: center;
}

.question {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.4rem;
  font-weight: 600;
  color: var(--accent-dark);
  line-height: 1.3;
  margin: 0;
}

.question-image {
  max-width: 100%;
  max-height: 200px;
  margin: 0.8rem auto 0;
  border-radius: 12px;
  box-shadow: 0 8px 24px var(--shadow-soft);
  display: block;
}

.drop-section {
  background: #fafafa;
  padding: 1.5rem;
  border-radius: 16px;
  border: 1px solid var(--border-elegant);
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.drop-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  flex: 1;
  justify-content: center;
}

.drop-zone {
  width: 100%;
  min-height: 60px;
  padding: 1rem 1.2rem;
  border-radius: 12px;
  border: 2px dashed var(--accent-gold);
  cursor: pointer;
  font-weight: 500;
  font-size: 1.05rem;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 0.8rem;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px var(--shadow-soft);
}

.drop-zone:hover {
  border-color: var(--accent-primary);
  background: #fafafa;
  transform: translateX(4px);
}

.drop-zone.filled {
  border-style: solid;
  background: linear-gradient(135deg, #f5f0eb, #faf7f4);
  border-color: var(--accent-gold);
}

.dropzone-image {
  max-width: 50px;
  max-height: 50px;
  border-radius: 8px;
  object-fit: cover;
}

/* ========== FEEDBACK ANIMATIONS ========== */
.correct {
  background: linear-gradient(135deg, #e8f5e9, #f1f8f2) !important;
  border-color: #4caf50 !important;
  color: #2e7d32;
  animation: correctPulse 0.6s ease;
}

@keyframes correctPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}

.wrong {
  background: linear-gradient(135deg, #ffebee, #fce4e4) !important;
  border-color: #e53935 !important;
  color: #c62828;
  animation: wrongShake 0.5s ease;
}

@keyframes wrongShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-8px); }
  75% { transform: translateX(8px); }
}

@keyframes gemPop {
  0% { transform: scale(1); }
  50% { transform: scale(1.25) rotate(8deg); }
  100% { transform: scale(1) rotate(0deg); }
}

.gem-pop {
  animation: gemPop 0.5s ease;
}

/* ========== MOTIVATION BOX ========== */
#motivationBox {
  position: fixed;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  max-width: 700px;
  padding: 1rem 2rem;
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--accent-dark);
  background: linear-gradient(135deg, #fff9f0, #fef5e7);
  border-radius: 12px;
  border: 2px solid var(--accent-gold);
  box-shadow: 0 8px 24px var(--shadow-medium);
  text-align: center;
  z-index: 100;
  opacity: 0;
  transition: opacity 0.3s ease;
}

/* ========== NAME FORM ========== */
#nameForm {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2rem;
  background: linear-gradient(135deg, #fefefe, #f9f9f9);
  padding: 3rem 4rem;
  border-radius: 20px;
  max-width: 600px;
  margin: auto;
  box-shadow: 0 12px 40px var(--shadow-medium);
}

.hero-quote {
  width: 100%;
  padding: 2rem;
  background: linear-gradient(135deg, var(--accent-dark), #3a3a3a);
  border-radius: 12px;
  box-shadow: 0 8px 24px var(--shadow-medium);
}

.hero-text {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.5rem;
  font-weight: 600;
  color: #f4e4c1;
  line-height: 1.5;
  font-style: italic;
}

.hero-author {
  margin-top: 1rem;
  font-size: 1.2rem;
  font-weight: 500;
  color: var(--accent-gold);
}

#nameInput,
#departmentSelect {
  width: 100%;
  padding: 1.2rem 1.5rem;
  background: #ffffff;
  border: 2px solid var(--border-elegant);
  border-radius: 12px;
  font-size: 1.05rem;
  font-family: 'Montserrat', sans-serif;
  outline: none;
  transition: all 0.3s ease;
}

#nameInput:focus,
#departmentSelect:focus {
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 4px rgba(139, 115, 85, 0.1);
}

#nameForm button {
  width: 100%;
  padding: 1.2rem;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-gold));
  color: #ffffff;
  font-size: 1.1rem;
  font-weight: 600;
  font-family: 'Montserrat', sans-serif;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 20px var(--shadow-medium);
  letter-spacing: 0.5px;
}

#nameForm button:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px var(--shadow-medium);
}

/* ========== ACTION BUTTONS ========== */
#nextBtn {
  margin: 1rem auto 0;
  padding: 0.8rem 2.5rem;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-gold));
  color: #ffffff;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  display: none;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px var(--shadow-medium);
  font-family: 'Montserrat', sans-serif;
}

#nextBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--shadow-medium);
}

#restartBtn {
  margin: 1rem auto 0;
  padding: 0.8rem 2.5rem;
  background: linear-gradient(135deg, #5a4a3a, #8b7355);
  color: #ffffff;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px var(--shadow-medium);
  display: block;
}

#restartBtn:hover {
  transform: translateY(-2px);
}

/* ========== SCORE CARD ========== */
#scoreCard {
  background: linear-gradient(135deg, #fefefe, #f9f9f9);
  padding: 2.5rem;
  border-radius: 16px;
  border: 2px solid var(--border-elegant);
  font-family: 'Cormorant Garamond', serif;
  line-height: 2;
  font-size: 1.3rem;
  text-align: center;
  box-shadow: 0 12px 40px var(--shadow-medium);
}

#scoreCard p {
  margin: 0.5rem 0;
  font-weight: 500;
}

#scoreCard button {
  margin-top: 1.5rem;
  padding: 1rem 2.5rem;
  background: linear-gradient(135deg, #4caf50, #66bb6a);
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 1.05rem;
  font-weight: 600;
  box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
  transition: all 0.3s ease;
}

#scoreCard button:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 28px rgba(76, 175, 80, 0.4);
}

/* ========== RESPONSIVE ADJUSTMENTS ========== */
@media (max-width: 1200px) {
  .content-wrapper {
    grid-template-columns: 1fr;
    gap: 2rem;
  }
  
  .container {
    height: auto;
    max-height: none;
  }
}

@media (max-width: 768px) {
  .quiz-header {
    grid-template-columns: 1fr;
    gap: 0.5rem;
    padding: 1rem;
  }
  
  .hud-item:nth-child(2),
  .hud-item:nth-child(3) {
    justify-content: flex-start;
  }
  
  .question {
    font-size: 1.4rem;
  }
  
  .content-wrapper {
    padding: 1.5rem;
  }
}

/* ========== LANDSCAPE ORIENTATION LOCK HINT ========== */
@media (orientation: portrait) and (max-width: 768px) {
  body::before {
    content: 'üì± Please rotate your device to landscape mode for the best experience';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--accent-dark);
    color: white;
    padding: 0.8rem;
    text-align: center;
    font-size: 0.9rem;
    z-index: 10000;
  }
}

</style>
</head>

<body>
  <div class="container" id="quizContainer">
    <div class="header-bar"></div>
    
    <!-- NAME FORM -->
    <div id="nameForm">
      <div class="hero-quote">
        <div class="hero-text">
          Ever tried. Ever failed. No matter. Try again. Fail again. Fail better.
        </div>
        <div class="hero-author">ü§ó‚ô•Ô∏è‚ú®</div>
      </div>

      <input 
        type="text" 
        id="nameInput" 
        placeholder="Enter your name"
      />

      <select id="departmentSelect">
        <option value="">-- Select Department --</option>
        <option value="English">English</option>
        <option value="Cyber Security">Cyber Security</option>
        <option value="CSE-1">CSE-1</option>
        <option value="CSE-2">CSE-2</option>
        <option value="CSE-3">CSE-3</option>
        <option value="Mechanical Engineering">Mechanical Engineering</option>
        <option value="ECE-1">ECE-1</option>
        <option value="ECE-2">ECE-2</option>
        <option value="ECE-3">ECE-3</option>
        <option value="AI DS-1">AI DS-1</option>
        <option value="AI DS-2">AI DS-2</option>
        <option value="Civil">Civil</option>
        <option value="Agri">Agri</option>
        <option value="EEE">EEE</option>
        <option value="EIE">EIE</option>
        <option value="Medical Electronics">Medical Electronics</option>
        <option value="IT-1">IT-1</option>
        <option value="IT-2">IT-2</option>
      </select>

      <button onclick="beginQuiz()">Begin Quest</button>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="quizContent" style="display:none;">
      <button id="muteBtn" onclick="toggleMute()" title="Toggle Sound">üîä</button>
      
      <div class="quiz-header">
        <div class="hud-item">
          <span class="hud-icon">‚è≥</span>
          <span id="timer">0s</span>
        </div>
        <div class="hud-item">
          <span class="hud-icon">üíé</span>
          <span id="gemsCounter">0</span>
        </div>
        <div class="hud-item">
          <span class="hud-icon">üìç</span>
          <span id="progressTracker">1 of 1</span>
        </div>
      </div>

      <div class="content-wrapper">
        <!-- LEFT PANEL - OPTIONS -->
        <div class="left-panel">
          <div class="options-section">
            <div class="section-title">Tap to Select</div>
            <div class="drag-options" id="dragOptions"></div>
          </div>
        </div>

        <!-- RIGHT PANEL - QUESTIONS & DROP ZONES -->
        <div class="right-panel">
          <div class="question-section">
            <div class="question" id="question"></div>
            <div id="questionImageContainer"></div>
          </div>
          
          <div class="drop-section">
            <div class="section-title">Complete the Sentences</div>
            <div class="drop-container" id="dropContainer"></div>
          </div>
          
          <button id="nextBtn" onclick="goToNextQuestion()">Continue ‚Üí</button>
          
          <div id="scoreCard"></div>
          <button id="restartBtn" style="display:none;">Restart Quest</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MOTIVATION BOX -->
  <div id="motivationBox"></div>

<script>
/* ========== CONFETTI FUNCTIONS ========== */
function triggerConfetti() {
  confetti({
    particleCount: 100,
    spread: 70,
    origin: { y: 0.6 }
  });
}

function triggerConfettiSides() {
  const duration = 1000;
  const end = Date.now() + duration;

  (function frame() {
    confetti({
      particleCount: 2,
      angle: 60,
      spread: 55,
      origin: { x: 0 },
      colors: ['#8b7355', '#b8966e', '#5a4a3a', '#d4c4b0']
    });
    confetti({
      particleCount: 2,
      angle: 120,
      spread: 55,
      origin: { x: 1 },
      colors: ['#8b7355', '#b8966e', '#5a4a3a', '#d4c4b0']
    });

    if (Date.now() < end) {
      requestAnimationFrame(frame);
    }
  }());
}

function triggerMegaConfetti() {
  const duration = 3000;
  const animationEnd = Date.now() + duration;
  const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  const interval = setInterval(function() {
    const timeLeft = animationEnd - Date.now();

    if (timeLeft <= 0) {
      return clearInterval(interval);
    }

    const particleCount = 50 * (timeLeft / duration);
    
    confetti(Object.assign({}, defaults, { 
      particleCount, 
      origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } 
    }));
    confetti(Object.assign({}, defaults, { 
      particleCount, 
      origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } 
    }));
  }, 250);
}

/* ========== AUDIO SETUP ========== */
const applauseSound = new Audio();
applauseSound.src = 'https://www.myinstants.com/media/sounds/smw_coin.mp3';

const wrongSound = new Audio();
wrongSound.src = 'https://www.myinstants.com/media/sounds/smb_bump.mp3';

applauseSound.volume = 0.5;
wrongSound.volume = 0.5;

applauseSound.load();
wrongSound.load();

let isMuted = false;

function toggleMute() {
  isMuted = !isMuted;
  const muteBtn = document.getElementById('muteBtn');
  
  if (isMuted) {
    muteBtn.innerText = 'üîá';
    muteBtn.title = 'Unmute Sound';
    applauseSound.muted = true;
    wrongSound.muted = true;
  } else {
    muteBtn.innerText = 'üîä';
    muteBtn.title = 'Mute Sound';
    applauseSound.muted = false;
    wrongSound.muted = false;
  }
  
  localStorage.setItem('questSoundMuted', isMuted);
}

function playApplauseSound() {
  if (isMuted) return;
  try {
    applauseSound.currentTime = 0;
    applauseSound.play().catch(err => console.log('Audio play failed:', err));
  } catch (error) {
    console.log('Audio error:', error);
  }
}

function playWrongSound() {
  if (isMuted) return;
  try {
    wrongSound.currentTime = 0;
    wrongSound.play().catch(err => console.log('Audio play failed:', err));
  } catch (error) {
    console.log('Audio error:', error);
  }
}

/* AUTO-RESTORE NAME + DEPT */
window.addEventListener("load", () => {
  const savedName = localStorage.getItem("questPlayerName");
  const savedDept = localStorage.getItem("questPlayerDept");
  if (savedName) document.getElementById("nameInput").value = savedName;
  if (savedDept) document.getElementById("departmentSelect").value = savedDept;
  
  const savedMuteState = localStorage.getItem('questSoundMuted');
  if (savedMuteState === 'true') {
    isMuted = true;
    applauseSound.muted = true;
    wrongSound.muted = true;
    setTimeout(() => {
      const muteBtn = document.getElementById('muteBtn');
      if (muteBtn) {
        muteBtn.innerText = 'üîá';
        muteBtn.title = 'Unmute Sound';
      }
    }, 100);
  }
});

/* MOTIVATION MESSAGES */
const rightMessages = [
  "'name' is unstoppable!",
  "'name' is awesome because 'name' has grit!",
  "'name' has got the right answer because 'name' loves trying!",
  "Nothing can slow 'name' down today!",
  "'name' learns fast because 'name' never gives up!",
  "Who is awesome? 'name'!",
  "'name' proves that effort beats talent every time!",
  "Every correct answer takes 'name' one step closer to greatness!",
  "'name' shines brighter with every question!"
];

const wrongMessages = [
  "'name' loves failures because 'name', like Edison, knows failure is the stepping stone to success.",
  "'name''s favourite quote: 'Ever tried. Ever failed. No matter. Try again. Fail again. Fail better.'",
  "Every mistake makes 'name' stronger.",
  "Mistakes guide 'name' towards victory!",
  "Failure is feedback, and 'name' takes feedback like a champion.",
  "Every wrong attempt brings 'name' closer to the right one.",
  "'name' believes in trying again and again and again!"
];

function showMotivation(isCorrect) {
  const box = document.getElementById("motivationBox");
  const list = isCorrect ? rightMessages : wrongMessages;

  let msg = list[Math.floor(Math.random() * list.length)];
  msg = msg.replace(/'name'/g, playerName);

  box.innerHTML = msg;
  box.style.opacity = 1;
}

const quizData = [
{
  "questionImage": "",
  "questionItems": [
    { 
      "word": "The website ___ showing only the questions.", 
      "answer": "is",
      "itemImage": ""
    },
    { 
      "word": "The questions ___ shown after login.", 
      "answer": "are",
      "itemImage": ""
    }
  ],
  "answers": [
    {
      "text": "is",
      "image": ""
    },
    {
      "text": "are",
      "image": ""
    }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The teacher ___ checking the submissions now.", "answer": "is", "itemImage": "" },
    { "word": "The students ___ waiting for feedback.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The server ___ running slowly today.", "answer": "is", "itemImage": "" },
    { "word": "The pages ___ loading very slowly.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The class ___ ready to start the activity.", "answer": "is", "itemImage": "" },
    { "word": "The students ___ ready with their notebooks.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The app ___ working properly now.", "answer": "is", "itemImage": "" },
    { "word": "The features ___ available after update.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The result page ___ open now.", "answer": "is", "itemImage": "" },
    { "word": "The results ___ visible to students.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The quiz ___ starting in a minute.", "answer": "is", "itemImage": "" },
    { "word": "The students ___ entering the room.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The teacher ___ explaining the rules.", "answer": "is", "itemImage": "" },
    { "word": "The rules ___ easy to understand.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The system ___ updating right now.", "answer": "is", "itemImage": "" },
    { "word": "The files ___ being uploaded.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
},
{
  "questionImage": "",
  "questionItems": [
    { "word": "The classroom ___ quiet now.", "answer": "is", "itemImage": "" },
    { "word": "The students ___ listening carefully.", "answer": "are", "itemImage": "" }
  ],
  "answers": [
    { "text": "is", "image": "" },
    { "text": "are", "image": "" }
  ]
}
];

let current = 0;
let wrongQuestions = [];
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;

const questionEl = document.getElementById("question");
const questionImageContainer = document.getElementById("questionImageContainer");
const dragOptionsEl = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl = document.getElementById("timer");
const gemsCounterEl = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard = document.getElementById("scoreCard");
const restartBtn = document.getElementById("restartBtn");
const nextBtn = document.getElementById("nextBtn");

function beginQuiz() {
  const nameField = document.getElementById("nameInput");
  const deptField = document.getElementById("departmentSelect");

  if (!nameField.value.trim()) { alert("Please enter your name!"); return; }
  if (!deptField.value) { alert("Please select your department!"); return; }

  playerName = nameField.value.trim();
  playerDept = deptField.value;

  localStorage.setItem("questPlayerName", playerName);
  localStorage.setItem("questPlayerDept", playerDept);

  document.getElementById("nameForm").style.display = "none";
  document.getElementById("quizContent").style.display = "block";

  startQuiz();
}

function startQuiz() {
  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();

  gemsCounterEl.innerText = "0";
  scoreCard.innerHTML = "";
  restartBtn.style.display = "none";
  loadQuestion();
  startTimer();
}

function loadQuestion() {
  if (current >= quizData.length) return showScore();

  selectedOption = null;
  nextBtn.style.display = "none";
  const data = quizData[current];
  progressTracker.innerText = `${current + 1} of ${quizData.length}`;

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  questionImageContainer.innerHTML = "";

  if (data.questionImage && data.questionImage.trim() !== "") {
    const img = document.createElement("img");
    img.src = data.questionImage;
    img.classList.add("question-image");
    img.alt = "Question image";
    questionImageContainer.appendChild(img);
  }

  let answersList = [];
  if (data.answers && data.answers.length > 0) {
    if (typeof data.answers[0] === 'string') {
      answersList = data.answers.map(ans => ({ text: ans, image: "" }));
    } else {
      answersList = data.answers;
    }
  }

  const shuffled = [...answersList].sort(() => Math.random() - 0.5);

  shuffled.forEach((ansObj) => {
    const div = document.createElement("div");
    div.classList.add("drag-item");
    div.dataset.answer = ansObj.text;
    
    if (ansObj.image && ansObj.image.trim() !== "") {
      const img = document.createElement("img");
      img.src = ansObj.image;
      img.classList.add("answer-image");
      img.alt = ansObj.text;
      div.appendChild(img);
    }
    
    const textSpan = document.createElement("span");
    textSpan.innerText = ansObj.text;
    div.appendChild(textSpan);
    
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  data.questionItems.forEach((item) => {
    const drop = document.createElement("div");
    drop.classList.add("drop-zone");
    
    if (item.itemImage && item.itemImage.trim() !== "") {
      const img = document.createElement("img");
      img.src = item.itemImage;
      img.classList.add("dropzone-image");
      img.alt = "Drop zone image";
      drop.appendChild(img);
    }
    
    const textSpan = document.createElement("span");
    textSpan.innerText = item.word;
    drop.appendChild(textSpan);
    
    drop.dataset.answer = item.answer;
    drop.onclick = () => placeOption(drop);
    dropContainerEl.appendChild(drop);
  });
}

function selectOption(div) {
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

function placeOption(dropZone) {
  if (!selectedOption) return;

  const answer = selectedOption.dataset.answer;
  const correctAnswer = dropZone.dataset.answer;

  if (answer === correctAnswer) {
    triggerConfetti();
    playApplauseSound();
    
    correctCount++;
    gemsCount++;
    gemsCounterEl.innerText = `${gemsCount}`;
    gemsCounterEl.classList.add('gem-pop');
    setTimeout(() => gemsCounterEl.classList.remove('gem-pop'), 500);
    
    showMotivation(true);

    const textSpan = dropZone.querySelector('span');
    const originalText = textSpan ? textSpan.innerText : dropZone.innerText;
    
    if (textSpan) {
      textSpan.innerHTML = originalText.replace("___", `<strong>${answer}</strong>`);
    } else {
      dropZone.innerHTML = originalText.replace("___", `<strong>${answer}</strong>`);
    }
    
    dropZone.classList.add("correct", "filled");
    selectedOption.style.display = "none";

  } else {
    playWrongSound();
    
    totalWrongGuesses++;
    gemsCount--;
    gemsCounterEl.innerText = `${gemsCount}`;
    showMotivation(false);

    dropZone.classList.add("wrong");
    setTimeout(() => dropZone.classList.remove("wrong"), 600);

    const currentQ = quizData[current];
    if (!wrongQuestions.includes(currentQ)) wrongQuestions.push(currentQ);
  }

  selectedOption.classList.remove("selected");
  selectedOption = null;

  if (document.querySelectorAll(".drop-zone:not(.filled)").length === 0) {
    nextBtn.style.display = "block";
  }
}

function goToNextQuestion() {
  nextBtn.style.display = "none";
  current++;
  if (current >= quizData.length && wrongQuestions.length > 0) {
    quizData.push(...wrongQuestions);
    wrongQuestions = [];
  }
  loadQuestion();
}

function startTimer() {
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    timerEl.innerText = `${elapsed}s`;
  }, 1000);
}

const EDGE_FUNCTION_URL =
  "https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/logQuest";

function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  triggerMegaConfetti();

  questionEl.innerText = "üéâ Quest Completed!";
  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  questionImageContainer.innerHTML = "";
  progressTracker.innerText = "";

  scoreCard.innerHTML = `
    <p><strong>Player:</strong> ${playerName}</p>
    <p><strong>Department:</strong> ${playerDept}</p>
    <p><strong>Correct Answers:</strong> ${correctCount}</p>
    <p><strong>Wrong Attempts:</strong> ${totalWrongGuesses}</p>
    <p><strong>Gems Earned:</strong> ${gemsCount}</p>
    <p><strong>Time Taken:</strong> ${totalTime} seconds</p>
    <button onclick="downloadPDFReport()">
      üì• Download PDF Report
    </button>
  `;

  restartBtn.style.display = "inline-block";

  sendViaEdgeFunction({
    student_name: playerName,
    department: playerDept,
    correct: correctCount,
    wrong: totalWrongGuesses,
    time_spent: totalTime,
    quest_id: "Quest 130"
  });
}

async function sendViaEdgeFunction(payload) {
  try {
    const response = await fetch(EDGE_FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      console.error("‚ùå Edge Function Error:", await response.text());
      return;
    }
    console.log("‚úÖ Saved to Supabase");
  } catch (err) {
    console.error("‚ö†Ô∏è Edge Function Error:", err);
  }
}

function downloadPDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('times', 'bold');
  doc.setFontSize(18);
  doc.text('SRM VALLIAMMAI ENGINEERING COLLEGE', 105, 16, { align: 'center' });
  doc.setFontSize(12);
  doc.setFont('times', 'italic');
  doc.text('(Autonomous)', 105, 23, { align: 'center' });
  doc.setFontSize(15);
  doc.setFont('times', 'normal');
  doc.text('Department of English', 105, 31, { align: 'center' });
  doc.setFontSize(14);
  doc.setFont('times', 'bold');
  doc.setTextColor(212, 175, 55);
  doc.text('Quest Performance Report', 105, 39, { align: 'center' });

  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text('CANDIDATE INFORMATION', 20, 55);
  doc.autoTable({
    startY: 58,
    body: [
      ['Student Name', playerName],
      ['Department', playerDept],
      ['Quest ID', 'Quest 130'],
      ['Completed On', reportDate]
    ],
    theme: 'plain',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: 'bold', cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 }
    },
    margin: { left: 20, right: 20 }
  });

  let y = doc.lastAutoTable.finalY + 10;
  doc.setFont('times', 'bold');
  doc.text('PERFORMANCE SUMMARY', 20, y);
  y += 4;
  doc.autoTable({
    startY: y + 3,
    body: [
      ['Total Questions', quizData.length.toString()],
      ['Correct Answers', correctCount.toString()],
      ['Wrong Attempts', totalWrongGuesses.toString()],
      ['Final Gems Earned', gemsCount.toString()],
      ['Total Time', `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`]
    ],
    theme: 'grid',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    margin: { left: 20, right: 20 }
  });

  y = doc.lastAutoTable.finalY + 12;
  if (y > 250) { doc.addPage(); y = 20; }
  doc.setFont('times', 'bold');
  doc.text('QUESTION BANK WITH CORRECT ANSWERS', 20, y);
  y += 6;

  quizData.forEach((item, i) => {
    if (y > 260) { doc.addPage(); y = 20; }
    doc.setFontSize(11);
    doc.setFont('times', 'bold');
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, 20, y);
    y += 6;
    doc.setTextColor(0, 0, 0);
    doc.setFont('times', 'normal');
    item.questionItems.forEach((qItem, j) => {
      const questionText = `${j + 1}. ${qItem.word.replace('___', '____')} `;
      const answerText = `Answer: ${qItem.answer}`;
      const lines = doc.splitTextToSize(questionText, 160);
      doc.text(lines, 25, y);
      y += lines.length * 5;
      doc.setTextColor(0, 128, 0);
      doc.text(answerText, 30, y);
      doc.setTextColor(0, 0, 0);
      y += 7;
    });
    y += 3;
    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.3);
    doc.line(20, y, 190, y);
    y += 5;
  });

  doc.setDrawColor(184, 134, 11);
  doc.setLineWidth(0.5);
  doc.line(20, 280, 190, 280);
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.setFont('times', 'italic');
  doc.text('This is a system-generated report', 105, 287, { align: 'center' });

  const cleanName = playerName.replace(/[^a-zA-Z0-9]/g, '_');
  doc.save(`${cleanName}_Quest130_Report.pdf`);
}

restartBtn.onclick = () => {
  document.getElementById("quizContent").style.display = "none";
  document.getElementById("nameForm").style.display = "block";
  document.getElementById("nameInput").value = "";
};
</script>
</body>
</html>
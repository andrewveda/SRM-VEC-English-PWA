<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pilot Profile ‚Äî Mission: Veni, Vidi, Vici!</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-main: #f5f3ff;
      --bg-card: #ffffff;
      --bg-soft: #eef2ff;
      --border-soft: rgba(129, 140, 248, 0.25);
      --text-main: #111827;
      --text-soft: #6b7280;
      --accent-1: #6366f1;
      --accent-2: #f97316;
      --accent-3: #06b6d4;
      --accent-4: #22c55e;
      --danger: #ef4444;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.10);
      --radius-lg: 20px;
      --radius-md: 14px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background:
        radial-gradient(circle at 10% 0%, rgba(196, 181, 253, 0.60), transparent 60%),
        radial-gradient(circle at 90% 20%, rgba(96, 165, 250, 0.50), transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(251, 191, 36, 0.35), transparent 60%),
        var(--bg-main);
      padding: 18px 10px 32px;
      overflow-x: hidden;
    }

    /* Soft glitter background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(circle at 2px 2px, rgba(250, 250, 255, 0.65) 1px, transparent 0),
        radial-gradient(circle at 1px 1px, rgba(191, 219, 254, 0.5) 1px, transparent 0);
      background-size: 40px 40px;
      opacity: 0.4;
      pointer-events: none;
      z-index: -1;
      animation: twinkle 10s linear infinite alternate;
    }

    @keyframes twinkle {
      0% { transform: translate3d(0, 0, 0); opacity: 0.35; }
      100% { transform: translate3d(-20px, 15px, 0); opacity: 0.55; }
    }

    .orb {
      position: fixed;
      border-radius: 999px;
      filter: blur(35px);
      opacity: 0.7;
      z-index: -1;
      mix-blend-mode: screen;
      animation: floatOrb 18s ease-in-out infinite alternate;
    }

    .orb.orb-1 {
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, #bfdbfe, transparent 70%);
      top: -40px;
      left: -30px;
    }

    .orb.orb-2 {
      width: 260px;
      height: 260px;
      background: radial-gradient(circle, #fbbf24, transparent 70%);
      bottom: -60px;
      right: -40px;
      animation-delay: 4s;
    }

    @keyframes floatOrb {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(20px, -25px, 0); }
    }

    .shell {
      max-width: 1080px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.82);
      border-radius: 28px;
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.20);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(20px);
      padding: 18px 18px 22px;
      position: relative;
      overflow: hidden;
      animation: floatIn 0.8s ease-out;
    }

    @keyframes floatIn {
      0% {
        opacity: 0;
        transform: translate3d(0, 14px, 0) scale(0.98);
      }
      100% {
        opacity: 1;
        transform: translate3d(0, 0, 0) scale(1);
      }
    }

    .shell::before {
      content: "SRM VEC ‚Ä¢ ENGLISH";
      position: absolute;
      top: 10px;
      right: 18px;
      font-size: 9px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
    }

    /* HEADER *********************************** */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .badge-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.4);
      background: linear-gradient(135deg, #eef2ff, #fefce8);
      font-size: 10px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #4b5563;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
      animation: pulseDot 1.3s infinite;
    }

    @keyframes pulseDot {
      0% { transform: scale(1); opacity: 1; }
      70% { transform: scale(1.7); opacity: 0; }
      100% { transform: scale(1.7); opacity: 0; }
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-main {
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: linear-gradient(120deg, #4f46e5, #ec4899, #f59e0b);
      -webkit-background-clip: text;
      color: transparent;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill-btn {
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.5);
      padding: 7px 12px;
      font-size: 11px;
      font-weight: 600;
      background: linear-gradient(135deg, #eef2ff, #ede9fe);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #4338ca;
      box-shadow: 0 8px 20px rgba(129, 140, 248, 0.25);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .pill-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 25px rgba(79, 70, 229, 0.35);
    }

    .pill-btn.secondary {
      background: #ffffff;
      color: #4b5563;
      border-color: rgba(156, 163, 175, 0.7);
      box-shadow: 0 6px 15px rgba(148, 163, 184, 0.30);
    }

    .info-banner {
      margin-bottom: 16px;
      font-size: 11px;
      color: #6b7280;
      padding: 8px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(129, 140, 248, 0.12), rgba(251, 191, 36, 0.12));
      border: 1px dashed rgba(148, 163, 184, 0.8);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-banner span.icon {
      font-size: 14px;
    }

    /* ENTRY SCREEN ****************************** */
    #entry-screen {
      margin-top: 10px;
      display: none; /* toggled via JS */
      animation: fadeUp 0.5s ease-out;
    }

    @keyframes fadeUp {
      0% { opacity: 0; transform: translate3d(0, 10px, 0); }
      100% { opacity: 1; transform: translate3d(0, 0, 0); }
    }

    .entry-card {
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(239, 246, 255, 0.96), rgba(254, 249, 195, 0.96));
      border: 1px solid rgba(129, 140, 248, 0.35);
      box-shadow: var(--shadow-soft);
      padding: 16px 16px 18px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 14px;
      align-items: center;
    }

    .entry-card-left h2 {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 6px;
      color: #1f2933;
    }

    .entry-card-left p {
      font-size: 13px;
      color: #4b5563;
      line-height: 1.5;
    }

    .sparkle-row {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .entry-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #4b5563;
    }

    input {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      background: rgba(255, 255, 255, 0.9);
      transition: border-color 0.12s ease, box-shadow 0.12s ease, transform 0.12s ease;
    }

    input:focus {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
      transform: translateY(-0.5px);
    }

    .entry-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    /* PROFILE SCREEN **************************** */
    #profile-screen {
      display: none; /* toggled via JS */
      margin-top: 12px;
      animation: fadeUp 0.6s ease-out;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1.1fr);
      gap: 16px;
    }

    @media (max-width: 880px) {
      .entry-card {
        grid-template-columns: minmax(0, 1fr);
      }
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* PROFILE COLUMN **************************** */
    .profile-card {
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 16px;
      position: relative;
      overflow: hidden;
    }

    .profile-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 0 -10%, rgba(196, 181, 253, 0.45), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
      z-index: 0;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 1;
      margin-bottom: 10px;
    }

    .avatar-circle {
      width: 54px;
      height: 54px;
      border-radius: 18px;
      background: conic-gradient(
        from 180deg,
        rgba(129, 140, 248, 0.9),
        rgba(236, 72, 153, 0.9),
        rgba(251, 191, 36, 0.9),
        rgba(59, 130, 246, 0.9),
        rgba(129, 140, 248, 0.9)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 22px;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.9);
      position: relative;
      overflow: hidden;
      animation: spinSlow 22s linear infinite;
    }

    .avatar-inner {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    @keyframes spinSlow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .pilot-text-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .pilot-name {
      font-size: 18px;
      font-weight: 800;
      color: #111827;
    }

    .pilot-subline {
      font-size: 12px;
      color: #4b5563;
    }

    .tag-row {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tiny-tag {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(156, 163, 175, 0.7);
      background: rgba(249, 250, 251, 0.98);
      color: #374151;
    }

    .last-mission-pill {
      font-size: 11px;
      padding: 6px 9px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.08);
      border: 1px dashed rgba(34, 197, 94, 0.6);
      color: #166534;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: absolute;
      right: 12px;
      top: 14px;
      backdrop-filter: blur(8px);
    }

    .last-mission-pill span.icon {
      font-size: 14px;
    }

    /* STAT GRID ********************************* */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
      position: relative;
      z-index: 1;
    }

    .stat-card {
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, #f9fafb, #eef2ff);
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 8px 9px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      position: relative;
      overflow: hidden;
      transform: translateY(3px);
      opacity: 0;
      animation: statPop 0.6s ease-out forwards;
    }

    .stat-card:nth-child(1) { animation-delay: 0.05s; }
    .stat-card:nth-child(2) { animation-delay: 0.10s; }
    .stat-card:nth-child(3) { animation-delay: 0.15s; }
    .stat-card:nth-child(4) { animation-delay: 0.20s; }
    .stat-card:nth-child(5) { animation-delay: 0.25s; }
    .stat-card:nth-child(6) { animation-delay: 0.30s; }

    @keyframes statPop {
      0% { opacity: 0; transform: translateY(8px) scale(0.97); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .stat-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #6b7280;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 800;
      color: #111827;
      font-variant-numeric: tabular-nums;
    }

    .stat-foot {
      font-size: 11px;
      color: #6b7280;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(209, 213, 219, 0.8);
      overflow: hidden;
      margin-top: 3px;
    }

    .progress-inner {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #facc15);
      transition: width 0.6s ease-out;
    }

    /* TIMELINE ********************************** */
    .timeline-card {
      margin-top: 12px;
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 12px 12px 14px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .section-title span.icon {
      font-size: 17px;
    }

    .section-sub {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .timeline-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }

    .timeline-column-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #4b5563;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 3px 7px;
      font-size: 10px;
      background: #f9fafb;
    }

    .timeline-list {
      max-height: 170px;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.9) transparent;
    }

    .timeline-list::-webkit-scrollbar {
      width: 4px;
    }

    .timeline-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .timeline-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.8);
      border-radius: 999px;
    }

    .timeline-item {
      padding: 5px 7px;
      border-radius: 10px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      background: #f9fafb;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 4px;
      animation: floatItem 0.5s ease-out;
    }

    @keyframes floatItem {
      0% { opacity: 0; transform: translateY(4px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .timeline-item-title {
      font-weight: 600;
      color: #111827;
    }

    .timeline-item-meta {
      font-size: 10px;
      color: #6b7280;
    }

    .badge-quest   { color: #b91c1c; }
    .badge-video   { color: #1d4ed8; }
    .badge-story   { color: #92400e; }

    /* RIGHT COLUMN: CALENDAR + SUMMARY ********** */
    .calendar-card {
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      padding: 12px 12px 14px;
    }

    .calendar-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .mini-cal-title {
      text-align: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #4f46e5;
      margin-bottom: 4px;
    }

    .mini-cal-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 3px;
      font-size: 9px;
    }

    .mini-cal-grid > div:nth-child(-n+7) {
      text-align: center;
      font-weight: 600;
      color: #9ca3af;
      padding-bottom: 3px;
    }

    .mini-cal-day {
      min-height: 36px;
      border-radius: 8px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      display: flex;
      flex-direction: column;
      padding: 3px;
      background: #f9fafb;
      position: relative;
      overflow: hidden;
    }

    .mini-cal-day.marked {
      border-color: rgba(34, 197, 94, 0.9);
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.16), #ecfdf3);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.35);
      animation: glowDay 1s ease-out;
    }

    @keyframes glowDay {
      0% { box-shadow: 0 0 0 rgba(34, 197, 94, 0.0); }
      100% { box-shadow: 0 0 12px rgba(34, 197, 94, 0.35); }
    }

    .mini-cal-date {
      font-weight: 700;
      color: #111827;
      margin-bottom: 2px;
    }

    .mini-cal-items {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      font-size: 10px;
    }

    .legend-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .legend-item {
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 6px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
    }

    .summary-card {
      margin-top: 10px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, #eef2ff, #fef3c7);
      border: 1px solid rgba(129, 140, 248, 0.5);
      padding: 10px;
      font-size: 11px;
      color: #4b5563;
    }

    .summary-card strong {
      color: #111827;
    }

    /* LOADER & ERROR **************************** */
    .loader {
      display: none;
      margin-top: 8px;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #4b5563;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(156, 163, 175, 0.5);
      border-top-color: #6366f1;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-text {
      margin-top: 6px;
      font-size: 11px;
      color: #b91c1c;
    }

  </style>
</head>
<body>
  <!-- soft floating glows -->
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <div class="shell">
    <header class="header">
      <div class="header-left">
        <div class="badge-pill">
          <span class="badge-dot"></span>
          Mission: Veni, Vidi, Vici!
        </div>
        <div class="title-block">
          <div class="title-main">Pilot Profile</div>
          <div class="subtitle">Zoom into a single cadet‚Äôs English mission stats ‚ú®</div>
        </div>
      </div>
      <div class="header-right">
        <button id="btn-clear" class="pill-btn secondary">
          ‚èè Clear Pilot &amp; Re-select
        </button>
      </div>
    </header>

    <div id="info-banner" class="info-banner">
      <span class="icon">üß≠</span>
      <span>
        If you open this page from the leaderboard, it auto-loads that pilot from local storage.
        Otherwise, enter name &amp; department below.
      </span>
    </div>

    <!-- ENTRY SCREEN (fallback) -->
    <section id="entry-screen">
      <div class="entry-card">
        <div class="entry-card-left">
          <div class="sparkle-row">‚ú®üßô‚Äç‚ôÇÔ∏èüìö</div>
          <h2>Summon a Pilot‚Äôs Profile</h2>
          <p>
            Type the <strong>exact name</strong> and <strong>department</strong> used in
            <code>report_card_view</code>, and I‚Äôll pull a fully enchanted mission dossier
            from Supabase for that cadet.
          </p>
        </div>
        <form id="lookup-form" class="entry-form">
          <div class="field-group">
            <label for="pilot-name">Pilot Name</label>
            <input id="pilot-name" type="text" placeholder="e.g., Priya S" required />
          </div>
          <div class="field-group">
            <label for="pilot-dept">Department</label>
            <input id="pilot-dept" type="text" placeholder="e.g., CSE A / Cyber / IT" required />
          </div>
          <div class="entry-actions">
            <button class="pill-btn" type="submit">
              üîÆ Fetch from Supabase
            </button>
            <div id="entry-loader" class="loader">
              <div class="spinner"></div>
              <span>Consulting the mission archives...</span>
            </div>
          </div>
          <div id="entry-error" class="error-text"></div>
        </form>
      </div>
    </section>

    <!-- PROFILE SCREEN -->
    <section id="profile-screen">
      <div class="layout">
        <!-- LEFT: PROFILE & TIMELINE -->
        <div>
          <div class="profile-card">
            <div class="profile-header">
              <div class="avatar-circle">
                <div class="avatar-inner" id="avatar-initials">AA</div>
              </div>
              <div class="pilot-text-block">
                <div class="pilot-name" id="pilot-name-display">Pilot Name</div>
                <div class="pilot-subline">
                  <span id="pilot-dept-display">Department</span> ‚Ä¢
                  <span id="pilot-missions-display">0 missions logged</span>
                </div>
                <div class="tag-row">
                  <div class="tiny-tag">Leaderboard Pilot</div>
                  <div class="tiny-tag" id="pilot-tag-accuracy">Accuracy: 0%</div>
                </div>
              </div>
              <div class="last-mission-pill">
                <span class="icon">‚è±</span>
                <span id="pilot-last-mission">Last mission: ‚Äî</span>
              </div>
            </div>

            <div class="stat-grid">
              <div class="stat-card">
                <div class="stat-label">Total Score</div>
                <div class="stat-value" id="stat-total-score">0</div>
                <div class="stat-foot">Mission points</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Accuracy</div>
                <div class="stat-value" id="stat-accuracy">0%</div>
                <div class="progress-bar">
                  <div id="progress-accuracy" class="progress-inner"></div>
                </div>
                <div class="stat-foot">Hit rate</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Attempts</div>
                <div class="stat-value" id="stat-attempts">0</div>
                <div class="stat-foot">Shots fired</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Correct</div>
                <div class="stat-value" id="stat-correct">0</div>
                <div class="stat-foot">Direct hits</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Wrong</div>
                <div class="stat-value" id="stat-wrong">0</div>
                <div class="stat-foot">Near misses</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Time on Mission</div>
                <div class="stat-value" id="stat-time">0h 0m 0s</div>
                <div class="stat-foot">Cumulative</div>
              </div>
            </div>
          </div>

          <div class="timeline-card">
            <div class="section-title">
              <span class="icon">üìú</span>
              <span>Quest, Video & Story Log</span>
            </div>
            <div class="section-sub">
              All missions are mapped from <strong>Day 1 (25 Aug 2025)</strong> onward, using the same
              numbering magic as your leaderboard.
            </div>

            <div class="timeline-grid">
              <div>
                <div class="timeline-column-title">
                  <span>‚ô•Ô∏è</span> QUESTS
                  <span class="chip">
                    Total: <span id="chip-quest-count">0</span>
                  </span>
                </div>
                <div class="timeline-list" id="timeline-quests"></div>
              </div>
              <div>
                <div class="timeline-column-title">
                  <span>üòç</span> VIDEOS
                  <span class="chip">
                    Total: <span id="chip-video-count">0</span>
                  </span>
                </div>
                <div class="timeline-list" id="timeline-videos"></div>
              </div>
              <div>
                <div class="timeline-column-title">
                  <span>üìö</span> STORIES
                  <span class="chip">
                    Total: <span id="chip-story-count">0</span>
                  </span>
                </div>
                <div class="timeline-list" id="timeline-stories"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: CALENDAR & SUMMARY -->
        <div>
          <div class="calendar-card">
            <div class="section-title">
              <span class="icon">üß≠</span>
              <span>Magical Activity Calendar</span>
            </div>
            <div class="section-sub">
              Days with Quests, Videos, or Stories shimmer in green.
            </div>

            <div id="calendar-container" class="calendar-grid"></div>

            <div class="legend-row">
              <div class="legend-item">
                <div class="legend-dot" style="background:#22c55e;"></div>
                Active day
              </div>
              <div class="legend-item">
                ‚ô•Ô∏è Quest
              </div>
              <div class="legend-item">
                üòç Video
              </div>
              <div class="legend-item">
                üìú Story
              </div>
            </div>

            <div class="summary-card" id="summary-card">
              <strong>Mission summary:</strong> no missions logged yet.
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // === IMPORTANT: full Supabase project details (no "..." truncation) ===
    const supabaseUrl = "https://ahezssoczvpbkteffcgz.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE";

    const supabase = createClient(supabaseUrl, supabaseKey);

    // Same start date as leaderboard
    const START_DATE = new Date("2025-08-25");

    // === Helpers ===========================================================
    function formatDateTime(dateStr) {
      if (!dateStr) return "No missions yet";
      const d = new Date(dateStr);
      if (isNaN(d)) return "No missions yet";
      return d.toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      });
    }

    function formatTimeHMSS(seconds) {
      if (!seconds && seconds !== 0) return "0h 0m 0s";
      const s = Math.round(seconds);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${h}h ${m}m ${sec}s`;
    }

    function getInitials(name = "") {
      return name
        .split(" ")
        .filter(Boolean)
        .slice(0, 2)
        .map(part => part[0]?.toUpperCase() || "")
        .join("") || "AA";
    }

    function mapToDate(number) {
      const d = new Date(START_DATE);
      d.setDate(d.getDate() + (number - 1));
      return d;
    }

    function parseItems(rawList) {
      if (!rawList || rawList === "NULL") return [];
      return rawList
        .split(",")
        .map(item => item.trim())
        .filter(item => item.length > 0)
        .map(item => {
          const [type, num] = item.split(" ");
          return {
            type,
            number: Number(num),
            label: item,
            date: mapToDate(Number(num))
          };
        });
    }

    function groupByDate(quests, videos, stories) {
      const map = {};
      const add = (item, icon) => {
        const key = item.date.toDateString();
        if (!map[key]) map[key] = [];
        map[key].push({ icon, label: item.label });
      };
      quests.forEach(q => add(q, "‚ô•Ô∏è"));
      videos.forEach(v => add(v, "üòç"));
      stories.forEach(s => add(s, "üìú"));
      return map;
    }

    function renderTimeline(list, containerId, typeLabel) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      if (!list || list.length === 0) {
        container.innerHTML = `<div class="timeline-item"><div class="timeline-item-meta">No ${typeLabel.toLowerCase()} yet.</div></div>`;
        return;
      }

      const sorted = [...list].sort((a, b) => a.number - b.number);

      sorted.forEach(item => {
        const wrapper = document.createElement("div");
        wrapper.className = "timeline-item";

        const dateStr = item.date.toLocaleDateString("en-IN", {
          day: "2-digit",
          month: "short",
          year: "numeric"
        });

        const typeClass =
          typeLabel === "QUESTS" ? "badge-quest" :
          typeLabel === "VIDEOS" ? "badge-video" :
          "badge-story";

        wrapper.innerHTML = `
          <div class="timeline-item-title">
            <span class="${typeClass}">
              ${
                typeLabel === "QUESTS" ? "‚ô•Ô∏è Quest" :
                typeLabel === "VIDEOS" ? "üòç Video" : "üìú Story"
              }
            </span>
            &nbsp;${item.number}
          </div>
          <div class="timeline-item-meta">
            ${dateStr} ¬∑ Label: <strong>${item.label}</strong>
          </div>
        `;

        container.appendChild(wrapper);
      });
    }

    function renderCalendar(grouped) {
      const container = document.getElementById("calendar-container");
      container.innerHTML = "";

      const today = new Date();
      let cursor = new Date(START_DATE.getFullYear(), START_DATE.getMonth(), 1);
      const end = new Date(today.getFullYear(), today.getMonth(), 1);

      while (cursor <= end) {
        container.innerHTML += renderOneMonth(cursor, grouped);
        cursor.setMonth(cursor.getMonth() + 1);
      }
    }

    function renderOneMonth(baseDate, grouped) {
      const year = baseDate.getFullYear();
      const month = baseDate.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const numDays = new Date(year, month + 1, 0).getDate();

      let html = `
        <div>
          <div class="mini-cal-title">
            ${baseDate.toLocaleString("en-IN", { month: "long", year: "numeric" })}
          </div>
          <div class="mini-cal-grid">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
            <div>Thu</div><div>Fri</div><div>Sat</div>
      `;

      for (let i = 0; i < firstDay; i++) {
        html += `<div></div>`;
      }

      for (let d = 1; d <= numDays; d++) {
        const date = new Date(year, month, d);
        const key = date.toDateString();
        const items = grouped[key];

        if (items && items.length > 0) {
          html += `
            <div class="mini-cal-day marked">
              <div class="mini-cal-date">${d}</div>
              <div class="mini-cal-items">
                ${items.map(i => `<span>${i.icon}</span>`).join("")}
              </div>
            </div>
          `;
        } else {
          html += `
            <div class="mini-cal-day">
              <div class="mini-cal-date">${d}</div>
            </div>
          `;
        }
      }

      html += `</div></div>`;
      return html;
    }

    function buildSummaryText(pilot, quests, videos, stories) {
      const totalMissions = quests.length + videos.length + stories.length;
      if (totalMissions === 0) {
        return `No quests, videos, or stories logged yet. The magic is waiting for ${
          pilot.name || "this pilot"
        } to begin.`;
      }

      const acc = Math.round((pilot.accuracy || 0) * 100);
      return `
        <strong>${pilot.name}</strong> has completed <strong>${totalMissions}</strong> missions so far:
        <strong>${quests.length}</strong> quests, <strong>${videos.length}</strong> videos, and
        <strong>${stories.length}</strong> stories. Accuracy is holding at <strong>${acc}%</strong>,
        with a total mission time of <strong>${formatTimeHMSS(pilot.total_time || 0)}</strong>.
      `;
    }

    function renderProfile(pilot) {
      // === Basic fields
      const name = pilot.name || "Unknown Pilot";
      const dept = pilot.department || "Unknown Department";
      const totalScore = pilot.total_score || 0;
      const accuracy = Math.round((pilot.accuracy || 0) * 100);
      const attempts = pilot.total_attempts || 0;
      const correct = pilot.total_correct || 0;
      const wrong = pilot.total_wrong || 0;
      const totalTime = pilot.total_time || 0;
      const lastMission = pilot.last_test_taken || null;

      // === DOM references
      document.getElementById("avatar-initials").textContent = getInitials(name);
      document.getElementById("pilot-name-display").textContent = name;
      document.getElementById("pilot-dept-display").textContent = dept;
      document.getElementById("pilot-tag-accuracy").textContent = `Accuracy: ${accuracy}%`;
      document.getElementById("pilot-last-mission").textContent =
        "Last mission: " + formatDateTime(lastMission);

      document.getElementById("stat-total-score").textContent = totalScore;
      document.getElementById("stat-accuracy").textContent = `${accuracy}%`;
      document.getElementById("stat-attempts").textContent = attempts;
      document.getElementById("stat-correct").textContent = correct;
      document.getElementById("stat-wrong").textContent = wrong;
      document.getElementById("stat-time").textContent = formatTimeHMSS(totalTime);

      const progressBar = document.getElementById("progress-accuracy");
      progressBar.style.width = `${Math.min(accuracy, 100)}%`;

      // === Parse quest/video/story lists
      const quests = parseItems(pilot.quest_list);
      const videos = parseItems(pilot.video_list);
      const stories = parseItems(pilot.story_list);

      // Missions chip
      const totalMissions = quests.length + videos.length + stories.length;
      document.getElementById("pilot-missions-display").textContent =
        `${totalMissions} mission${totalMissions === 1 ? "" : "s"} logged`;

      // Chips counts
      document.getElementById("chip-quest-count").textContent = quests.length;
      document.getElementById("chip-video-count").textContent = videos.length;
      document.getElementById("chip-story-count").textContent = stories.length;

      // Timeline sections
      renderTimeline(quests, "timeline-quests", "QUESTS");
      renderTimeline(videos, "timeline-videos", "VIDEOS");
      renderTimeline(stories, "timeline-stories", "STORIES");

      // Calendar
      const grouped = groupByDate(quests, videos, stories);
      renderCalendar(grouped);

      // Summary text
      document.getElementById("summary-card").innerHTML = buildSummaryText(
        pilot,
        quests,
        videos,
        stories
      );

      // UI toggles
      document.getElementById("profile-screen").style.display = "block";
    }

    async function fetchPilotFromSupabase(name, dept) {
      const loader = document.getElementById("entry-loader");
      const errorBox = document.getElementById("entry-error");
      loader.style.display = "flex";
      errorBox.textContent = "";

      const { data, error } = await supabase
        .from("report_card_view")
        .select("*")
        .eq("name", name)
        .eq("department", dept);

      loader.style.display = "none";

      if (error) {
        console.error(error);
        errorBox.textContent = "Supabase error while fetching pilot. Check console.";
        return null;
      }

      if (!data || data.length === 0) {
        errorBox.textContent = "No matching pilot found. Check name & department.";
        return null;
      }

      if (data.length > 1) {
        errorBox.textContent =
          "Multiple pilots matched. Please ensure name + department is unique.";
      }

      // Just take the first row as the pilot
      return data[0];
    }

    function showEntryScreen() {
      document.getElementById("entry-screen").style.display = "block";
      document.getElementById("profile-screen").style.display = "none";
      document.getElementById("info-banner").innerHTML =
        '<span class="icon">üßô‚Äç‚ôÇÔ∏è</span><span>No pilot found in local storage. Use the form below to summon one from Supabase.</span>';
    }

    function showLoadedFromLocalMessage() {
      document.getElementById("info-banner").innerHTML =
        '<span class="icon">‚ú®</span><span>Pilot loaded from local storage (selected on the leaderboard). You can clear &amp; re-select using the button above.</span>';
    }

    function clearPilot() {
      localStorage.removeItem("selectedPilot");
      showEntryScreen();
    }

    // === INIT ===============================================================
    window.addEventListener("DOMContentLoaded", () => {
      const saved = localStorage.getItem("selectedPilot");

      if (saved) {
        try {
          const pilot = JSON.parse(saved);
          renderProfile(pilot);
          showLoadedFromLocalMessage();
        } catch (e) {
          console.error("Failed to parse saved pilot:", e);
          showEntryScreen();
        }
      } else {
        showEntryScreen();
      }

      // Entry form submit
      document.getElementById("lookup-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("pilot-name").value.trim();
        const dept = document.getElementById("pilot-dept").value.trim();

        if (!name || !dept) return;

        const pilot = await fetchPilotFromSupabase(name, dept);
        if (pilot) {
          // Save to localStorage so future visits auto-load
          localStorage.setItem("selectedPilot", JSON.stringify(pilot));
          document.getElementById("entry-screen").style.display = "none";
          renderProfile(pilot);
          showLoadedFromLocalMessage();
        }
      });

      // Clear button
      document.getElementById("btn-clear").addEventListener("click", () => {
        clearPilot();
      });
    });
  </script>
</body>
</html>

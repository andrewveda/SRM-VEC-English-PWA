<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>V for Video üåå</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;800&family=Syne:wght@400;600;700&display=swap">
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    :root {
      --bg: #07080f;
      --surface: #0e1020;
      --card: #12152a;
      --border: rgba(255,255,255,0.07);
      --gold: #f5c842;
      --gold-dim: rgba(245,200,66,0.18);
      --accent: #6c63ff;
      --accent-soft: rgba(108,99,255,0.2);
      --text: #e2e0f0;
      --muted: rgba(255,255,255,0.38);
      --green: #23d18b;
      --r: 12px;
      --font-head: 'Orbitron', monospace;
      --font-body: 'Syne', sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Stars */
    #stars { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    .star {
      position: absolute; border-radius: 50%; background: #fff;
      animation: tw var(--d,3s) ease-in-out infinite var(--dl,0s);
    }
    @keyframes tw {
      0%,100% { opacity: var(--lo,.05); }
      50%      { opacity: var(--hi,.7); }
    }
    body::before {
      content:''; position:fixed; width:700px; height:700px;
      background: radial-gradient(circle, rgba(108,99,255,.09) 0%, transparent 65%);
      top:-250px; left:-200px; border-radius:50%; pointer-events:none; z-index:0;
    }
    body::after {
      content:''; position:fixed; width:500px; height:500px;
      background: radial-gradient(circle, rgba(245,200,66,.06) 0%, transparent 65%);
      bottom:-150px; right:-100px; border-radius:50%; pointer-events:none; z-index:0;
    }

    /* Nav */
    nav {
      position: sticky; top: 0; z-index: 100;
      background: rgba(7,8,15,.88);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid var(--border);
      padding: 0 2rem;
      height: 60px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .logo {
      font-family: var(--font-head);
      font-size: .85rem;
      letter-spacing: .25em;
      color: var(--gold);
      text-shadow: 0 0 18px rgba(245,200,66,.45);
    }

    /* ‚îÄ‚îÄ MENU BUTTON ‚îÄ‚îÄ */
    .menu-btn {
      display: none;
      align-items: center; justify-content: center;
      width: 40px; height: 40px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all .2s;
      position: relative;
    }
    .menu-btn:hover { border-color: var(--gold); background: var(--gold-dim); }
    .menu-btn svg { transition: transform .2s; }
    .menu-btn.open svg { transform: rotate(90deg); }

    .menu-dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 200px;
      background: #1a1c35;
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: .6rem;
      box-shadow: 0 16px 40px rgba(0,0,0,.6);
      animation: dropIn .18s ease forwards;
    }
    .menu-dropdown.open { display: block; }
    @keyframes dropIn {
      from { opacity:0; transform:translateY(-6px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .menu-dropdown-header {
      padding: .5rem .75rem .4rem;
      font-size: .7rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      margin-bottom: .4rem;
    }
    .menu-user-name {
      padding: .45rem .75rem;
      font-size: .88rem;
      font-weight: 600;
      color: var(--text);
    }
    .menu-user-dept {
      padding: .2rem .75rem .5rem;
      font-size: .78rem;
      color: var(--gold);
    }

    /* Wrap */
    .wrap {
      position: relative; z-index: 1;
      max-width: 1280px;
      margin: 0 auto;
      padding: 2rem 1.5rem 5rem;
    }

    /* Screens */
    .screen { display: none; }
    .screen.active { display: block; }

    /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
    .login-wrap { max-width: 440px; margin: 6vh auto 0; }
    .login-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 0 80px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.05);
      animation: slideUp .5s ease forwards;
    }
    @keyframes slideUp {
      from { opacity:0; transform:translateY(24px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .login-title {
      font-family: var(--font-head);
      font-size: 1rem;
      letter-spacing: .2em;
      color: var(--gold);
      text-align: center;
      margin-bottom: 1.8rem;
      text-shadow: 0 0 16px rgba(245,200,66,.4);
    }
    .quotes { margin-bottom: 1.8rem; display:flex; flex-direction:column; gap:.7rem; }
    .quote {
      border-left: 2px solid var(--gold-dim);
      padding: .3rem .85rem;
      font-size: .78rem;
      color: rgba(245,200,66,.6);
      font-style: italic; line-height: 1.5;
    }
    .quote em { font-style:normal; color:rgba(245,200,66,.4); font-size:.73rem; }

    .field-label {
      display: block;
      font-size: .72rem; letter-spacing: .12em; text-transform: uppercase;
      color: var(--muted); margin-bottom: .4rem; margin-top: 1rem;
    }
    select, input[type=text] {
      width: 100%; padding: .75rem 1rem;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--border);
      border-radius: var(--r);
      color: var(--text); font-family: var(--font-body); font-size: .9rem;
      outline: none; transition: border-color .2s, box-shadow .2s; appearance: none;
    }
    select:focus, input:focus {
      border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft);
    }
    select option { background: #1a1b30; }
    .btn-launch {
      width: 100%; margin-top: 1.6rem; padding: .9rem;
      background: linear-gradient(135deg, #5a50e0, #8b7fff);
      color: white; font-family: var(--font-body); font-size: .97rem; font-weight: 700;
      border: none; border-radius: var(--r); cursor: pointer; letter-spacing: .04em;
      box-shadow: 0 4px 22px rgba(108,99,255,.4); transition: all .2s;
    }
    .btn-launch:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 8px 30px rgba(108,99,255,.55); }
    .btn-launch:disabled { opacity:.5; cursor:not-allowed; }

    /* ‚îÄ‚îÄ LIBRARY ‚îÄ‚îÄ */
    .section-eyebrow {
      font-family: var(--font-head); font-size: .7rem; letter-spacing: .22em;
      color: var(--gold); margin-bottom: 1.2rem;
      display: flex; align-items: center; gap: .7rem;
    }
    .section-eyebrow::after { content:''; flex:1; height:1px; background:var(--border); }

    .cat-bar { display: flex; align-items: center; gap: .8rem; margin-bottom: 2rem; position: relative; }

    .cat-menu-btn {
      display: inline-flex; align-items: center; gap: .55rem;
      padding: .55rem 1.1rem;
      border: 1px solid var(--border); border-radius: 99px;
      background: rgba(255,255,255,.04);
      color: var(--text); font-family: var(--font-body); font-size: .85rem;
      cursor: pointer; transition: all .2s;
    }
    .cat-menu-btn:hover, .cat-menu-btn.active {
      border-color: var(--gold); color: var(--gold); background: var(--gold-dim);
    }
    .cat-menu-btn .arrow {
      font-size: .65rem; transition: transform .2s; display: inline-block;
    }
    .cat-menu-btn.open .arrow { transform: rotate(180deg); }

    .cat-active-label {
      font-size: .8rem; color: var(--muted);
    }
    .cat-active-label span { color: var(--gold); font-weight: 600; }

    .cat-dropdown {
      display: none; position: absolute; top: calc(100% + 8px); left: 0;
      min-width: 200px; z-index: 50;
      background: #1a1c35; border: 1px solid var(--border);
      border-radius: var(--r); padding: .5rem;
      box-shadow: 0 16px 40px rgba(0,0,0,.6);
      animation: dropIn .18s ease forwards;
    }
    .cat-dropdown.open { display: block; }
    .cat-option {
      padding: .55rem .9rem; border-radius: 8px;
      font-family: var(--font-body); font-size: .85rem;
      color: var(--muted); cursor: pointer; transition: all .15s;
    }
    .cat-option:hover { background: rgba(255,255,255,.06); color: var(--text); }
    .cat-option.active { color: var(--gold); background: var(--gold-dim); font-weight: 600; }

    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
      gap: 1.2rem;
    }

    .vid-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--r); overflow: hidden; cursor: pointer;
      transition: transform .22s, box-shadow .22s, border-color .22s;
      animation: fadeInUp .4s both;
      animation-delay: calc(var(--i) * 0.04s);
      position: relative;
    }
    .vid-card:hover {
      transform: translateY(-5px);
      border-color: rgba(108,99,255,.5);
      box-shadow: 0 12px 40px rgba(0,0,0,.5), 0 0 0 1px rgba(108,99,255,.2);
    }
    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(18px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .thumb-wrap {
      position: relative; width: 100%; aspect-ratio: 16/9;
      overflow: hidden; background: #0b0d1c;
    }
    .thumb-wrap img {
      width:100%; height:100%; object-fit:cover; display:block;
      transition: transform .4s ease;
    }
    .vid-card:hover .thumb-wrap img { transform: scale(1.05); }

    .play-overlay {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,.35); opacity: 0; transition: opacity .22s;
    }
    .vid-card:hover .play-overlay { opacity: 1; }
    .play-icon {
      width: 52px; height: 52px; background: rgba(245,200,66,.92);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 24px rgba(245,200,66,.5); transform: scale(.85); transition: transform .2s;
    }
    .vid-card:hover .play-icon { transform: scale(1); }
    .play-icon svg { margin-left: 3px; }

    .completed-badge {
      position: absolute; top: 8px; right: 8px;
      background: var(--green); color: #04200e;
      font-size: .68rem; font-weight: 700; letter-spacing: .08em;
      padding: .25rem .6rem; border-radius: 99px; display: none;
    }
    .vid-card.completed .completed-badge { display: block; }

    .thumb-progress {
      position: absolute; bottom: 0; left: 0; right: 0;
      height: 4px; background: rgba(255,255,255,.12);
    }
    .thumb-progress-fill {
      height: 100%; background: var(--gold); transition: width .5s ease; width: 0%;
    }
    .vid-card.completed .thumb-progress-fill { background: var(--green); }

    .vid-info { padding: .9rem 1rem; }
    .vid-title {
      font-size: .9rem; font-weight: 600; color: var(--text);
      line-height: 1.4; margin-bottom: .35rem;
      display: -webkit-box; -webkit-line-clamp: 2;
      -webkit-box-orient: vertical; overflow: hidden;
    }
    .vid-meta {
      font-size: .75rem; color: var(--muted);
      display: flex; align-items: center; gap: .5rem;
    }
    .vid-meta .dot { width:3px; height:3px; border-radius:50%; background:var(--muted); }

    /* ‚îÄ‚îÄ PLAYER ‚îÄ‚îÄ */
    .player-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
    .back-btn {
      display: inline-flex; align-items: center; gap: .4rem;
      padding: .5rem 1rem; background: rgba(255,255,255,.06);
      border: 1px solid var(--border); border-radius: 99px;
      color: var(--muted); font-family: var(--font-body); font-size: .82rem;
      cursor: pointer; transition: all .2s;
    }
    .back-btn:hover { color: var(--gold); border-color: var(--gold); background: var(--gold-dim); }

    .player-layout {
      display: grid; grid-template-columns: 1fr 340px; gap: 1.5rem; align-items: start;
    }
    @media (max-width: 820px) { .player-layout { grid-template-columns: 1fr; } }

    .embed-wrap {
      border-radius: var(--r); overflow: hidden; border: 1px solid var(--border);
      background: #000; aspect-ratio: 16/9; position: relative;
    }
    .embed-wrap > div { position: absolute; inset: 0; width: 100% !important; height: 100% !important; }

    .side-panel {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--r); padding: 1.3rem;
      position: sticky; top: 76px;
    }
    .side-title { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: .3rem; line-height: 1.4; }
    .side-cat { font-size: .75rem; color: var(--accent); letter-spacing: .08em; margin-bottom: 1.2rem; }

    .watch-section { margin-top: 1rem; }
    .watch-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem; }
    .watch-label { font-size: .72rem; letter-spacing: .1em; text-transform: uppercase; color: var(--muted); }
    .watch-val { font-family: var(--font-head); font-size: .78rem; color: var(--gold); }
    .progress-track { width:100%; height:8px; background:rgba(255,255,255,.08); border-radius:99px; overflow:hidden; }
    .progress-fill {
      height:100%; border-radius:99px;
      background: linear-gradient(90deg, var(--accent), var(--gold));
      box-shadow: 0 0 8px rgba(108,99,255,.5); transition: width .9s ease; width:0%;
    }
    .progress-fill.done {
      background: linear-gradient(90deg, #23d18b, #a3ffda);
      box-shadow: 0 0 10px rgba(35,209,139,.5);
    }
    .watch-status {
      margin-top: .75rem; font-size: .82rem; color: var(--muted);
      text-align: center; min-height: 1.4em; transition: color .3s;
    }
    .watch-status.ready { color: var(--green); font-weight: 600; }

    .divider { border:none; border-top:1px solid var(--border); margin:1.2rem 0; }

    .up-next-label { font-size:.72rem; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:.8rem; }
    .next-list { display:flex; flex-direction:column; gap:.6rem; }
    .next-item {
      display: flex; gap: .7rem; align-items: center;
      cursor: pointer; padding: .5rem; border-radius: 8px; transition: background .2s;
    }
    .next-item:hover { background: rgba(255,255,255,.05); }
    .next-thumb { width:80px; min-width:80px; aspect-ratio:16/9; border-radius:6px; overflow:hidden; background:#0b0d1c; }
    .next-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .next-info { flex:1; }
    .next-title {
      font-size:.78rem; color:var(--text); line-height:1.35;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; margin-bottom:.2rem;
    }
    .next-cat { font-size:.7rem; color:var(--muted); }
    .next-item.done-item .next-title { color: var(--green); }

    .spinner {
      display:inline-block; width:14px; height:14px;
      border:2px solid rgba(255,255,255,.2); border-top-color:#fff;
      border-radius:50%; animation:spin .6s linear infinite;
      vertical-align:middle; margin-right:.4rem;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>
<body>

<div id="stars"></div>

<nav>
  <div class="logo">‚ú¶ V FOR VIDEO</div>

  <!-- MENU BUTTON (hidden until logged in) -->
  <div style="position:relative;" id="menuWrap">
    <button class="menu-btn" id="menuBtn" aria-label="Menu" aria-expanded="false">
      <svg width="18" height="14" viewBox="0 0 18 14" fill="none">
        <rect width="18" height="2" rx="1" fill="rgba(245,200,66,0.85)"/>
        <rect y="6" width="12" height="2" rx="1" fill="rgba(245,200,66,0.85)"/>
        <rect y="12" width="16" height="2" rx="1" fill="rgba(245,200,66,0.85)"/>
      </svg>
    </button>
    <div class="menu-dropdown" id="menuDropdown">
      <div class="menu-dropdown-header">Logged in as</div>
      <div class="menu-user-name" id="menuName">‚Äî</div>
      <div class="menu-user-dept" id="menuDept">‚Äî</div>
    </div>
  </div>
</nav>

<div class="wrap">

  <!-- LOGIN -->
  <div class="screen active" id="screenLogin">
    <div class="login-wrap">
      <div class="login-card">
        <div class="login-title">üåå MISSION BRIEFING</div>
        <div class="quotes">
          <div class="quote">"Ever tried. Ever failed. No matter. Try again. Fail again. Fail better." <em>‚Äî Samuel Beckett</em></div>
          <div class="quote">"Try not. Do. Or, do not. There is no Try." <em>‚Äî Yoda</em></div>
          <div class="quote">"The opposite of a good idea is another good idea." <em>‚Äî Niels Bohr</em></div>
        </div>
        <label class="field-label" for="deptSelect">Department</label>
        <select id="deptSelect">
          <option value="">‚Äî Select your department ‚Äî</option>
          <option>Cyber Security</option><option>CSE-1</option><option>CSE-2</option><option>CSE-3</option>
          <option>Mechanical Engineering</option><option>ECE-1</option><option>ECE-2</option><option>ECE-3</option>
          <option>AI DS-1</option><option>AI DS-2</option><option>Civil</option><option>Agri</option>
          <option>EEE</option><option>EIE</option><option>Medical Electronics</option><option>IT-1</option><option>IT-2</option>
        </select>
        <label class="field-label" for="nameInput">Your Name</label>
        <input type="text" id="nameInput" placeholder="Enter your name" autocomplete="name" />
        <button class="btn-launch" id="launchBtn" onclick="handleLaunch()">Enter the Archive üöÄ</button>
      </div>
    </div>
  </div>

  <!-- LIBRARY -->
  <div class="screen" id="screenLibrary">
    <div class="section-eyebrow">VIDEO ARCHIVE</div>
    <div class="cat-bar" id="catBar">
      <button class="cat-menu-btn" id="catMenuBtn">
        ‚ò∞ Filter Category <span class="arrow">‚ñº</span>
      </button>
      <div class="cat-dropdown" id="catDropdown"></div>
      <span class="cat-active-label">Showing: <span id="catActiveLabel">All</span></span>
    </div>
    <div class="video-grid" id="videoGrid"></div>
  </div>

  <!-- PLAYER -->
  <div class="screen" id="screenPlayer">
    <div class="player-header">
      <button class="back-btn" id="backBtn">‚Üê Back to Archive</button>
    </div>
    <div class="player-layout">
      <div>
        <div class="embed-wrap" id="embedWrap">
          <div id="ytPlayer"></div>
        </div>
      </div>
      <div class="side-panel">
        <div class="side-cat" id="sideCategory"></div>
        <div class="side-title" id="sideTitle"></div>
        <div class="watch-section">
          <div class="watch-header">
            <span class="watch-label">üé¨ Watch Progress</span>
            <span class="watch-val" id="watchVal">0s / 0s</span>
          </div>
          <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
          <div class="watch-status" id="watchStatus">‚ñ∂ Press play to begin</div>
          <button id="saveBtn" disabled onclick="manualSave()" style="
            width:100%; margin-top:1rem; padding:.8rem;
            background: linear-gradient(135deg, #23d18b, #16a34a);
            color:#04200e; font-family:var(--font-body); font-size:.92rem; font-weight:700;
            border:none; border-radius:var(--r); cursor:pointer;
            box-shadow: 0 4px 18px rgba(35,209,139,.3);
            transition: all .2s; letter-spacing:.03em;
          ">üíæ Save Score</button>
        </div>
        <hr class="divider">
        <div class="up-next-label">Up Next</div>
        <div class="next-list" id="nextList"></div>
      </div>
    </div>
  </div>

</div><!-- /wrap -->

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  window.supabase = createClient(
    'https://ahezssoczvpbkteffcgz.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE'
  );
</script>

<script>
/* STARS */
(function(){
  const c = document.getElementById('stars');
  for (let i=0;i<130;i++){
    const s = document.createElement('div');
    s.className='star';
    const sz = Math.random()*2.2+.4;
    s.style.cssText=`width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;--d:${(Math.random()*4+2).toFixed(1)}s;--dl:-${(Math.random()*6).toFixed(1)}s;--lo:${(Math.random()*.1).toFixed(2)};--hi:${(Math.random()*.6+.25).toFixed(2)}`;
    c.appendChild(s);
  }
})();

/* MENU TOGGLE */
const menuBtn = document.getElementById('menuBtn');
const menuDropdown = document.getElementById('menuDropdown');
menuBtn.addEventListener('click', () => {
  const open = menuDropdown.classList.toggle('open');
  menuBtn.classList.toggle('open', open);
  menuBtn.setAttribute('aria-expanded', open);
});
document.addEventListener('click', (e) => {
  if (!document.getElementById('menuWrap').contains(e.target)) {
    menuDropdown.classList.remove('open');
    menuBtn.classList.remove('open');
    menuBtn.setAttribute('aria-expanded', false);
  }
});

/* STATE */
let youtubeReady = false;
window.onYouTubeIframeAPIReady = () => { youtubeReady = true; };

let quizData = [];
let playerName = '', playerDept = '';
let activeCategory = 'all';
let watchedMap = {};
let completedSet = new Set();
let ytPlayer = null, watchInterval = null;
let currentVideo = null;
let watchTime = 0;

/* PRELOAD DATA */
const dataPromise = (async () => {
  try {
    const cached = sessionStorage.getItem('vfv_data');
    if (cached) { quizData = JSON.parse(cached); return quizData; }
  } catch(_){}
  const res = await fetch("andrewveda.github.io/SRM-VEC-English-PWA/buttons/videoquests.json");
quizData = await res.json();
 
  try { sessionStorage.setItem('vfv_data', JSON.stringify(quizData)); } catch(_){}
  return quizData;
})();

/* RESTORE SAVED */
window.addEventListener('DOMContentLoaded', () => {
  try {
    const n = localStorage.getItem('vfv_name');
    const d = localStorage.getItem('vfv_dept');
    if(n) document.getElementById('nameInput').value = n;
    if(d) document.getElementById('deptSelect').value = d;
  } catch(_){}
});

/* SCREENS */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* LAUNCH */
async function handleLaunch() {
  const n = document.getElementById('nameInput').value.trim();
  const d = document.getElementById('deptSelect').value;
  if (!n) { alert('Please enter your name!'); return; }
  if (!d) { alert('Please select your department!'); return; }
  playerName = n; playerDept = d;
  try { localStorage.setItem('vfv_name',n); localStorage.setItem('vfv_dept',d); } catch(_){}

  const btn = document.getElementById('launchBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Loading archive‚Ä¶';

  try {
    await dataPromise;
    // Populate menu dropdown
    document.getElementById('menuName').textContent = playerName;
    document.getElementById('menuDept').textContent = playerDept;
    document.getElementById('menuBtn').style.display = 'flex';
    buildLibrary();
    showScreen('screenLibrary');
  } catch(e) {
    alert('Failed to load. Please refresh.');
    btn.disabled = false;
    btn.innerHTML = 'Enter the Archive üöÄ';
  }
}
window.handleLaunch = handleLaunch;

/* LIBRARY */
function buildLibrary() {
  const cats = ['all', ...new Set(quizData.map(q => q.category))];
  const dropdown = document.getElementById('catDropdown');
  dropdown.innerHTML = '';
  cats.forEach(cat => {
    const opt = document.createElement('div');
    opt.className = 'cat-option' + (cat === activeCategory ? ' active' : '');
    opt.textContent = cat === 'all' ? '‚≠ê All' : cat;
    opt.onclick = () => {
      activeCategory = cat;
      document.getElementById('catActiveLabel').textContent = cat === 'all' ? 'All' : cat;
      updateDropdownOptions();
      closeCatDropdown();
      renderGrid();
    };
    dropdown.appendChild(opt);
  });

  // Set up toggle button
  const btn = document.getElementById('catMenuBtn');
  btn.onclick = (e) => {
    e.stopPropagation();
    const open = dropdown.classList.toggle('open');
    btn.classList.toggle('open', open);
  };
  document.addEventListener('click', closeCatDropdown);

  renderGrid();
}

function closeCatDropdown() {
  document.getElementById('catDropdown').classList.remove('open');
  document.getElementById('catMenuBtn').classList.remove('open');
}

function updateDropdownOptions() {
  document.querySelectorAll('.cat-option').forEach(opt => {
    const label = opt.textContent.replace('‚≠ê ', '');
    opt.classList.toggle('active', label === activeCategory || (activeCategory === 'all' && opt.textContent === '‚≠ê All'));
  });
}

function renderGrid() {
  const grid = document.getElementById('videoGrid');
  const filtered = activeCategory === 'all' ? quizData : quizData.filter(q => q.category === activeCategory);
  grid.innerHTML = '';
  filtered.forEach((vid, i) => {
    const videoId = extractId(vid.video);
    const watched = watchedMap[vid.questId] || 0;
    const pct = vid.watchTarget > 0 ? Math.min((watched / vid.watchTarget) * 100, 100) : 0;
    const done = completedSet.has(vid.questId);
    const card = document.createElement('div');
    card.className = 'vid-card' + (done ? ' completed' : '');
    card.style.setProperty('--i', i);
    card.innerHTML = `
      <div class="thumb-wrap">
        <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" alt="${escHtml(vid.title)}" loading="lazy"
             onerror="this.src='https://img.youtube.com/vi/${videoId}/mqdefault.jpg'">
        <div class="play-overlay">
          <div class="play-icon">
            <svg width="18" height="20" viewBox="0 0 18 20" fill="none">
              <path d="M1 1L17 10L1 19V1Z" fill="#07080f"/>
            </svg>
          </div>
        </div>
        <div class="completed-badge">‚úì WATCHED</div>
        <div class="thumb-progress"><div class="thumb-progress-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="vid-info">
        <div class="vid-title">${escHtml(vid.title)}</div>
        <div class="vid-meta">
          <span>${escHtml(vid.category)}</span>
          <span class="dot"></span>
          <span>‚è± ${vid.watchTarget}s required</span>
        </div>
      </div>`;
    card.onclick = () => openPlayer(vid);
    grid.appendChild(card);
  });
}

/* PLAYER */
async function openPlayer(vid) {
  currentVideo = vid;
  watchTime = watchedMap[vid.questId] || 0;

  document.getElementById('sideTitle').textContent = vid.title;
  document.getElementById('sideCategory').textContent = vid.category;
  document.getElementById('watchVal').textContent = `${watchTime}s / ${vid.watchTarget}s`;

  const alreadyDone = completedSet.has(vid.questId);
  const statusEl = document.getElementById('watchStatus');
  statusEl.textContent = alreadyDone ? '‚úÖ Already saved!' : '‚ñ∂ Press play to begin';
  statusEl.className = 'watch-status' + (alreadyDone ? ' ready' : '');

  const saveBtn = document.getElementById('saveBtn');
  saveBtn.disabled = !alreadyDone;
  saveBtn.textContent = alreadyDone ? '‚úÖ Score Saved' : 'üíæ Save Score';
  saveBtn.style.opacity = alreadyDone ? '.6' : '1';

  const pct = vid.watchTarget > 0 ? Math.min((watchTime / vid.watchTarget) * 100, 100) : 0;
  const fill = document.getElementById('progressFill');
  fill.style.width = pct + '%';
  fill.classList.toggle('done', pct >= 100);

  buildNextList(vid);
  showScreen('screenPlayer');

  if (!youtubeReady) {
    let t = 0;
    while (!youtubeReady && t < 80) { await new Promise(r=>setTimeout(r,100)); t++; }
  }

  clearInterval(watchInterval); watchInterval = null;
  if (ytPlayer) { try { ytPlayer.destroy(); } catch(_){} ytPlayer = null; }

  document.getElementById('embedWrap').innerHTML = '<div id="ytPlayer"></div>';
  ytPlayer = new YT.Player('ytPlayer', {
    videoId: extractId(vid.video),
    playerVars: { autoplay: 0, controls: 1, rel: 0 },
    events: { onStateChange: onPlayerState }
  });
}

function onPlayerState(event) {
  if (event.data === YT.PlayerState.PLAYING) {
    if (!watchInterval) {
      watchInterval = setInterval(() => {
        watchTime++;
        watchedMap[currentVideo.questId] = watchTime;
        const pct = Math.min((watchTime / currentVideo.watchTarget) * 100, 100);
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressFill').classList.toggle('done', pct >= 100);
        document.getElementById('watchVal').textContent = `${watchTime}s / ${currentVideo.watchTarget}s`;

        if (watchTime >= currentVideo.watchTarget && !completedSet.has(currentVideo.questId)) {
          const s = document.getElementById('watchStatus');
          s.textContent = '‚úÖ Target reached! Save when ready.';
          s.className = 'watch-status ready';
          const saveBtn = document.getElementById('saveBtn');
          saveBtn.disabled = false;
          saveBtn.style.opacity = '1';
        }
      }, 1000);
    }
  } else {
    clearInterval(watchInterval); watchInterval = null;
    if (!completedSet.has(currentVideo?.questId)) {
      document.getElementById('watchStatus').textContent = '‚è∏ Paused ‚Äî keep watching!';
    }
  }
}

function manualSave() {
  if (!currentVideo || completedSet.has(currentVideo.questId)) return;

  const saveBtn = document.getElementById('saveBtn');
  saveBtn.disabled = true;
  saveBtn.textContent = '‚è≥ Saving‚Ä¶';

  const client = window.supabase;
  if (!client) { saveBtn.textContent = '‚ùå Error'; return; }

  client.from('Quests').insert([{
    student_name: playerName, department: playerDept,
    correct: 10, wrong: 0,
    time_spent: watchTime, quest_id: currentVideo.questId
  }]).then(({error}) => {
    if (error) {
      console.error('Supabase:', error);
      saveBtn.disabled = false;
      saveBtn.textContent = '‚ùå Failed ‚Äî Try Again';
    } else {
      completedSet.add(currentVideo.questId);
      saveBtn.textContent = '‚úÖ Score Saved';
      saveBtn.style.opacity = '.6';
      document.getElementById('watchStatus').textContent = '‚úÖ Score saved!';
      renderGrid();
    }
  });
}
window.manualSave = manualSave;

function buildNextList(current) {
  const list = document.getElementById('nextList');
  const others = quizData.filter(v => v.questId !== current.questId).slice(0, 6);
  list.innerHTML = '';
  others.forEach(vid => {
    const videoId = extractId(vid.video);
    const done = completedSet.has(vid.questId);
    const item = document.createElement('div');
    item.className = 'next-item' + (done ? ' done-item' : '');
    item.innerHTML = `
      <div class="next-thumb"><img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" alt="" loading="lazy"></div>
      <div class="next-info">
        <div class="next-title">${done ? '‚úì ' : ''}${escHtml(vid.title)}</div>
        <div class="next-cat">${escHtml(vid.category)} ¬∑ ${vid.watchTarget}s</div>
      </div>`;
    item.onclick = () => openPlayer(vid);
    list.appendChild(item);
  });
}

document.getElementById('backBtn').onclick = () => {
  clearInterval(watchInterval); watchInterval = null;
  if (ytPlayer) { try { ytPlayer.stopVideo(); } catch(_){} }
  renderGrid();
  showScreen('screenLibrary');
};

function extractId(url) {
  if (!url) return '';
  const m = url.match(/[?&]v=([^&]+)/);
  return m ? m[1] : url;
}
function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>

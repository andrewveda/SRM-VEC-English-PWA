<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title> The Icecream Story üåå</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --page-padding-x: 1.5rem;
    --top-strip-bg: rgba(255, 255, 240, 0.96);
    --top-strip-border: #d2b48c;
  }

  /* Base */
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(ellipse at center, #f4ecd8 0%, #e8d9b5 100%);
    color: #3b2f1e;
    text-align: center;
    width: 100vw;
    height: 100vh;
    overflow-x: hidden;
  }

  .container {
    position: relative;
    background: rgba(255, 255, 240, 0.85);
    width: 100vw;
    min-height: 100vh;
    margin: 0;
    border: none;
    border-radius: 0;
    box-shadow: none;
    padding: 0; /* no top padding; we position content below fixed strip via JS */
  }

  /* Name form */
  #nameForm {
    padding: 5rem var(--page-padding-x) 2rem;
  }
  #nameInput, #departmentSelect {
    display: block;
    width: 90%;
    max-width: 300px;
    margin: 1rem auto;
    padding: 0.7rem;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #c2a677;
    background: #fffdf6;
    color: #3b2f1e;
  }
  #startQuizBtn {
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #8b7355;
    border: 1px solid #5b442a;
    border-radius: 10px;
    cursor: pointer;
    color: #ffffff;
    transition: background-color 0.2s ease;
  }
  #startQuizBtn:hover { background-color: #6b5a43; }

  /* --- UNIFIED TOP STRIP (Header + Answers) --- */
  .top-strip {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;

    background: var(--top-strip-bg);
    border-bottom: 1px solid var(--top-strip-border);

    padding: 0.5rem 0.8rem;
    z-index: 30;
    backdrop-filter: blur(4px);
  }
  /* First row: Timer ‚Äì Gems ‚Äì Progress */
  .top-strip-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95rem;
    color: #5b442a;
    margin-bottom: 0.35rem;
    padding: 0 var(--page-padding-x);
  }
  #timer, #gemsCounter, #progressTracker {
    font-size: 1.05rem;
    color: #6b4f33;
    font-weight: 500;
  }
  /* Second row: Answers ‚Äî compact, centered, wrapping */
.top-strip-answers {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  justify-content: center;
  align-items: center;

  padding-top: 1rem;
  border-top: 1px solid #d2b48c; /* thin line above answers */
}

  .drag-item {
    display: inline-block;
    padding: 0.35rem 0.6rem;
    font-size: 0.95rem;
    background: #f7e7c4;
    border: 1px solid #d2b48c;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease-in-out;
    color: #3b2f1e;
    white-space: nowrap; /* keep compact */
  }
  .drag-item:hover { background: #f5deb3; transform: scale(1.05); }
  .drag-item.selected { border: 2px solid #8b7355; background: #f0dba5; transform: scale(1.02); }

  /* Passage area */
  .drop-container {
    padding: 0.8rem var(--page-padding-x) 2rem;
    overflow-y: auto;
    text-align: justify;        /* FULL JUSTIFICATION */
    line-height: 1.9;
    font-size: 1.3rem;
    color: #3b2f1e;
  }

  /* Blanks */
  .drop-zone {
    display: inline-block;
    border: 1px dashed #a1886f;
    padding: 0.2rem 0.8rem;
    margin: 0 0.2rem;
    cursor: pointer;
    background: #fffdf6;
    color: #5b442a;
    font-size: 1.2rem;
    font-family: 'Courier New', Courier, monospace;
    border-radius: 5px;
    min-width: 60px;
    text-align: center;
    transition: all 0.2s ease;
    vertical-align: middle;
  }
  .drop-zone:hover { background: #f7e7c4; }
  .drop-zone.filled {
    border: 1px solid transparent;
    background: none;
    color: #228b22;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: bold;
    padding: 0.2rem 0.2rem;
    min-width: unset;
    cursor: default;
  }
  .correct { color: #228b22 !important; }
  .wrong { border-color: #b22222 !important; animation: shake 0.5s ease-in-out; }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  /* Gems FX */
  @keyframes sparkle {
    0% { transform: translate(0, 0) scale(1); opacity: 1; }
    100% { transform: translate(var(--random-x, 0), -100px) scale(1.5); opacity: 0; }
  }
  @keyframes gemPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
  }
  .gem-spark { position: absolute; pointer-events: none; font-size: 1.5rem; animation: sparkle 1s ease-out forwards; z-index: 20; }
  .gem-counter-pulse { animation: gemPulse 0.4s ease-in-out; }

  /* Buttons / Score */
  #nextPageBtn {
    margin-top: 1.5rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #4CAF50;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    color: white;
    transition: background-color 0.2s ease;
    font-weight: bold;
  }
  #nextPageBtn:hover { background-color: #45a049; }

  #restartBtn {
    margin-top: 2rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #d2b48c;
    border: 1px solid #a1886f;
    border-radius: 10px;
    cursor: pointer;
    color: #3b2f1e;
    transition: background-color 0.2s ease;
  }
  #restartBtn:hover { background-color: #c9a96b; }

  #scoreCard {
    margin-top: 2rem;
    font-size: 1.2rem;
    color: #4b3b2a;
  }
</style>
</head>

<body>
<div class="container" id="quizContainer">

  <!-- Name Entry Page -->
  <div id="nameForm">
    <h1 id="quizTitle" style="font-size:2rem; margin-bottom:0.3rem; color:#4a3b2a;">
Letter </h1>
 Letter to a friend <br> <br>
    
<h3 id="quizAuthor" style="font-size:1.1rem; margin-bottom:1.5rem; color:#6b4f33; font-weight:normal;">
<br> 

</h3>

    <input type="text" id="nameInput" placeholder="Enter your name" />
    <select id="departmentSelect">
      <option value="">-- Select Department --</option>
      <option value="Cyber Security">Cyber Security</option>
      <option value="CSE-1">CSE-1</option>
      <option value="CSE-2">CSE-2</option>
      <option value="CSE-3">CSE-3</option>
      <option value="Mechanical Engineering">Mechanical Engineering</option>
      <option value="ECE-1">ECE-1</option>
      <option value="ECE-2">ECE-2</option>
      <option value="ECE-3">ECE-3</option>
      <option value="AI DS-1">AI DS-1</option>
      <option value="AI DS-2">AI DS-2</option>
      <option value="Civil">Civil</option>
      <option value="Agri">Agri</option>
      <option value="EEE">EEE</option>
      <option value="EIE">EIE</option>
      <option value="Medical Electronics">Medical Electronics</option>
      <option value="IT-1">IT-1</option>
      <option value="IT-2">IT-2</option>
    </select>
    <!-- FIX: Removed inline onclick, will be added in JS. But for minimal change, we just need to make beginQuiz global. -->
    <button id="startQuizBtn" onclick="beginQuiz()">Start Quiz</button>
  </div>

  <!-- Quiz Content -->
  <div id="quizContent" style="display:none;">
    <div class="top-strip" id="topStrip">
      <div class="top-strip-header">
        <div id="timer">‚è≥ 0s</div>
        <div id="gemsCounter">üíé 0</div>
        <div id="progressTracker">üìç 1 / 1</div>
      </div>
      <div class="top-strip-answers" id="dragOptions"></div>
    </div>

    <div class="drop-container" id="dropContainer"></div>
    <div id="scoreCard"></div>
    <button id="nextPageBtn" style="display: none;">Next &rarr;</button>
    <button id="restartBtn" style="display: none;">Restart</button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const supabase = createClient(
  'https://ahezssoczvpbkteffcgz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE'
);

// --- HELPER FUNCTIONS ---
function autoGenerateBlanks(passage, frequency = 7) {
  const words = passage.split(/(\s+)/);
  const answers = [];
  let wordCount = 0;
  
  const blankedPassage = words.map(word => {
    if (word.trim() && ++wordCount % frequency === 0) {
      answers.push(word.trim());
      return '___';
    }
    return word;
  }).join('');
  
  return { passage: blankedPassage, answers };
}

// --- QUIZ DATA ---
const quizDataStore = (() => {
 const fullPassage = ` 


Dear Jaqen,

I heard you got into Hogwarts college. I am in SRM Valliammai Engineering College (which is better than Hogwarts!) where I'm figuring out this thing called ‚ÄòLife‚Äô. This is very serious news. This means we are officially adults, except we do not feel like adults, do not act like adults, and do not know what we are doing. This is normal. Or at least everyone says it is normal, which probably means nobody knows anything. As Douglas Adams wrote, ‚ÄúDon‚Äôt panic.‚Äù I panic a little every day, but in a calm and professional way.

College is strange. Nobody says ‚Äúsit here‚Äù or "sit there‚Äù. You can sit anywhere. This sounds amazing until you realise you have to decide everything yourself. Deciding where to sit is harder than exams. If you sit in the front, you look too serious. If you sit at the back, you look suspicious. I change places every day like I am in Game of Thrones. New seat. New alliance. New "enemy‚Äù.

My college life is going well, I think. I walk confidently even when I am lost. I nod seriously even when I do not understand anything. This is an important college skill. Sherlock would be proud. As he says, ‚ÄúThe world is full of obvious things which nobody ever observes.‚Äù For example, everyone looks confident. Nobody is confident. This is the biggest secret of college.

Classes are long. Very long. So long that they feel like The Lord of the Rings. You start fresh and hopeful. Halfway through, you feel tired and emotional. By the end, you are just thinking, ‚ÄúI can‚Äôt carry this anymore.‚Äù But then you remember the line, ‚ÄúEven the smallest person can change the course of the future,‚Äù so you take notes and feel brave again for five minutes.

Classes reminds me of our favourite TV show, House. He says, ‚ÄúEverybody lies.‚Äù In college, people lie about everything. ‚ÄúI studied yesterday.‚Äù Lie. ‚ÄúI understand this topic.‚Äù Lie. ‚ÄúI will start early.‚Äù Biggest lie. College is basically a safe place to practice lying badly.
 
We need to make a real plan to meet. Not a ‚Äúwe will see‚Äù plan. Not a ‚Äútext me later‚Äù plan. A proper plan with a place, a time, and food involved. Otherwise, this will become like Game of Thrones: many messages, many promises, and nobody actually meeting. As they say, ‚ÄúWinter is coming,‚Äù and winter here means exams, assignments, and disappearing friends.
We can meet somewhere in the middle. We can complain about college. We can eat something unhealthy. We can say, ‚ÄúSchool was simpler,‚Äù and then immediately remember homework and change our mind. As they say in Harry Potter, ‚ÄúWe are only as strong as we are united.‚Äù Also, we are funnier when we complain together.

First, we should meet for coffee. Not fast coffee. Not standing coffee. Sitting coffee. The kind where we talk for one hour and forget why we came. Coffee is important because it makes us feel intelligent, even when we are saying nonsense. It is very Sherlock-like. You sit, think deeply, drink coffee, and say things that sound smart. As in Sherlock, we can observe people and feel mysterious, even if we are just judging their coffee choices.

After coffee, we can go for a movie. Any movie is fine. A good movie is enjoyable. A bad movie is even better because we can talk about it for days. Watching a bad movie together is important because it gives us shared suffering, which builds strong friendships. 

Then comes the main event. A full traditional South Indian meal. Proper sitting. Big banana leaf. Rice everywhere. Sambar that keeps coming even when you say ‚Äúenough.‚Äù Rasam that suddenly makes you emotional. At least five vegetables you did not plan to eat. Payasam at the end, which you eat even when you are full, because tradition. This part is very The Lord of the Rings. Long journey. Heavy load. But friendship survives. As they say, even small people can finish very large meals.

The only problem is timing. We will both say, ‚ÄúI am free anytime,‚Äù which means never. We will both check our calendars and feel tired. This is normal adult behaviour. Even House would agree. ‚ÄúEverybody lies,‚Äù especially when they say they are free. But we must fight this. We must choose a date, circle it, and protect it like it is attendance.

So let us decide. Coffee. Movie. South Indian meal. In that order or any order. If one plan fails, we move to the next. As my English teacher keeps saying, ‚ÄúThe opposite of a good idea is another great idea.‚Äù The important thing is not the plan. The important thing is meeting before college turns us into people who only say, ‚ÄúWe should meet sometime.‚Äù

Write back soon. Tell me everything. Tell me nothing. Just reply. We shouldn't ‚Äòtry to meet‚Äô. We should meet! As Yoda says, ‚ÄúDo or do not. There is no try.‚Äù

Yours truly,
hungry, hopeful, and waiting to see you soon, 
Andrew
Live long and prosper!

 
 `;
 
    
  const result = autoGenerateBlanks(fullPassage, 42);
  return [result];
})();

// FIX: Define Quest ID for PDF report
const currentQuestID = " Quest 114";

// --- STATE VARIABLES ---
let quizData = [];          // flattened pages
let current = 0;            // current page index
let wrongQuestions = [];    // pages to retry
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;
let totalQuestionsInQuiz = 0; // includes wrong-page retries

const blanksPerPage = 10;

// --- DOM ELEMENTS ---
const quizContainer   = document.getElementById("quizContainer");
const dragOptionsEl   = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl         = document.getElementById("timer");
const gemsCounterEl   = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard       = document.getElementById("scoreCard");
const restartBtn      = document.getElementById("restartBtn");
const nextPageBtn     = document.getElementById("nextPageBtn");
const quizContentEl   = document.getElementById("quizContent");
const nameFormEl      = document.getElementById("nameForm");
const nameInputEl     = document.getElementById("nameInput");
const deptSelectEl    = document.getElementById("departmentSelect");
const topStripEl      = document.getElementById("topStrip");

/* --------------- LAYOUT & PRE-FLIGHT --------------- */

/* Measure the top strip height and push the passage below it */
function adjustForTopStrip() {
  const h = topStripEl ? topStripEl.offsetHeight : 0;
  dropContainerEl.style.marginTop = h + "px";
  // Leave ~1.5rem visual breathing at bottom; ensure max-height fits viewport
  dropContainerEl.style.maxHeight = `calc(100vh - ${h}px - 2rem)`;
}

function autoFillFromStorage() {
  try {
    const storedName = localStorage.getItem('playerName');
    const storedDept = localStorage.getItem('playerDept');
    
    if (storedName) {
      nameInputEl.value = storedName;
    }
    if (storedDept) {
      deptSelectEl.value = storedDept;
    }
  } catch (e) {
    console.log('Could not access localStorage:', e);
  }
}

/* --------------- QUIZ FLOW (FUNCTIONS) --------------- */

function beginQuiz() {
  if (!nameInputEl.value.trim()) {
    nameInputEl.style.borderColor = "red";
    return;
  }
  if (!deptSelectEl.value) {
    deptSelectEl.style.borderColor = "red";
    return;
  }
  nameInputEl.style.borderColor = "#c2a677";
  deptSelectEl.style.borderColor = "#c2a677";

  playerName = nameInputEl.value.trim();
  playerDept = deptSelectEl.value;
  
  // Save to localStorage for future use
  try {
    localStorage.setItem('playerName', playerName);
    localStorage.setItem('playerDept', playerDept);
  } catch (e) {
    console.log('Could not save to localStorage:', e);
  }

  document.getElementById("quizTitle").style.display = "none";
  document.getElementById("quizAuthor").style.display = "none";

  nameFormEl.style.display = "none";
  quizContentEl.style.display = "block";
  startQuiz();
}

// FIX: Expose beginQuiz to the global scope for the inline onclick attribute
window.beginQuiz = beginQuiz;

function startQuiz() {
  quizData = [];
  wrongQuestions = [];

  // Flatten passages into page objects
  quizDataStore.forEach((p, idx) => {
    const total = p.answers.length;
    const totalPages = Math.ceil(total / blanksPerPage);
    for (let i = 0; i < totalPages; i++) {
      quizData.push({
        originalPassage: p.passage,
        originalAnswers: p.answers,
        pageIndex: i,
        passageIndex: idx,
        totalPassagePages: totalPages,
        pageId: `p${idx}-pg${i}`
      });
    }
  });

  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();
  totalQuestionsInQuiz = quizData.length;

  timerEl.innerText = "‚è≥ 0s";
  gemsCounterEl.innerText = `üíé 0`;
  scoreCard.innerHTML = "";
  restartBtn.style.display = "none";
  nextPageBtn.style.display = "none";

  loadQuestion();
  startTimer(); // This will now work
}

function updateProgress() {
  const currentQuestionNumber = current + 1;
  if (quizData[current]) {
    progressTracker.innerText = `üìç ${currentQuestionNumber} / ${totalQuestionsInQuiz}`;
  } else if (current > 0) {
    progressTracker.innerText = "Done!";
  } else {
    progressTracker.innerText = `üìç 1 / ${totalQuestionsInQuiz}`;
  }
}

function loadQuestion() {
  if (current >= quizData.length) {
    return showScore();
  }

  selectedOption = null;
  const d = quizData[current];

  updateProgress();

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  nextPageBtn.style.display = "none";

  // Page slice
  const s = d.pageIndex * blanksPerPage;
  const e = s + blanksPerPage;

  const answers = d.originalAnswers.slice(s, e);
  const parts = d.originalPassage.split("___").slice(s, e + 1);

  // Render answers (shuffled), compact & centered
  const shuffled = [...answers].sort(() => Math.random() - 0.5);
  shuffled.forEach(ans => {
    const div = document.createElement("div");
    div.classList.add("drag-item");
    div.innerText = ans;
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  // Passage parts
  if (s > 0) dropContainerEl.appendChild(document.createTextNode("... "));
  parts.forEach((part, i) => {
    dropContainerEl.appendChild(document.createTextNode(part));
    if (i < answers.length) {
      const b = document.createElement("button");
      b.classList.add("drop-zone");
      b.innerText = "___";
      b.dataset.answer = answers[i];
      b.onclick = () => placeOption(b);
      dropContainerEl.appendChild(b);
      dropContainerEl.appendChild(document.createTextNode(" "));
    }
  });
  if (e < d.originalAnswers.length) dropContainerEl.appendChild(document.createTextNode(" ..."));

  // After rendering, adjust for top strip height
  adjustForTopStrip();
}

function selectOption(div) {
  if (div.style.display === "none") return;
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

function placeOption(dz) {
  if (!selectedOption || dz.classList.contains("filled")) return;

  const ans = selectedOption.innerText;
  const correct = dz.dataset.answer;

  if (ans === correct) {
    // Correct
    correctCount++;
    gemsCount++;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;

    // FX
    createSparkleEffect(dz);
    gemsCounterEl.classList.add('gem-counter-pulse');
    setTimeout(() => gemsCounterEl.classList.remove('gem-counter-pulse'), 400);

    dz.innerText = ans;
    dz.classList.add("correct", "filled");
    dz.disabled = true;
    selectedOption.style.display = "none";
  } else {
    // Wrong
    totalWrongGuesses++;
    gemsCount--;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    dz.classList.add("wrong");
    setTimeout(() => dz.classList.remove("wrong"), 600);

    // Queue this page for retry if not already queued
    const currentData = quizData[current];
    if (!wrongQuestions.includes(currentData)) {
      wrongQuestions.push(currentData);
      totalQuestionsInQuiz++;   // keep total growing to reflect retries
      updateProgress();         // immediate reflect in header
    }
  }

  if (selectedOption) {
    selectedOption.classList.remove("selected");
    selectedOption = null;
  }

  if (!dropContainerEl.querySelector(".drop-zone:not(.filled)")) {
    nextPageBtn.style.display = "inline-block";
  }
}

function createSparkleEffect(element) {
  const rect = element.getBoundingClientRect();
  const containerRect = quizContainer.getBoundingClientRect();

  const sparkCount = 8;
  for (let i = 0; i < sparkCount; i++) {
    const spark = document.createElement('div');
    spark.className = 'gem-spark';
    spark.innerText = ['üíé', '‚ú®', '‚≠ê'][Math.floor(Math.random() * 3)];
    spark.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
    spark.style.top  = `${rect.top  - containerRect.top  + rect.height / 2}px`;
    const randomX = (Math.random() - 0.5) * 100;
    spark.style.setProperty('--random-x', `${randomX}px`);
    quizContainer.appendChild(spark);
    setTimeout(() => spark.remove(), 1000);
  }
}

async function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "<h2 style='text-align:center;'>üéâ Quiz Completed!</h2>";
  progressTracker.innerText = "Done!";
  nextPageBtn.style.display = "none";

  const successMessage = (totalWrongGuesses === 0)
    ? "<p>‚úÖ Flawless! All questions answered correctly on the first attempt!</p>"
    : `<p>‚úÖ Correct Answers (total): ${correctCount}</p>
       <p>‚ùå Wrong Attempts (total): ${totalWrongGuesses}</p>`;

  scoreCard.innerHTML = `
    <p>üë§ Player: <strong>${playerName}</strong> (${playerDept})</p>
    ${successMessage}
    <p>üíé Final Gems: ${gemsCount}</p>
    <p>‚è±Ô∏è Time Taken: ${totalTime} seconds</p>
    <button onclick="downloadPDFReport()" style="margin-top: 1rem; padding: 0.7rem 2rem; background-color: #4CAF50; border: none; border-radius: 10px; cursor: pointer; color: white; font-size: 1rem;">üì• Download PDF Report</button>
  `;
  restartBtn.style.display = "inline-block";

  // save to Supabase
  try {
    const { error } = await supabase
      .from('Quests')
      .insert([
        {
          student_name: playerName,
          department: playerDept,
          correct: correctCount,
          wrong: totalWrongGuesses,
          time_spent: totalTime,
          quest_id: "Quest 114" 
        }
      ]);
    if (error) console.error('Supabase insert error:', error);
    else console.log('‚úÖ Quest saved to Supabase');
  } catch (err) {
    console.error('Error inserting into Supabase:', err);
  }
}

// FIX: Moved startTimer to the top-level scope
function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime)/1000);
    timerEl.innerText = `‚è≥ ${elapsed}s`;
  }, 1000);
}

/* --------------- PDF REPORT --------------- */


function downloadPDFReport() {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert("PDF library not loaded yet. Please try again.");
    return;
  }

  const doc = new window.jspdf.jsPDF({ unit: "mm", format: "a4" });

  if (typeof doc.autoTable !== "function") {
    alert("AutoTable plugin not loaded.");
    return;
  }

  const pageHeight = doc.internal.pageSize.height;
  const marginLeft = 20;
  const usableWidth = 170;
  const topMargin = 20;
  const bottomSafeMargin = 30;

  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
  const questID = currentQuestID;

  /* ================= HEADER ================= */

  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, "F");

  doc.setTextColor(255, 255, 255);
  doc.setFont("times", "bold");
  doc.setFontSize(18);
  doc.text("SRM VALLIAMMAI ENGINEERING COLLEGE", 105, 16, { align: "center" });

  doc.setFontSize(12);
  doc.setFont("times", "italic");
  doc.text("(Autonomous)", 105, 23, { align: "center" });

  doc.setFontSize(15);
  doc.setFont("times", "normal");
  doc.text("Department of English", 105, 31, { align: "center" });

  doc.setFontSize(14);
  doc.setFont("times", "bold");
  doc.setTextColor(212, 175, 55);
  doc.text(`${questID} ‚Äî Performance Report`, 105, 39, { align: "center" });

  /* ================= STUDENT INFO ================= */

  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text("CANDIDATE INFORMATION", marginLeft, 55);

  doc.autoTable({
    startY: 58,
    body: [
      ["Student Name", playerName],
      ["Department", playerDept],
      ["Quest ID", questID],
      ["Completed On", reportDate],
    ],
    theme: "plain",
    styles: { fontSize: 10, font: "times", cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 },
    },
    margin: { left: marginLeft, right: marginLeft },
  });

  /* ================= PERFORMANCE SUMMARY ================= */

  let y = doc.lastAutoTable.finalY + 10;

  if (y > pageHeight - bottomSafeMargin) {
    doc.addPage();
    y = topMargin;
  }

  doc.setFont("times", "bold");
  doc.setFontSize(11);
  doc.text("PERFORMANCE SUMMARY", marginLeft, y);
  y += 6;

  doc.autoTable({
    startY: y,
    body: [
      ["Total Question Pages", quizData.length.toString()],
      ["Correct Answers (Total)", correctCount.toString()],
      ["Wrong Attempts (Total)", totalWrongGuesses.toString()],
      ["Final Gems Earned", gemsCount.toString()],
      ["Total Time", `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`],
    ],
    theme: "grid",
    styles: { fontSize: 10, font: "times", cellPadding: 3 },
    margin: { left: marginLeft, right: marginLeft },
  });

  y = doc.lastAutoTable.finalY + 12;

  /* ================= QUESTION BANK ================= */

  if (y > pageHeight - bottomSafeMargin) {
    doc.addPage();
    y = topMargin;
  }

  doc.setFont("times", "bold");
  doc.setFontSize(11);
  doc.text("QUESTION BANK WITH CORRECT ANSWERS", marginLeft, y);
  y += 8;

  quizDataStore.forEach((item, i) => {
    let fullPassage = item.passage;

    item.answers.forEach(ans => {
      fullPassage = fullPassage.replace("___", ` [${ans}] `);
    });

    doc.setFont("times", "normal");
    doc.setFontSize(10);
    doc.setLineHeightFactor(1.15);

    const lines = doc.splitTextToSize(fullPassage, usableWidth);
    const lineHeight = doc.getFontSize() * 1.15;
    const blockHeight = lines.length * lineHeight + 10;

    if (y + blockHeight > pageHeight - bottomSafeMargin) {
      doc.addPage();
      y = topMargin;
    }

    doc.setFont("times", "bold");
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, marginLeft, y);
    y += 6;

    doc.setFont("times", "normal");
    doc.setTextColor(0, 0, 0);
    doc.text(lines, marginLeft + 5, y, { align: "left" });
    y += lines.length * lineHeight + 5;

    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.3);
    doc.line(marginLeft, y, 190, y);
    y += 6;
  });

  /* ================= FOOTER ================= */

  const totalPages = doc.getNumberOfPages();
  for (let i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.setFont("times", "italic");
    doc.text(`Page ${i} of ${totalPages}`, 105, pageHeight - 10, { align: "center" });
  }

  /* ================= SAVE ================= */

  const cleanName = playerName.replace(/[^a-zA-Z0-9]/g, "_");
  const cleanQuest = questID.replace(/[^a-zA-Z0-9]/g, "_");

  doc.save(`${cleanName}_${cleanQuest}_Report.pdf`);
}
/* --------------- EVENT LISTENERS --------------- */

// Call auto-fill when page loads
window.addEventListener('DOMContentLoaded', autoFillFromStorage);

/* Recalculate layout on resize (for top-strip height changes due to wrapping) */
window.addEventListener('resize', adjustForTopStrip);

/* --- Button Clicks (using JS properties) --- */
restartBtn.onclick = () => {
  quizContentEl.style.display = "none";
  nameFormEl.style.display = "block";
  
  // Clear the fields for a true restart
  nameInputEl.value = ""; 
  deptSelectEl.value = "";
  
  // Also clear from storage so it doesn't auto-fill next time
  try {
     localStorage.removeItem('playerName');
     localStorage.removeItem('playerDept');
  } catch(e) {
     console.log('Could not clear localStorage');
  }

  nextPageBtn.style.display = "none";
  
  // Reset title/author
  document.getElementById("quizTitle").style.display = "block";
  document.getElementById("quizAuthor").style.display = "block";
};

nextPageBtn.onclick = () => {
  current++;
  if (current >= quizData.length && wrongQuestions.length > 0) {
    quizData.push(...wrongQuestions);
    wrongQuestions = [];
  }
  loadQuestion();
};

</script>

<!-- PWA-friendly link handling -->
<script>
document.addEventListener("click", function (e) {
  const target = e.target.closest("a");
  if (!target) return;

  const url = target.href;
  const internalDomains = [
    window.location.origin,
    "andrewveda.github.io",
    "sites.google.com/view/cys-english/",
    "sites.google.com/view/srm-vec-english/"
  ];

  const isInternal = internalDomains.some(domain => url.includes(domain));

  if (isInternal) {
    if (
      window.matchMedia("(display-mode: standalone)").matches ||
      window.matchMedia("(display-mode: fullscreen)").matches
    ) {
      e.preventDefault();
      window.location.href = url;
    }
  } else {
    target.setAttribute("target", "_blank");
  }
});
</script>
</body>
</html>

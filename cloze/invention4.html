<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title> The Icecream Story üåå</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --page-padding-x: 1.5rem;
    --top-strip-bg: rgba(255, 255, 240, 0.96);
    --top-strip-border: #d2b48c;
  }

  /* Base */
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(ellipse at center, #f4ecd8 0%, #e8d9b5 100%);
    color: #3b2f1e;
    text-align: center;
    width: 100vw;
    height: 100vh;
    overflow-x: hidden;
  }

  .container {
    position: relative;
    background: rgba(255, 255, 240, 0.85);
    width: 100vw;
    min-height: 100vh;
    margin: 0;
    border: none;
    border-radius: 0;
    box-shadow: none;
    padding: 0; /* no top padding; we position content below fixed strip via JS */
  }

  /* Name form */
  #nameForm {
    padding: 5rem var(--page-padding-x) 2rem;
  }
  #nameInput, #departmentSelect {
    display: block;
    width: 90%;
    max-width: 300px;
    margin: 1rem auto;
    padding: 0.7rem;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #c2a677;
    background: #fffdf6;
    color: #3b2f1e;
  }
  #startQuizBtn {
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #8b7355;
    border: 1px solid #5b442a;
    border-radius: 10px;
    cursor: pointer;
    color: #ffffff;
    transition: background-color 0.2s ease;
  }
  #startQuizBtn:hover { background-color: #6b5a43; }

  /* --- UNIFIED TOP STRIP (Header + Answers) --- */
  .top-strip {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;

    background: var(--top-strip-bg);
    border-bottom: 1px solid var(--top-strip-border);

    padding: 0.5rem 0.8rem;
    z-index: 30;
    backdrop-filter: blur(4px);
  }
  /* First row: Timer ‚Äì Gems ‚Äì Progress */
  .top-strip-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95rem;
    color: #5b442a;
    margin-bottom: 0.35rem;
    padding: 0 var(--page-padding-x);
  }
  #timer, #gemsCounter, #progressTracker {
    font-size: 1.05rem;
    color: #6b4f33;
    font-weight: 500;
  }
  /* Second row: Answers ‚Äî compact, centered, wrapping */
.top-strip-answers {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  justify-content: center;
  align-items: center;

  padding-top: 1rem;
  border-top: 1px solid #d2b48c; /* thin line above answers */
}

  .drag-item {
    display: inline-block;
    padding: 0.35rem 0.6rem;
    font-size: 0.95rem;
    background: #f7e7c4;
    border: 1px solid #d2b48c;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease-in-out;
    color: #3b2f1e;
    white-space: nowrap; /* keep compact */
  }
  .drag-item:hover { background: #f5deb3; transform: scale(1.05); }
  .drag-item.selected { border: 2px solid #8b7355; background: #f0dba5; transform: scale(1.02); }

  /* Passage area */
  .drop-container {
    padding: 0.8rem var(--page-padding-x) 2rem;
    overflow-y: auto;
    text-align: justify;        /* FULL JUSTIFICATION */
    line-height: 1.9;
    font-size: 1.3rem;
    color: #3b2f1e;
  }

  /* Blanks */
  .drop-zone {
    display: inline-block;
    border: 1px dashed #a1886f;
    padding: 0.2rem 0.8rem;
    margin: 0 0.2rem;
    cursor: pointer;
    background: #fffdf6;
    color: #5b442a;
    font-size: 1.2rem;
    font-family: 'Courier New', Courier, monospace;
    border-radius: 5px;
    min-width: 60px;
    text-align: center;
    transition: all 0.2s ease;
    vertical-align: middle;
  }
  .drop-zone:hover { background: #f7e7c4; }
  .drop-zone.filled {
    border: 1px solid transparent;
    background: none;
    color: #228b22;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: bold;
    padding: 0.2rem 0.2rem;
    min-width: unset;
    cursor: default;
  }
  .correct { color: #228b22 !important; }
  .wrong { border-color: #b22222 !important; animation: shake 0.5s ease-in-out; }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  /* Gems FX */
  @keyframes sparkle {
    0% { transform: translate(0, 0) scale(1); opacity: 1; }
    100% { transform: translate(var(--random-x, 0), -100px) scale(1.5); opacity: 0; }
  }
  @keyframes gemPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
  }
  .gem-spark { position: absolute; pointer-events: none; font-size: 1.5rem; animation: sparkle 1s ease-out forwards; z-index: 20; }
  .gem-counter-pulse { animation: gemPulse 0.4s ease-in-out; }

  /* Buttons / Score */
  #nextPageBtn {
    margin-top: 1.5rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #4CAF50;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    color: white;
    transition: background-color 0.2s ease;
    font-weight: bold;
  }
  #nextPageBtn:hover { background-color: #45a049; }

  #restartBtn {
    margin-top: 2rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #d2b48c;
    border: 1px solid #a1886f;
    border-radius: 10px;
    cursor: pointer;
    color: #3b2f1e;
    transition: background-color 0.2s ease;
  }
  #restartBtn:hover { background-color: #c9a96b; }

  #scoreCard {
    margin-top: 2rem;
    font-size: 1.2rem;
    color: #4b3b2a;
  }
  /* Nice dual-ring spinner */
.lds-dual-ring {
  display: inline-block;
  width: 32px;
  height: 32px;
}

.lds-dual-ring:after {
  content: " ";
  display: block;
  width: 24px;
  height: 24px;
  margin: 4px;
  border-radius: 50%;
  border: 3px solid #6b4f33;
  border-color: #6b4f33 transparent #6b4f33 transparent;
  animation: lds-dual-ring 1.2s linear infinite;
}

@keyframes lds-dual-ring {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

</style>
</head>

<body>
<div class="container" id="quizContainer">

  <!-- Name Entry Page -->
  <div id="nameForm">
    <h1 id="quizTitle" style="font-size:2rem; margin-bottom:0.3rem; color:#4a3b2a;">
The Invention That Changed the World the Most: Artificial Intelligence <br> Part 4
<h3 id="quizAuthor" style="font-size:1.1rem; margin-bottom:1.5rem; color:#6b4f33; font-weight:normal;">
<br> 
</h3>

    <input type="text" id="nameInput" placeholder="Enter your name" />
    <select id="departmentSelect">
      <option value="">-- Select Department --</option>
      <option value="Cyber Security">Cyber Security</option>
      <option value="CSE-1">CSE-1</option>
      <option value="CSE-2">CSE-2</option>
      <option value="CSE-3">CSE-3</option>
      <option value="Mechanical Engineering">Mechanical Engineering</option>
      <option value="ECE-1">ECE-1</option>
      <option value="ECE-2">ECE-2</option>
      <option value="ECE-3">ECE-3</option>
      <option value="AI DS-1">AI DS-1</option>
      <option value="AI DS-2">AI DS-2</option>
      <option value="Civil">Civil</option>
      <option value="Agri">Agri</option>
      <option value="EEE">EEE</option>
      <option value="EIE">EIE</option>
      <option value="Medical Electronics">Medical Electronics</option>
      <option value="IT-1">IT-1</option>
      <option value="IT-2">IT-2</option>
    </select>
    <!-- FIX: Removed inline onclick, will be added in JS. But for minimal change, we just need to make beginQuiz global. -->
    <button id="startQuizBtn" onclick="beginQuiz()">Start Quiz</button>
  </div>

  <!-- Quiz Content -->
  <div id="quizContent" style="display:none;">
    <div class="top-strip" id="topStrip">
      <div class="top-strip-header">
        <div id="timer">‚è≥ 0s</div>
        <div id="gemsCounter">üíé 0</div>
        <div id="progressTracker">üìç 1 / 1</div>
      </div>
      <div class="top-strip-answers" id="dragOptions"></div>
    </div>

    <div class="drop-container" id="dropContainer"></div>
    <div id="savingSpinner" style="
  display:none;
  margin-top: 1.5rem;
  font-size: 1.1rem;
  color:#6b4f33;
  text-align:center;
">
  <div class="lds-dual-ring" style="
    display:inline-block;
    width:32px;
    height:32px;
    margin-bottom:8px;
  "></div>
  <div>Saving your progress...</div>
</div>
    <div id="scoreCard"></div>
    <button id="nextPageBtn" style="display: none;">Next &rarr;</button>
    <button id="restartBtn" style="display: none;">Restart</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  'https://ahezssoczvpbkteffcgz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE'
);

// DNS warm-up 
fetch("https://ahezssoczvpbkteffcgz.supabase.co/rest/v1/", { mode: "no-cors" });

// --- HELPER FUNCTIONS ---
function autoGenerateBlanks(passage, frequency = 7) {
  const words = passage.split(/(\s+)/);
  const answers = [];
  let wordCount = 0;
  
  const blankedPassage = words.map(word => {

    // ‚úÖ FIX: Never blank HTML tags (prevents <em> and </em> becoming answers)
    if (word.trim().startsWith("<") && word.trim().endsWith(">")) {
      return word;
    }

    if (word.trim() && ++wordCount % frequency === 0) {
      answers.push(word.replace(/<[^>]*>/g, "").trim());
      return '___';
    }
    return word;
  }).join('');
  
  return { passage: blankedPassage, answers };
}

  

// --- QUIZ DATA ---
const quizDataStore = (() => {
const fullPassage = ` AI challenges human identity by redefining the very idea of intelligence. For millennia, intelligence distinguished humans from other beings; it shaped our sense of dignity, purpose, and uniqueness. AI unsettles this long-held boundary. Epictetus observed, ‚ÄúIt‚Äôs not what happens to you, but how you react to it that matters.‚Äù This is the right frame for understanding AI. The technology itself is neutral; it is our response that determines whether it enriches or erodes our humanity.

If AI can now perform tasks once seen as hallmarks of intelligence, the human task is not to despair but to rise. We must shift our focus to creativity, judgement, ethics, empathy, and intention. These are the higher forms of thought that machines cannot imitate meaningfully. AI does not diminish human intelligence; it sharpens it by stripping away routine cognition and forcing us to reconsider what truly counts as intellectual excellence.

In Harry Potter and the Philosopher‚Äôs Stone, Hermione captures this hierarchy of values when she declares, ‚ÄúBooks! And cleverness! There are more important things: friendship and bravery.‚Äù Her insight mirrors our present moment: intelligence remains vital, but it is our character, courage, and choices that ultimately define us.

`;

    const result = autoGenerateBlanks(fullPassage, 7);
  return [result];
})();

const currentQuestID = "Quest 116";

// --- STATE VARIABLES ---
let quizData = [];          // flattened pages
let current = 0;            // current page index
let wrongQuestions = [];    // pages to retry
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;
let totalQuestionsInQuiz = 0; // includes wrong-page retries

const blanksPerPage = 10;

// --- DOM ELEMENTS ---
const quizContainer   = document.getElementById("quizContainer");
const dragOptionsEl   = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl         = document.getElementById("timer");
const gemsCounterEl   = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard       = document.getElementById("scoreCard");
const restartBtn      = document.getElementById("restartBtn");
const nextPageBtn     = document.getElementById("nextPageBtn");
const quizContentEl   = document.getElementById("quizContent");
const nameFormEl      = document.getElementById("nameForm");
const nameInputEl     = document.getElementById("nameInput");
const deptSelectEl    = document.getElementById("departmentSelect");
const topStripEl      = document.getElementById("topStrip");

/* --------------- LAYOUT & PRE-FLIGHT --------------- */

/* Measure the top strip height and push the passage below it */
function adjustForTopStrip() {
  const h = topStripEl ? topStripEl.offsetHeight : 0;
  dropContainerEl.style.marginTop = h + "px";
  // Leave ~1.5rem visual breathing at bottom; ensure max-height fits viewport
  dropContainerEl.style.maxHeight = `calc(100vh - ${h}px - 2rem)`;
}

function autoFillFromStorage() {
  try {
    const storedName = localStorage.getItem('playerName');
    const storedDept = localStorage.getItem('playerDept');
    
    if (storedName) {
      nameInputEl.value = storedName;
    }
    if (storedDept) {
      deptSelectEl.value = storedDept;
    }
  } catch (e) {
    console.log('Could not access localStorage:', e);
  }
}
 async function resendPendingSubmissions() {
  const key = 'pendingQuestSubmissions';
  let pending = JSON.parse(localStorage.getItem(key) || "[]");

  if (pending.length === 0) return;

  console.log("üîÑ Trying to resend pending submissions:", pending);

  const stillPending = [];

  for (const entry of pending) {
    try {
      const ok = await sendViaEdgeFunction(entry);
      if (!ok) throw new Error("Edge function failed");
      console.log("‚úî Resent successfully:", entry);
    } catch (e) {
      console.warn("‚ö† Still pending:", entry);
      stillPending.push(entry);
    }
  }

  // update storage
  if (stillPending.length === 0) {
    localStorage.removeItem(key);
  } else {
    localStorage.setItem(key, JSON.stringify(stillPending));
  }
}


/* --------------- QUIZ FLOW (FUNCTIONS) --------------- */

function beginQuiz() {
  if (!nameInputEl.value.trim()) {
    nameInputEl.style.borderColor = "red";
    return;
  }
  if (!deptSelectEl.value) {
    deptSelectEl.style.borderColor = "red";
    return;
  }
  nameInputEl.style.borderColor = "#c2a677";
  deptSelectEl.style.borderColor = "#c2a677";

  playerName = nameInputEl.value.trim();
  playerDept = deptSelectEl.value;
  
  // Save to localStorage for future use
  try {
    localStorage.setItem('playerName', playerName);
    localStorage.setItem('playerDept', playerDept);
  } catch (e) {
    console.log('Could not save to localStorage:', e);
  }

  document.getElementById("quizTitle").style.display = "none";
  document.getElementById("quizAuthor").style.display = "none";

  nameFormEl.style.display = "none";
  quizContentEl.style.display = "block";
  startQuiz();
}

// FIX: Expose beginQuiz to the global scope for the inline onclick attribute
window.beginQuiz = beginQuiz;

function startQuiz() {
  quizData = [];
  wrongQuestions = [];

  // Flatten passages into page objects
  quizDataStore.forEach((p, idx) => {
    const total = p.answers.length;
    const totalPages = Math.ceil(total / blanksPerPage);
    for (let i = 0; i < totalPages; i++) {
      quizData.push({
        originalPassage: p.passage,
        originalAnswers: p.answers,
        pageIndex: i,
        passageIndex: idx,
        totalPassagePages: totalPages,
        pageId: `p${idx}-pg${i}`
      });
    }
  });

  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();
  totalQuestionsInQuiz = quizData.length;

  timerEl.innerText = "‚è≥ 0s";
  gemsCounterEl.innerText = `üíé 0`;
  scoreCard.innerHTML = "";
  restartBtn.style.display = "none";
  nextPageBtn.style.display = "none";

  loadQuestion();
  startTimer(); // This will now work
}

function updateProgress() {
  const currentQuestionNumber = current + 1;
  if (quizData[current]) {
    progressTracker.innerText = `üìç ${currentQuestionNumber} / ${totalQuestionsInQuiz}`;
  } else if (current > 0) {
    progressTracker.innerText = "Done!";
  } else {
    progressTracker.innerText = `üìç 1 / ${totalQuestionsInQuiz}`;
  }
}

function loadQuestion() {
  if (current >= quizData.length) {
    return showScore();
  }

  selectedOption = null;
  const d = quizData[current];

  updateProgress();

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  nextPageBtn.style.display = "none";

  // Page slice
  const s = d.pageIndex * blanksPerPage;
  const e = s + blanksPerPage;

  const answers = d.originalAnswers.slice(s, e);
  const parts = d.originalPassage.split("___").slice(s, e + 1);

  // Render answers (shuffled), compact & centered
  const shuffled = [...answers].sort(() => Math.random() - 0.5);
  shuffled.forEach(ans => {
    const div = document.createElement("div");
    div.classList.add("drag-item");
    div.innerText = ans;
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  // Passage parts
  if (s > 0) dropContainerEl.appendChild(document.createTextNode("... "));
  parts.forEach((part, i) => {
  const span = document.createElement("span");
span.innerHTML = part;   // allow <b>, <br>, <p>, etc.
dropContainerEl.appendChild(span);
  if (i < answers.length) {
      const b = document.createElement("button");
      b.classList.add("drop-zone");
      b.innerText = "___";
      b.dataset.answer = answers[i];
      b.onclick = () => placeOption(b);
      dropContainerEl.appendChild(b);
      dropContainerEl.appendChild(document.createTextNode(" "));
    }
  });
  if (e < d.originalAnswers.length) dropContainerEl.appendChild(document.createTextNode(" ..."));

  // After rendering, adjust for top strip height
  adjustForTopStrip();
}

function selectOption(div) {
  if (div.style.display === "none") return;
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

function placeOption(dz) {
  if (!selectedOption || dz.classList.contains("filled")) return;

  const ans = selectedOption.innerText;
  const correct = dz.dataset.answer;

  if (ans === correct) {
    // Correct
    correctCount++;
    gemsCount++;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;

    // FX
    createSparkleEffect(dz);
    gemsCounterEl.classList.add('gem-counter-pulse');
    setTimeout(() => gemsCounterEl.classList.remove('gem-counter-pulse'), 400);

    dz.innerText = ans;
    dz.classList.add("correct", "filled");
    dz.disabled = true;
    selectedOption.style.display = "none";
  } else {
    // Wrong
    totalWrongGuesses++;
    gemsCount--;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    dz.classList.add("wrong");
    setTimeout(() => dz.classList.remove("wrong"), 600);

    // Queue this page for retry if not already queued
    const currentData = quizData[current];
    if (!wrongQuestions.includes(currentData)) {
      wrongQuestions.push(currentData);
      totalQuestionsInQuiz++;   // keep total growing to reflect retries
      updateProgress();         // immediate reflect in header
    }
  }

  if (selectedOption) {
    selectedOption.classList.remove("selected");
    selectedOption = null;
  }

  if (!dropContainerEl.querySelector(".drop-zone:not(.filled)")) {
    nextPageBtn.style.display = "inline-block";
  }
}

function createSparkleEffect(element) {
  const rect = element.getBoundingClientRect();
  const containerRect = quizContainer.getBoundingClientRect();

  const sparkCount = 8;
  for (let i = 0; i < sparkCount; i++) {
    const spark = document.createElement('div');
    spark.className = 'gem-spark';
    spark.innerText = ['üíé', '‚ú®', '‚≠ê'][Math.floor(Math.random() * 3)];
    spark.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
    spark.style.top  = `${rect.top  - containerRect.top  + rect.height / 2}px`;
    const randomX = (Math.random() - 0.5) * 100;
    spark.style.setProperty('--random-x', `${randomX}px`);
    quizContainer.appendChild(spark);
    setTimeout(() => spark.remove(), 1000);
  }
}
async function sendViaEdgeFunction(payload) {
  try {
    const response = await fetch(
      "https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/logQuest",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }
    );

    if (!response.ok) return false;

    const data = await response.json();
    return data.success === true;
  } catch (e) {
    return false;
  }
}

      
async function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  // ‚≠ê SHOW spinner while saving
  document.getElementById("savingSpinner").style.display = "block";
  scoreCard.innerHTML = "";
  nextPageBtn.style.display = "none";

  // ‚≠ê Retry logic for iPhone
 async function trySave(attempt = 1) {
  const submission = {
    student_name: playerName,
    department: playerDept,
    correct: correctCount,
    wrong: totalWrongGuesses,
    time_spent: totalTime,
    quest_id: currentQuestID
  };

  try {
    const ok = await sendViaEdgeFunction(submission);
    if (ok) return true;

    throw new Error("Edge function failed");

  } catch (err) {
    if (attempt < 3) {
      console.warn(`Save failed (attempt ${attempt}), retrying...`);
      await new Promise(res => setTimeout(res, 1000));
      return await trySave(attempt + 1);
    }
    return false;
  }
}


  const saved = await trySave();

  // ‚≠ê Hide spinner after saving
  document.getElementById("savingSpinner").style.display = "none";

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "<h2 style='text-align:center;'>üéâ Quiz Completed!</h2>";
  progressTracker.innerText = "Done!";

  const successMessage = (totalWrongGuesses === 0)
    ? "<p>‚úÖ Flawless! All questions answered correctly on the first attempt!</p>"
    : `<p>‚úÖ Correct Answers (total): ${correctCount}</p>
       <p>‚ùå Wrong Attempts (total): ${totalWrongGuesses}</p>`;
  let statusLine = "";

  if (saved) {
    statusLine = `<p style="color:green;">‚úî Saved to server</p>`;

  } else {
    // save locally
    const key = 'pendingQuestSubmissions';
    const pending = JSON.parse(localStorage.getItem(key) || "[]");

    const submission = {
      student_name: playerName,
      department: playerDept,
      correct: correctCount,
      wrong: totalWrongGuesses,
      time_spent: totalTime,
      quest_id: currentQuestID,
      timestamp: Date.now()
    };

    pending.push(submission);
    localStorage.setItem(key, JSON.stringify(pending));

    statusLine = `
      <p style="color:red;">‚ö†Ô∏è Could not save to server.<br>Saved locally.</p>
      <button id="retrySaveBtn"
        style="margin-top:10px; padding:6px 14px; background:#d9534f; color:white; border:none; border-radius:8px; cursor:pointer;">
        üîÑ Try Again
      </button>
    `;
  }

  // ‚≠ê PDF ALWAYS ENABLED
  const pdfButton = `
    <button onclick="downloadPDFReport()" 
      style="margin-top: 1rem; padding: 0.7rem 2rem; background-color: #4CAF50; border: none; border-radius: 10px; cursor: pointer; color: white; font-size: 1rem;">
      üì• Download PDF Report
    </button>
  `;

  // ‚≠ê FINAL SCORECARD RENDERING
  scoreCard.innerHTML = `
    <p>üë§ Player: <strong>${playerName}</strong> (${playerDept})</p>
    ${successMessage}
    <p>üíé Final Gems: ${gemsCount}</p>
    <p>‚è±Ô∏è Time Taken: ${totalTime} seconds</p>
    ${statusLine}
    ${pdfButton}
  `;

  // ‚≠ê Manual retry button activation
  setTimeout(() => {
    const retryBtn = document.getElementById("retrySaveBtn");
    if (retryBtn) {
      retryBtn.onclick = async () => {
        retryBtn.innerText = "Trying...";
        retryBtn.style.opacity = 0.6;

        await resendPendingSubmissions();

        const key = 'pendingQuestSubmissions';
        const pending = JSON.parse(localStorage.getItem(key) || "[]");

        if (pending.length === 0) {
          retryBtn.innerText = "‚úî Saved!";
          retryBtn.style.background = "#4CAF50";
        } else {
          retryBtn.innerText = "Retry Failed";
          retryBtn.style.background = "#a94442";
        }
      };
    }
  }, 50);

  restartBtn.style.display = "inline-block";
}


// FIX: Moved startTimer to the top-level scope
function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime)/1000);
    timerEl.innerText = `‚è≥ ${elapsed}s`;
  }, 1000);
}

/* --------------- PDF REPORT --------------- */
// FIX: Moved downloadPDFReport to the top-level scope
function downloadPDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4" });

  const pageHeight = doc.internal.pageSize.height;
  const marginLeft = 20;
  const usableWidth = 170;

  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });

  // ‚úÖ Uses the questID variable defined at the top
  const questID = currentQuestID; 

  /* ---------------- HEADER ---------------- */

  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, "F");
  doc.setTextColor(255, 255, 255);
  doc.setFont("times", "bold");
  doc.setFontSize(18);
  doc.text("SRM VALLIAMMAI ENGINEERING COLLEGE", 105, 16, { align: "center" });
  doc.setFontSize(12);
  doc.setFont("times", "italic");
  doc.text("(Autonomous)", 105, 23, { align: "center" });
  doc.setFontSize(15);
  doc.setFont("times", "normal");
  doc.text("Department of English", 105, 31, { align: "center" });

  doc.setFontSize(14);
  doc.setFont("times", "bold");
  doc.setTextColor(212, 175, 55);
  doc.text(`${questID} ‚Äî Performance Report`, 105, 39, { align: "center" });

  /* ---------------- STUDENT INFO ---------------- */

  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text("CANDIDATE INFORMATION", marginLeft, 55);

  doc.autoTable({
    startY: 58,
    body: [
      ["Student Name", playerName],
      ["Department", playerDept],
      ["Quest ID", questID],
      ["Completed On", reportDate],
    ],
    theme: "plain",
    styles: { fontSize: 10, font: "times", cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 },
    },
    margin: { left: marginLeft, right: marginLeft },
  });

  /* ---------------- PERFORMANCE SUMMARY ---------------- */

  let y = doc.lastAutoTable.finalY + 10;

  if (y > pageHeight - 30) {
    doc.addPage();
    y = 20;
  }

  doc.setFont("times", "bold");
  doc.text("PERFORMANCE SUMMARY", marginLeft, y);
  y += 3;

  doc.autoTable({
    startY: y + 3,
    body: [
      ["Total Question Pages", quizData.length.toString()],
      ["Correct Answers (Total)", correctCount.toString()],
      ["Wrong Attempts (Total)", totalWrongGuesses.toString()],
      ["Final Gems Earned", gemsCount.toString()],
      ["Total Time", `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`],
    ],
    theme: "grid",
    styles: { fontSize: 10, font: "times", cellPadding: 3 },
    margin: { left: marginLeft, right: marginLeft },
    pageBreak: "auto",
  });

  y = doc.lastAutoTable.finalY + 12;

  /* ---------------- QUESTION BANK ---------------- */

  if (y > pageHeight - 30) {
    doc.addPage();
    y = 20;
  }

  doc.setFont("times", "bold");
  doc.text("QUESTION BANK WITH CORRECT ANSWERS", marginLeft, y);
  y += 6;

  quizDataStore.forEach((item, i) => {
    /* Predict text block height BEFORE writing */
    let fullPassage = item.passage;

    item.answers.forEach(ans => {
      fullPassage = fullPassage.replace("___", ` [${ans}] `);
    });
fullPassage = fullPassage.replace(/<[^>]*>/g, "");

    const lines = doc.splitTextToSize(fullPassage, usableWidth);
    const blockHeight = lines.length * 5 + 10; // estimate

    // ‚úÖ PREVENT overflow BEFORE writing
    if (y + blockHeight > pageHeight - 20) {
      doc.addPage();
      y = 20;
    }

    // Question heading
    doc.setFont("times", "bold");
    doc.setFontSize(11);
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, marginLeft, y);
    y += 6;

    // Passage
    doc.setFont("times", "normal");
    doc.setTextColor(0, 0, 0);
    doc.text(lines, marginLeft + 5, y);
    y += lines.length * 5 + 3;

    // Divider line
    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.3);
    doc.line(marginLeft, y, 190, y);
    y += 5;
  });

  /* ---------------- FOOTER ON LAST PAGE ---------------- */

  doc.setDrawColor(184, 134, 11);
  doc.setLineWidth(0.5);
  doc.line(marginLeft, pageHeight - 17, 190, pageHeight - 17);

  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.setFont("times", "italic");
  doc.text("This is a system-generated report", 105, pageHeight - 10, { align: "center" });

  /* ---------------- SAVE FILE ---------------- */

  const cleanName = playerName.replace(/[^a-zA-Z0-9]/g, "_");
  const cleanQuest = questID.replace(/[^a-zA-Z0-9]/g, "_");

  doc.save(`${cleanName}_${cleanQuest}_Report.pdf`);
}

// FIX: Expose downloadPDFReport to the global scope for the inline onclick
window.downloadPDFReport = downloadPDFReport;

  /* Safe autoresend: Supabase is ready because we are inside the module */
window.addEventListener('DOMContentLoaded', () => {
  autoFillFromStorage();
  resendPendingSubmissions();
});

/* Recalculate layout on resize (for top-strip height changes due to wrapping) */
window.addEventListener('resize', adjustForTopStrip);

/* --- Button Clicks (using JS properties) --- */
restartBtn.onclick = () => {
  quizContentEl.style.display = "none";
  nameFormEl.style.display = "block";
  
  // Clear the fields for a true restart
  nameInputEl.value = ""; 
  deptSelectEl.value = "";
  
  // Also clear from storage so it doesn't auto-fill next time
  try {
     localStorage.removeItem('playerName');
     localStorage.removeItem('playerDept');
  } catch(e) {
     console.log('Could not clear localStorage');
  }

  nextPageBtn.style.display = "none";
  
  // Reset title/author
  document.getElementById("quizTitle").style.display = "block";
  document.getElementById("quizAuthor").style.display = "block";
};

nextPageBtn.onclick = () => {
  current++;
  if (current >= quizData.length && wrongQuestions.length > 0) {
    quizData.push(...wrongQuestions);
    wrongQuestions = [];
  }
  loadQuestion();
};

</script>

<!-- PWA-friendly link handling -->
<script>
document.addEventListener("click", function (e) {
  const target = e.target.closest("a");
  if (!target) return;

  const url = target.href;
  const internalDomains = [
    window.location.origin,
    "andrewveda.github.io",
    "sites.google.com/view/cys-english/",
    "sites.google.com/view/srm-vec-english/"
  ];

  const isInternal = internalDomains.some(domain => url.includes(domain));

  if (isInternal) {
    if (
      window.matchMedia("(display-mode: standalone)").matches ||
      window.matchMedia("(display-mode: fullscreen)").matches
    ) {
      e.preventDefault();
      window.location.href = url;
    }
  } else {
    target.setAttribute("target", "_blank");
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>The Icecream Story üåå</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --page-padding-x: 1.5rem;
    --top-strip-bg: rgba(255, 255, 240, 0.96);
    --top-strip-border: #d2b48c;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(ellipse at center, #f4ecd8 0%, #e8d9b5 100%);
    color: #3b2f1e;
    text-align: center;
    width: 100vw;
    height: 100vh;
    overflow-x: hidden;
  }

  .container {
    position: relative;
    background: rgba(255, 255, 240, 0.85);
    width: 100vw;
    min-height: 100vh;
    margin: 0;
    border: none;
    border-radius: 0;
    box-shadow: none;
    padding: 0;
  }

  #nameForm {
    padding: 5rem var(--page-padding-x) 2rem;
  }
  #nameInput, #departmentSelect {
    display: block;
    width: 90%;
    max-width: 300px;
    margin: 1rem auto;
    padding: 0.7rem;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #c2a677;
    background: #fffdf6;
    color: #3b2f1e;
  }
  #startQuizBtn {
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #8b7355;
    border: 1px solid #5b442a;
    border-radius: 10px;
    cursor: pointer;
    color: #ffffff;
    transition: background-color 0.2s ease;
  }
  #startQuizBtn:hover { background-color: #6b5a43; }

  .top-strip {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--top-strip-bg);
    border-bottom: 1px solid var(--top-strip-border);
    padding: 0.5rem 0.8rem;
    z-index: 30;
    backdrop-filter: blur(4px);
  }
  
  .top-strip-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95rem;
    color: #5b442a;
    margin-bottom: 0.35rem;
    padding: 0 var(--page-padding-x);
  }
  #timer, #gemsCounter, #progressTracker {
    font-size: 1.05rem;
    color: #6b4f33;
    font-weight: 500;
  }
  
  .top-strip-answers {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    justify-content: center;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #d2b48c;
  }

  .drag-item {
    display: inline-block;
    padding: 0.35rem 0.6rem;
    font-size: 0.95rem;
    background: #f7e7c4;
    border: 1px solid #d2b48c;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease-in-out;
    color: #3b2f1e;
    white-space: nowrap;
  }
  .drag-item:hover { background: #f5deb3; transform: scale(1.05); }
  .drag-item.selected { border: 2px solid #8b7355; background: #f0dba5; transform: scale(1.02); }

  .drop-container {
    padding: 0.8rem var(--page-padding-x) 2rem;
    overflow-y: auto;
    text-align: justify;
    line-height: 1.9;
    font-size: 1.3rem;
    color: #3b2f1e;
  }

  .drop-zone {
    display: inline-block;
    border: 1px dashed #a1886f;
    padding: 0.2rem 0.8rem;
    margin: 0 0.2rem;
    cursor: pointer;
    background: #fffdf6;
    color: #5b442a;
    font-size: 1.2rem;
    font-family: 'Courier New', Courier, monospace;
    border-radius: 5px;
    min-width: 60px;
    text-align: center;
    transition: all 0.2s ease;
    vertical-align: middle;
  }
  .drop-zone:hover { background: #f7e7c4; }
  .drop-zone.filled {
    border: 1px solid transparent;
    background: none;
    color: #228b22;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: bold;
    padding: 0.2rem 0.2rem;
    min-width: unset;
    cursor: default;
  }
  .correct { color: #228b22 !important; }
  .wrong { border-color: #b22222 !important; animation: shake 0.5s ease-in-out; }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  @keyframes sparkle {
    0% { transform: translate(0, 0) scale(1); opacity: 1; }
    100% { transform: translate(var(--random-x, 0), -100px) scale(1.5); opacity: 0; }
  }
  @keyframes gemPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
  }
  .gem-spark { position: absolute; pointer-events: none; font-size: 1.5rem; animation: sparkle 1s ease-out forwards; z-index: 20; }
  .gem-counter-pulse { animation: gemPulse 0.4s ease-in-out; }

  #nextPageBtn {
    margin-top: 1.5rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #4CAF50;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    color: white;
    transition: background-color 0.2s ease;
    font-weight: bold;
  }
  #nextPageBtn:hover { background-color: #45a049; }

  #restartBtn {
    margin-top: 2rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #d2b48c;
    border: 1px solid #a1886f;
    border-radius: 10px;
    cursor: pointer;
    color: #3b2f1e;
    transition: background-color 0.2s ease;
  }
  #restartBtn:hover { background-color: #c9a96b; }

  #scoreCard {
    margin-top: 2rem;
    font-size: 1.2rem;
    color: #4b3b2a;
  }
</style>
</head>

<body>
<div class="container" id="quizContainer">

  <div id="nameForm">
    <h1 id="quizTitle" style="font-size:2rem; margin-bottom:0.3rem; color:#4a3b2a;">
      US President Ronald Reagan's Reframing
    </h1>
    <h3 id="quizAuthor" style="font-size:1.1rem; margin-bottom:1.5rem; color:#6b4f33; font-weight:normal;">
      <br> 
    </h3>

    <input type="text" id="nameInput" placeholder="Enter your name" />
    <select id="departmentSelect">
      <option value="">-- Select Department --</option>
      <option value="Cyber Security">Cyber Security</option>
      <option value="CSE-1">CSE-1</option>
      <option value="CSE-2">CSE-2</option>
      <option value="CSE-3">CSE-3</option>
      <option value="Mechanical Engineering">Mechanical Engineering</option>
      <option value="ECE-1">ECE-1</option>
      <option value="ECE-2">ECE-2</option>
      <option value="ECE-3">ECE-3</option>
      <option value="AI DS-1">AI DS-1</option>
      <option value="AI DS-2">AI DS-2</option>
      <option value="Civil">Civil</option>
      <option value="Agri">Agri</option>
      <option value="EEE">EEE</option>
      <option value="EIE">EIE</option>
      <option value="Medical Electronics">Medical Electronics</option>
      <option value="IT-1">IT-1</option>
      <option value="IT-2">IT-2</option>
    </select>
    <button id="startQuizBtn" onclick="beginQuiz()">Start Quiz</button>
  </div>

  <div id="quizContent" style="display:none;">
    <div class="top-strip" id="topStrip">
      <div class="top-strip-header">
        <div id="timer">‚è≥ 0s</div>
        <div id="gemsCounter">üíé 0</div>
        <div id="progressTracker">üìç 1 / 1</div>
      </div>
      <div class="top-strip-answers" id="dragOptions"></div>
    </div>

    <div class="drop-container" id="dropContainer"></div>
    <div id="scoreCard"></div>
    <button id="nextPageBtn" style="display: none;">Next &rarr;</button>
    <button id="restartBtn" style="display: none;">Restart</button>
  </div>
</div>

<script>
const currentQuestID = "Story 79";

function autoGenerateBlanks(passage, frequency = 7) {
  const words = passage.split(/(\s+)/);
  const answers = [];
  let wordCount = 0;
  
  const blankedPassage = words.map(word => {
    if (word.trim() && ++wordCount % frequency === 0) {
      answers.push(word.trim());
      return '___';
    }
    return word;
  }).join('');
  
  return { passage: blankedPassage, answers };
}

const quizDataStore = (() => {
  const fullPassage = ` In 1984, America was preparing for its presidential election. Ronald Reagan, the sitting president, was seventy-three years old, the oldest man to have held the office at that time. His opponent, Walter Mondale, was much younger and wanted the country to notice it.

The media did too. They began to ask whether Reagan was too old to handle the pressures of the presidency. In the first debate, he looked tired. He forgot a number or two. People whispered that perhaps he was slowing down.

Then came the second debate. The hall was quiet. Cameras were close. The moderator asked, politely but clearly:

"Mr. President, you've been the oldest person ever elected to the presidency. Do you think your age might limit your ability to function in office?"

It was a trap, neatly laid.

Reagan did not explain. He did not argue. He merely smiled. It was the sort of small smile that suggests both patience and amusement. Then, with perfect calm, he said:

"I will not make age an issue of this campaign. I am not going to exploit, for political purposes, my opponent's youth and inexperience."

The room broke. Laughter rose like a tide. Everyone laughed and applauded, the audience, the moderator, even Mondale himself.

That single line changed everything. The question of Reagan's age never returned.

It was not only a joke. It was reframing at its best.
Simple reframing turns weakness into strength. It transforms the weapons aimed at you, polishing it until it becomes your shield.

Reagan didn't argue about age. He did not fight.

You have to win the war without fighting, remember?
He agreed to what was said. Agreement is the first step, remember?`;
  
  const result = autoGenerateBlanks(fullPassage, 7);
  return [result];
})();

let quizData = [];
let current = 0;
let wrongQuestions = [];
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;
let totalQuestionsInQuiz = 0;

const blanksPerPage = 10;

const quizContainer   = document.getElementById("quizContainer");
const dragOptionsEl   = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl         = document.getElementById("timer");
const gemsCounterEl   = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard       = document.getElementById("scoreCard");
const restartBtn      = document.getElementById("restartBtn");
const nextPageBtn     = document.getElementById("nextPageBtn");
const quizContentEl   = document.getElementById("quizContent");
const nameFormEl      = document.getElementById("nameForm");
const nameInputEl     = document.getElementById("nameInput");
const deptSelectEl    = document.getElementById("departmentSelect");
const topStripEl      = document.getElementById("topStrip");

function adjustForTopStrip() {
  const h = topStripEl ? topStripEl.offsetHeight : 0;
  dropContainerEl.style.marginTop = h + "px";
  dropContainerEl.style.maxHeight = `calc(100vh - ${h}px - 2rem)`;
}

function autoFillFromStorage() {
  try {
    const storedName = localStorage.getItem('playerName');
    const storedDept = localStorage.getItem('playerDept');
    
    if (storedName) {
      nameInputEl.value = storedName;
    }
    if (storedDept) {
      deptSelectEl.value = storedDept;
    }
  } catch (e) {
    console.log('Could not access localStorage:', e);
  }
}

window.addEventListener('DOMContentLoaded', autoFillFromStorage);

function beginQuiz() {
  if (!nameInputEl.value.trim()) {
    nameInputEl.style.borderColor = "red";
    return;
  }
  if (!deptSelectEl.value) {
    deptSelectEl.style.borderColor = "red";
    return;
  }
  nameInputEl.style.borderColor = "#c2a677";
  deptSelectEl.style.borderColor = "#c2a677";

  playerName = nameInputEl.value.trim();
  playerDept = deptSelectEl.value;
  
  try {
    localStorage.setItem('playerName', playerName);
    localStorage.setItem('playerDept', playerDept);
  } catch (e) {
    console.log('Could not save to localStorage:', e);
  }

  document.getElementById("quizTitle").style.display = "none";
  document.getElementById("quizAuthor").style.display = "none";

  nameFormEl.style.display = "none";
  quizContentEl.style.display = "block";
  startQuiz();
}

function startQuiz() {
  quizData = [];
  wrongQuestions = [];

  quizDataStore.forEach((p, idx) => {
    const total = p.answers.length;
    const totalPages = Math.ceil(total / blanksPerPage);
    for (let i = 0; i < totalPages; i++) {
      quizData.push({
        originalPassage: p.passage,
        originalAnswers: p.answers,
        pageIndex: i,
        passageIndex: idx,
        totalPassagePages: totalPages,
        pageId: `p${idx}-pg${i}`
      });
    }
  });

  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();
  totalQuestionsInQuiz = quizData.length;

  timerEl.innerText = "‚è≥ 0s";
  gemsCounterEl.innerText = `üíé 0`;
  scoreCard.innerHTML = "";
  restartBtn.style.display = "none";
  nextPageBtn.style.display = "none";

  loadQuestion();
  startTimer();
}

function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime)/1000);
    timerEl.innerText = `‚è≥ ${elapsed}s`;
  }, 1000);
}

function updateProgress() {
  const currentQuestionNumber = current + 1;
  if (quizData[current]) {
    progressTracker.innerText = `üìç ${currentQuestionNumber} / ${totalQuestionsInQuiz}`;
  } else if (current > 0) {
    progressTracker.innerText = "Done!";
  } else {
    progressTracker.innerText = `üìç 1 / ${totalQuestionsInQuiz}`;
  }
}

function loadQuestion() {
  if (current >= quizData.length) {
    return showScore();
  }

  selectedOption = null;
  const d = quizData[current];

  updateProgress();

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  nextPageBtn.style.display = "none";

  const s = d.pageIndex * blanksPerPage;
  const e = s + blanksPerPage;

  const answers = d.originalAnswers.slice(s, e);
  const parts = d.originalPassage.split("___").slice(s, e + 1);

  const shuffled = [...answers].sort(() => Math.random() - 0.5);
  shuffled.forEach(ans => {
    const div = document.createElement("div");
    div.classList.add("drag-item");
    div.innerText = ans;
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  if (s > 0) dropContainerEl.appendChild(document.createTextNode("... "));
  parts.forEach((part, i) => {
    dropContainerEl.appendChild(document.createTextNode(part));
    if (i < answers.length) {
      const b = document.createElement("button");
      b.classList.add("drop-zone");
      b.innerText = "___";
      b.dataset.answer = answers[i];
      b.onclick = () => placeOption(b);
      dropContainerEl.appendChild(b);
      dropContainerEl.appendChild(document.createTextNode(" "));
    }
  });
  if (e < d.originalAnswers.length) dropContainerEl.appendChild(document.createTextNode(" ..."));

  adjustForTopStrip();
}

function selectOption(div) {
  if (div.style.display === "none") return;
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

function placeOption(dz) {
  if (!selectedOption || dz.classList.contains("filled")) return;

  const ans = selectedOption.innerText;
  const correct = dz.dataset.answer;

  if (ans === correct) {
    correctCount++;
    gemsCount++;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;

    createSparkleEffect(dz);
    gemsCounterEl.classList.add('gem-counter-pulse');
    setTimeout(() => gemsCounterEl.classList.remove('gem-counter-pulse'), 400);

    dz.innerText = ans;
    dz.classList.add("correct", "filled");
    dz.disabled = true;
    selectedOption.style.display = "none";
  } else {
    totalWrongGuesses++;
    gemsCount--;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    dz.classList.add("wrong");
    setTimeout(() => dz.classList.remove("wrong"), 600);

    const currentData = quizData[current];
    if (!wrongQuestions.includes(currentData)) {
      wrongQuestions.push(currentData);
      totalQuestionsInQuiz++;
      updateProgress();
    }
  }

  if (selectedOption) {
    selectedOption.classList.remove("selected");
    selectedOption = null;
  }

  if (!dropContainerEl.querySelector(".drop-zone:not(.filled)")) {
    nextPageBtn.style.display = "inline-block";
  }
}

function createSparkleEffect(element) {
  const rect = element.getBoundingClientRect();
  const containerRect = quizContainer.getBoundingClientRect();

  const sparkCount = 8;
  for (let i = 0; i < sparkCount; i++) {
    const spark = document.createElement('div');
    spark.className = 'gem-spark';
    spark.innerText = ['üíé', '‚ú®', '‚≠ê'][Math.floor(Math.random() * 3)];
    spark.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
    spark.style.top  = `${rect.top  - containerRect.top  + rect.height / 2}px`;
    const randomX = (Math.random() - 0.5) * 100;
    spark.style.setProperty('--random-x', `${randomX}px`);
    quizContainer.appendChild(spark);
    setTimeout(() => spark.remove(), 1000);
  }
}

function saveAttemptLocally(attemptData) {
  try {
    attemptData.id = crypto.randomUUID();
    attemptData.synced = false;

    let queue = JSON.parse(localStorage.getItem("attemptQueue") || "[]");
    queue.push(attemptData);
    localStorage.setItem("attemptQueue", JSON.stringify(queue));
    console.log("üíæ Saved locally:", attemptData);
  } catch (e) {
    console.log('Could not save attempt:', e);
  }
}

async function syncAttempts() {
  try {
    let queue = JSON.parse(localStorage.getItem("attemptQueue") || "[]");

    for (let attempt of queue.filter(a => !a.synced)) {
      try {
        await fetch("https://script.google.com/macros/s/AKfycbz1qiChC4llPA9nTV0l0cxBe8mbsRADeotk2dFJqdiByh9eudws4isLbuvznWI7xH6L/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(attempt)
        });
        attempt.synced = true;
        console.log("‚úÖ Synced:", attempt.name, attempt.questID);
      } catch (err) {
        console.warn("‚ö†Ô∏è Sync failed:", err);
        break;
      }
    }

    localStorage.setItem("attemptQueue", JSON.stringify(queue));
  } catch (e) {
    console.log('Sync error:', e);
  }
}

window.addEventListener("online", syncAttempts);
setInterval(syncAttempts, 10000);

function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "<h2 style='text-align:center;'>üéâ Quiz Completed!</h2>";
  progressTracker.innerText = "Done!";
  nextPageBtn.style.display = "none";

  const successMessage = (totalWrongGuesses === 0)
    ? "<p>‚úÖ Flawless! All questions answered correctly on the first attempt!</p>"
    : `<p>‚úÖ Correct Answers (total): ${correctCount}</p>
       <p>‚ùå Wrong Attempts (total): ${totalWrongGuesses}</p>`;

  scoreCard.innerHTML = `
    <p>üë§ Player: <strong>${playerName}</strong> (${playerDept})</p>
    ${successMessage}
    <p>üíé Final Gems: ${gemsCount}</p>
    <p>‚è±Ô∏è Time Taken: ${totalTime} seconds</p>
    <button onclick="downloadPDFReport()" style="margin-top: 1rem; padding: 0.7rem 2rem; background-color: #4CAF50; border: none; border-radius: 10px; cursor: pointer; color: white; font-size: 1rem;">üì• Download PDF Report</button>
  `;
  restartBtn.style.display = "inline-block";

  const attemptData = {
    timestamp: new Date().toISOString(),
    name: playerName,
    correct: correctCount,
    wrong: totalWrongGuesses,
    timeTaken: totalTime,
    department: playerDept,
    questID: currentQuestID
  };

  saveAttemptLocally(attemptData);

  if (navigator.onLine) {
    syncAttempts();
  } else {
    console.log("üì¥ Offline ‚Äì saved locally, will sync later.");
  }
}

function downloadPDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4" });

  const pageHeight = doc.internal.pageSize.height;
  const marginLeft = 20;
  const usableWidth = 170;

  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });

  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, "F");
  doc.setTextColor(255, 255, 255);
  doc.setFont("times", "bold");
  doc.setFontSize(18);
  doc.text("SRM VALLIAMMAI ENGINEERING COLLEGE", 105, 16, { align: "center" });
  doc.setFontSize(12);
  doc.setFont("times", "italic");
  doc.text("(Autonomous)", 105, 23, { align: "center" });
  doc.setFontSize(15);
  doc.setFont("times", "normal");
  doc.text("Department of English", 105, 31, { align: "center" });

  doc.setFontSize(14);
  doc.setFont("times", "bold");
  doc.setTextColor(212, 175, 55);
  doc.text(`${currentQuestID} ‚Äî Performance Report`, 105, 39, { align: "center" });

  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text("CANDIDATE INFORMATION", marginLeft, 55);

  doc.autoTable({
    startY: 58,
    body: [
      ["Student Name", playerName],
      ["Department", playerDept],
      ["Quest ID", currentQuestID],
      ["Completed On", reportDate],
    ],
    theme: "plain",
    styles: { fontSize: 10, font: "times", cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 },
    },
    margin: { left: marginLeft, right: marginLeft },
  });

  let y = doc.lastAutoTable.finalY + 10;

  if (y > pageHeight - 30) {
    doc.addPage();
    y = 20;
  }

  doc.setFont("times", "bold");
  doc.text("PERFORMANCE SUMMARY", marginLeft, y);
  y += 3;

  doc.autoTable({
    startY: y + 3,
    body: [
      ["Total Question Pages", quizData.length.toString()],
      ["Correct Answers (Total)", correctCount.toString()],
      ["Wrong Attempts (Total)", totalWrongGuesses.toString()],
      ["Final Gems Earned", gemsCount.toString()],
      ["Total Time", `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`],
    ],
    theme: "grid",
    styles: { fontSize: 10, font: "times", cellPadding: 3 },
    margin: { left: marginLeft, right: marginLeft },
    pageBreak: "auto",
  });

  y = doc.lastAutoTable.finalY + 12;

  if (y > pageHeight - 30) {
    doc.addPage();
    y = 20;
  }

  doc.setFont("times", "bold");
  doc.text("QUESTION BANK WITH CORRECT ANSWERS", marginLeft, y);
  y += 6;

  quizDataStore.forEach((item, i) => {
    let fullPassage = item.passage;

    item.answers.forEach(ans => {
      fullPassage = fullPassage.replace("___", ` [${ans}] `);
    });

    const lines = doc.splitTextToSize(fullPassage, usableWidth);
    const blockHeight = lines.length * 5 + 10;

    if (y + blockHeight > pageHeight - 20) {
      doc.addPage();
      y = 20;
    }

    doc.setFont("times", "bold");
    doc.setFontSize(11);
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, marginLeft, y);
    y += 6;

    doc.setFont("times", "normal");
    doc.setTextColor(0, 0, 0);
    doc.text(lines, marginLeft + 5, y);
    y += lines.length * 5 + 5; // move down for next passage
  });

  // Footer
  if (y > pageHeight - 20) {
    doc.addPage();
    y = 20;
  }

  doc.setFont("times", "italic");
  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  doc.text("Generated automatically by The Icecream Story üåå Quiz Engine", 105, pageHeight - 10, { align: "center" });

  // Save the file
  doc.save(`${playerName.replace(/\s+/g, '_')}_Reagan_Reframing_Report.pdf`);
}
</script>
</body>
</html>

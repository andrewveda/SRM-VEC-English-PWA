<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tap-to-Match Cloze Quiz üåå</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --page-padding-x: 1.5rem;
    --top-strip-bg: rgba(255, 255, 240, 0.96);
    --top-strip-border: #d2b48c;
  }

  /* Base */
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(ellipse at center, #f4ecd8 0%, #e8d9b5 100%);
    color: #3b2f1e;
    text-align: center;
    width: 100vw;
    height: 100vh;
    overflow-x: hidden;
  }

  .container {
    position: relative;
    background: rgba(255, 255, 240, 0.85);
    width: 100vw;
    min-height: 100vh;
    margin: 0;
    border: none;
    border-radius: 0;
    box-shadow: none;
    padding: 0; /* no top padding; we position content below fixed strip via JS */
  }

  /* Name form */
  #nameForm {
    padding: 5rem var(--page-padding-x) 2rem;
  }
  #nameInput, #departmentSelect {
    display: block;
    width: 90%;
    max-width: 300px;
    margin: 1rem auto;
    padding: 0.7rem;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #c2a677;
    background: #fffdf6;
    color: #3b2f1e;
  }
  #startQuizBtn {
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #8b7355;
    border: 1px solid #5b442a;
    border-radius: 10px;
    cursor: pointer;
    color: #ffffff;
    transition: background-color 0.2s ease;
  }
  #startQuizBtn:hover { background-color: #6b5a43; }

  /* --- UNIFIED TOP STRIP (Header + Answers) --- */
  .top-strip {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;

    background: var(--top-strip-bg);
    border-bottom: 1px solid var(--top-strip-border);

    padding: 0.5rem 0.8rem;
    z-index: 30;
    backdrop-filter: blur(4px);
  }
  /* First row: Timer ‚Äì Gems ‚Äì Progress */
  .top-strip-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95rem;
    color: #5b442a;
    margin-bottom: 0.35rem;
    padding: 0 var(--page-padding-x);
  }
  #timer, #gemsCounter, #progressTracker {
    font-size: 1.05rem;
    color: #6b4f33;
    font-weight: 500;
  }
  /* Second row: Answers ‚Äî compact, centered, wrapping */
.top-strip-answers {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  justify-content: center;
  align-items: center;

  padding-top: 1rem;
  border-top: 1px solid #d2b48c; /* thin line above answers */
}

  .drag-item {
    display: inline-block;
    padding: 0.35rem 0.6rem;
    font-size: 0.95rem;
    background: #f7e7c4;
    border: 1px solid #d2b48c;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease-in-out;
    color: #3b2f1e;
    white-space: nowrap; /* keep compact */
  }
  .drag-item:hover { background: #f5deb3; transform: scale(1.05); }
  .drag-item.selected { border: 2px solid #8b7355; background: #f0dba5; transform: scale(1.02); }

  /* Passage area */
  .drop-container {
    padding: 0.8rem var(--page-padding-x) 2rem;
    overflow-y: auto;
    text-align: justify;       /* FULL JUSTIFICATION */
    line-height: 1.9;
    font-size: 1.3rem;
    color: #3b2f1e;
  }

  /* Blanks */
  .drop-zone {
    display: inline-block;
    border: 1px dashed #a1886f;
    padding: 0.2rem 0.8rem;
    margin: 0 0.2rem;
    cursor: pointer;
    background: #fffdf6;
    color: #5b442a;
    font-size: 1.2rem;
    font-family: 'Courier New', Courier, monospace;
    border-radius: 5px;
    min-width: 60px;
    text-align: center;
    transition: all 0.2s ease;
    vertical-align: middle;
  }
  .drop-zone:hover { background: #f7e7c4; }
  .drop-zone.filled {
    border: 1px solid transparent;
    background: none;
    color: #228b22;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: bold;
    padding: 0.2rem 0.2rem;
    min-width: unset;
    cursor: default;
  }
  .correct { color: #228b22 !important; }
  .wrong { border-color: #b22222 !important; animation: shake 0.5s ease-in-out; }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  /* Gems FX */
  @keyframes sparkle {
    0% { transform: translate(0, 0) scale(1); opacity: 1; }
    100% { transform: translate(var(--random-x, 0), -100px) scale(1.5); opacity: 0; }
  }
  @keyframes gemPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
  }
  .gem-spark { position: absolute; pointer-events: none; font-size: 1.5rem; animation: sparkle 1s ease-out forwards; z-index: 20; }
  .gem-counter-pulse { animation: gemPulse 0.4s ease-in-out; }

  /* Buttons / Score */
  #nextPageBtn {
    margin-top: 1.5rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #4CAF50;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    color: white;
    transition: background-color 0.2s ease;
    font-weight: bold;
  }
  #nextPageBtn:hover { background-color: #45a049; }

  #restartBtn {
    margin-top: 2rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #d2b48c;
    border: 1px solid #a1886f;
    border-radius: 10px;
    cursor: pointer;
    color: #3b2f1e;
    transition: background-color 0.2s ease;
  }
  #restartBtn:hover { background-color: #c9a96b; }

  #scoreCard {
    margin-top: 2rem;
    font-size: 1.2rem;
    color: #4b3b2a;
  }
</style>
</head>

<body>
<div class="container" id="quizContainer">

  <!-- Name Entry Page -->
  <div id="nameForm">
    <h1 id="quizTitle" style="font-size:2rem; margin-bottom:0.3rem; color:#4a3b2a;">
Water the Garden Efficiently!
</h1>

<h3 id="quizAuthor" style="font-size:1.1rem; margin-bottom:1.5rem; color:#6b4f33; font-weight:normal;">
Humans using AI as a replacement for their thinking will be thrashed by humans who can think. <br> <br> A thinking human using AI as a tool will be unstoppable. <br> <br> written by Andrew Veda 
</h3>

    <input type="text" id="nameInput" placeholder="Enter your name" />
    <select id="departmentSelect">
      <option value="">-- Select Department --</option>
      <option value="Cyber Security">Cyber Security</option>
      <option value="CSE-1">CSE-1</option>
      <option value="CSE-2">CSE-2</option>
      <option value="CSE-3">CSE-3</option>
      <option value="Mechanical Engineering">Mechanical Engineering</option>
      <option value="ECE-1">ECE-1</option>
      <option value="ECE-2">ECE-2</option>
      <option value="ECE-3">ECE-3</option>
      <option value="AI DS-1">AI DS-1</option>
      <option value="AI DS-2">AI DS-2</option>
      <option value="Civil">Civil</option>
      <option value="Agri">Agri</option>
      <option value="EEE">EEE</option>
      <option value="EIE">EIE</option>
      <option value="Medical Electronics">Medical Electronics</option>
      <option value="IT-1">IT-1</option>
      <option value="IT-2">IT-2</option>
    </select>
    <button id="startQuizBtn" onclick="beginQuiz()">Start Quiz</button>
  </div>

  <!-- Quiz Content -->
  <div id="quizContent" style="display:none;">
    <div class="top-strip" id="topStrip">
      <div class="top-strip-header">
        <div id="timer">‚è≥ 0s</div>
        <div id="gemsCounter">üíé 0</div>
        <div id="progressTracker">üìç 1 / 1</div>
      </div>
      <div class="top-strip-answers" id="dragOptions"></div>
    </div>

    <div class="drop-container" id="dropContainer"></div>
    <div id="scoreCard"></div>
    <button id="nextPageBtn" style="display: none;">Next &rarr;</button>
    <button id="restartBtn" style="display: none;">Restart</button>
  </div>
</div>

<script>
/* ------------------ DATA ------------------ */
const quizDataStore = [
{
  "passage": "It was raining hard. ___ students sat in the ___ The teacher said, \"Water the garden ___ Go!\" The first student ___ \"But it's raining.\" \"So what? Take ___ umbrella. Do it efficiently,\" the teacher ___ The first student stopped ___ the moment the instruction clashed ___ his expectations. He decided the ___ was pointless. He saw only ___ surface: rain outside, a hose ___ hand, and a teacher who ___ unreasonable. He used the old ___ because it was familiar. He ___ been taught those methods and ___ once questioned them. He lacked critical ___ so he never asked what ___ real problem was or what ___ real solution could be. If ___ had even basic critical thinking ___ he would have focused on ___ specific problem in front of ___ and looked for a specific ___ instead of rejecting the possibility ___ a solution. He made no impact ___ he never had an original thought in his head. ___ him, the world was fixed, ___ his job was to repeat ___ he had already been ___.",
  "answers": [
    "Two",
    "classroom.",
    "efficiently.",
    "protested.",
    "an",
    "said.",
    "thinking",
    "with",
    "task",
    "the",
    "in",
    "seemed",
    "methods",
    "had",
    "never",
    "thinking,",
    "the",
    "the",
    "he.",
    "skills,",
    "the",
    "him",
    "solution",
    "of",
    "because",
    "To",
    "and",
    "what",
    "taught."
  ]
},
  {
  "passage": "The second student paused. ___ certainly appeared the teacher was ___. But he recalled what ___ had said: consider ___ idea fully before rejecting ___. So he asked, ‚ÄúWhat if she‚Äôs right?‚Äù ___ did not assume the teacher was wrong and ___ his mind to ___ ideas. He asked what efficient meant under these ___ conditions. A hose against the ___ made no sense. Competing with rain was ___. Directing it wasn‚Äôt.\n\nHe went outside and studied the ground. He dug channels where the water already wanted to ___. He raised the soil where plants could ___. He guided the rain instead of resisting ___. A task that seemed meaningless to ___ student became effective in the hands of ___ .",
  "answers": [
    "It",
    "wrong",
    "Aristotle",
    "an",
    "it.",
    "He",
    "close",
    "new",
    "changed",
    "monsoon",
    "pointless.",
    "flow.",
    "drown.",
    "it.",
    "one",
    "another."
  ]
},
  {
  "passage": "He understood something simple: ___ have to look at ___ world with a fresh ___ each time. Conditions shift. ___ change. Problems evolve. What ___ yesterday may block you ___ Unlearning is the first ___ in learning. You find the right ___ only when the mind ___ open to ___ fact that a solution ___ \n\nOn a larger scale, the lesson held. On a ___ acres or a thousand, a single pond placed with ___ could sustain a farm ___ years without rain. One ___ decision will outweigh years of routine effort.\n\nA human ___ without critical thinking skills ___ not know how to water the garden efficiently even with ___ but a thinking Homo sapiens using AI will be unstoppable. Use ___ the tools that you have but not as replacement for ___ thinking.\n\nThe two students walked into the same storm. One saw only a dead end and ___ clouds. The other ___ a system he could ___ and a brilliant rainbow.",
  "answers": [
    "you",
    "the",
    "perception",
    "Tools",
    "worked",
    "today.",
    "step",
    "solution",
    "stays",
    "the",
    "exists.",
    "hundred",
    "understanding",
    "for",
    "intelligent",
    "being",
    "would",
    "AI",
    "all",
    "your",
    "dark",
    "saw",
    "redesign"
  ]
}



];

/* --------------- STATE & ELEMENTS --------------- */
let quizData = [];           // flattened pages
let current = 0;             // current page index
let wrongQuestions = [];     // pages to retry
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;
let totalQuestionsInQuiz = 0; // includes wrong-page retries

const blanksPerPage = 10;

const quizContainer   = document.getElementById("quizContainer");
const dragOptionsEl   = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl         = document.getElementById("timer");
const gemsCounterEl   = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard       = document.getElementById("scoreCard");
const restartBtn      = document.getElementById("restartBtn");
const nextPageBtn     = document.getElementById("nextPageBtn");
const quizContentEl   = document.getElementById("quizContent");
const nameFormEl      = document.getElementById("nameForm");
const nameInputEl     = document.getElementById("nameInput");
const deptSelectEl    = document.getElementById("departmentSelect");
const topStripEl      = document.getElementById("topStrip");

/* --------------- TOP STRIP -> LAYOUT ADJUST --------------- */
/* Measure the top strip height and push the passage below it */
function adjustForTopStrip() {
  const h = topStripEl ? topStripEl.offsetHeight : 0;
  dropContainerEl.style.marginTop = h + "px";
  // Leave ~1.5rem visual breathing at bottom; ensure max-height fits viewport
  dropContainerEl.style.maxHeight = `calc(100vh - ${h}px - 2rem)`;
}

/* --------------- QUIZ FLOW --------------- */
function beginQuiz() {
  if (!nameInputEl.value.trim()) {
    nameInputEl.style.borderColor = "red";
    return;
  }
  if (!deptSelectEl.value) {
    deptSelectEl.style.borderColor = "red";
    return;
  }
  nameInputEl.style.borderColor = "#c2a677";
  deptSelectEl.style.borderColor = "#c2a677";

  playerName = nameInputEl.value.trim();
  playerDept = deptSelectEl.value;

  document.getElementById("quizTitle").style.display = "none";
document.getElementById("quizAuthor").style.display = "none";

  nameFormEl.style.display = "none";
  quizContentEl.style.display = "block";
  startQuiz();
}

function startQuiz() {
  quizData = [];
  wrongQuestions = [];

  // Flatten passages into page objects
  quizDataStore.forEach((p, idx) => {
    const total = p.answers.length;
    const totalPages = Math.ceil(total / blanksPerPage);
    for (let i = 0; i < totalPages; i++) {
      quizData.push({
        originalPassage: p.passage,
        originalAnswers: p.answers,
        pageIndex: i,
        passageIndex: idx,
        totalPassagePages: totalPages,
        pageId: `p${idx}-pg${i}`
      });
    }
  });

  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();
  totalQuestionsInQuiz = quizData.length;

  timerEl.innerText = "‚è≥ 0s";
  gemsCounterEl.innerText = `üíé 0`;
  scoreCard.innerHTML = "";
  restartBtn.style.display = "none";
  nextPageBtn.style.display = "none";

  loadQuestion();
  startTimer();
}

function updateProgress() {
  const currentQuestionNumber = current + 1;
  if (quizData[current]) {
    progressTracker.innerText = `üìç ${currentQuestionNumber} / ${totalQuestionsInQuiz}`;
  } else if (current > 0) {
    progressTracker.innerText = "Done!";
  } else {
    progressTracker.innerText = `üìç 1 / ${totalQuestionsInQuiz}`;
  }
}

function loadQuestion() {
  if (current >= quizData.length) {
    return showScore();
  }

  selectedOption = null;
  const d = quizData[current];

  updateProgress();

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  nextPageBtn.style.display = "none";

  // Page slice
  const s = d.pageIndex * blanksPerPage;
  const e = s + blanksPerPage;

  const answers = d.originalAnswers.slice(s, e);
  const parts = d.originalPassage.split("___").slice(s, e + 1);

  // Render answers (shuffled), compact & centered
  const shuffled = [...answers].sort(() => Math.random() - 0.5);
  shuffled.forEach(ans => {
    const div = document.createElement("div");
    div.classList.add("drag-item");
    div.innerText = ans;
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  // Passage parts
  if (s > 0) dropContainerEl.appendChild(document.createTextNode("... "));
  parts.forEach((part, i) => {
    dropContainerEl.appendChild(document.createTextNode(part));
    if (i < answers.length) {
      const b = document.createElement("button");
      b.classList.add("drop-zone");
      b.innerText = "___";
      b.dataset.answer = answers[i];
      b.onclick = () => placeOption(b);
      dropContainerEl.appendChild(b);
      dropContainerEl.appendChild(document.createTextNode(" "));
    }
  });
  if (e < d.originalAnswers.length) dropContainerEl.appendChild(document.createTextNode(" ..."));

  // After rendering, adjust for top strip height
  adjustForTopStrip();
}

function selectOption(div) {
  if (div.style.display === "none") return;
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

function placeOption(dz) {
  if (!selectedOption || dz.classList.contains("filled")) return;

  const ans = selectedOption.innerText;
  const correct = dz.dataset.answer;

  if (ans === correct) {
    // Correct
    correctCount++;
    gemsCount++;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;

    // FX
    createSparkleEffect(dz);
    gemsCounterEl.classList.add('gem-counter-pulse');
    setTimeout(() => gemsCounterEl.classList.remove('gem-counter-pulse'), 400);

    dz.innerText = ans;
    dz.classList.add("correct", "filled");
    dz.disabled = true;
    selectedOption.style.display = "none";
  } else {
    // Wrong
    totalWrongGuesses++;
    gemsCount--;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    dz.classList.add("wrong");
    setTimeout(() => dz.classList.remove("wrong"), 600);

    // Queue this page for retry if not already queued
    const currentData = quizData[current];
    if (!wrongQuestions.includes(currentData)) {
      wrongQuestions.push(currentData);
      totalQuestionsInQuiz++;   // keep total growing to reflect retries
      updateProgress();         // immediate reflect in header
    }
  }

  if (selectedOption) {
    selectedOption.classList.remove("selected");
    selectedOption = null;
  }

  if (!dropContainerEl.querySelector(".drop-zone:not(.filled)")) {
    nextPageBtn.style.display = "inline-block";
  }
}

function createSparkleEffect(element) {
  const rect = element.getBoundingClientRect();
  const containerRect = quizContainer.getBoundingClientRect();

  const sparkCount = 8;
  for (let i = 0; i < sparkCount; i++) {
    const spark = document.createElement('div');
    spark.className = 'gem-spark';
    spark.innerText = ['üíé', '‚ú®', '‚≠ê'][Math.floor(Math.random() * 3)];
    spark.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
    spark.style.top  = `${rect.top  - containerRect.top  + rect.height / 2}px`;
    const randomX = (Math.random() - 0.5) * 100;
    spark.style.setProperty('--random-x', `${randomX}px`);
    quizContainer.appendChild(spark);
    setTimeout(() => spark.remove(), 1000);
  }
}

function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "<h2 style='text-align:center;'>üéâ Quiz Completed!</h2>";
  progressTracker.innerText = "Done!";
  nextPageBtn.style.display = "none";

  const successMessage = (totalWrongGuesses === 0)
    ? "<p>‚úÖ Flawless! All questions answered correctly on the first attempt!</p>"
    : `<p>‚úÖ Correct Answers (total): ${correctCount}</p>
       <p>‚ùå Wrong Attempts (total): ${totalWrongGuesses}</p>`;

  scoreCard.innerHTML = `
    <p>üë§ Player: <strong>${playerName}</strong> (${playerDept})</p>
    ${successMessage}
    <p>üíé Final Gems: ${gemsCount}</p>
    <p>‚è±Ô∏è Time Taken: ${totalTime} seconds</p>
    <button onclick="downloadPDFReport()" style="margin-top: 1rem; padding: 0.7rem 2rem; background-color: #4CAF50; border: none; border-radius: 10px; cursor: pointer; color: white; font-size: 1rem;">üì• Download PDF Report</button>
  `;
  restartBtn.style.display = "inline-block";

  // send to Google Sheet (fire-and-forget)
  fetch("https://script.google.com/macros/s/AKfycbxA0lRkERWFt2cYfmm04IQioaG4-21k5VFF5CFKP30zyVaJXM5_27PL3v8JIZEweK3u/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name: playerName,
      correct: correctCount,
      wrong: totalWrongGuesses,
      time: totalTime,
      department: playerDept,
      questId: "Story 76"
    })
  });
}

function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime)/1000);
    timerEl.innerText = `‚è≥ ${elapsed}s`;
  }, 1000);
}

/* --------------- PDF REPORT --------------- */
function downloadPDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4" });

  const pageHeight = doc.internal.pageSize.height;
  const marginLeft = 20;
  const usableWidth = 170;

  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });

  // ‚úÖ Dynamic Quest ID variable (example: "Quest 20 (Cloze)")
  const questID = typeof currentQuestID !== "undefined" ? currentQuestID : "Quest";

  /* ---------------- HEADER ---------------- */

  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, "F");
  doc.setTextColor(255, 255, 255);
  doc.setFont("times", "bold");
  doc.setFontSize(18);
  doc.text("SRM VALLIAMMAI ENGINEERING COLLEGE", 105, 16, { align: "center" });
  doc.setFontSize(12);
  doc.setFont("times", "italic");
  doc.text("(Autonomous)", 105, 23, { align: "center" });
  doc.setFontSize(15);
  doc.setFont("times", "normal");
  doc.text("Department of English", 105, 31, { align: "center" });

  doc.setFontSize(14);
  doc.setFont("times", "bold");
  doc.setTextColor(212, 175, 55);
  doc.text(`${questID} ‚Äî Performance Report`, 105, 39, { align: "center" });

  /* ---------------- STUDENT INFO ---------------- */

  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text("CANDIDATE INFORMATION", marginLeft, 55);

  doc.autoTable({
    startY: 58,
    body: [
      ["Student Name", playerName],
      ["Department", playerDept],
      ["Quest ID", questID],
      ["Completed On", reportDate],
    ],
    theme: "plain",
    styles: { fontSize: 10, font: "times", cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: "bold", cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 },
    },
    margin: { left: marginLeft, right: marginLeft },
  });

  /* ---------------- PERFORMANCE SUMMARY ---------------- */

  let y = doc.lastAutoTable.finalY + 10;

  if (y > pageHeight - 30) {
    doc.addPage();
    y = 20;
  }

  doc.setFont("times", "bold");
  doc.text("PERFORMANCE SUMMARY", marginLeft, y);
  y += 3;

  doc.autoTable({
    startY: y + 3,
    body: [
      ["Total Question Pages", quizData.length.toString()],
      ["Correct Answers (Total)", correctCount.toString()],
      ["Wrong Attempts (Total)", totalWrongGuesses.toString()],
      ["Final Gems Earned", gemsCount.toString()],
      ["Total Time", `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`],
    ],
    theme: "grid",
    styles: { fontSize: 10, font: "times", cellPadding: 3 },
    margin: { left: marginLeft, right: marginLeft },
    pageBreak: "auto",
  });

  y = doc.lastAutoTable.finalY + 12;

  /* ---------------- QUESTION BANK ---------------- */

  if (y > pageHeight - 30) {
    doc.addPage();
    y = 20;
  }

  doc.setFont("times", "bold");
  doc.text("QUESTION BANK WITH CORRECT ANSWERS", marginLeft, y);
  y += 6;

  quizDataStore.forEach((item, i) => {
    /* Predict text block height BEFORE writing */
    let fullPassage = item.passage;

    item.answers.forEach(ans => {
      fullPassage = fullPassage.replace("___", ` [${ans}] `);
    });

    const lines = doc.splitTextToSize(fullPassage, usableWidth);
    const blockHeight = lines.length * 5 + 10; // estimate

    // ‚úÖ PREVENT overflow BEFORE writing
    if (y + blockHeight > pageHeight - 20) {
      doc.addPage();
      y = 20;
    }

    // Question heading
    doc.setFont("times", "bold");
    doc.setFontSize(11);
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, marginLeft, y);
    y += 6;

    // Passage
    doc.setFont("times", "normal");
    doc.setTextColor(0, 0, 0);
    doc.text(lines, marginLeft + 5, y);
    y += lines.length * 5 + 3;

    // Divider line
    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.3);
    doc.line(marginLeft, y, 190, y);
    y += 5;
  });

  /* ---------------- FOOTER ON LAST PAGE ---------------- */

  doc.setDrawColor(184, 134, 11);
  doc.setLineWidth(0.5);
  doc.line(marginLeft, pageHeight - 17, 190, pageHeight - 17);

  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.setFont("times", "italic");
  doc.text("This is a system-generated report", 105, pageHeight - 10, { align: "center" });

  /* ---------------- SAVE FILE ---------------- */

  const cleanName = playerName.replace(/[^a-zA-Z0-9]/g, "_");
  const cleanQuest = questID.replace(/[^a-zA-Z0-9]/g, "_");

  doc.save(`${cleanName}_${cleanQuest}_Report.pdf`);
}

/* --------------- CONTROLS --------------- */
restartBtn.onclick = () => {
  quizContentEl.style.display = "none";
  nameFormEl.style.display = "block";
  nameInputEl.value = "";
  deptSelectEl.value = "";
  nextPageBtn.style.display = "none";
};

nextPageBtn.onclick = () => {
  current++;
  if (current >= quizData.length && wrongQuestions.length > 0) {
    quizData.push(...wrongQuestions);
    wrongQuestions = [];
  }
  loadQuestion();
};

/* Recalculate layout on resize (for top-strip height changes due to wrapping) */
window.addEventListener('resize', adjustForTopStrip);
</script>

<!-- PWA-friendly link handling -->
<script>
document.addEventListener("click", function (e) {
  const target = e.target.closest("a");
  if (!target) return;

  const url = target.href;
  const internalDomains = [
    window.location.origin,
    "andrewveda.github.io",
    "sites.google.com/view/cys-english/",
    "sites.google.com/view/srm-vec-english/"
  ];

  const isInternal = internalDomains.some(domain => url.includes(domain));

  if (isInternal) {
    if (
      window.matchMedia("(display-mode: standalone)").matches ||
      window.matchMedia("(display-mode: fullscreen)").matches
    ) {
      e.preventDefault();
      window.location.href = url;
    }
  } else {
    target.setAttribute("target", "_blank");
  }
});
</script>

<script>
document.addEventListener("click", function (e) {
  const target = e.target.closest("a");
  if (!target) return;

  const url = target.href;
  const internalDomains = [
    "andrewveda.github.io",
    "sites.google.com/view/cys-english",
    "sites.google.com/view/srm-vec-english"
  ];
  const isInternal = internalDomains.some(domain => url.includes(domain));

  if (isInternal) {
    e.preventDefault();
    window.location.href = url;
  } else {
    target.setAttribute("target", "_blank");
  }
});
</script>
</body>
</html>

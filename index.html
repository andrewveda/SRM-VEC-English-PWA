<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SRM VEC English â€” Dashboard</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7A0019">
<link rel="stylesheet" href="style.css" />

</head>
<body>

<!-- Loading -->
<div class="loading-screen" id="loadingScreen">
  <h1>Loading your Quest Dashboard...</h1>
  <div class="spinner"></div>
  <p class="credits">Created with â™¥ï¸ by Andrew Veda, AP<br>SRM Valliammai Engineering College</p>
</div>

<!-- Name input (only asks for name) -->
<div class="name-input-container" id="nameInputContainer">
  <h1>SRM Valliammai Engineering College (Autonomous)</h1>
  <h2>Department of English</h2>
  <input type="text" id="nameInput" placeholder="Enter Your Name">
  <button class="btn-primary" onclick="saveAndLogin()">Get Started</button>

  <!-- Keep original fast links/buttons (as you requested) -->
  <a href="https://sites.google.com/view/srm-vec-english/daily-vocabulary">
    <button class="btn-vocab">ğŸ“š Daily Vocabulary</button>
  </a>
  <a href="https://sites.google.com/view/cys-english/preliminary-event-registration">
    <button class="btn-mystic">ğŸ¯ Register for Mystic Summit</button>
  </a>
  <a href="https://sites.google.com/view/cys-english/wordle">
    <button class="btn-wordle">ğŸ‘½ WORDLE!</button>
  </a>
  <a href="https://sites.google.com/view/srm-vec-english/department-quest-leaderboard">
    <button class="btn-leaderboard">ğŸ˜ Leaderboard</button>
  </a>
  <a href="https://sites.google.com/view/cys-english/elll-virtual-record">
    <button class="btn-elll">ğŸ“ ELLL Virtual Recordâœ¨</button>
  </a>
</div>

<!-- Profile icon + overlay + drawer -->
<div class="profile-icon" id="profileIcon">ğŸ‘¤</div>
<div class="overlay" id="overlay"></div>
<div class="profile-drawer" id="profileDrawer">
  <span class="close-drawer" id="closeDrawer">&times;</span>
  <h3>Menu</h3>
  <div class="drawer-item">
    <a href="https://sites.google.com/view/srm-vec-english/daily-vocabulary">ğŸ“š Daily Vocabulary</a>
  </div>
  <div class="drawer-item">
    <a href="https://sites.google.com/view/cys-english/preliminary-event-registration">ğŸ¯ Mystic Summit</a>
  </div>
  <div class="drawer-item">
    <a href="https://sites.google.com/view/cys-english/wordle">ğŸ‘½ WORDLE!</a>
  </div>
  <div class="drawer-item">
    <a href="https://sites.google.com/view/srm-vec-english/department-quest-leaderboard">ğŸ˜ Leaderboard</a>
  </div>
  <div class="drawer-item">
    <a href="https://sites.google.com/view/cys-english/elll-virtual-record">ğŸ“ ELLL Virtual Record</a>
  </div>
  <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
</div>

<!-- Dashboard (replaces the calendar) -->
<div class="dashboard-container" id="dashboardContainer">
  <div class="offline-banner" id="offlineBanner">ğŸ“¡ Offline mode â€” progress will sync when online.</div>

  <div class="user-info">
    <h2 id="userName">Student</h2>
    <p id="userSummary">Welcome â€” fetching your progress...</p>
  </div>

  <div class="buttons-row">
    <button class="btn-primary" id="nextQuestBtn">ğŸ“ Open Next Quest</button>
    <a href="https://sites.google.com/view/cys-english/video-quests"><button class="btn-mystic">ğŸ¥ Video Quests</button></a>
    <a href="https://sites.google.com/view/cys-english/elll-virtual-record"><button class="btn-elll">ğŸ—£ï¸ ELLL</button></a>
  </div>

  <div style="text-align:center; margin-top:10px;">
    <small id="syncStatus">Last synced: â€”</small>
  </div>
</div>

<script>
/* ===== CONFIG (original endpoints kept) ===== */
const USER_DATA_URL = "https://script.google.com/macros/s/AKfycbzPmoVR2sfZFgrh7YGxag018JF3HtIkDq3AG65Tt_psWgWLGvbERINZw7lP9wuupbVd/exec";
const ANALYTICS_URL = "https://script.google.com/macros/s/AKfycbxA0lRkERWFt2cYfmm04IQioaG4-21k5VFF5CFKP30zyVaJXM5_27PL3v8JIZEweK3u/exec";

/* Links mapping (kept from your prior code) */
const questLinks = {
  1: "quests/quest1.html",
  2: "https://sites.google.com/view/srm-vec-english/quest/wh-questions-1",
  3: "https://sites.google.com/view/cys-english/self-introduction-1",
  4: "https://sites.google.com/view/srm-vec-english/quest/one-word-substitution-1"
};
const videoLink = "https://sites.google.com/view/cys-english/video-quests";
const ipaLink = "https://sites.google.com/view/cys-english/elll-virtual-record";

/* ===== APP STATE ===== */
let userData = null;
let sessionStartTime = Date.now();
let totalTimeSpent = parseInt(localStorage.getItem('totalTimeSpent') || '0', 10) || 0;
let currentUserName = localStorage.getItem('userName') || null;

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', init);

function init() {
  setupEventListeners();
  registerServiceWorker();
  attachUIHandlers();
  checkOnlineStatus();

  if (currentUserName) {
    // if user already exists, hide name input and show dashboard immediately (with cached data if present)
    document.getElementById('nameInputContainer').classList.remove('show');
    document.getElementById('loadingScreen').classList.add('show');
    const cached = localStorage.getItem('cachedUserData');
    if (cached) {
      userData = JSON.parse(cached);
      showDashboard();
      // fetch fresh in background
      loadUserDataInBackground(currentUserName);
    } else {
      loadUserData(currentUserName);
    }
  } else {
    document.getElementById('nameInputContainer').classList.add('show');
  }

  // start periodic time tracking (local)
  trackTimeSpent();
}

/* ===== UI/Events ===== */
function setupEventListeners() {
  document.getElementById('profileIcon').addEventListener('click', toggleDrawer);
  document.getElementById('closeDrawer').addEventListener('click', toggleDrawer);
  document.getElementById('overlay').addEventListener('click', toggleDrawer);
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  window.addEventListener('beforeunload', syncData);
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) syncData();
    else sessionStartTime = Date.now();
  });
}

function attachUIHandlers() {
  document.getElementById('nextQuestBtn').addEventListener('click', openNextQuest);
  // also allow pressing Enter on name input
  document.getElementById('nameInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') saveAndLogin();
  });
}

/* Drawer toggle */
function toggleDrawer() {
  const drawer = document.getElementById('profileDrawer');
  const overlay = document.getElementById('overlay');
  drawer.classList.toggle('open');
  overlay.classList.toggle('active');
}

/* ===== AUTH / USER LOAD ===== */
async function saveAndLogin() {
  const nameField = document.getElementById('nameInput');
  const name = (nameField.value || '').trim();
  if (!name) return alert('Please enter your name!');

  currentUserName = name.toUpperCase();
  localStorage.setItem('userName', currentUserName);

  document.getElementById('nameInputContainer').classList.remove('show');
  document.getElementById('loadingScreen').classList.add('show');

  // create minimal user object and show dashboard quickly
  userData = { Name: currentUserName, Quests: 0, TotalCorrect: 0, Challenges: [] };
  showDashboard();

  // fetch actual row in background (non-blocking)
  await loadUserDataInBackground(currentUserName);
}

/* Fetch fresh data in background */
async function loadUserDataInBackground(name) {
  try {
    const res = await fetch(USER_DATA_URL);
    const data = await res.json();

    const fetchedUser = data.find(u => (u.Name || '').toUpperCase() === name.toUpperCase());
    if (fetchedUser) {
      userData = normalizeUserData(fetchedUser);
      localStorage.setItem('cachedUserData', JSON.stringify(userData));
      updateDashboard();
      setSyncStatus('Synced just now');
    }
  } catch (err) {
    console.error('Background load error:', err);
    document.getElementById('offlineBanner').classList.add('show');
    setSyncStatus('Offline - using cached data');
  }
}

/* Initial load when no cache */
async function loadUserData(name) {
  try {
    const res = await fetch(USER_DATA_URL);
    const data = await res.json();
    userData = data.find(u => (u.Name || '').toUpperCase() === name.toUpperCase()) || { Name: name.toUpperCase(), Quests:0, TotalCorrect:0, Challenges:[] };
    userData = normalizeUserData(userData);
    localStorage.setItem('cachedUserData', JSON.stringify(userData));
    showDashboard();
    setSyncStatus('Synced just now');
  } catch (err) {
    console.error('Error loading data:', err);
    const cached = localStorage.getItem('cachedUserData');
    if (cached) {
      userData = JSON.parse(cached);
      showDashboard();
      document.getElementById('offlineBanner').classList.add('show');
      setSyncStatus('Offline - using cached data');
    } else {
      alert('Could not fetch data. Please check network and try again.');
      document.getElementById('loadingScreen').classList.remove('show');
      document.getElementById('nameInputContainer').classList.add('show');
    }
  }
}

function normalizeUserData(raw) {
  const copy = Object.assign({}, raw);
  if (Array.isArray(copy.Challenges)) return copy;
  if (typeof copy.Challenges === 'string') {
    const s = copy.Challenges.trim();
    if (!s) copy.Challenges = [];
    else if (s.includes('||')) copy.Challenges = s.split('||').map(x => x.trim()).filter(Boolean);
    else copy.Challenges = s.split(',').map(x => x.trim()).filter(Boolean);
    return copy;
  }
  copy.Challenges = [];
  return copy;
}

/* ===== DASHBOARD UI (no calendar) ===== */
function showDashboard() {
  document.getElementById('loadingScreen').classList.remove('show');
  document.getElementById('dashboardContainer').classList.add('show');
  document.getElementById('profileIcon').classList.add('show');
  document.getElementById('userName').textContent = userData.Name || (currentUserName || 'Student');
  updateDashboard();
}

function updateDashboard() {
  const challenges = Array.isArray(userData.Challenges) ? userData.Challenges.slice() : (userData.Challenges || '').split(',').map(s => s.trim()).filter(Boolean);
  const totalCompleted = challenges.filter(c => c.startsWith('Quest')).length;
  document.getElementById('userSummary').textContent = `You have completed ${totalCompleted} quests.`;
  document.getElementById('completedCount')?.textContent = totalCompleted; // safe if exists
  document.getElementById('userName').textContent = userData.Name || currentUserName;
  // set button state
  const nextNum = totalCompleted + 1;
  const nextLink = questLinks[nextNum] || videoLink || '#';
  const nextBtn = document.getElementById('nextQuestBtn');
  nextBtn.dataset.next = nextNum;
  nextBtn.dataset.url = nextLink;
  setSyncStatus('Synced just now');
}

/* Open next quest (mapped if exists) */
function openNextQuest() {
  const btn = document.getElementById('nextQuestBtn');
  const url = btn.dataset.url || videoLink;
  if (!url) return alert('No link available for the next quest.');
  // open internal links in same window, external in new tab
  const internalDomains = ["andrewveda.github.io", "sites.google.com"];
  const isInternal = internalDomains.some(d => url.includes(d));
  if (isInternal) window.location.href = url;
  else window.open(url, '_blank');
}

/* ===== TIME TRACKING & SYNC ===== */
function trackTimeSpent() {
  // Update local time value every 30 seconds (minutes stored)
  setInterval(() => {
    const minutes = Math.floor((Date.now() - sessionStartTime) / 1000 / 60);
    totalTimeSpent = minutes;
    localStorage.setItem('totalTimeSpent', totalTimeSpent);
  }, 30000);
}

function syncData() {
  if (!userData) return;
  const sessionDuration = Math.floor((Date.now() - sessionStartTime) / 1000);
  const analyticsData = {
    name: userData.Name,
    totalCorrect: userData.TotalCorrect || 0,
    sessionDuration,
    lastActive: new Date().toISOString(),
    sessionStart: new Date(sessionStartTime).toISOString(),
    device: navigator.userAgent,
    isOnline: navigator.onLine
  };

  if (navigator.onLine && navigator.sendBeacon) {
    try {
      navigator.sendBeacon(ANALYTICS_URL, JSON.stringify(analyticsData));
      setSyncStatus('Synced just now');
    } catch (e) {
      // fallback
      queueAnalytics(analyticsData);
    }
  } else if (navigator.onLine) {
    // fallback to fetch POST
    fetch(ANALYTICS_URL, { method: 'POST', body: JSON.stringify(analyticsData) }).then(() => {
      setSyncStatus('Synced just now');
    }).catch(err => {
      console.error('Sync failed:', err);
      queueAnalytics(analyticsData);
    });
  } else {
    queueAnalytics(analyticsData);
  }
}

function queueAnalytics(payload) {
  const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
  pending.push(payload);
  localStorage.setItem('pendingSync', JSON.stringify(pending));
  setSyncStatus('Offline - queued');
}

function handleOnline() {
  document.getElementById('offlineBanner').classList.remove('show');
  const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
  if (pending.length) {
    pending.forEach(data => {
      fetch(ANALYTICS_URL, { method:'POST', body: JSON.stringify(data) }).catch(err => console.error('Sync error:', err));
    });
    localStorage.removeItem('pendingSync');
    setSyncStatus('Synced pending data');
  } else {
    setSyncStatus('Back online');
  }
  // try refreshing user data
  if (currentUserName) loadUserDataInBackground(currentUserName);
}

function handleOffline() {
  document.getElementById('offlineBanner').classList.add('show');
  setSyncStatus('Offline');
}

function checkOnlineStatus() {
  if (!navigator.onLine) document.getElementById('offlineBanner').classList.add('show');
}

function setSyncStatus(text) {
  const el = document.getElementById('syncStatus');
  if (el) el.textContent = `Last synced: ${text}`;
}

/* ===== INSTALL / TRACKING (kept) ===== */
function attachInstallPromptHandler() {
  // placeholder in case you want to prompt install manually
}
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); // we won't show default prompt automatically
  // you can show your own install UI and call e.prompt() when user clicks
  const payload = { name: localStorage.getItem('userName') || 'Unknown', event: 'install_prompt_shown', timestamp: new Date().toISOString() };
  fetch(ANALYTICS_URL, { method:'POST', body: JSON.stringify(payload) }).catch(()=>{});
});
window.addEventListener('appinstalled', () => {
  const payload = { name: localStorage.getItem('userName') || 'Unknown', event: 'app_installed', timestamp: new Date().toISOString() };
  fetch(ANALYTICS_URL, { method:'POST', body: JSON.stringify(payload) }).catch(()=>{});
});

/* ===== LOGOUT ===== */
function logout() {
  if (confirm('Are you sure you want to logout?')) {
    syncData();
    localStorage.removeItem('userName');
    localStorage.removeItem('cachedUserData');
    localStorage.removeItem('totalTimeSpent');
    window.location.reload();
  }
}

/* ===== Service worker registration ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('ServiceWorker registered:', reg.scope))
      .catch(err => console.log('ServiceWorker registration failed:', err));
  });
}

/* ===== Utility: intercept internal link clicks to preserve PWA experience (optional) ===== */
document.addEventListener("click", function (e) {
  const anchor = e.target.closest("a");
  if (!anchor) return;
  const url = anchor.href;
  const internalDomains = ["andrewveda.github.io", "sites.google.com/view/cys-english", "sites.google.com/view/srm-vec-english"];
  const isInternal = internalDomains.some(domain => url.includes(domain));
  if (isInternal) {
    // allow navigation in-app
    e.preventDefault();
    window.location.href = url;
  } else {
    anchor.setAttribute('target','_blank');
  }
});

/* ===== Initialize UI ===== */
function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').catch(err => console.warn('SW register failed', err));
  }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SRM VEC English — Quest Dashboard</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#7A0019" />

<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
body {
  background: #f9f9f9;
  color: #222;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Screens */
#loginScreen, #loadingScreen, #dashboardContainer {
  width: 100%;
  max-width: 600px;
  text-align: center;
  margin-top: 100px;
}
.hidden { display: none; }
.show { display: block !important; }

/* Dashboard */
.dashboard-header { padding: 1rem; }
.dashboard-cards {
  display: flex; flex-wrap: wrap;
  justify-content: center;
  gap: 1rem;
  margin-top: 1rem;
}
.card {
  background: #fff;
  border-radius: 1rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  width: 180px;
  padding: 1rem;
  text-align: center;
}
#offlineBanner {
  background: #ffb3b3;
  color: #700;
  padding: 0.5rem;
  text-align: center;
  display: none;
}
#offlineBanner.show { display: block; }

/* Profile Icon */
#profileIcon {
  position: fixed;
  top: 15px; right: 15px;
  cursor: pointer;
  display: none;
}
#profileIcon.show { display: block; }

button {
  background-color: #7A0019;
  color: #fff;
  border: none;
  border-radius: 0.5rem;
  padding: 0.7rem 1.5rem;
  cursor: pointer;
}
button:hover { background-color: #a3152a; }
</style>
</head>

<body>
<div id="offlineBanner">You are offline. Some features may be unavailable.</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <h1>Welcome to SRM VEC English</h1>
  <p>Please enter your name and department to begin:</p>
  <input type="text" id="nameInput" placeholder="Your Name" /><br /><br />
  <input type="text" id="deptInput" placeholder="Department" /><br /><br />
  <button onclick="saveAndLogin()">Login</button>
</div>

<!-- LOADING SCREEN -->
<div id="loadingScreen" class="hidden">
  <h2>Loading your data...</h2>
  <p>Please wait a moment.</p>
</div>

<!-- DASHBOARD -->
<div id="dashboardContainer" class="hidden">
  <div class="dashboard-header">
    <h2 id="dashboardGreeting">Welcome!</h2>
    <p id="dashboardStatus">Loading your data...</p>
  </div>

  <div class="dashboard-cards">
    <div class="card" id="nextQuestCard">
      <h3>Next Quest</h3>
      <p id="nextQuest">–</p>
    </div>

    <div class="card" id="completedCard">
      <h3>Completed</h3>
      <p id="completedCount">–</p>
    </div>

    <div class="card" id="offlineCard">
      <h3>Status</h3>
      <p id="offlineStatus">Online</p>
    </div>
  </div>

  <br />
  <button onclick="logout()">Logout</button>
</div>

<!-- Profile Icon -->
<img id="profileIcon" src="profile.png" alt="Profile" width="40" onclick="logout()" />

<script>
// ---------------- VARIABLES ----------------
let userData = null;
let sessionStartTime = Date.now();
let totalTimeSpent = parseInt(localStorage.getItem('totalTimeSpent') || '0');

// ---------------- INIT ----------------
function init() {
  const savedName = localStorage.getItem('userName');
  if (savedName) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('loadingScreen').classList.remove('hidden');
    loadUserData(savedName);
  }
  setupEventListeners();
  trackInstall();
  checkOnlineStatus();
}

// ---------------- EVENT LISTENERS ----------------
function setupEventListeners() {
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  window.addEventListener('beforeunload', syncData);
}

// ---------------- LOGIN ----------------
function saveAndLogin() {
  const name = document.getElementById('nameInput').value.trim();
  const dept = document.getElementById('deptInput').value.trim();

  if (!name || !dept) {
    alert('Please enter both name and department.');
    return;
  }

  localStorage.setItem('userName', name);
  localStorage.setItem('department', dept);

  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('loadingScreen').classList.remove('hidden');

  loadUserData(name);
}

// ---------------- LOAD DATA ----------------
function loadUserData(name) {
  const cachedData = JSON.parse(localStorage.getItem('cachedUserData') || '{}');
  if (cachedData && cachedData.Name === name) {
    userData = cachedData;
    showDashboard();
    loadUserDataInBackground(name);
  } else {
    fetchDataFromSheet(name);
  }
}

function fetchDataFromSheet(name) {
  fetch("https://script.google.com/macros/s/AKfycbzFE7M6bsy4boUY4o_ZXK_1KhxoE9m0hb9EdUem_6HzL5Dgf8H18NNzV3W8PWiEKJcCwQ/exec")
    .then(r => r.json())
    .then(data => {
      userData = data.find(u => u.Name.toUpperCase() === name.toUpperCase()) || {
        Name: name, Challenges: "", TotalCorrect: 0
      };
      localStorage.setItem('cachedUserData', JSON.stringify(userData));
      showDashboard();
    })
    .catch(err => {
      console.error('Error loading data:', err);
      alert('Could not load data. Try again later.');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('loadingScreen').classList.add('hidden');
    });
}

function loadUserDataInBackground(name) {
  fetch("https://script.google.com/macros/s/AKfycbzFE7M6bsy4boUY4o_ZXK_1KhxoE9m0hb9EdUem_6HzL5Dgf8H18NNzV3W8PWiEKJcCwQ/exec")
    .then(r => r.json())
    .then(data => {
      const latest = data.find(u => u.Name.toUpperCase() === name.toUpperCase());
      if (latest) {
        localStorage.setItem('cachedUserData', JSON.stringify(latest));
        userData = latest;
        updateDashboard();
      }
    })
    .catch(err => console.log('Background fetch failed:', err));
}

// ---------------- DASHBOARD ----------------
function showDashboard() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('dashboardContainer').classList.remove('hidden');
  document.getElementById('profileIcon').classList.add('show');
  updateDashboard();
}

function updateDashboard() {
  const challengesString = Array.isArray(userData.Challenges)
    ? userData.Challenges.join(",")
    : (userData.Challenges || "");
  const challenges = challengesString.split(",").map(c => c.trim());

  const totalCompleted = challenges.filter(c => c.startsWith("Quest")).length;
  const nextQuest = "Quest " + (totalCompleted + 1);

  document.getElementById('dashboardGreeting').textContent = `Welcome, ${userData.Name}!`;
  document.getElementById('dashboardStatus').textContent = `You’ve completed ${totalCompleted} quests so far.`;
  document.getElementById('completedCount').textContent = totalCompleted;
  document.getElementById('nextQuest').textContent = nextQuest;
  
  const offlineCard = document.getElementById('offlineStatus');
  offlineCard.textContent = navigator.onLine ? 'Online' : 'Offline';
  offlineCard.style.color = navigator.onLine ? 'green' : 'red';
}

// ---------------- TIME TRACKING ----------------
function trackTimeSpent() {
  setInterval(() => {
    totalTimeSpent = Math.floor((Date.now() - sessionStartTime) / 1000 / 60);
    localStorage.setItem('totalTimeSpent', totalTimeSpent);
  }, 30000);
}

// ---------------- SYNC ----------------
function syncData() {
  if (!userData) return;
  const sessionDuration = Math.floor((Date.now() - sessionStartTime) / 1000);
  
  const analyticsData = {
    name: userData.Name,
    totalCorrect: userData.TotalCorrect,
    sessionDuration,
    lastActive: new Date().toISOString(),
    device: navigator.userAgent,
    isOnline: navigator.onLine
  };
  
  if (navigator.onLine) {
    navigator.sendBeacon(
      'https://script.google.com/macros/s/AKfycbxA0lRkERWFt2cYfmm04IQioaG4-21k5VFF5CFKP30zyVaJXM5_27PL3v8JIZEweK3u/exec',
      JSON.stringify(analyticsData)
    );
  } else {
    const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
    pending.push(analyticsData);
    localStorage.setItem('pendingSync', JSON.stringify(pending));
  }
}

function handleOnline() {
  document.getElementById('offlineBanner').classList.remove('show');
  const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
  if (pending.length > 0) {
    pending.forEach(data => {
      fetch('https://script.google.com/macros/s/AKfycbxA0lRkERWFt2cYfmm04IQioaG4-21k5VFF5CFKP30zyVaJXM5_27PL3v8JIZEweK3u/exec', {
        method: 'POST',
        body: JSON.stringify(data)
      }).catch(err => console.error('Sync error:', err));
    });
    localStorage.removeItem('pendingSync');
  }
}

function handleOffline() {
  document.getElementById('offlineBanner').classList.add('show');
}

function checkOnlineStatus() {
  if (!navigator.onLine)
    document.getElementById('offlineBanner').classList.add('show');
}

// ---------------- INSTALL TRACK ----------------
function trackInstall() {
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    const data = {
      name: localStorage.getItem('userName') || 'Unknown',
      event: 'install_prompt',
      timestamp: new Date().toISOString(),
      device: navigator.userAgent
    };
    fetch('https://script.google.com/macros/s/AKfycbxA0lRkERWFt2cYfmm04IQioaG4-21k5VFF5CFKP30zyVaJXM5_27PL3v8JIZEweK3u/exec', {
      method: 'POST', body: JSON.stringify(data)
    });
  });

  window.addEventListener('appinstalled', () => {
    const data = {
      name: localStorage.getItem('userName') || 'Unknown',
      event: 'app_installed',
      timestamp: new Date().toISOString(),
      device: navigator.userAgent
    };
    fetch('https://script.google.com/macros/s/AKfycbxA0lRkERWFt2cYfmm04IQioaG4-21k5VFF5CFKP30zyVaJXM5_27PL3v8JIZEweK3u/exec', {
      method: 'POST', body: JSON.stringify(data)
    });
  });
}

// ---------------- LOGOUT ----------------
function logout() {
  if (confirm('Are you sure you want to logout?')) {
    syncData();
    localStorage.clear();
    window.location.reload();
  }
}

// ---------------- SERVICE WORKER ----------------
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('ServiceWorker registered:', reg.scope))
      .catch(err => console.log('ServiceWorker registration failed:', err));
  });
}

// ---------------- INIT CALL ----------------
init();
</script>
</body>
</html>

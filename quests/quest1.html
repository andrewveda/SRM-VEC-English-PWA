<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tap-to-Match Cloze Quiz üåå</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(ellipse at center, #f4ecd8 0%, #e8d9b5 100%);
    color: #3b2f1e;
    text-align: center;
    /* Full screen properties */
    width: 100vw;
    height: 100vh;
    overflow-x: hidden; /* Prevent horizontal scroll */
  }

  .container {
    position: relative;
    /* max-width: 900px; */ /* REMOVED */
    /* margin: 2rem auto; */ /* REMOVED */
    background: rgba(255, 255, 240, 0.85);
    padding: 2rem;
    padding-top: 5rem; /* Adjusted padding-top for header */
    /* border-radius: 15px; */ /* REMOVED */
    /* border: 1px solid #d2b48c; */ /* REMOVED */
    /* box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); */ /* REMOVED */

    /* --- ADDED FOR FULL SCREEN --- */
    width: 100vw;
    min-height: 100vh;
    margin: 0;
    border-radius: 0;
    box-shadow: none;
    border: none;
    box-sizing: border-box; /* Important: includes padding in 100% width/height */
    /* --- END FULL SCREEN --- */
  }

  .question {
    font-size: 1.6rem;
    margin-bottom: 1rem;
    color: #4a3b2a;
  }

  /* UPDATED STYLES FOR DRAG OPTIONS */
  .drag-options {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem; /* Reduced gap for compactness */
    margin-bottom: 2.5rem;
    justify-content: center; /* Center-justifies the items */
    padding: 0.8rem; /* Slightly reduced padding */
    border-bottom: 2px dashed #d2b48c;
  }

  .drag-item {
    padding: 0.4rem 0.9rem; /* Reduced padding for compactness */
    background: #f7e7c4;
    border: 1px solid #d2b48c;
    border-radius: 8px; /* Slightly smaller border-radius */
    cursor: pointer;
    user-select: none;
    color: #3b2f1e;
    transition: all 0.2s ease-in-out;
    font-size: 0.95rem; /* Slightly smaller font size */
  }

  .drag-item:hover {
    background: #f5deb3;
    transform: scale(1.05);
  }

  .drag-item.selected {
    border: 2px solid #8b7355;
    background: #f0dba5;
    transform: scale(1.02);
  }
  /* END UPDATED STYLES */

  .drop-container {
    text-align: left;
    line-height: 2.5; /* Increased line-height for readability */
    font-size: 1.3rem; /* Set base font size for the passage */
    color: #3b2f1e;
  }

  .drop-zone {
    display: inline-block;
    border: 1px dashed #a1886f;
    padding: 0.2rem 0.8rem;
    margin: 0 0.2rem;
    cursor: pointer;
    background: #fffdf6;
    color: #5b442a;
    font-size: 1.2rem;
    font-family: 'Courier New', Courier, monospace;
    border-radius: 5px;
    min-width: 60px; /* Give it a minimum size */
    text-align: center;
    transition: all 0.2s ease;
    vertical-align: middle; /* Align with text */
  }

  .drop-zone:hover {
    background: #f7e7c4;
  }

  .drop-zone.filled {
    border: 1px solid transparent;
    background: none;
    color: #228b22; /* correct color */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Revert font */
    font-weight: bold;
    padding: 0.2rem 0.2rem; /* Reduce padding once filled */
    min-width: unset;
    cursor: default;
  }

  .correct {
    color: #228b22 !important; /* soft natural green */
  }

  .wrong {
    border-color: #b22222 !important; /* muted brick red */
    /* Add a little shake animation */
    animation: shake 0.5s ease-in-out;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  @keyframes sparkle {
    0% {
      transform: translate(0, 0) scale(1);
      opacity: 1;
    }
    100% {
      transform: translate(var(--random-x, 0), -100px) scale(1.5);
      opacity: 0;
    }
  }

  @keyframes gemPulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.3);
    }
  }

  .gem-spark {
    position: absolute;
    pointer-events: none;
    font-size: 1.5rem;
    animation: sparkle 1s ease-out forwards;
    z-index: 20; /* Ensure sparks are on top */
  }

  .gem-counter-pulse {
    animation: gemPulse 0.4s ease-in-out;
  }

  #scoreCard {
    margin-top: 2rem;
    font-size: 1.2rem;
    color: #4b3b2a;
  }

  #timer, #gemsCounter, #progressTracker {
    font-size: 1.1rem; /* Slightly larger */
    margin-bottom: 1rem;
    color: #6b4f33;
    font-weight: 500;
  }

  #restartBtn {
    margin-top: 2rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #d2b48c;
    border: 1px solid #a1886f;
    border-radius: 10px;
    cursor: pointer;
    color: #3b2f1e;
    transition: background-color 0.2s ease;
  }

  #restartBtn:hover {
    background-color: #c9a96b;
  }
  
  #startQuizBtn {
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #8b7355;
    border: 1px solid #5b442a;
    border-radius: 10px;
    cursor: pointer;
    color: #ffffff;
    transition: background-color 0.2s ease;
  }
  #startQuizBtn:hover {
    background-color: #6b5a43;
  }


  #nameForm {
    margin-bottom: 1.5rem;
  }

  #nameInput, #departmentSelect {
    display: block;
    width: 90%;
    max-width: 300px;
    margin: 1rem auto;
    padding: 0.7rem;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #c2a677;
    background: #fffdf6;
    color: #3b2f1e;
  }

  .quiz-header {
    position: absolute;
    top: 10px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 1.5rem; /* Increased padding */
    font-size: 1rem;
    color: #5b442a;
    z-index: 10;
  }

  .quiz-header #timer {
    text-align: left;
    flex: 1;
  }

  .quiz-header #gemsCounter {
    text-align: center;
    flex: 1;
  }

  .quiz-header #progressTracker {
    text-align: right;
    flex: 1;
    font-size: 0.9rem; /* Adjusted font size for new text */
  }

  #nextPageBtn {
    margin-top: 1.5rem;
    padding: 0.7rem 2rem;
    font-size: 1.1rem;
    background-color: #4CAF50; /* Green */
    border: none;
    border-radius: 10px;
    cursor: pointer;
    color: white;
    transition: background-color 0.2s ease;
    font-weight: bold;
  }
  #nextPageBtn:hover {
    background-color: #45a049;
  }

</style>

</head>
<body>
<div class="container" id="quizContainer">
  <div id="nameForm">
    <input type="text" id="nameInput" placeholder="Enter your name" />
  
    <!-- Department Selector --><select id="departmentSelect">
      <option value="">-- Select Department --</option>
      <option value="Cyber Security">Cyber Security</option>
      <option value="CSE-1">CSE-1</option>
      <option value="CSE-2">CSE-2</option>
      <option value="CSE-3">CSE-3</option>
      <option value="Mechanical Engineering">Mechanical Engineering</option>
      <option value="ECE-1">ECE-1</option>
      <option value="ECE-2">ECE-2</option>
      <option value="ECE-3">ECE-3</option>
      <option value="AI DS-1">AI DS-1</option>
      <option value="AI DS-2">AI DS-2</option>
      <option value="Civil">Civil</option>
      <option value="Agri">Agri</option>
      <option value="EEE">EEE</option>
      <option value="EIE">EIE</option>
      <option value="Medical Electronics">Medical Electronics</option>
      <option value="IT-1">IT-1</option>
      <option value="IT-2">IT-2</option>
    </select>

    <button id="startQuizBtn" onclick="beginQuiz()">Start Quiz</button>
  </div>


  <div id="quizContent" style="display:none;">
    <div class="quiz-header">
      <div id="timer">‚è≥ 0s</div>
      <div id="gemsCounter">üíé 0</div>
      <div id="progressTracker">üìç 1 of 1</div>
    </div>
    <!-- Question title removed, as the passage is the question
    <div class="question" id="question"></div> 
    --><div class="drag-options" id="dragOptions"></div>
    <div class="drop-container" id="dropContainer"></div>
    <div id="scoreCard"></div>
    <button id="nextPageBtn" style="display: none;">Next &rarr;</button> 
    <button id="restartBtn" style="display: none;">Restart</button>
  </div>
</div>

<script>
// --- NEW QUIZ DATA STRUCTURE ---
const quizDataStore = [
 {
  "passage": "A father ___ into his son‚Äôs room ___ say goodnight ___ him. He ___ this every night before going ___ bed himself, as part ___ their small bedtime routine. Both of them ___ it very much. The father ___ that if he ever ___ to say goodnight ___ his son, the boy ___ have trouble ___ asleep. That night, the house ___ quiet. The lights ___ dim, and there ___ a heavy stillness ___ the air. The father slowly ___ through the hallway and ___ open the door ___ his son‚Äôs room. The boy ___ already tucked ___ his blanket, waiting ___ him as usual. A small lamp ___ the bedside table ___ the room a soft, yellow glow that ___ gently ___ the walls. Everything ___ peaceful at first. \n\nBut when the father ___ more closely ___ his son, he ___ something ___ different about him. The boy ___ the same ‚Äî the same small face, the same hair, the same pyjamas ‚Äî yet something ___ not right ___ his expression. The boy ___ a grin that ___ from ear to ear. It ___ too wide, too still, too unnatural ___ a child. ‚ÄúAre you all right, son?‚Äù the father ___ softly, standing ___ the bed. The boy ___, still smiling in that strange way, his eyes ___ straight ___ his father without blinking. Then he ___, ‚ÄúDaddy, please check ___ monsters under my bed.‚Äù \n\nThe father ___ quietly and moved ___ the floor. It ___ not the first time his son ___ said that. ‚ÄúAll right,‚Äù he ___ kindly, ‚Äúlet‚Äôs make sure there ___ no monsters ___ there tonight.‚Äù He ___ down ___ his knees and ___ the blanket carefully ___ the edge ___ the bed. He ___ forward and ___ beneath it, expecting ___ see only dust, a few old toys, or maybe a lost sock behind a box. But instead, he ___ another face staring ___ at him. The face was pale, frightened, and trembling ___ the darkness. It ___ his real son. The boy ___ the bed whispered softly, \"Daddy, there‚Äôs someone ___ my bed.\"",
  "answers": [
    "went", "to", "to",
    "did", "to", "of",
    "enjoyed",
    "knew", "forgot", "to", "would", "falling",
    "was", "were", "was", "in",
    "walked", "pushed", "to",
    "was", "under", "for",
    "on", "gave", "spread", "across",
    "seemed",
    "looked", "at", "felt", "was",
    "looked", "was", "in",
    "had", "stretched",
    "was", "for",
    "asked", "by",
    "nodded", "staring", "at",
    "said", "for",
    "chuckled", "to",
    "was", "had",
    "said", "were", "under",
    "got", "onto", "lifted", "from", "of",
    "leaned", "peered", "to",
    "saw", "up", "in",
    "was",
    "under", "on"
  ]
}

];

let quizData = []; // This will hold the active quiz questions
let current = 0;
let wrongQuestions = [];
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;
let totalQuestionsInQuiz = 0; // Tracks total questions including retries

// --- New Pagination State ---
const blanksPerPage = 10;
// let currentBlankPage = 0; // No longer needed as a global variable
// --------------------------

// Element cache
// const questionEl = document.getElementById("question"); // No longer needed
const dragOptionsEl = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl = document.getElementById("timer");
const gemsCounterEl = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard = document.getElementById("scoreCard");
const restartBtn = document.getElementById("restartBtn");
const nextPageBtn = document.getElementById("nextPageBtn"); 
const quizContentEl = document.getElementById("quizContent");
const nameFormEl = document.getElementById("nameForm");
const nameInputEl = document.getElementById("nameInput");
const deptSelectEl = document.getElementById("departmentSelect");


function beginQuiz() {
  if (!nameInputEl.value.trim()) { 
    // Use a custom modal or simple visual feedback instead of alert
    nameInputEl.style.borderColor = "red";
    return; 
  }
  if (!deptSelectEl.value) { 
    deptSelectEl.style.borderColor = "red";
    return; 
  }
  // Reset border colors if validation passes
  nameInputEl.style.borderColor = "#c2a677";
  deptSelectEl.style.borderColor = "#c2a677";

  playerName = nameInputEl.value.trim();
  playerDept = deptSelectEl.value;

  nameFormEl.style.display = "none";
  quizContentEl.style.display = "block";
  startQuiz();
}

function startQuiz() {
  // Reset all quiz state variables
  quizData = []; // Clear quiz data
  wrongQuestions = [];
  
  // --- Pre-process quizDataStore into a flat list of PAGES ---
  quizDataStore.forEach((passageObject, passageIdx) => {
    const totalAnswers = passageObject.answers.length;
    const totalBlankPages = Math.ceil(totalAnswers / blanksPerPage);
    
    for (let i = 0; i < totalBlankPages; i++) {
      const pageObject = {
        originalPassage: passageObject.passage, // Full text
        originalAnswers: passageObject.answers, // All answers
        pageIndex: i, // Which page this is (0-based)
        passageIndex: passageIdx, // Which passage this belongs to
        totalPassagesInStore: quizDataStore.length,
        totalPassagePages: totalBlankPages,
        // Unique ID for this specific page
        pageId: `p${passageIdx}-pg${i}` 
      };
      quizData.push(pageObject);
    }
  });
  // ---------------------------------------------------------
  
  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();
  totalQuestionsInQuiz = quizData.length; // Total questions is now total PAGES
  // currentBlankPage = 0; // No longer needed
  
  // Reset UI elements
  timerEl.innerText = "‚è≥ 0s";
  gemsCounterEl.innerText = `üíé 0`;
  scoreCard.innerHTML = "";
  restartBtn.style.display = "none";
  nextPageBtn.style.display = "none"; 
  
  loadQuestion();
  startTimer();
  // updateProgress(); // Initial progress update - This is called by loadQuestion()
}

function updateProgress() {
  // New logic:
  // totalQuestionsInQuiz is the total number of pages, including retries.
  const currentQuestionNumber = current + 1; // This is the global page number
  
  // Add page number to progress tracker
  if (quizData[current]) {
    const data = quizData[current];
    // const totalBlankPages = Math.ceil(data.originalAnswers.length / blanksPerPage); // Already have this
    const totalBlankPages = data.totalPassagePages;
    const currentPageNum = data.pageIndex + 1; // Page number *within* the passage
    
    // Example: "Page 5 of 32 (Passage Page 5 of 10)"
    progressTracker.innerText = `üìç Page ${currentQuestionNumber} of ${totalQuestionsInQuiz} (Passage Page ${currentPageNum} of ${totalBlankPages})`;
  } else if (current > 0) {
    progressTracker.innerText = "Done!";
  } else {
    progressTracker.innerText = `üìç Page 1 of ${totalQuestionsInQuiz}`;
  }
}


// --- REFACTORED loadQuestion ---
function loadQuestion() {
  if (current >= quizData.length) return showScore();
  
  selectedOption = null;
  const data = quizData[current]; // Data is now a PAGE object
  updateProgress(); // Call updateProgress here to get page numbers
  
  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  nextPageBtn.style.display = "none"; // Ensure next button is hidden on new page load

  // --- Pagination Logic ---
  const pageIndex = data.pageIndex;
  const startIndex = pageIndex * blanksPerPage;
  const endIndex = startIndex + blanksPerPage;
  
  const answersForThisPage = data.originalAnswers.slice(startIndex, endIndex);
  const allPassageParts = data.originalPassage.split("___");
  // Get parts relevant to this page. +1 because split gives one more part than answers.
  const partsForThisPage = allPassageParts.slice(startIndex, endIndex + 1);
  // -------------------------

  // 1. Shuffle and display drag options for this page
  const shuffledAnswers = [...answersForThisPage].sort(() => Math.random() - 0.5);
  shuffledAnswers.forEach((ans) => {
    const div = document.createElement("div");
    div.classList.add("drag-item");
    div.innerText = ans;
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  // 2. Process the passage string
  // const passage = data.passage; // Old
  // const answers = data.answers; // Old
  // const parts = passage.split("___"); // Old

  // 3. Reconstruct the passage with interactive blanks
  
  // Add "..." if this isn't the first page
  if (startIndex > 0) {
    dropContainerEl.appendChild(document.createTextNode("... "));
  }

  partsForThisPage.forEach((part, index) => {
    // Add the text part
    dropContainerEl.appendChild(document.createTextNode(part));

    // If there's another answer for this page, add a blank
    if (index < answersForThisPage.length) {
      const dropZone = document.createElement("button"); // Use a button for interactivity
      dropZone.classList.add("drop-zone");
      dropZone.innerText = "___"; // This is the visual blank
      dropZone.dataset.answer = answersForThisPage[index]; // Assign the correct answer
      dropZone.onclick = () => placeOption(dropZone);
      dropContainerEl.appendChild(dropZone);
      dropContainerEl.appendChild(document.createTextNode(" ")); // Add a space
    }
  });

  // Add "..." if this isn't the last page
  if (endIndex < data.originalAnswers.length) {
     dropContainerEl.appendChild(document.createTextNode(" ..."));
  }
}

function selectOption(div) {
  if (div.style.display === "none") return; // Don't select hidden options
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

// --- REFACTORED placeOption ---
function placeOption(dropZone) {
  // If no option is selected, or blank is already filled, do nothing
  if (!selectedOption || dropZone.classList.contains("filled")) return;

  const answer = selectedOption.innerText;
  const correctAnswer = dropZone.dataset.answer;

  if (correctAnswer === answer) {
    // --- CORRECT ---
    correctCount++;
    gemsCount++;
    
    // Create sparkle effect
    createSparkleEffect(dropZone);
    
    // Pulse the gem counter
    gemsCounterEl.classList.add('gem-counter-pulse');
    setTimeout(() => gemsCounterEl.classList.remove('gem-counter-pulse'), 400);
    
    gemsCounterEl.innerText = `üíé ${gemsCount}`;

    // Replace blank with correct answer
    dropZone.innerText = answer;
    dropZone.classList.add("correct", "filled");
    dropZone.disabled = true; // Disable the button
    
    selectedOption.style.display = "none"; // Hide the used option
  
  } else {
    // --- WRONG ---
    totalWrongGuesses++;
    gemsCount--;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    
    // Flash the drop zone red
    dropZone.classList.add("wrong");
    setTimeout(() => dropZone.classList.remove("wrong"), 600);

    // Add the entire current question back to wrongQuestions if not already added
    const currentData = quizData[current]; // This is now the PAGE object
    if (!wrongQuestions.includes(currentData)) {
      wrongQuestions.push(currentData); // Push the PAGE, not the whole passage
      totalQuestionsInQuiz++; // Increment the total
      updateProgress(); // Update immediately
    }
  }

  // Deselect the option
  selectedOption.classList.remove("selected");
  selectedOption = null;

  // Check if all blanks for the current question are filled
  const remaining = dropContainerEl.querySelectorAll(".drop-zone:not(.filled)").length;
  
  if (remaining === 0) {
    // All blanks for this page are filled
    // Show the next button so the user can review and advance manually
    nextPageBtn.style.display = "inline-block";
  }
}

function createSparkleEffect(element) {
  const rect = element.getBoundingClientRect();
  const containerRect = quizContainer.getBoundingClientRect(); // Use main container
  
  // Create multiple sparks
  const sparkCount = 8;
  for (let i = 0; i < sparkCount; i++) {
    const spark = document.createElement('div');
    spark.className = 'gem-spark';
    spark.innerText = ['üíé', '‚ú®', '‚≠ê'][Math.floor(Math.random() * 3)];
    
    // Position relative to the main container
    spark.style.position = 'absolute';
    spark.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
    spark.style.top = `${rect.top - containerRect.top + rect.height / 2}px`;
    
    // Random horizontal spread
    const randomX = (Math.random() - 0.5) * 100;
    spark.style.setProperty('--random-x', `${randomX}px`);
    
    quizContainer.appendChild(spark); // Append to main container
    
    // Remove after animation
    setTimeout(() => spark.remove(), 1000);
  }
}

function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  // questionEl.innerText = "üéâ Quiz Completed!"; // No longer using questionEl
  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = `<h2 style="text-align:center;">üéâ Quiz Completed!</h2>`;
  progressTracker.innerText = "Done!";
  nextPageBtn.style.display = "none"; 
  
  // Determine success message
  const successMessage = (totalWrongGuesses === 0) 
    ? "<p>‚úÖ Flawless! All questions answered correctly on the first attempt!</p>"
    : `<p>‚úÖ Correct Answers (total): ${correctCount}</p>
       <p>‚ùå Wrong Attempts (total): ${totalWrongGuesses}</p>`;

  scoreCard.innerHTML = `
    <p>üë§ Player: <strong>${playerName}</strong> (${playerDept})</p>
    ${successMessage}
    <p>üíé Final Gems: ${gemsCount}</p>
    <p>‚è±Ô∏è Time Taken: ${totalTime} seconds</p>
    <button onclick="downloadPDFReport()" style="margin-top: 1rem; padding: 0.7rem 2rem; background-color: #4CAF50; border: none; border-radius: 10px; cursor: pointer; color: white; font-size: 1rem;">üì• Download PDF Report</button>
  `;
  restartBtn.style.display = "inline-block";


  // --- SEND RESULTS TO GOOGLE SHEET ---
  // This remains unchanged
  fetch("https://script.google.com/macros/s/AKfycbxA0lRkERWFt2cYfmm04IQioaG4-21k5VFF5CFKP30zyVaJXM5_27PL3v8JIZEweK3u/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name: playerName,
      correct: correctCount,
      wrong: totalWrongGuesses,
      time: totalTime,
      department: playerDept,
      questId: "Quest 20 (Cloze)" // Updated Quest ID
    })
  });
}


function startTimer() {
  clearInterval(timerInterval); // Clear any existing timer
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime)/1000);
    timerEl.innerText = `‚è≥ ${elapsed}s`;
  }, 1000);
}

// --- REFACTORED downloadPDFReport ---
function downloadPDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

  // --- HEADER ---
  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('times', 'bold');
  doc.setFontSize(18);
  doc.text('SRM VALLIAMMAI ENGINEERING COLLEGE', 105, 16, { align: 'center' });
  doc.setFontSize(12);
  doc.setFont('times', 'italic');
  doc.text('(Autonomous)', 105, 23, { align: 'center' });
  doc.setFontSize(15);
  doc.setFont('times', 'normal');
  doc.text('Department of English', 105, 31, { align: 'center' });
  doc.setFontSize(14);
  doc.setFont('times', 'bold');
  doc.setTextColor(212, 175, 55);
  doc.text('Quest Performance Report', 105, 39, { align: 'center' });

  // --- STUDENT INFO ---
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text('CANDIDATE INFORMATION', 20, 55);
  doc.autoTable({
    startY: 58,
    body: [
      ['Student Name', playerName],
      ['Department', playerDept],
      ['Quest ID', 'Quest 20 (Cloze)'],
      ['Completed On', reportDate]
    ],
    theme: 'plain',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: 'bold', cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 }
    },
    margin: { left: 20, right: 20 }
  });

  // --- PERFORMANCE SUMMARY ---
  let y = doc.lastAutoTable.finalY + 10;
  doc.setFont('times', 'bold');
  doc.text('PERFORMANCE SUMMARY', 20, y);
  y += 4;
  doc.autoTable({
    startY: y + 3,
    body: [
      ['Total Questions', quizDataStore.length.toString()], // Use master store length
      ['Correct Answers (Total)', correctCount.toString()],
      ['Wrong Attempts (Total)', totalWrongGuesses.toString()],
      ['Final Gems Earned', gemsCount.toString()],
      ['Total Time', `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`]
    ],
    theme: 'grid',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    margin: { left: 20, right: 20 }
  });

  // --- QUESTION BANK SECTION (SIMPLIFIED) ---
  y = doc.lastAutoTable.finalY + 12;
  if (y > 250) { doc.addPage(); y = 20; }
  doc.setFont('times', 'bold');
  doc.text('QUESTION BANK WITH CORRECT ANSWERS', 20, y);
  y += 6;

  quizDataStore.forEach((item, i) => {
    if (y > 260) { doc.addPage(); y = 20; }
    
    // Reconstruct the full passage with answers
    let fullPassage = item.passage;
    item.answers.forEach(ans => {
      // Use a special color/font for the answer in the PDF
      // jspdf-autotable doesn't make this easy in a single text block.
      // We'll just put the answer in brackets [ ].
      fullPassage = fullPassage.replace("___", ` [${ans}] `);
    });

    doc.setFontSize(11);
    doc.setFont('times', 'bold');
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, 20, y);
    y += 6;
    
    doc.setTextColor(0, 0, 0);
    doc.setFont('times', 'normal');
    
    // Add the reconstructed passage
    const lines = doc.splitTextToSize(fullPassage, 160); // 160 = width
    doc.text(lines, 25, y);
    y += lines.length * 5; // Adjust y based on number of lines
    
    y += 3;
    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.3);
    doc.line(20, y, 190, y); // Separator line
    y += 5;
  });

  // --- FOOTER ---
  doc.setDrawColor(184, 134, 11);
  doc.setLineWidth(0.5);
  doc.line(20, 280, 190, 280);
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.setFont('times', 'italic');
  doc.text('This is a system-generated report', 105, 287, { align: 'center' });

  const cleanName = playerName.replace(/[^a-zA-Z0-9]/g, '_');
  doc.save(`${cleanName}_Quest20_Report.pdf`);
}

restartBtn.onclick = () => {
  quizContentEl.style.display = "none";
  nameFormEl.style.display = "block";
  nameInputEl.value = ""; // Clear name field
  deptSelectEl.value = ""; // Reset department dropdown
  nextPageBtn.style.display = "none"; 
};

// --- Handle Next Page Button Click ---
nextPageBtn.onclick = () => {
  current++; // Move to next page

  // If we've finished the initial set, check if there are wrong questions to retry
  if (current >= quizData.length && wrongQuestions.length > 0) {
    quizData.push(...wrongQuestions); // Add wrong PAGES to the end
    wrongQuestions = []; // Clear the retry queue
  }
  
  loadQuestion(); // Load the next question (or show score)
};


</script>
<!-- ‚úÖ Add this PWA navigation handler below -->
<script>
document.addEventListener("click", function (e) {
  const target = e.target.closest("a");
  if (!target) return;

  const url = target.href;
  const internalDomains = [
    window.location.origin,
    "andrewveda.github.io",
    "sites.google.com/view/cys-english/",
    "sites.google.com/view/srm-vec-english/"
  ];

  const isInternal = internalDomains.some(domain => url.includes(domain));

  if (isInternal) {
    if (
      window.matchMedia("(display-mode: standalone)").matches ||
      window.matchMedia("(display-mode: fullscreen)").matches
    ) {
      e.preventDefault();
      window.location.href = url;
    }
  } else {
    target.setAttribute("target", "_blank");
  }
});
</script>
<script>
// Add this script to EVERY quest page
document.addEventListener("click", function (e) {
  const target = e.target.closest("a");
  if (!target) return;

  const url = target.href;

  // Domains to open internally (no browser bar)
  const internalDomains = [
    "andrewveda.github.io",
    "sites.google.com/view/cys-english",
    "sites.google.com/view/srm-vec-english"
  ];

  const isInternal = internalDomains.some(domain => url.includes(domain));

  if (isInternal) {
    // Open in same PWA context (native feel)
    e.preventDefault();
    window.location.href = url;
  } else {
    // Open external links in new tab
    target.setAttribute("target", "_blank");
  }
});
</script>
</body>
</html>

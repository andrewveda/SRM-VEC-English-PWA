<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speaking Quest - SRM VEC English</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f3ff 0%, #eff6ff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        .progress-section {
            margin-bottom: 24px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #9333ea 0%, #3b82f6 100%);
            transition: width 0.3s ease;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 32px;
        }

        h1, h2 {
            color: #1f2937;
            margin-bottom: 8px;
        }

        h1 {
            font-size: 28px;
        }

        h2 {
            font-size: 22px;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 32px;
        }

        .recording-section {
            text-align: center;
            margin: 40px 0;
        }

        .timer {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .recording-indicator {
            width: 16px;
            height: 16px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        button {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #9333ea 0%, #3b82f6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(147, 51, 234, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: white;
            color: #4b5563;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f9fafb;
        }

        .recording-card {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }

        .recording-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .recording-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #16a34a;
            font-weight: 600;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: #16a34a;
            border-radius: 50%;
        }

        .recording-time {
            color: #15803d;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        .completion-card {
            text-align: center;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #dcfce7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 40px;
        }

        .recording-list {
            margin: 32px 0;
        }

        .recording-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .recording-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .recording-item-title {
            font-weight: 600;
            color: #1f2937;
        }

        .play-button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .icon {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <div class="progress-info">
                <span id="questionProgress">Question 1 of 5</span>
                <span id="recordedCount">0 recorded</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Question View -->
        <div class="card" id="questionView">
            <h2 id="questionTitle">Introduce yourself</h2>
            <p class="subtitle" id="questionPrompt">Tell us your name, where you're from, and one interesting thing about yourself.</p>

            <!-- Not Recorded State -->
            <div class="recording-section" id="notRecordedState" style="display: block;">
                <button class="btn-primary" id="startRecordBtn">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    Start Recording
                </button>
            </div>

            <!-- Recording State -->
            <div class="recording-section" id="recordingState" style="display: none;">
                <div class="timer">
                    <div class="recording-indicator"></div>
                    <span id="timerDisplay">0:00</span>
                </div>
                <button class="btn-danger" id="stopRecordBtn">
                    <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
                        <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                    </svg>
                    Stop Recording
                </button>
            </div>

            <!-- Recorded State -->
            <div class="recording-card" id="recordedState" style="display: none;">
                <div class="recording-header">
                    <div class="recording-status">
                        <div class="status-dot"></div>
                        <span>Recording saved</span>
                    </div>
                    <span class="recording-time" id="savedDuration">0:00</span>
                </div>
                
                <!-- Transcription Display -->
                <div id="transcriptionSection" style="display: none; margin: 16px 0; padding: 16px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #9333ea;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span style="font-weight: 600; color: #4b5563;">Transcription:</span>
                    </div>
                    <p id="transcriptionText" style="color: #1f2937; line-height: 1.6; font-style: italic;"></p>
                </div>
                
                <div class="button-group">
                    <button class="btn-secondary" id="playRecordBtn" style="flex: 1;">
                        <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"></path>
                        </svg>
                        Play
                    </button>
                    <button class="btn-secondary" id="reRecordBtn">
                        Re-record
                    </button>
                </div>
            </div>

            <button class="btn-primary" id="nextBtn" style="width: 100%; margin-top: 24px; display: none;">
                Next Question
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>

        <!-- Completion View -->
        <div class="card completion-card" id="completionView" style="display: none;">
            <div class="success-icon">✓</div>
            <h1>Quest Complete!</h1>
            <p class="subtitle">Great job completing all 5 questions.</p>

            <div class="recording-list" id="recordingList"></div>

            <div class="button-group" style="justify-content: center;">
                <button class="btn-primary" id="downloadBtn">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download All Recordings
                </button>
                <button class="btn-secondary" id="restartBtn">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Restart
                </button>
            </div>
        </div>
    </div>

    <script>
        const questions = [
            {
                id: 1,
                question: "Introduce yourself",
                prompt: "Tell us your name, where you're from, and one interesting thing about yourself."
            },
            {
                id: 2,
                question: "Your favorite hobby",
                prompt: "Describe your favorite hobby and why you enjoy it."
            },
            {
                id: 3,
                question: "A memorable experience",
                prompt: "Share a memorable experience from the past year."
            },
            {
                id: 4,
                question: "Future goals",
                prompt: "What are your goals for the next six months?"
            },
            {
                id: 5,
                question: "Advice to others",
                prompt: "What advice would you give to someone learning a new skill?"
            }
        ];

        let currentQuestion = 0;
        let isRecording = false;
        let recordings = {};
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTime = 0;
        let timerInterval = null;
        let currentAudio = null;
        let recognition = null;
        let currentTranscript = '';

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
        }

        // DOM Elements
        const questionProgress = document.getElementById('questionProgress');
        const recordedCount = document.getElementById('recordedCount');
        const progressFill = document.getElementById('progressFill');
        const questionTitle = document.getElementById('questionTitle');
        const questionPrompt = document.getElementById('questionPrompt');
        const notRecordedState = document.getElementById('notRecordedState');
        const recordingState = document.getElementById('recordingState');
        const recordedState = document.getElementById('recordedState');
        const timerDisplay = document.getElementById('timerDisplay');
        const savedDuration = document.getElementById('savedDuration');
        const nextBtn = document.getElementById('nextBtn');
        const questionView = document.getElementById('questionView');
        const completionView = document.getElementById('completionView');
        const progressSection = document.getElementById('progressSection');

        // Initialize
        updateUI();

        // Event Listeners
        document.getElementById('startRecordBtn').addEventListener('click', startRecording);
        document.getElementById('stopRecordBtn').addEventListener('click', stopRecording);
        document.getElementById('playRecordBtn').addEventListener('click', togglePlayback);
        document.getElementById('reRecordBtn').addEventListener('click', reRecord);
        document.getElementById('nextBtn').addEventListener('click', nextQuestion);
        document.getElementById('downloadBtn').addEventListener('click', downloadAllRecordings);
        document.getElementById('restartBtn').addEventListener('click', restart);

        function updateUI() {
            const question = questions[currentQuestion];
            questionTitle.textContent = question.question;
            questionPrompt.textContent = question.prompt;
            questionProgress.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
            recordedCount.textContent = `${Object.keys(recordings).length} recorded`;
            progressFill.style.width = `${((currentQuestion + 1) / questions.length) * 100}%`;

            const hasRecording = recordings[question.id];
            
            // Show/hide sections based on state
            if (isRecording) {
                notRecordedState.style.display = 'none';
                recordingState.style.display = 'block';
                recordedState.style.display = 'none';
                nextBtn.style.display = 'none';
            } else if (hasRecording) {
                notRecordedState.style.display = 'none';
                recordingState.style.display = 'none';
                recordedState.style.display = 'block';
                nextBtn.style.display = 'block';
                
                // Show transcription if available
                const transcriptionSection = document.getElementById('transcriptionSection');
                const transcriptionText = document.getElementById('transcriptionText');
                
                if (hasRecording.transcript && hasRecording.transcript.trim()) {
                    transcriptionSection.style.display = 'block';
                    transcriptionText.textContent = hasRecording.transcript;
                } else {
                    transcriptionSection.style.display = 'none';
                }
            } else {
                notRecordedState.style.display = 'block';
                recordingState.style.display = 'none';
                recordedState.style.display = 'none';
                nextBtn.style.display = 'none';
            }

            if (hasRecording) {
                savedDuration.textContent = formatTime(recordings[question.id].duration);
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recordingTime = 0;
                currentTranscript = '';

                // Start speech recognition
                if (recognition) {
                    recognition.onresult = (event) => {
                        let interimTranscript = '';
                        let finalTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript + ' ';
                            } else {
                                interimTranscript += transcript;
                            }
                        }

                        currentTranscript = (currentTranscript + finalTranscript).trim();
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                    };

                    recognition.start();
                }

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    recordings[questions[currentQuestion].id] = {
                        blob: audioBlob,
                        url: audioUrl,
                        duration: recordingTime,
                        transcript: currentTranscript
                    };

                    stream.getTracks().forEach(track => track.stop());
                    
                    // Stop speech recognition
                    if (recognition) {
                        recognition.stop();
                    }
                    
                    isRecording = false;
                    updateUI();
                };

                mediaRecorder.start();
                isRecording = true;
                
                timerInterval = setInterval(() => {
                    recordingTime++;
                    timerDisplay.textContent = formatTime(recordingTime);
                }, 1000);

                updateUI();
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Unable to access microphone. Please grant permission and try again.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                clearInterval(timerInterval);
            }
        }

        function togglePlayback() {
            const questionId = questions[currentQuestion].id;
            const playBtn = document.getElementById('playRecordBtn');
            
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                playBtn.innerHTML = '<svg class="icon" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg> Play';
            } else {
                if (currentAudio) {
                    currentAudio.pause();
                }
                
                currentAudio = new Audio(recordings[questionId].url);
                currentAudio.onended = () => {
                    playBtn.innerHTML = '<svg class="icon" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg> Play';
                };
                
                currentAudio.play();
                playBtn.innerHTML = '<svg class="icon" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"></path></svg> Pause';
            }
        }

        function reRecord() {
            if (currentAudio) {
                currentAudio.pause();
            }
            delete recordings[questions[currentQuestion].id];
            updateUI();
        }

        function nextQuestion() {
            if (currentAudio) {
                currentAudio.pause();
            }
            
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                updateUI();
            } else {
                showCompletion();
            }
        }

        function showCompletion() {
            questionView.style.display = 'none';
            progressSection.style.display = 'none';
            completionView.style.display = 'block';
            
            const recordingList = document.getElementById('recordingList');
            recordingList.innerHTML = '';
            
            questions.forEach((q) => {
                const recording = recordings[q.id];
                const item = document.createElement('div');
                item.className = 'recording-item';
                
                let transcriptHTML = '';
                if (recording && recording.transcript && recording.transcript.trim()) {
                    transcriptHTML = `
                        <div style="margin-top: 8px; padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #9333ea;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 600;">Transcription:</div>
                            <div style="font-size: 14px; color: #1f2937; font-style: italic;">${recording.transcript}</div>
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <div class="recording-item-header">
                        <span class="recording-item-title">${q.question}</span>
                        <span class="recording-time">${recording ? formatTime(recording.duration) : 'No recording'}</span>
                    </div>
                    ${recording ? `<button class="btn-secondary play-button" onclick="playRecording(${q.id})">▶ Play</button>` : '<span style="color: #9ca3af; font-size: 14px;">No recording</span>'}
                    ${transcriptHTML}
                `;
                recordingList.appendChild(item);
            });
        }

        window.playRecording = function(questionId) {
            if (currentAudio) {
                currentAudio.pause();
            }
            currentAudio = new Audio(recordings[questionId].url);
            currentAudio.play();
        };

        async function downloadAllRecordings() {
            const audioContext = new AudioContext();
            const sources = [];

            for (let i = 0; i < questions.length; i++) {
                const questionId = questions[i].id;
                if (recordings[questionId]) {
                    const arrayBuffer = await recordings[questionId].blob.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    sources.push(audioBuffer);
                }
            }

            if (sources.length === 0) {
                alert('No recordings to download');
                return;
            }

            const totalLength = sources.reduce((sum, buffer) => sum + buffer.length, 0);
            const combinedBuffer = audioContext.createBuffer(2, totalLength, audioContext.sampleRate);

            let offset = 0;
            sources.forEach(buffer => {
                for (let channel = 0; channel < 2; channel++) {
                    const channelData = buffer.numberOfChannels > channel 
                        ? buffer.getChannelData(channel) 
                        : buffer.getChannelData(0);
                    combinedBuffer.getChannelData(channel).set(channelData, offset);
                }
                offset += buffer.length;
            });

            const wavBlob = audioBufferToWav(combinedBuffer);
            const url = URL.createObjectURL(wavBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `speaking-quest-${Date.now()}.wav`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function audioBufferToWav(buffer) {
            const length = buffer.length * buffer.numberOfChannels * 2;
            const arrayBuffer = new ArrayBuffer(44 + length);
            const view = new DataView(arrayBuffer);
            
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, buffer.numberOfChannels, true);
            view.setUint32(24, buffer.sampleRate, true);
            view.setUint32(28, buffer.sampleRate * 4, true);
            view.setUint16(32, buffer.numberOfChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length, true);

            let offset = 44;
            for (let i = 0; i < buffer.length; i++) {
                for (let channel = 0; channel < buffer.numberOfChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
            }

            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        function restart() {
            if (currentAudio) {
                currentAudio.pause();
            }
            currentQuestion = 0;
            recordings = {};
            completionView.style.display = 'none';
            progressSection.style.display = 'block';
            questionView.style.display = 'block';
            updateUI();
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
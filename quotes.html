<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Quote a Day âœ¨</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700&family=Raleway:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Special+Elite&family=Syne:wght@700;800&family=DM+Mono:wght@300;400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Unbounded:wght@700;800&family=Cormorant+Garamond:ital,wght@0,300;0,600;1,300;1,600&display=swap" rel="stylesheet">

<style>
/* â”€â”€â”€ RESET â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* â”€â”€â”€ ROOT â”€â”€â”€ */
:root {
  --gold: #d4af37;
  --gold-dim: rgba(212,175,55,0.18);
  --card-bg: rgba(255,255,255,0.04);
  --card-border: rgba(255,255,255,0.10);
  --text: #f0efe8;
  --text-dim: #888;
  --transition: 0.45s cubic-bezier(.4,0,.2,1);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body {
  min-height: 100%;
  background: #0a0a0a;
  color: var(--text);
  font-family: 'Raleway', sans-serif;
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
}

/* â”€â”€â”€ SHELL â”€â”€â”€ */
.shell {
  min-height: 100dvh;
  display: grid;
  grid-template-rows: auto 1fr auto;
}

/* â”€â”€â”€ TOP BAR â”€â”€â”€ */
.topbar {
  position: sticky;
  top: 0;
  z-index: 10;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: calc(12px + var(--safe-top)) 16px 10px;
  background: rgba(10,10,10,0.85);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--card-border);
}

.topbar-left {
  display: flex;
  gap: 8px;
  align-items: center;
}

.topbar-title {
  font-family: 'Cinzel', serif;
  font-size: 13px;
  letter-spacing: 2px;
  color: var(--gold);
  text-transform: uppercase;
}

.topbar-counter {
  font-size: 10px;
  padding: 4px 10px;
  border-radius: 14px;
  background: rgba(255,255,255,0.06);
  border: 1px solid var(--card-border);
  color: var(--text-dim);
}

/* â”€â”€â”€ STAGE (SCROLL AREA) â”€â”€â”€ */
.stage {
  position: relative;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 20px 0 24px;
}

/* background */
.ambient {
  position: absolute;
  inset: 0;
  z-index: 0;
}

/* â”€â”€â”€ CONTENT â”€â”€â”€ */
.card-wrap {
  position: relative;
  z-index: 1;
  width: 94%;
  max-width: 780px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* â”€â”€â”€ CARD â”€â”€â”€ */
.card {
  width: 100%;
  padding: 28px 20px 22px;
  border-radius: 18px;
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  backdrop-filter: blur(22px);
  box-shadow: 0 8px 40px rgba(0,0,0,0.35);
  animation: cardIn 0.5s cubic-bezier(.4,0,.2,1);
}

@keyframes cardIn {
  from { opacity: 0; transform: translateY(18px) scale(0.96); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.card.swap {
  animation: cardOut 0.25s cubic-bezier(.4,0,.2,1) forwards,
             cardIn 0.45s cubic-bezier(.4,0,.2,1) 0.25s both;
}

@keyframes cardOut {
  to { opacity: 0; transform: translateY(-14px) scale(0.95); }
}

/* â”€â”€â”€ QUOTE â”€â”€â”€ */
.q-mark {
  font-family: 'Cinzel', serif;
  font-size: 44px;
  opacity: 0.35;
  color: var(--gold);
  display: block;
  text-align: center;
  margin-bottom: 6px;
}

.q-text {
  font-family: 'Cormorant Garamond', serif;
  font-size: clamp(20px, 5vw, 32px);
  line-height: 1.5;
  text-align: center;
}

.q-author {
  margin-top: 18px;
  font-size: 12px;
  letter-spacing: 2px;
  color: var(--gold);
  text-align: center;
}

.q-contrib {
  margin-top: 10px;
  font-size: 11px;
  text-align: center;
  color: var(--text-dim);
}

.q-about {
  margin-top: 8px;
  font-size: 15px;
  font-style: italic;
  text-align: center;
  color: rgba(255,255,255,0.45);
}

/* â”€â”€â”€ REACTIONS â”€â”€â”€ */
.reactions {
  display: flex;
  gap: 8px;
  margin-top: 18px;
  flex-wrap: wrap;
  justify-content: center;
}

.rxn {
  min-height: 44px;
  padding: 8px 14px;
  border-radius: 22px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  cursor: pointer;
  display: flex;
  gap: 6px;
  align-items: center;
}

/* â”€â”€â”€ NAV â”€â”€â”€ */
.nav-arrows {
  margin-top: 16px;
  display: flex;
  gap: 12px;
}

.nav-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 1px solid var(--card-border);
  background: rgba(255,255,255,0.05);
  color: var(--text);
  font-size: 18px;
}

/* â”€â”€â”€ FOOTER â”€â”€â”€ */
footer {
  text-align: center;
  font-size: 10px;
  padding: 10px 10px calc(10px + var(--safe-bottom));
  color: #444;
  border-top: 1px solid rgba(255,255,255,0.05);
}

/* â”€â”€â”€ SMALL PHONES â”€â”€â”€ */
@media (max-width: 374px) {
  .card { padding: 22px 16px; }
  .q-text { font-size: 20px; }
  .rxn { padding: 8px 10px; }
}

/* â”€â”€â”€ DIRECTORY PANEL (REQUIRED) â”€â”€â”€ */
.dir-panel {
  position: fixed;
  top: 0;
  right: 0;
  width: 380px;
  max-width: 90vw;
  height: 100dvh;
  background: rgba(12,12,18,0.92);
  backdrop-filter: blur(28px);
  border-left: 1px solid var(--card-border);
  box-shadow: -12px 0 48px rgba(0,0,0,0.45);
  z-index: 100;
  display: flex;
  flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.38s cubic-bezier(.4,0,.2,1);
}

.dir-panel.open {
  transform: translateX(0);
}

.dir-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 99;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s;
}

.dir-backdrop.show {
  opacity: 1;
  pointer-events: auto;
}
</style>
</head>

<body class="t-glass">

<div class="dir-backdrop" id="dirBackdrop"></div>

<div class="shell">

<header class="topbar">
  <div class="topbar-left">
    <span class="topbar-title">Quote a Day</span>
    <span class="topbar-counter" id="counter">â€” / â€”</span>
  </div>
  <div style="display:flex;gap:12px;align-items:center;">
    <button class="dir-toggle" id="dirToggle">âŠ Directory</button>
    <div class="theme-strip" id="themeBtns"></div>
  </div>
</header>

<section class="stage">
  <div class="ambient"></div>

  <div class="card-wrap">
    <div class="card" id="card">
      <span class="q-mark">"</span>
      <div class="q-text" id="qText">Loadingâ€¦</div>
      <div class="q-author" id="qAuthor"></div>
      <div class="q-contrib" id="qContrib"></div>
      <div class="q-about" id="qAbout"></div>
    </div>

    <div class="reactions" id="reactions"></div>

    <div class="nav-arrows">
      <button class="nav-btn" id="prevBtn">â†</button>
      <button class="nav-btn" id="nextBtn">â†’</button>
    </div>

    <div class="dot-strip" id="dots"></div>
  </div>
</section>

<footer>Quote a Day Â· Student Contributions Â· All Quotes Interactive</footer>

</div>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QUOTES_URL = "https://raw.githubusercontent.com/AndrewVeda/SRM-VEC-English-PWA/main/QUOTES.md";

const REACTIONS = [
  { key:'heart',  emoji:'â¤ï¸',  label:'Love' },
  { key:'clap',   emoji:'ğŸ‘',  label:'Clap' },
  { key:'fire',   emoji:'ğŸ”¥',  label:'Fire' },
  { key:'wow',    emoji:'ğŸ¤¯',  label:'Mind-blown' },
  { key:'save',   emoji:'ğŸ”–',  label:'Save' },
  { key:'share',  emoji:'âœ¨',  label:'Inspire' }
];

const THEMES = ['minimal','academia','cyber','brutalist','wellness','retro','glass','poster'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let quotes   = [];
let idx      = 0;
let current  = 'glass';
// reactions: { [quoteIndex]: { heart: N, clap: N, â€¦ }, â€¦ }
// userReacted: { [quoteIndex]: Set<key> }
let reactionData = {};
let userReacted  = {};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', async () => {
  buildThemeBtns();
  buildReactionBtns();
  await loadState();        // async now â€” theme + index
  await fetchQuotes();      // also calls hydrateAllReactions() at the end
  render();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FETCH & PARSE QUOTES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchQuotes() {
  try {
    const res  = await fetch(QUOTES_URL);
    const text = await res.text();
    const lines = text.split('\n');

    for (let i = 0; i < lines.length; i++) {
      const l = lines[i].trim();
      if (l.startsWith('> "') && lines[i+1] && lines[i+1].includes('added by')) {
        const quoteLine = l.replace(/^>/, '').trim();
        const metaLine  = lines[i+1].replace(/^>/, '').trim();

        const dashIdx = quoteLine.lastIndexOf('â€”');
        const qPart   = dashIdx > -1 ? quoteLine.slice(0, dashIdx) : quoteLine;
        const aPart   = dashIdx > -1 ? quoteLine.slice(dashIdx + 1) : 'Unknown';

        const [, rest]       = metaLine.split('added by');
        const [contrib, ab]  = (rest || '').split('| about:');

        quotes.push({
          quote:       qPart.replace(/[""]/g, '').trim(),
          author:      aPart.trim() || 'Unknown',
          contributor: (contrib || '').trim() || 'A student',
          about:       (ab || '').trim()
        });
      }
    }

    buildDots();
    buildDirectoryIndex();
    // pull every shared reaction key into memory so the UI is warm on load
    await hydrateAllReactions();

  } catch(e) {
    document.getElementById('qText').textContent = 'Could not load quotes â€” check your connection.';
    console.error(e);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER CURRENT QUOTE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(animate = false) {
  if (!quotes.length) return;
  const q = quotes[idx];

  if (animate) {
    const card = document.getElementById('card');
    card.classList.remove('swap');
    void card.offsetWidth;
    card.classList.add('swap');
  }

  document.getElementById('qText').textContent   = `\u201C${q.quote}\u201D`;
  document.getElementById('qAuthor').textContent  = `â€” ${q.author}`;
  document.getElementById('qContrib').textContent = `ğŸ… Contributed by ${q.contributor}`;
  document.getElementById('qAbout').textContent   = q.about || '';
  document.getElementById('counter').textContent  = `${idx + 1} / ${quotes.length}`;

  updateDots();
  renderReactionCounts();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('click', e => {
  if (e.target.closest('#prevBtn')) go(-1);
  if (e.target.closest('#nextBtn')) go(1);
});

document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft')  go(-1);
  if (e.key === 'ArrowRight') go(1);
});

function go(dir) {
  idx = (idx + dir + quotes.length) % quotes.length;
  render(true);
  saveState();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildDots() {
  const strip = document.getElementById('dots');
  strip.innerHTML = '';
  quotes.forEach((_, i) => {
    const d = document.createElement('div');
    d.className = 'dot' + (i === idx ? ' active' : '');
    d.onclick = () => { idx = i; render(true); saveState(); };
    strip.appendChild(d);
  });
}
function updateDots() {
  document.querySelectorAll('.dot').forEach((d, i) => {
    d.classList.toggle('active', i === idx);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REACTIONS  â€”  shared via window.storage
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* key helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sharedKey(i) { return `qd-rxn:${i}`; }          // shared counters per quote
const   USER_KEY      = 'qd-my-rxns';                     // personal: which ones I've tapped

/* hydrate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Pull every shared reaction blob that already exists into the in-memory cache.
// We list all keys with our prefix, then read them in one tight loop.
async function hydrateAllReactions() {
  try {
    const listing = await window.storage.list('qd-rxn:', true); // shared = true
    if (listing && listing.keys) {
      for (const k of listing.keys) {
        try {
          const row = await window.storage.get(k, true);
          if (row) {
            const i = k.replace('qd-rxn:', '');
            reactionData[i] = JSON.parse(row.value);
          }
        } catch(_) { /* key may have vanished */ }
      }
    }
  } catch(_) { /* storage not yet ready */ }

  // also load the user's own toggle-set (personal, not shared)
  try {
    const me = await window.storage.get(USER_KEY, false);
    if (me) {
      const raw = JSON.parse(me.value);
      userReacted = {};
      Object.entries(raw).forEach(([k, v]) => { userReacted[k] = new Set(v); });
    }
  } catch(_) { /* first visit */ }
}

/* build DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildReactionBtns() {
  const wrap = document.getElementById('reactions');
  REACTIONS.forEach(r => {
    const btn = document.createElement('div');
    btn.className = 'rxn';
    btn.id = 'rxn-' + r.key;
    btn.innerHTML = `<span class="rxn-icon">${r.emoji}</span><span class="rxn-count">0</span>`;
    btn.onclick = () => toggleReaction(r.key);
    wrap.appendChild(btn);
  });
}

/* toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function toggleReaction(key) {
  // â”€â”€ 1. optimistic local update â”€â”€
  if (!reactionData[idx])  reactionData[idx]  = {};
  if (!userReacted[idx])   userReacted[idx]   = new Set();

  const adding = !userReacted[idx].has(key);
  if (adding) {
    userReacted[idx].add(key);
    reactionData[idx][key] = (reactionData[idx][key] || 0) + 1;
  } else {
    userReacted[idx].delete(key);
    reactionData[idx][key] = Math.max(0, (reactionData[idx][key] || 1) - 1);
  }

  // pop animation
  const btn  = document.getElementById('rxn-' + key);
  const icon = btn.querySelector('.rxn-icon');
  icon.classList.remove('pop');
  void icon.offsetWidth;
  icon.classList.add('pop');

  renderReactionCounts();

  // â”€â”€ 2. persist shared counters â”€â”€
  try {
    // re-read so we don't clobber a concurrent writer
    let live = {};
    try {
      const row = await window.storage.get(sharedKey(idx), true);
      if (row) live = JSON.parse(row.value);
    } catch(_) { /* key doesn't exist yet */ }

    // apply our delta on top of the live value
    live[key] = (live[key] || 0) + (adding ? 1 : -1);
    if (live[key] < 0) live[key] = 0;

    await window.storage.set(sharedKey(idx), JSON.stringify(live), true);

    // write back the authoritative numbers so our UI stays in sync
    reactionData[idx] = live;
    renderReactionCounts();
  } catch(e) { console.warn('shared write failed', e); }

  // â”€â”€ 3. persist personal toggle-set â”€â”€
  try {
    const serialised = {};
    Object.entries(userReacted).forEach(([k, s]) => { serialised[k] = [...s]; });
    await window.storage.set(USER_KEY, JSON.stringify(serialised), false);
  } catch(e) { console.warn('personal write failed', e); }
}

/* render counts from cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderReactionCounts() {
  const data = reactionData[idx] || {};
  const user = userReacted[idx]  || new Set();
  REACTIONS.forEach(r => {
    const btn   = document.getElementById('rxn-' + r.key);
    const count = btn.querySelector('.rxn-count');
    count.textContent = data[r.key] || 0;
    btn.classList.toggle('active', user.has(r.key));
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildThemeBtns() {
  const strip = document.getElementById('themeBtns');
  THEMES.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'theme-btn' + (t === current ? ' active' : '');
    btn.dataset.theme = t;
    btn.title = t.charAt(0).toUpperCase() + t.slice(1);
    btn.onclick = () => setTheme(t);
    strip.appendChild(btn);
  });
}

function setTheme(t) {
  document.body.className = 't-' + t;
  current = t;
  document.querySelectorAll('.theme-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.theme === t);
  });
  saveState();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSIST  â€”  personal prefs (theme + index)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PREFS_KEY = 'qd-prefs';

async function saveState() {
  try {
    await window.storage.set(PREFS_KEY, JSON.stringify({ idx, theme: current }), false);
  } catch(_) { /* silent */ }
}

async function loadState() {
  try {
    const row = await window.storage.get(PREFS_KEY, false);
    if (row) {
      const d = JSON.parse(row.value);
      if (d.idx  !== undefined) idx = d.idx;
      if (d.theme)              setTheme(d.theme);
    }
  } catch(_) { /* first visit */ }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DIRECTORY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let dirIndex     = { authors: {}, contributors: {} }; // name â†’ [quoteIdx, â€¦]
let dirTab       = 'authors';   // current tab
let dirExpanded  = null;        // currently expanded row key (or null)

/* â”€â”€ build index once after quotes are loaded â”€â”€ */
function buildDirectoryIndex() {
  dirIndex = { authors: {}, contributors: {} };
  quotes.forEach((q, i) => {
    const a = q.author;
    const c = q.contributor;
    (dirIndex.authors[a]       = dirIndex.authors[a]       || []).push(i);
    (dirIndex.contributors[c]  = dirIndex.contributors[c]  || []).push(i);
  });
}

/* â”€â”€ open / close â”€â”€ */
document.getElementById('dirToggle').addEventListener('click', () => {
  openDir();
});
document.getElementById('dirClose').addEventListener('click', closeDir);
document.getElementById('dirBackdrop').addEventListener('click', closeDir);

function openDir() {
  document.getElementById('dirPanel').classList.add('open');
  document.getElementById('dirBackdrop').classList.add('show');
  renderDirList();                          // refresh list each time it opens
  document.getElementById('dirSearch').value = '';
  document.getElementById('dirSearch').focus();
}
function closeDir() {
  document.getElementById('dirPanel').classList.remove('open');
  document.getElementById('dirBackdrop').classList.remove('show');
  dirExpanded = null;
}

/* â”€â”€ tab switch â”€â”€ */
document.querySelectorAll('.dir-tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.dir-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    dirTab = btn.dataset.tab;
    dirExpanded = null;
    document.getElementById('dirSearch').value = '';
    renderDirList();
  });
});

/* â”€â”€ live search filter â”€â”€ */
document.getElementById('dirSearch').addEventListener('input', () => {
  dirExpanded = null;
  renderDirList();
});

/* â”€â”€ render the list â”€â”€ */
function renderDirList() {
  const container = document.getElementById('dirList');
  container.innerHTML = '';

  const map    = dirIndex[dirTab];
  const query  = document.getElementById('dirSearch').value.trim().toLowerCase();

  // sort names alphabetically
  let names = Object.keys(map).sort((a, b) => a.localeCompare(b));

  // filter
  if (query) {
    names = names.filter(n => n.toLowerCase().includes(query));
  }

  if (!names.length) {
    container.innerHTML = '<div class="dir-empty">No results found</div>';
    return;
  }

  names.forEach(name => {
    const indices = map[name];
    const isOpen  = dirExpanded === (dirTab + ':' + name);
    const initials = name.split(' ').map(w => w[0] || '').join('').slice(0,2).toUpperCase();

    const row = document.createElement('div');
    row.className = 'dir-row' + (isOpen ? ' expanded' : '');

    // â”€â”€ head â”€â”€
    const head = document.createElement('div');
    head.className = 'dir-row-head';
    head.innerHTML = `
      <div class="dir-row-avatar">${initials}</div>
      <div class="dir-row-info">
        <div class="dir-row-name">${escHtml(name)}</div>
        <div class="dir-row-count">${indices.length} quote${indices.length !== 1 ? 's' : ''}</div>
      </div>
      <div class="dir-row-chevron">â€º</div>`;
    head.addEventListener('click', () => {
      const key = dirTab + ':' + name;
      dirExpanded = (dirExpanded === key) ? null : key;
      renderDirList();   // re-render to toggle
    });

    // â”€â”€ quotes list â”€â”€
    const qList = document.createElement('div');
    qList.className = 'dir-row-quotes';

    indices.forEach(qi => {
      const q    = quotes[qi];
      const card = document.createElement('div');
      card.className = 'dir-quote';

      // label depends on which tab we're in
      const metaLabel = dirTab === 'authors'
        ? `contributed by ${q.contributor}`
        : `â€” ${q.author}`;

      card.innerHTML = `
        <div class="dir-quote-text">\u201C${escHtml(q.quote)}\u201D</div>
        <div class="dir-quote-meta">${escHtml(metaLabel)} Â· #${qi + 1}</div>`;

      card.addEventListener('click', (e) => {
        e.stopPropagation();
        idx = qi;
        render(true);
        closeDir();
        saveState();
      });

      qList.appendChild(card);
    });

    row.appendChild(head);
    row.appendChild(qList);
    container.appendChild(row);
  });
}

/* â”€â”€ tiny HTML-escape helper â”€â”€ */
function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SWIPE GESTURE (mobile)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function () {
  let startX = 0, startY = 0, moved = false;
  const THRESHOLD = 40; // px minimum drag to count as a swipe

  const stage = document.querySelector('.stage');

  stage.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    moved  = false;
  }, { passive: true });

  stage.addEventListener('touchmove', e => {
    // if vertical movement dominates, bail out (let page scroll)
    if (!moved && Math.abs(e.touches[0].clientY - startY) > 10) return;
    moved = true;
  }, { passive: true });

  stage.addEventListener('touchend', e => {
    if (!moved) return;                           // was a tap, not a drag
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    if (Math.abs(dx) < Math.abs(dy)) return;     // vertical swipe â€” ignore
    if (Math.abs(dx) < THRESHOLD) return;        // too short â€” ignore
    go(dx < 0 ? 1 : -1);                         // left â†’ next, right â†’ prev
  }, { passive: true });
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO-ADVANCE (30 s)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
setInterval(() => go(1), 30000);
</script>
</body>
</html>
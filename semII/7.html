<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>V for Vote of Thanks! Live long and prosper!üåå</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root {
  --bg-main: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
  --card-bg: #ffffff;

  --accent-main: #ff9800;
  --accent-soft: #ffcc80;

  --blue-main: #2979ff;
  --green-main: #00c853;
  --red-main: #e53935;

  --text-main: #1f2933;
  --text-muted: #6b7280;
}

/* ---------- BASE ---------- */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
  text-align: center;
}

/* ---------- MAIN CONTAINER ---------- */
.container {
  position: relative;
  max-width: 900px;
  margin: 2rem auto;
  background: var(--card-bg);
  padding: 2rem;
  border-radius: 18px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.12);
}

/* ---------- QUIZ HEADER / HUD ---------- */
.quiz-header {
  position: absolute;
  top: 10px;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 1rem;
  font-size: 1rem;
  font-weight: bold;
  color: var(--blue-main);
}

/* ---------- QUESTION ---------- */
.question {
  font-size: 1.6rem;
  font-weight: 700;
  margin-bottom: 1.2rem;
}

/* ---------- OPTIONS ---------- */
.drag-options {
  display: flex;
  flex-wrap: wrap;
  gap: 0.8rem;
  margin-bottom: 2rem;
  justify-content: center;
}

.drag-item {
  padding: 0.7rem 1.2rem;
  background: #f1f5f9;
  border-radius: 14px;
  cursor: pointer;
  user-select: none;
  font-weight: 600;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.drag-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(0,0,0,0.15);
}

.drag-item.selected {
  background: var(--accent-main);
  color: #fff;
}

/* ---------- DROP ZONES ---------- */
.drop-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  align-items: center;
}

.drop-zone {
  width: 100%;
  max-width: 520px;
  min-height: 44px;
  padding: 0.7rem 1rem;
  border-radius: 12px;
  border: 2px dashed var(--blue-main);
  cursor: pointer;
  font-weight: 600;
  background: #f8fafc;
}

.drop-zone.filled {
  border-style: solid;
  background: #e3f2fd;
}

/* ---------- FEEDBACK ---------- */
.correct {
  background-color: #e8f5e9 !important;
  border-color: var(--green-main) !important;
  color: var(--green-main);
  animation: correctPulse 0.6s ease;
}

@keyframes correctPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.wrong {
  background-color: #ffebee !important;
  border-color: var(--red-main) !important;
  color: var(--red-main);
  animation: wrongShake 0.5s ease;
}

@keyframes wrongShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

/* ---------- GEMS ANIMATION ---------- */
@keyframes gemPop {
  0% { transform: scale(1); }
  50% { transform: scale(1.3) rotate(10deg); }
  100% { transform: scale(1) rotate(0deg); }
}

.gem-pop {
  animation: gemPop 0.5s ease;
}

/* ---------- MOTIVATION BOX ---------- */
#motivationBox {
  margin-top: 2rem;
  min-height: 120px;
  padding: 1.5rem;
  font-size: 1.9rem;
  font-weight: 800;
  color: var(--accent-main);
  background: linear-gradient(135deg, #fff3e0, #ffe0b2);
  border-radius: 18px;
  box-shadow: 0 10px 25px rgba(255,152,0,0.35);
}

.hero-quote {
  max-width: 94%;
  margin: 0.6rem auto 1.2rem auto;
  padding: 1rem 1rem;
  background: linear-gradient(135deg, #000000, #1a1a1a);
  border-radius: 10px;
}

.hero-text {
  font-size: 1.2rem;
  font-weight: 700;
  color: #FFD700;
  line-height: 1.3;
}

.hero-author {
  margin-top: 0.3rem;
  font-size: 0.95rem;
  font-weight: 600;
  color: #d4af37;
}

  #nameForm {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  background: linear-gradient(135deg, #ffffff, #f1f5f9);
  padding: 2rem 1.5rem;
  border-radius: 20px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.18);
  max-width: 420px;
  margin: 2rem auto;
}

/* ---------- INPUTS ---------- */
#nameInput,
#departmentSelect {
  width: 100%;
  padding: 0.9rem 1rem;
  background: #ffffff;
  border: 2px solid #cbd5e1;
  border-radius: 12px;
  font-size: 1rem;
  outline: none;
}

#nameInput:focus,
#departmentSelect:focus {
  border-color: var(--blue-main);
  box-shadow: 0 0 0 3px rgba(41,121,255,0.25);
}

/* ---------- BUTTON ---------- */
#nameForm button {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, var(--accent-main), #ffb300);
  color: #000;
  font-size: 1.1rem;
  font-weight: bold;
  border: none;
  border-radius: 14px;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#nameForm button:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(255,152,0,0.45);
}

/* ---------- RESTART BUTTON ---------- */
#restartBtn {
  margin-top: 1.5rem;
  padding: 0.8rem 2.2rem;
  background: linear-gradient(135deg, #2979ff, #00b0ff);
  color: #fff;
  border: none;
  border-radius: 14px;
  font-weight: bold;
  cursor: pointer;
}

/* ---------- RESPONSIVE ---------- */
@media (max-width: 600px) {
  .question { font-size: 1.3rem; }
  .hero-text { font-size: 1.4rem; }
}
/* ---------- SCORE PORTAL (VIEWPORT LOCKED) ---------- */

.score-portal {
  height: calc(100vh - 80px);          /* üöÄ Prevent scrolling */
  max-height: 720px;
  
  display: flex;
  flex-direction: column;
  justify-content: space-evenly;       /* ‚ú® Perfect balance */

  margin-top: 1.2rem;
  padding: 2rem 1.8rem;
  border-radius: 26px;

  background: linear-gradient(135deg, #020617, #0f172a);
  color: #e5e7eb;

  box-shadow: 0 25px 60px rgba(0,0,0,0.55);
  animation: portalEntrance 0.8s ease;
}

@keyframes portalEntrance {
  from {
    opacity: 0;
    transform: translateY(25px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* ---------- TITLE ---------- */

.score-title {
  font-size: 2.3rem;
  font-weight: 900;
  letter-spacing: 2px;
  color: #FFD700;

  margin-bottom: 0.2rem;

  text-shadow:
    0 0 12px rgba(255,215,0,0.4),
    0 0 28px rgba(255,215,0,0.25);
}

.score-player {
  font-size: 1rem;
  color: #94a3b8;

  margin-bottom: 1rem;
}

/* ---------- ACCURACY RING ---------- */

.accuracy-wrapper {
  display: flex;
  justify-content: center;
  margin: 0.5rem 0 0.8rem 0;
}

.accuracy-ring {
  width: clamp(150px, 22vh, 190px);    /* ‚úÖ Responsive scaling */
  height: clamp(150px, 22vh, 190px);

  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;

  box-shadow:
    0 0 35px rgba(0,0,0,0.6),
    inset 0 0 0 6px rgba(0,0,0,0.5);

  animation: ringReveal 0.8s ease;
}

.accuracy-ring::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 50%;

  background: conic-gradient(
    var(--ring-color) calc(var(--progress) * 1%),
    rgba(255,255,255,0.08) 0
  );
}

@keyframes ringReveal {
  from { transform: scale(0.7); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.accuracy-inner {
  width: clamp(115px, 16vh, 145px);
  height: clamp(115px, 16vh, 145px);

  border-radius: 50%;
  background: linear-gradient(135deg, #020617, #0f172a);

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.05);

  z-index: 1;
}

.accuracy-value {
  font-size: 2.2rem;
  font-weight: 900;
  color: var(--ring-color);

  animation: accuracyPulse 1.5s ease-in-out infinite;
}

@keyframes accuracyPulse {
  0%,100% { transform: scale(1); }
  50% { transform: scale(1.06); }
}

.accuracy-label {
  font-size: 0.8rem;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #64748b;
}

/* ---------- STAT CARDS ---------- */

.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);

  gap: 0.9rem;
  margin: 1rem 0;
}

.stat-card {
  backdrop-filter: blur(6px);

  background: linear-gradient(135deg, #0f172a, #020617);
  border-radius: 18px;
  padding: 1.2rem;

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.05),
    0 12px 30px rgba(0,0,0,0.45);

  animation: statFloat 0.6s ease;
}

@keyframes statFloat {
  from { transform: translateY(10px) scale(0.95); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

.stat-value {
  font-size: 2.6rem;
  font-weight: 900;
  margin-bottom: 0.2rem;
}

.stat-label {
  font-size: 0.75rem;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #64748b;
}

/* Glow Colours */

.correct-card .stat-value {
  color: #00e676;
  text-shadow: 0 0 12px rgba(0,230,118,0.35);
}

.wrong-card .stat-value {
  color: #ff5252;
  text-shadow: 0 0 12px rgba(255,82,82,0.35);
}

.gems-card .stat-value {
  color: #FFD700;
  text-shadow: 0 0 16px rgba(255,215,0,0.45);
}

.time-card .stat-value {
  color: #40c4ff;
  text-shadow: 0 0 12px rgba(64,196,255,0.35);
}

/* ---------- PERFORMANCE MESSAGE ---------- */

.performance-message {
  margin-top: 0.5rem;

  font-size: 1.2rem;
  font-weight: 800;
  color: #ffcc80;

  text-shadow: 0 0 10px rgba(255,204,128,0.25);
}

/* ---------- BUTTONS ---------- */

.next-quest-btn {
  margin-top: 0.6rem;

  padding: 0.95rem 2.2rem;
  font-size: 1rem;

  border-radius: 16px;
  border: none;
  cursor: pointer;

  background: linear-gradient(135deg, #ff9800, #ffb300);
  color: #000;
  font-weight: bold;

  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.next-quest-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(255,152,0,0.35);
}

.report-btn {
  margin-top: 0.2rem;

  font-size: 0.95rem;
  background: none;
  border: none;
  color: #94a3b8;
  cursor: pointer;
}

</style>
</head>

<body>
  <div class="container" id="quizContainer">
  <div id="nameForm">

  <div class="hero-quote">
    <div class="hero-text">
      We love trying!
    </div>
    <div class="hero-author"> ü§ó‚ô•Ô∏è‚ú® </div>
  </div>

  <input 
    type="text" 
    id="nameInput" 
    placeholder="Enter your name"
  />

  <select id="departmentSelect">
    <option value="">-- Select Department --</option>
    <option value="Cyber Security">Cyber Security</option>
    <option value="EIE">EIE</option>
    <option value="CSE-1">CSE-1</option>
    <option value="CSE-2">CSE-2</option>
    <option value="CSE-3">CSE-3</option>
    <option value="Mechanical Engineering">Mechanical Engineering</option>
    <option value="ECE-1">ECE-1</option>
    <option value="ECE-2">ECE-2</option>
    <option value="ECE-3">ECE-3</option>
    <option value="AI DS-1">AI DS-1</option>
    <option value="AI DS-2">AI DS-2</option>
    <option value="Agri and Civil">Agri and Civil</option>
    <option value="EEE">EEE</option>
     <option value="Medical Electronics">Medical Electronics</option>
    <option value="IT-1">IT-1</option>
    <option value="IT-2">IT-2</option>
  </select>

  <button onclick="beginQuiz()">Start Quiz</button>
</div>

  <!-- QUIZ SCREEN -->
  <div id="quizContent" style="display:none;">
    <div class="quiz-header">
      <div id="timer">‚è≥ 0s</div>
      <div id="gemsCounter">üíé 0</div>
       <button id="muteBtn" title="Mute / Unmute"
    style="background:none;border:none;font-size:1.2rem;cursor:pointer;">
    üîä
  </button>
      <div id="progressTracker">üìç 1 of 1</div>
    </div>

    <div class="question" id="question"></div>
    <div class="drag-options" id="dragOptions"></div>
    <div class="drop-container" id="dropContainer"></div>

    <div id="scoreCard"></div>
    <button id="restartBtn" style="display:none;">Restart</button>
  </div>

</div>

<!-- MOTIVATION BOX BELOW QUIZ -->
<div id="motivationBox"></div>

<script>
/* ========== CONFETTI FUNCTIONS ========== */
function triggerConfetti() {
  // Main confetti burst from center
  confetti({
    particleCount: 100,
    spread: 70,
    origin: { y: 0.6 }
  });
}

function triggerConfettiSides() {
  // Confetti from both sides
  const duration = 1000;
  const end = Date.now() + duration;

  (function frame() {
    confetti({
      particleCount: 2,
      angle: 60,
      spread: 55,
      origin: { x: 0 },
      colors: ['#ff9800', '#2979ff', '#00c853', '#FFD700']
    });
    confetti({
      particleCount: 2,
      angle: 120,
      spread: 55,
      origin: { x: 1 },
      colors: ['#ff9800', '#2979ff', '#00c853', '#FFD700']
    });

    if (Date.now() < end) {
      requestAnimationFrame(frame);
    }
  }());
}

function triggerMegaConfetti() {
  // Epic confetti for quiz completion
  const duration = 3000;
  const animationEnd = Date.now() + duration;
  const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  const interval = setInterval(function() {
    const timeLeft = animationEnd - Date.now();

    if (timeLeft <= 0) {
      return clearInterval(interval);
    }

    const particleCount = 50 * (timeLeft / duration);
    
    confetti(Object.assign({}, defaults, { 
      particleCount, 
      origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } 
    }));
    confetti(Object.assign({}, defaults, { 
      particleCount, 
      origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } 
    }));
  }, 250);
}

/* ========== AUDIO SETUP ========== */
let isMuted = localStorage.getItem("questMuted") === "true"; 
  const applauseSound = new Audio();
applauseSound.src = 'https://andrewveda.github.io/SRM-VEC-English-PWA/sounds/crowd.mp3';

const wrongSound = new Audio();
wrongSound.src = 'https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3';

applauseSound.volume = 0.4;
wrongSound.volume = 0.3;

applauseSound.load();
wrongSound.load();
  applauseSound.muted = isMuted;
wrongSound.muted = isMuted;
const muteBtn = document.getElementById("muteBtn");
  muteBtn.innerText = isMuted ? "üîá" : "üîä";


muteBtn.onclick = () => {
  isMuted = !isMuted;
localStorage.setItem("questMuted", isMuted);

  applauseSound.muted = isMuted;
  wrongSound.muted = isMuted;

  muteBtn.innerText = isMuted ? "üîá" : "üîä";
}; 
function playApplauseSound() {
  if (isMuted) return;
  try {
    applauseSound.currentTime = 0;
    applauseSound.play().catch(err => console.log('Audio play failed:', err));
  } catch (error) {
    console.log('Audio error:', error);
  }
}

function playWrongSound() {
  if (isMuted) return;
  try {
    wrongSound.currentTime = 0;
    wrongSound.play().catch(err => console.log('Audio play failed:', err));
  } catch (error) {
    console.log('Audio error:', error);
  }
}

/* AUTO-RESTORE NAME + DEPT */
window.addEventListener("load", () => {
  const savedName = localStorage.getItem("questPlayerName");
  const savedDept = localStorage.getItem("questPlayerDept");
  if (savedName) document.getElementById("nameInput").value = savedName;
  if (savedDept) document.getElementById("departmentSelect").value = savedDept;
});

/* MOTIVATION MESSAGES */
const rightMessages = [
  "'name' is unstoppable!",
  "'name' is awesome because 'name' has grit!",
  "'name' has got the right answer because 'name' loves trying!",
  "Nothing can slow 'name' down today!",
  "'name' learns fast because 'name' never gives up!",
  "Who is awesome? 'name'!",
  "'name' proves that effort beats talent every time!",
  "Every correct answer takes 'name' one step closer to greatness!",
  "'name' shines brighter with every question!"
];

const wrongMessages = [
  "'name' loves failures because 'name', like Edison, knows failure is the stepping stone to success.",
  "'name''s favourite quote: 'Ever tried. Ever failed. No matter. Try again. Fail again. Fail better.'",
  "Every mistake makes 'name' stronger.",
  "Mistakes guide 'name' towards victory!",
  "Failure is feedback, and 'name' takes feedback like a champion.",
  "Every wrong attempt brings 'name' closer to the right one.",
  "'name' believes in trying again and again and again!"
];

/* SHOW MOTIVATION */
function showMotivation(isCorrect) {
  const box = document.getElementById("motivationBox");
  const list = isCorrect ? rightMessages : wrongMessages;

  let msg = list[Math.floor(Math.random() * list.length)];
  msg = msg.replace(/'name'/g, playerName);

  box.innerHTML = msg;
  box.style.opacity = 1;
}

  const quizData = [
{
  "questionItems": [
    { "word": "The best way ___ a new language is to immerse yourself in the culture.", "answer": "to learn" },

    { "word": "It's essential ___ regularly for maintaining good health.", "answer": "to exercise" },

    { "word": "The teacher assigned the students the task of ___ a historical event.", "answer": "researching" }
  ],

  "answers": [
    "to learn",
    "to exercise",
    "researching"
  ]
},
    {
  "questionItems": [
    { "word": "He threatened ___ the company if things don‚Äôt improve.", "answer": "to leave" },

    { "word": "He decided ___ the local football club next week.", "answer": "to join" },

    { "word": "I look forward to ___ you at the conference.", "answer": "meeting" }
  ],

  "answers": [
    "to leave",
    "to join",
    "meeting"
  ]
},
{
  "questionItems": [
    { "word": "They avoided ___ about the sensitive topic.", "answer": "talking" },

    { "word": "We promised ___ them with the project.", "answer": "to help" },

    { "word": "She admitted ___ a mistake in the report.", "answer": "making" }
  ],

  "answers": [
    "talking",
    "to help",
    "making"
  ]
},
{
  "questionItems": [
    { "word": "He refused ___ for his behavior.", "answer": "to apologize" },

    { "word": "I can‚Äôt stand ___ in long queues.", "answer": "waiting" },

    { "word": "She hopes ___ selected for the scholarship.", "answer": "to be" }
  ],

  "answers": [
    "to apologize",
    "waiting",
    "to be"
  ]
},
{
  "questionItems": [
    { "word": "We discussed ___ a charity event for the school.", "answer": "organizing" },

    { "word": "He is good at ___ difficult puzzles.", "answer": "solving" },

    { "word": "She apologized for ___ late.", "answer": "arriving" }
  ],

  "answers": [
    "organizing",
    "solving",
    "arriving"
  ]
},

{
  "questionItems": [
    { "word": "She wants ___ a doctor.", "answer": "to become" },
    { "word": "I forgot ___ my homework yesterday.", "answer": "to submit" },
    { "word": "He promised ___ me with the project.", "answer": "to help" },
       { "word": "They plan ___ early to avoid the traffic.", "answer": "to leave" }
 
    ],

  "answers": [
    "to become",
    "to submit",
    "to help",
    "to leave"
  ]
},
{
  "questionItems": [
    { "word": "They decided ___ abroad for higher studies.", "answer": "to go" },

    { "word": "She was eager ___ in front of the audience with confidence.", "answer": "to speak" },

    { "word": "She asked me ___ her with the assignment.", "answer": "to assist" }
  ],

  "answers": [
    "to go",
    "to speak",
    "to assist"
  ]
},
{
  "questionItems": [
    
    { "word": "I need ___ a new laptop for my work.", "answer": "to buy" },

    { "word": "He refused ___ the offer.", "answer": "to accept" },

    { "word": "We plan ___ a trip next month.", "answer": "to take" }
    ],

  "answers": [
    "to buy",
    "to accept",
    "to take"
  ]
},
{
  "questionItems": [
    
    { "word": "She learned ___ Spanish in just six months.", "answer": "to speak" },

    { "word": "The manager advised the employees ___ their best efforts.", "answer": "to give" },

    { "word": "The first step is ___ the instructions carefully.", "answer": "to read" },
    { "word": "The teacher asked him ___ a valid reason for his absence.", "answer": "to give" }

 
  ],

  "answers": [
    "to speak",
    "to give",
    "to read",
    "to give"]
},
{
  "questionItems": [
    
    { "word": "I can't wait ___ my favorite band in concert.", "answer": "to see" },

    { "word": "The goal is ___ a positive impact on the community.", "answer": "to make" },

    { "word": "To ___ a successful business, you need a solid plan.", "answer": "run" }
  ],

  "answers": [
    "to see",
    "to make",
    "run"
  ]
}


];

let current = 0;
let wrongQuestions = [];
let correctCount = 0;
let totalWrongGuesses = 0;
let gemsCount = 0;
let startTime;
let timerInterval;
let playerName = "";
let playerDept = "";
let selectedOption = null;

const questionEl = document.getElementById("question");
const dragOptionsEl = document.getElementById("dragOptions");
const dropContainerEl = document.getElementById("dropContainer");
const timerEl = document.getElementById("timer");
const gemsCounterEl = document.getElementById("gemsCounter");
const progressTracker = document.getElementById("progressTracker");
const scoreCard = document.getElementById("scoreCard");
const restartBtn = document.getElementById("restartBtn");
const NEXT_QUEST_URL = "https://andrewveda.github.io/SRM-VEC-English-PWA/semII/8";
function goToNextQuest() {
  window.location.href = NEXT_QUEST_URL;
}


/* START QUIZ */
function beginQuiz() {
  const nameField = document.getElementById("nameInput");
  const deptField = document.getElementById("departmentSelect");

  if (!nameField.value.trim()) { alert("Please enter your name!"); return; }
  if (!deptField.value) { alert("Please select your department!"); return; }

  playerName = nameField.value.trim();
  playerDept = deptField.value;

  localStorage.setItem("questPlayerName", playerName);
  localStorage.setItem("questPlayerDept", playerDept);

  document.getElementById("nameForm").style.display = "none";
  document.getElementById("quizContent").style.display = "block";

  startQuiz();
}

function startQuiz() {
  current = 0;
  correctCount = 0;
  totalWrongGuesses = 0;
  gemsCount = 0;
  startTime = Date.now();

  gemsCounterEl.innerText = "üíé 0";
  scoreCard.innerHTML = "";
  restartBtn.style.display = "none";
  loadQuestion();
  startTimer();
}

function loadQuestion() {
  if (current >= quizData.length) return showScore();

  selectedOption = null;
  const data = quizData[current];
  progressTracker.innerText = `üìç ${current + 1} of ${quizData.length}`;

  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";

  const shuffled = [...data.answers].sort(() => Math.random() - 0.5);

  shuffled.forEach((ans) => {
    const div = document.createElement("div");
    div.classList.add("drag-item");
    div.innerText = ans;
    div.onclick = () => selectOption(div);
    dragOptionsEl.appendChild(div);
  });

  data.questionItems.forEach((item) => {
    const drop = document.createElement("div");
    drop.classList.add("drop-zone");
    drop.innerText = item.word;
    drop.dataset.answer = item.answer;
    drop.onclick = () => placeOption(drop);
    dropContainerEl.appendChild(drop);
  });
}

function selectOption(div) {
  if (selectedOption) selectedOption.classList.remove("selected");
  selectedOption = div;
  div.classList.add("selected");
}

function placeOption(dropZone) {
  if (!selectedOption) return;

  const answer = selectedOption.innerText;
  const correctAnswer = dropZone.dataset.answer;

  if (answer === correctAnswer) {
    // üéâ CORRECT ANSWER - TRIGGER CONFETTI!
    triggerConfetti();
    playApplauseSound();
    
    correctCount++;
    gemsCount++;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    gemsCounterEl.classList.add('gem-pop');
    setTimeout(() => gemsCounterEl.classList.remove('gem-pop'), 500);
    
    showMotivation(true);

    dropZone.innerHTML = dropZone.innerText.replace("___", `<strong>${answer}</strong>`);
    dropZone.classList.add("correct", "filled");
    selectedOption.style.display = "none";

  } else {
    // ‚ùå WRONG ANSWER
    playWrongSound();
    
    totalWrongGuesses++;
    gemsCount--;
    gemsCounterEl.innerText = `üíé ${gemsCount}`;
    showMotivation(false);

    dropZone.classList.add("wrong");
    setTimeout(() => dropZone.classList.remove("wrong"), 600);

    const currentQ = quizData[current];
    if (!wrongQuestions.includes(currentQ)) wrongQuestions.push(currentQ);
  }

  selectedOption.classList.remove("selected");
  selectedOption = null;

  if (document.querySelectorAll(".drop-zone:not(.filled)").length === 0) {
    setTimeout(() => {
      current++;
      if (current >= quizData.length && wrongQuestions.length > 0) {
        quizData.push(...wrongQuestions);
        wrongQuestions = [];
      }
      loadQuestion();
    }, 800);
  }
}

/* TIMER */
function startTimer() {
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    timerEl.innerText = `‚è≥ ${elapsed}s`;
  }, 1000);
}
function calculateAccuracy() {
  const totalAttempts = correctCount + totalWrongGuesses;

  if (totalAttempts === 0) return 0;

  return Math.round((correctCount / totalAttempts) * 100);
}
  function getAccuracyColor(acc) {
  if (acc >= 85) return "#00e676";   // Elite
  if (acc >= 60) return "#ffcc00";   // Good
  return "#ff5252";                  // Needs work
}
 function animateAccuracy(finalAccuracy) {

  const ring = document.querySelector(".accuracy-ring");
  const valueEl = document.getElementById("accuracyValue");

  if (!ring || !valueEl) {
    console.log("Accuracy ring not found ‚Äî skipping animation.");
    return;
  }

  ring.style.setProperty("--ring-color", getAccuracyColor(finalAccuracy));

  let current = 0;

  const animation = setInterval(() => {
    if (current >= finalAccuracy) {
      clearInterval(animation);
      return;
    }

    current++;

    ring.style.setProperty("--progress", current);
    valueEl.innerText = `${current}%`;

  }, 15);
}
function generatePerformanceMessage() {
  const accuracy = calculateAccuracy();

  if (accuracy >= 90) return "üåü Outstanding performance!";
  if (accuracy >= 75) return "üî• Strong work! Keep pushing!";
  if (accuracy >= 50) return "üí™ Good progress ‚Äî mastery is close!";
  return "üöÄ Every expert was once a beginner. Keep going!";
}



const EDGE_FUNCTION_URL =
  "https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/logQuest";

function showScore() {
  clearInterval(timerInterval);
  const totalTime = Math.floor((Date.now() - startTime) / 1000);

  // üéä MEGA CONFETTI FOR COMPLETION!
  triggerMegaConfetti();

  questionEl.innerText = "üéâ Quiz Completed!";
  dragOptionsEl.innerHTML = "";
  dropContainerEl.innerHTML = "";
  progressTracker.innerText = "";
const accuracy = calculateAccuracy();

scoreCard.innerHTML = `
<div class="score-portal">

  <div class="score-player">üë§ ${playerName} | üè¢ ${playerDept}</div>

  <div class="accuracy-wrapper">
    <div class="accuracy-ring" style="--progress:0; --ring-color:#00e676;">
      <div class="accuracy-inner">
        <div class="accuracy-value" id="accuracyValue">0%</div>
        <div class="accuracy-label">Accuracy</div>
      </div>
    </div>
  </div>


  <div class="performance-message">
    ${generatePerformanceMessage()}
  </div>

  <button class="next-quest-btn" onclick="goToNextQuest()">
    üöÄ Continue to Next Quest
  </button>

  <button onclick="downloadPDFReport()" class="report-btn">
    üì• Download Performance Report
  </button>

</div>`;
setTimeout(() => animateAccuracy(accuracy), 50);
  
  restartBtn.style.display = "inline-block";

  sendViaEdgeFunction({
    student_name: playerName,
    department: playerDept,
    correct: correctCount,
    wrong: totalWrongGuesses,
    time_spent: totalTime,
    quest_id: "Quest 177"
  });
}

async function sendViaEdgeFunction(payload) {
  try {
    const response = await fetch(EDGE_FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      console.error("‚ùå Edge Function Error:", await response.text());
      return;
    }
    console.log("‚úÖ Saved to Supabase");
  } catch (err) {
    console.error("‚ö†Ô∏è Edge Function Error:", err);
  }
}

function downloadPDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const totalTime = Math.floor((Date.now() - startTime) / 1000);
  const reportDate = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

  // --- HEADER ---
  doc.setFillColor(25, 25, 60);
  doc.rect(0, 0, 210, 45, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFont('times', 'bold');
  doc.setFontSize(18);
  doc.text('SRM VALLIAMMAI ENGINEERING COLLEGE', 105, 16, { align: 'center' });
  doc.setFontSize(12);
  doc.setFont('times', 'italic');
  doc.text('(Autonomous)', 105, 23, { align: 'center' });
  doc.setFontSize(15);
  doc.setFont('times', 'normal');
  doc.text('Department of English', 105, 31, { align: 'center' });
  doc.setFontSize(14);
  doc.setFont('times', 'bold');
  doc.setTextColor(212, 175, 55);
  doc.text('Quest Performance Report', 105, 39, { align: 'center' });

  // --- STUDENT INFO ---
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(11);
  doc.text('CANDIDATE INFORMATION', 20, 55);
  doc.autoTable({
    startY: 58,
    body: [
      ['Student Name', playerName],
      ['Department', playerDept],
      ['Quest ID', 'Quest 130'],
      ['Completed On', reportDate]
    ],
    theme: 'plain',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    columnStyles: {
      0: { fontStyle: 'bold', cellWidth: 60, textColor: [70, 70, 70] },
      1: { cellWidth: 120 }
    },
    margin: { left: 20, right: 20 }
  });

  // --- PERFORMANCE SUMMARY ---
  let y = doc.lastAutoTable.finalY + 10;
  doc.setFont('times', 'bold');
  doc.text('PERFORMANCE SUMMARY', 20, y);
  y += 4;
  doc.autoTable({
    startY: y + 3,
    body: [
      ['Total Questions', quizData.length.toString()],
      ['Correct Answers', correctCount.toString()],
      ['Wrong Attempts', totalWrongGuesses.toString()],
      ['Final Gems Earned', gemsCount.toString()],
      ['Total Time', `${Math.floor(totalTime / 60)}m ${totalTime % 60}s`]
    ],
    theme: 'grid',
    styles: { fontSize: 10, font: 'times', cellPadding: 3 },
    margin: { left: 20, right: 20 }
  });

  // --- QUESTION BANK SECTION ---
  y = doc.lastAutoTable.finalY + 12;
  if (y > 250) { doc.addPage(); y = 20; }
  doc.setFont('times', 'bold');
  doc.text('QUESTION BANK WITH CORRECT ANSWERS', 20, y);
  y += 6;

  quizData.forEach((item, i) => {
    if (y > 260) { doc.addPage(); y = 20; }
    doc.setFontSize(11);
    doc.setFont('times', 'bold');
    doc.setTextColor(25, 25, 60);
    doc.text(`Question ${i + 1}:`, 20, y);
    y += 6;
    doc.setTextColor(0, 0, 0);
    doc.setFont('times', 'normal');
    item.questionItems.forEach((qItem, j) => {
      const questionText = `${j + 1}. ${qItem.word.replace('___', '____')} `;
      const answerText = `Answer: ${qItem.answer}`;
      const lines = doc.splitTextToSize(questionText, 160);
      doc.text(lines, 25, y);
      y += lines.length * 5;
      doc.setTextColor(0, 128, 0);
      doc.text(answerText, 30, y);
      doc.setTextColor(0, 0, 0);
      y += 7;
    });
    y += 3;
    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.3);
    doc.line(20, y, 190, y);
    y += 5;
  });

  // --- FOOTER ---
  doc.setDrawColor(184, 134, 11);
  doc.setLineWidth(0.5);
  doc.line(20, 280, 190, 280);
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.setFont('times', 'italic');
  doc.text('This is a system-generated report', 105, 287, { align: 'center' });

  const cleanName = playerName.replace(/[^a-zA-Z0-9]/g, '_');
  doc.save(`${cleanName}_Quest130_Report.pdf`);
}

restartBtn.onclick = () => {
  document.getElementById("quizContent").style.display = "none";
  document.getElementById("nameForm").style.display = "block";
  document.getElementById("nameInput").value = "";
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Linguathon ‚Äî Sentence Quest</title>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Exo+2:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0b0f1a; --surface:#111827; --surface2:#1a2235;
      --border:rgba(99,179,237,0.18); --accent:#63b3ed; --accent2:#f6ad55;
      --accent3:#68d391; --danger:#fc8181; --gold:#ffd700; --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Exo 2',sans-serif;background:var(--bg);min-height:100vh;display:flex;flex-direction:column;align-items:center;color:white;overflow-x:hidden;}
    body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(99,179,237,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(99,179,237,0.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
    body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(99,179,237,0.08) 0%,transparent 70%);pointer-events:none;z-index:0;}

    /* HEADER ‚Äî progress + q count only */
    #header-bar{width:100%;max-width:520px;background:var(--surface);border-bottom:2px solid var(--border);padding:8px 14px;display:flex;align-items:center;gap:10px;z-index:100;position:sticky;top:0;}
    #header-bar.hidden{display:none;}
    #q-progress-bar{flex:1;height:6px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden;}
    #q-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:6px;transition:width 0.5s ease;}
    #q-label{font-family:'Russo One',sans-serif;font-size:0.8rem;color:rgba(255,255,255,0.4);white-space:nowrap;}

    #game-wrapper{width:100%;max-width:520px;padding:14px 12px 40px;position:relative;z-index:1;display:flex;flex-direction:column;gap:12px;}

    /* LOADER */
    #loading-screen{text-align:center;padding:60px 20px;display:block;}
    .loader-ring{width:56px;height:56px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.9s linear infinite;margin:0 auto 18px;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .loader-text{font-family:'Russo One',sans-serif;font-size:0.95rem;color:var(--accent);letter-spacing:2px;}

    /* LOBBY */
    #lobby-screen{display:none;flex-direction:column;gap:14px;}
    .lobby-title{font-family:'Russo One',sans-serif;font-size:2rem;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:2px;text-align:center;padding-top:24px;}
    .lobby-sub{color:rgba(255,255,255,0.45);font-size:0.85rem;text-align:center;margin-top:4px;}
    .creator-credit{text-align:center;font-size:0.73rem;color:rgba(255,255,255,0.4);line-height:1.9;}
    .creator-credit strong{color:var(--accent2);}
    .name-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;}
    .name-card label{display:block;font-size:0.73rem;font-weight:700;letter-spacing:1.5px;color:var(--accent);text-transform:uppercase;margin-bottom:6px;}
    .name-card select,.name-card input{width:100%;padding:11px 14px;font-size:0.95rem;font-family:'Exo 2',sans-serif;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:white;outline:none;transition:border 0.2s;margin-bottom:12px;}
    .name-card select option{background:var(--surface);}
    .name-card input::placeholder{color:rgba(255,255,255,0.3);}
    .name-card select:focus,.name-card input:focus{border-color:var(--accent);}
    #start-lobby-btn{padding:15px;font-family:'Russo One',sans-serif;font-size:1.1rem;letter-spacing:2px;border:none;border-radius:var(--radius);background:linear-gradient(135deg,var(--accent),#4299e1);color:var(--bg);cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 4px 24px rgba(99,179,237,0.35);}
    #start-lobby-btn:hover{transform:translateY(-2px);}

    /* GAME BOARD */
    #game-board{display:none;flex-direction:column;gap:10px;}

    /* TOPIC PILL ‚Äî small, subtle */
    #topic-pill{display:flex;align-items:center;gap:8px;padding:6px 12px;background:rgba(246,173,85,0.08);border:1px solid rgba(246,173,85,0.2);border-radius:20px;align-self:flex-start;font-size:0.78rem;font-weight:700;letter-spacing:1px;color:var(--accent2);text-transform:uppercase;}

    /* SENTENCE LIST */
    #sentence-list{display:flex;flex-direction:column;gap:8px;}

    .sent-card{
      display:flex;align-items:center;gap:10px;
      border-radius:12px;
      border:2px solid rgba(255,255,255,0.07);
      background:var(--surface2);
      padding:13px 14px;
      cursor:pointer;
      -webkit-user-select:none;user-select:none;
      transition:border-color 0.2s, background 0.2s, transform 0.12s, box-shadow 0.15s, opacity 0.2s;
    }

    /* Inactive ‚Äî not yet tapped */
    .sent-card.inactive{opacity:0.38;filter:grayscale(0.3);}
    .sent-card.active{opacity:1;filter:none;}

    /* Tap-selected (first tap) */
    .sent-card.selected{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(99,179,237,0.22);
      transform:scale(1.018);
    }

    /* After interaction ‚Äî position correct */
    .sent-card.pos-correct{
      border-color:var(--accent3);
      background:rgba(104,211,145,0.09);
    }
    /* After interaction ‚Äî position wrong */
    .sent-card.pos-wrong{
      border-color:var(--danger);
      background:rgba(252,129,129,0.07);
    }

    /* Swap flash animation */
    @keyframes swapFlash{0%,100%{transform:scale(1);}50%{transform:scale(1.04);}}
    .swap-flash{animation:swapFlash 0.25s ease;}

    /* Position number dot */
    .pos-dot{
      min-width:26px;height:26px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-family:'Russo One',sans-serif;font-size:0.72rem;flex-shrink:0;
      background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3);
      transition:background 0.2s,color 0.2s;
    }
    .pos-dot.c{background:rgba(104,211,145,0.22);color:var(--accent3);}
    .pos-dot.w{background:rgba(252,129,129,0.2);color:var(--danger);}

    .sent-text{flex:1;font-size:0.9rem;font-weight:600;line-height:1.5;color:white;}

    /* ‚úÖ / ‚ùå badge */
    .pos-badge{font-size:1rem;flex-shrink:0;min-width:20px;text-align:center;}

    /* FEEDBACK */
    #feedback-msg{font-family:'Russo One',sans-serif;font-size:0.9rem;min-height:24px;text-align:center;letter-spacing:0.5px;}
    .correct-msg{color:var(--accent3);} .wrong-msg{color:var(--danger);} .info-msg{color:var(--accent2);}

    /* BUTTONS */
    #submit-btn{padding:14px;font-family:'Russo One',sans-serif;font-size:1.05rem;letter-spacing:1.5px;border:none;border-radius:var(--radius);background:linear-gradient(135deg,var(--accent),#4299e1);color:var(--bg);cursor:pointer;transition:transform 0.2s;box-shadow:0 4px 20px rgba(99,179,237,0.35);}
    #submit-btn:hover{transform:translateY(-2px);}
    #next-btn{display:none;padding:14px;font-family:'Russo One',sans-serif;font-size:1.05rem;letter-spacing:1.5px;border:none;border-radius:var(--radius);background:linear-gradient(135deg,var(--accent3),#38a169);color:var(--bg);cursor:pointer;box-shadow:0 4px 20px rgba(104,211,145,0.3);}

    .action-row{display:flex;gap:8px;}
    .action-btn{flex:1;padding:11px 6px;border-radius:10px;border:none;font-family:'Russo One',sans-serif;font-size:0.79rem;cursor:pointer;transition:transform 0.15s;}
    .action-btn:hover{transform:translateY(-2px);}
    .btn-reset{background:rgba(252,129,129,0.12);color:var(--danger);border:1px solid rgba(252,129,129,0.3);}
    .btn-hint{background:rgba(246,173,85,0.1);color:var(--accent2);border:1px solid rgba(246,173,85,0.25);}
    .btn-mute{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.1);}

    /* EXPLANATION */
    #explanation-panel{display:none;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:13px;}
    .exp-header{font-family:'Russo One',sans-serif;font-size:0.78rem;letter-spacing:1px;color:var(--accent2);text-transform:uppercase;margin-bottom:10px;}
    .exp-row{display:flex;gap:9px;margin-bottom:8px;padding:10px;border-radius:10px;background:var(--surface2);border-left:3px solid var(--border);cursor:pointer;}
    .exp-row.c{border-left-color:var(--accent3);} .exp-row.w{border-left-color:var(--danger);}
    .exp-pos{font-family:'Russo One',sans-serif;font-size:0.7rem;min-width:20px;padding-top:2px;color:rgba(255,255,255,0.32);}
    .exp-sent{font-size:0.81rem;font-weight:600;line-height:1.45;margin-bottom:3px;}
    .exp-sent.c{color:var(--accent3);} .exp-sent.w{color:var(--danger);}
    .exp-why{font-size:0.75rem;color:rgba(255,255,255,0.5);line-height:1.5;display:none;padding-top:4px;border-top:1px solid rgba(255,255,255,0.06);margin-top:4px;}
    .exp-why.open{display:block;}
    .exp-toggle{font-size:0.67rem;color:var(--accent);letter-spacing:1px;font-weight:700;margin-top:3px;display:block;}

    /* SCORE */
    #score-screen{display:none;flex-direction:column;gap:13px;}
    .score-hero{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:26px 18px;text-align:center;}
    .score-trophy{font-size:3.2rem;margin-bottom:6px;}
    .score-title{font-family:'Russo One',sans-serif;font-size:1.5rem;background:linear-gradient(135deg,var(--gold),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .score-name{margin-top:4px;font-size:0.88rem;color:rgba(255,255,255,0.4);}
    .score-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
    .score-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:center;}
    .score-block .val{font-family:'Russo One',sans-serif;font-size:1.8rem;}
    .score-block .lbl{font-size:0.67rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-top:3px;}
    .score-block.gold .val{color:var(--gold);} .score-block.blue .val{color:var(--accent);} .score-block.green .val{color:var(--accent3);} .score-block.orange .val{color:var(--accent2);}
    .score-bar-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;}
    .score-bar-label{display:flex;justify-content:space-between;font-size:0.75rem;font-weight:700;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
    .score-bar-track{height:9px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden;}
    .score-bar-fill{height:100%;border-radius:10px;transition:width 1s ease;background:linear-gradient(90deg,var(--accent3),#68d391);}
    #back-lobby-btn{padding:14px;font-family:'Russo One',sans-serif;font-size:1rem;letter-spacing:2px;border:1px solid var(--border);border-radius:var(--radius);background:transparent;color:rgba(255,255,255,0.5);cursor:pointer;}

    /* PARTICLES */
    #word-correct-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:800;pointer-events:none;opacity:0;transition:opacity 0.25s;}
    #word-correct-overlay.show{opacity:1;}
    .big-correct-text{font-family:'Russo One',sans-serif;font-size:3rem;color:var(--gold);text-shadow:0 0 30px rgba(255,215,0,0.8);animation:popIn 0.45s cubic-bezier(0.175,0.885,0.32,1.275);letter-spacing:4px;}
    @keyframes popIn{0%{transform:scale(0.3);opacity:0;}70%{transform:scale(1.12);}100%{transform:scale(1);opacity:1;}}
    .flying-gem{position:fixed;font-family:'Russo One',sans-serif;font-size:1.1rem;pointer-events:none;z-index:999;animation:flyGem 0.85s ease-out forwards;}
    .flying-gem.plus{color:var(--accent);} .flying-gem.minus{color:var(--danger);}
    @keyframes flyGem{0%{opacity:1;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-65px) scale(1.2);}}
    .spark{position:fixed;width:6px;height:6px;border-radius:50%;pointer-events:none;z-index:900;animation:sparkFly 0.75s ease-out forwards;}
    @keyframes sparkFly{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0);}}
    .confetti-piece{position:fixed;width:8px;height:8px;pointer-events:none;z-index:901;animation:confettiFall 1.3s ease-out forwards;}
    @keyframes confettiFall{0%{opacity:1;transform:translateY(0) rotate(0deg);}100%{opacity:0;transform:translateY(260px) rotate(540deg);}}
    .gem-pulse{animation:gemPulse 0.35s ease;}
    @keyframes gemPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.3);filter:brightness(1.6);}}
    #time-bonus-flash{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:rgba(104,211,145,0.15);border:1px solid var(--accent3);border-radius:20px;padding:6px 20px;font-family:'Russo One',sans-serif;font-size:0.95rem;color:var(--accent3);pointer-events:none;z-index:800;opacity:0;transition:opacity 0.2s;}
    #time-bonus-flash.show{opacity:1;}
  </style>
</head>
<body>

<div id="word-correct-overlay"><div class="big-correct-text">‚ö° CORRECT!</div></div>
<div id="time-bonus-flash">‚ö° SPEED BONUS!</div>

<!-- minimal header: just progress bar + Q counter -->
<div id="header-bar" class="hidden">
  <div id="q-progress-bar"><div id="q-progress-fill" style="width:0%"></div></div>
  <div id="q-label"><span id="q-current">1</span>/<span id="q-total">?</span></div>
</div>

<div id="game-wrapper">
  <div id="loading-screen"><div class="loader-ring"></div><div class="loader-text">LOADING...</div></div>

  <!-- LOBBY -->
  <div id="lobby-screen">
    <div class="lobby-title">‚ö° Linguathon</div>
    <div class="lobby-sub">Sentence Rearrangement Quest ¬∑ Mystic Summit</div>
    <div class="creator-credit">
      Student Development Team:<br>
      <strong>Monesh ‚Äì Cyber Security</strong> &nbsp;|&nbsp; <strong>Sruthi ‚Äì ECE 3</strong> &nbsp;|&nbsp; <strong>Subiksha ‚Äì ECE 3</strong><br>
      <strong>Pooja ‚Äì CSE 2</strong> &nbsp;|&nbsp; <strong>Mohana Priya ‚Äì CSE 2</strong> &nbsp;|&nbsp; <strong>Valan Ezhilan ‚Äì EIE</strong>
    </div>
    <div class="name-card">
      <label>Department</label>
      <select id="dept-select">
        <option value="">-- Select Department --</option>
        <option>Cyber Security</option><option>CSE-1</option><option>CSE-2</option>
        <option>CSE-3</option><option>Mechanical Engineering</option><option>ECE-1</option>
        <option>ECE-2</option><option>ECE-3</option><option>AI DS-1</option>
        <option>AI DS-2</option><option>Civil</option><option>Agri</option>
        <option>EEE</option><option>EIE</option><option>Medical Electronics</option>
        <option>IT-1</option><option>IT-2</option>
      </select>
      <label>Your Name</label>
      <input type="text" id="name-input" placeholder="Enter your full name" style="margin-bottom:0"/>
    </div>
    <button id="start-lobby-btn">üöÄ START QUEST</button>
  </div>

  <!-- GAME BOARD -->
  <div id="game-board">
    <div id="topic-pill">
      <span id="topic-icon">üìù</span>
      <span id="topic-name">‚Äî</span>
    </div>

    <div id="sentence-list"></div>

    <div id="feedback-msg"></div>

    <button id="submit-btn">‚úÖ SUBMIT ORDER</button>
    <button id="next-btn">NEXT ‚Üí</button>

    <div id="explanation-panel">
      <div class="exp-header">üìñ Explanation</div>
      <div id="exp-body"></div>
    </div>

    <div class="action-row">
      <button class="action-btn btn-reset" id="reset-btn">üîÑ RESET</button>
      <button class="action-btn btn-hint"  id="hint-btn">üí° HINT <span style="font-size:0.67rem;opacity:0.7">(-1üíé)</span></button>
      <button class="action-btn btn-mute"  id="mute-btn">üîä SFX</button>
    </div>
  </div>

  <!-- SCORE -->
  <div id="score-screen">
    <div class="score-hero">
      <div class="score-trophy" id="score-trophy">üèÜ</div>
      <div class="score-title">QUEST COMPLETE!</div>
      <div class="score-name" id="score-name-lbl"></div>
    </div>
    <div class="score-grid">
      <div class="score-block gold"><div class="val" id="sc-gems">0</div><div class="lbl">Total Gems</div></div>
      <div class="score-block green"><div class="val" id="sc-correct">0</div><div class="lbl">Correct</div></div>
      <div class="score-block blue"><div class="val" id="sc-streak">0</div><div class="lbl">Best Streak</div></div>
      <div class="score-block orange"><div class="val" id="sc-time">0s</div><div class="lbl">Total Time</div></div>
    </div>
    <div class="score-bar-wrap">
      <div class="score-bar-label"><span>Accuracy</span><span id="sc-acc-pct">0%</span></div>
      <div class="score-bar-track"><div class="score-bar-fill" id="sc-acc-bar" style="width:0%"></div></div>
    </div>
    <button id="back-lobby-btn">‚Ü© PLAY AGAIN</button>
  </div>
</div>

<script>
/* ‚ïê‚ïê SUPABASE ‚ïê‚ïê */
const SUPABASE_URL="https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/logQuest";

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   QUEST DATA
   correctOrder[i] = index into sentences[] that belongs at position i
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const QUEST={
  id:"sentence-rearrange-01", title:"Paragraph Order Quest",
  questions:[
    /* ‚îÄ‚îÄ Q1 Solar Energy ‚îÄ‚îÄ */
    {topic:"Solar Energy",icon:"‚òÄÔ∏è",
     sentences:[
       "Solar energy is increasingly being adopted as an alternative source of power.",
       "Solar power is clean and does not cause pollution.",
       "It can be used to generate electricity as well as heat water.",
       "Over time, the cost of installation has also decreased significantly.",
       "Many households are now installing solar panels on their rooftops.",
       "In addition, governments are offering subsidies to encourage its use.",
       "This helps reduce dependence on non-renewable energy resources.",
       "As a result, solar energy is becoming a practical solution for sustainable living."
     ],
     correctOrder:[0,1,2,3,4,5,6,7],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Opening / Topic Sentence ‚Äî introduces the main idea broadly. All other sentences explain why adoption is happening."},
       {pos:"2Ô∏è‚É£",why:"Key Advantage ‚Äî the primary reason for adoption is clean energy. Flow: Adoption ‚Üí Reason."},
       {pos:"3Ô∏è‚É£",why:"Practical Uses ‚Äî moves from environmental benefit to utility. Flow: Benefit ‚Üí Utility."},
       {pos:"4Ô∏è‚É£",why:"Economic Justification ‚Äî affordability follows after explaining utility. Flow: Benefits ‚Üí Cost ‚Üì."},
       {pos:"5Ô∏è‚É£",why:"Observable Outcome ‚Äî falling costs lead to real-world household adoption. Flow: Cost ‚Üì ‚Üí Adoption ‚Üë."},
       {pos:"6Ô∏è‚É£",why:"Policy Support ‚Äî 'In addition' layers government subsidies on top of household adoption."},
       {pos:"7Ô∏è‚É£",why:"Broader Impact ‚Äî 'This' refers to adoption + subsidies combined. Flow: Adoption + Support ‚Üí Energy impact."},
       {pos:"8Ô∏è‚É£",why:"Conclusion ‚Äî 'As a result' synthesises every prior point into a final judgement about sustainability."}
     ]
    },
    /* ‚îÄ‚îÄ Q2 PLACEHOLDER ‚îÄ‚îÄ */
    {topic:"Placeholder Topic 2",icon:"üìù",
     sentences:["Sentence A ‚Äî replace this.","Sentence B ‚Äî replace this.","Sentence C ‚Äî replace this.","Sentence D ‚Äî replace this."],
     correctOrder:[0,1,2,3],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Why this sentence comes first."},
       {pos:"2Ô∏è‚É£",why:"Why this sentence comes second."},
       {pos:"3Ô∏è‚É£",why:"Why this sentence comes third."},
       {pos:"4Ô∏è‚É£",why:"Why this sentence comes fourth."}
     ]
    },
    /* ‚îÄ‚îÄ Q3 PLACEHOLDER ‚îÄ‚îÄ */
    {topic:"Placeholder Topic 3",icon:"üìù",
     sentences:["Sentence A ‚Äî replace this.","Sentence B ‚Äî replace this.","Sentence C ‚Äî replace this.","Sentence D ‚Äî replace this."],
     correctOrder:[0,1,2,3],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Why this sentence comes first."},
       {pos:"2Ô∏è‚É£",why:"Why this sentence comes second."},
       {pos:"3Ô∏è‚É£",why:"Why this sentence comes third."},
       {pos:"4Ô∏è‚É£",why:"Why this sentence comes fourth."}
     ]
    },
    /* ‚îÄ‚îÄ Q4 PLACEHOLDER ‚îÄ‚îÄ */
    {topic:"Placeholder Topic 4",icon:"üìù",
     sentences:["Sentence A ‚Äî replace this.","Sentence B ‚Äî replace this.","Sentence C ‚Äî replace this.","Sentence D ‚Äî replace this."],
     correctOrder:[0,1,2,3],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Why this sentence comes first."},
       {pos:"2Ô∏è‚É£",why:"Why this sentence comes second."},
       {pos:"3Ô∏è‚É£",why:"Why this sentence comes third."},
       {pos:"4Ô∏è‚É£",why:"Why this sentence comes fourth."}
     ]
    },
    /* ‚îÄ‚îÄ Q5 PLACEHOLDER ‚îÄ‚îÄ */
    {topic:"Placeholder Topic 5",icon:"üìù",
     sentences:["Sentence A ‚Äî replace this.","Sentence B ‚Äî replace this.","Sentence C ‚Äî replace this.","Sentence D ‚Äî replace this."],
     correctOrder:[0,1,2,3],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Why this sentence comes first."},
       {pos:"2Ô∏è‚É£",why:"Why this sentence comes second."},
       {pos:"3Ô∏è‚É£",why:"Why this sentence comes third."},
       {pos:"4Ô∏è‚É£",why:"Why this sentence comes fourth."}
     ]
    },
    /* ‚îÄ‚îÄ Q6 PLACEHOLDER ‚îÄ‚îÄ */
    {topic:"Placeholder Topic 6",icon:"üìù",
     sentences:["Sentence A ‚Äî replace this.","Sentence B ‚Äî replace this.","Sentence C ‚Äî replace this.","Sentence D ‚Äî replace this."],
     correctOrder:[0,1,2,3],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Why this sentence comes first."},
       {pos:"2Ô∏è‚É£",why:"Why this sentence comes second."},
       {pos:"3Ô∏è‚É£",why:"Why this sentence comes third."},
       {pos:"4Ô∏è‚É£",why:"Why this sentence comes fourth."}
     ]
    },
    /* ‚îÄ‚îÄ Q7 PLACEHOLDER ‚îÄ‚îÄ */
    {topic:"Placeholder Topic 7",icon:"üìù",
     sentences:["Sentence A ‚Äî replace this.","Sentence B ‚Äî replace this.","Sentence C ‚Äî replace this.","Sentence D ‚Äî replace this."],
     correctOrder:[0,1,2,3],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Why this sentence comes first."},
       {pos:"2Ô∏è‚É£",why:"Why this sentence comes second."},
       {pos:"3Ô∏è‚É£",why:"Why this sentence comes third."},
       {pos:"4Ô∏è‚É£",why:"Why this sentence comes fourth."}
     ]
    },
    /* ‚îÄ‚îÄ Q8 PLACEHOLDER ‚îÄ‚îÄ */
    {topic:"Placeholder Topic 8",icon:"üìù",
     sentences:["Sentence A ‚Äî replace this.","Sentence B ‚Äî replace this.","Sentence C ‚Äî replace this.","Sentence D ‚Äî replace this."],
     correctOrder:[0,1,2,3],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Why this sentence comes first."},
       {pos:"2Ô∏è‚É£",why:"Why this sentence comes second."},
       {pos:"3Ô∏è‚É£",why:"Why this sentence comes third."},
       {pos:"4Ô∏è‚É£",why:"Why this sentence comes fourth."}
     ]
    },
    /* ‚îÄ‚îÄ Q9 PLACEHOLDER ‚îÄ‚îÄ */
    {topic:"Placeholder Topic 9",icon:"üìù",
     sentences:["Sentence A ‚Äî replace this.","Sentence B ‚Äî replace this.","Sentence C ‚Äî replace this.","Sentence D ‚Äî replace this."],
     correctOrder:[0,1,2,3],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Why this sentence comes first."},
       {pos:"2Ô∏è‚É£",why:"Why this sentence comes second."},
       {pos:"3Ô∏è‚É£",why:"Why this sentence comes third."},
       {pos:"4Ô∏è‚É£",why:"Why this sentence comes fourth."}
     ]
    },
    /* ‚îÄ‚îÄ Q10 PLACEHOLDER ‚îÄ‚îÄ */
    {topic:"Placeholder Topic 10",icon:"üìù",
     sentences:["Sentence A ‚Äî replace this.","Sentence B ‚Äî replace this.","Sentence C ‚Äî replace this.","Sentence D ‚Äî replace this."],
     correctOrder:[0,1,2,3],
     explanations:[
       {pos:"1Ô∏è‚É£",why:"Why this sentence comes first."},
       {pos:"2Ô∏è‚É£",why:"Why this sentence comes second."},
       {pos:"3Ô∏è‚É£",why:"Why this sentence comes third."},
       {pos:"4Ô∏è‚É£",why:"Why this sentence comes fourth."}
     ]
    }
  ]
};

/* ‚ïê‚ïê STATE ‚ïê‚ïê */
let playerName="",playerDept="";
let current=0,currentGems=0,currentStreak=0,highestStreak=0;
let totalCorrectFirst=0,totalWrong=0;
let startTime,timerInterval,qStartTime;
let isMuted=false,audioCtx;
let displayOrder=[];   // displayOrder[pos] = sentence index
let tapSelected=null;  // currently highlighted card position
let movedCards=new Set(); // positions that have been tapped at least once
let firstAttemptThisQ=true;

/* ‚ïê‚ïê AUDIO ‚ïê‚ïê */
function getAC(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function tone(f,d,t='sine',v=0.09){if(isMuted)return;try{const c=getAC(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type=t;o.frequency.setValueAtTime(f,c.currentTime);g.gain.setValueAtTime(v,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+d);o.start(c.currentTime);o.stop(c.currentTime+d);}catch(e){}}
const sfxTap=()=>tone(440,0.07,'sine',0.05);
const sfxSwap=()=>{tone(520,0.08,'sine',0.06);setTimeout(()=>tone(680,0.08),70);};
const sfxCorrect=()=>{tone(523,0.28);setTimeout(()=>tone(659,0.22),100);setTimeout(()=>tone(784,0.28),210);};
const sfxWrong=()=>tone(220,0.3,'sine',0.08);
const sfxVictory=()=>{[440,523,587,659,784,880].forEach((f,i)=>setTimeout(()=>tone(f,0.3,'sine',0.12),i*110));};
document.getElementById('mute-btn').onclick=()=>{isMuted=!isMuted;document.getElementById('mute-btn').textContent=isMuted?'üîá SFX':'üîä SFX';};

/* ‚ïê‚ïê BOOT ‚ïê‚ïê */
window.onload=()=>{
  try{const sn=localStorage.getItem('pName'),sd=localStorage.getItem('pDept');if(sn)document.getElementById('name-input').value=sn;if(sd)document.getElementById('dept-select').value=sd;}catch(e){}
  document.getElementById('q-total').textContent=QUEST.questions.length;
  showOnly('lobby-screen');
};

document.getElementById('start-lobby-btn').onclick=()=>{
  const n=document.getElementById('name-input').value.trim();
  const d=document.getElementById('dept-select').value;
  if(!d){alert('Please select your department!');return;}
  if(!n){alert('Please enter your name!');return;}
  playerName=n;playerDept=d;
  try{localStorage.setItem('pName',n);localStorage.setItem('pDept',d);}catch(e){}
  document.getElementById('header-bar').classList.remove('hidden');
  showOnly('game-board');
  initGame();
};

/* ‚ïê‚ïê GAME ‚ïê‚ïê */
function initGame(){
  current=0;currentGems=0;currentStreak=0;highestStreak=0;
  totalCorrectFirst=0;totalWrong=0;
  startTime=Date.now();
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{},1000); // keep timer running silently for Supabase
  loadQuestion();
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

function loadQuestion(){
  if(current>=QUEST.questions.length){showScore();return;}
  const q=QUEST.questions[current];
  firstAttemptThisQ=true;tapSelected=null;movedCards=new Set();
  qStartTime=Date.now();

  document.getElementById('q-progress-fill').style.width=(current/QUEST.questions.length*100)+'%';
  document.getElementById('q-current').textContent=current+1;
  document.getElementById('topic-icon').textContent=q.icon||'üìù';
  document.getElementById('topic-name').textContent=q.topic;
  document.getElementById('next-btn').style.display='none';
  document.getElementById('submit-btn').style.display='block';
  document.getElementById('explanation-panel').style.display='none';
  document.getElementById('feedback-msg').textContent='';
  document.getElementById('feedback-msg').className='';

  displayOrder=shuffle([...Array(q.sentences.length).keys()]);
  renderList(q);
}

/* ‚ïê‚ïê RENDER ‚ïê‚ïê */
function renderList(q){
  const list=document.getElementById('sentence-list');
  list.innerHTML='';
  displayOrder.forEach((sentIdx,pos)=>{
    const touched=movedCards.has(pos);
    const isCorrect=sentIdx===q.correctOrder[pos];

    const card=document.createElement('div');
    card.className='sent-card '+(touched?'active':'inactive');
    if(touched) card.classList.add(isCorrect?'pos-correct':'pos-wrong');
    if(tapSelected===pos) card.classList.add('selected');
    card.dataset.pos=pos;

    const dot=document.createElement('div');
    dot.className='pos-dot'+(touched?(isCorrect?' c':' w'):'');
    dot.textContent=pos+1;

    const text=document.createElement('div');
    text.className='sent-text';
    text.textContent=q.sentences[sentIdx];

    const badge=document.createElement('div');
    badge.className='pos-badge';
    badge.textContent=touched?(isCorrect?'‚úÖ':'‚ùå'):'';

    card.appendChild(dot);
    card.appendChild(text);
    card.appendChild(badge);

    card.addEventListener('click',()=>handleTap(pos,q));
    list.appendChild(card);
  });
}

/* ‚ïê‚ïê TAP-TO-SWAP ‚ïê‚ïê */
function handleTap(pos,q){
  sfxTap();
  movedCards.add(pos);

  if(tapSelected===null){
    // First tap ‚Äî select
    tapSelected=pos;
    renderList(q);
    return;
  }

  if(tapSelected===pos){
    // Tap same card ‚Äî deselect
    tapSelected=null;
    renderList(q);
    return;
  }

  // Second tap ‚Äî swap
  const a=tapSelected, b=pos;
  tapSelected=null;
  movedCards.add(a);movedCards.add(b);
  [displayOrder[a],displayOrder[b]]=[displayOrder[b],displayOrder[a]];
  if(firstAttemptThisQ) firstAttemptThisQ=false;
  sfxSwap();
  renderList(q);

  // Flash swapped cards
  setTimeout(()=>{
    const cards=document.querySelectorAll('.sent-card');
    [cards[a],cards[b]].forEach(c=>{if(c){c.classList.add('swap-flash');setTimeout(()=>c.classList.remove('swap-flash'),260);}});
  },20);

  // Check if everything looks correct
  const allDone=displayOrder.every((s,p)=>s===q.correctOrder[p]);
  if(allDone) showFeedback('üéâ Looks perfect! Hit Submit!','correct-msg');
  else document.getElementById('feedback-msg').textContent='';
}

/* ‚ïê‚ïê SUBMIT ‚ïê‚ïê */
document.getElementById('submit-btn').onclick=()=>{
  const q=QUEST.questions[current];
  // Reveal indicators for all cards
  displayOrder.forEach((_,p)=>movedCards.add(p));
  renderList(q);

  const isCorrect=displayOrder.every((s,p)=>s===q.correctOrder[p]);

  if(isCorrect){
    sfxCorrect();createSparks();showWordOverlay();
    const qTime=Math.floor((Date.now()-qStartTime)/1000);
    let gems=2;
    if(qTime<8)gems+=2; else if(qTime<15)gems+=1;
    if(gems>2) flashSpeedBonus();
    currentStreak++;
    if(currentStreak>highestStreak) highestStreak=currentStreak;
    if(currentStreak%3===0){createConfetti();gems++;showFeedback(`üî• ${currentStreak} STREAK! +${gems}üíé`,'correct-msg');}
    else showFeedback('‚úÖ PERFECT ORDER!','correct-msg');
    totalCorrectFirst++;currentGems+=gems;showFlyingGem(true,gems);
    document.getElementById('next-btn').style.display='block';
    document.getElementById('submit-btn').style.display='none';
  } else {
    sfxWrong();currentStreak=0;totalWrong++;
    currentGems=Math.max(0,currentGems-1);showFlyingGem(false,1);
    if(firstAttemptThisQ) firstAttemptThisQ=false;
    showFeedback('‚ùå Not quite ‚Äî tap two sentences to swap and try again!','wrong-msg');
  }

  showExplanation(q);
};

/* ‚ïê‚ïê EXPLANATION ‚ïê‚ïê */
function showExplanation(q){
  const panel=document.getElementById('explanation-panel');
  const body=document.getElementById('exp-body');
  body.innerHTML='';panel.style.display='block';
  q.correctOrder.forEach((correctSentIdx,pos)=>{
    const ok=displayOrder[pos]===correctSentIdx;
    const exp=q.explanations[pos];
    const row=document.createElement('div');
    row.className=`exp-row ${ok?'c':'w'}`;
    row.innerHTML=`
      <div class="exp-pos">${exp.pos}</div>
      <div style="flex:1">
        <div class="exp-sent ${ok?'c':'w'}">"${q.sentences[correctSentIdx]}"</div>
        <span class="exp-toggle">‚ñº WHY?</span>
        <div class="exp-why">${exp.why}</div>
      </div>`;
    const toggle=row.querySelector('.exp-toggle'),why=row.querySelector('.exp-why');
    row.addEventListener('click',()=>{const o=why.classList.toggle('open');toggle.textContent=o?'‚ñ≤ HIDE':'‚ñº WHY?';});
    body.appendChild(row);
  });
}

/* ‚ïê‚ïê NEXT ‚ïê‚ïê */
document.getElementById('next-btn').onclick=()=>{
  current++;
  document.getElementById('explanation-panel').style.display='none';
  document.getElementById('feedback-msg').textContent='';
  loadQuestion();
};

/* ‚ïê‚ïê RESET ‚ïê‚ïê */
document.getElementById('reset-btn').onclick=()=>{
  const q=QUEST.questions[current];
  displayOrder=shuffle([...Array(q.sentences.length).keys()]);
  tapSelected=null;movedCards=new Set();
  document.getElementById('feedback-msg').textContent='';
  document.getElementById('explanation-panel').style.display='none';
  document.getElementById('submit-btn').style.display='block';
  document.getElementById('next-btn').style.display='none';
  renderList(q);
};

/* ‚ïê‚ïê HINT ‚ïê‚ïê */
document.getElementById('hint-btn').onclick=()=>{
  if(currentGems<1){showFeedback('üíé Not enough gems!','wrong-msg');return;}
  const q=QUEST.questions[current];
  for(let pos=0;pos<displayOrder.length;pos++){
    if(displayOrder[pos]!==q.correctOrder[pos]){
      currentGems=Math.max(0,currentGems-1);showFlyingGem(false,1);
      firstAttemptThisQ=false;
      showFeedback(`üí° Position ${pos+1} is wrong ‚Äî tap it to start a swap!`,'info-msg');
      const cards=[...document.querySelectorAll('.sent-card')];
      if(cards[pos]){cards[pos].style.outline='3px solid var(--accent2)';setTimeout(()=>cards[pos].style.outline='',1500);}
      return;
    }
  }
  showFeedback('üí° Looks good ‚Äî hit Submit!','info-msg');
};

/* ‚ïê‚ïê SCORE ‚ïê‚ïê */
function showScore(){
  clearInterval(timerInterval);sfxVictory();createConfetti();
  const t=Math.floor((Date.now()-startTime)/1000);
  const acc=Math.round((totalCorrectFirst/QUEST.questions.length)*100);
  document.getElementById('score-trophy').textContent=acc>=90?'üèÜ':acc>=70?'ü•à':acc>=50?'ü•â':'üéÆ';
  document.getElementById('score-name-lbl').textContent=playerName+' ¬∑ '+playerDept;
  document.getElementById('sc-gems').textContent=currentGems;
  document.getElementById('sc-correct').textContent=totalCorrectFirst+'/'+QUEST.questions.length;
  document.getElementById('sc-streak').textContent=highestStreak;
  document.getElementById('sc-time').textContent=t+'s';
  document.getElementById('sc-acc-pct').textContent=acc+'%';
  setTimeout(()=>document.getElementById('sc-acc-bar').style.width=acc+'%',300);
  showOnly('score-screen');
  document.getElementById('header-bar').classList.add('hidden');
  sendToSupabase({student_name:playerName,department:playerDept,quest_id:QUEST.id,quest_title:QUEST.title,correct:totalCorrectFirst,wrong:totalWrong,gems:currentGems,highest_streak:highestStreak,accuracy:acc,time_spent:t});
}
async function sendToSupabase(p){try{await fetch(SUPABASE_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});}catch(e){}}
document.getElementById('back-lobby-btn').onclick=()=>location.reload();

/* ‚ïê‚ïê HELPERS ‚ïê‚ïê */
function showOnly(id){
  ['loading-screen','lobby-screen','game-board','score-screen'].forEach(sid=>{
    const el=document.getElementById(sid);
    if(sid==='loading-screen') el.style.display=sid===id?'block':'none';
    else{ el.style.display=sid===id?'flex':'none'; if(sid===id)el.style.flexDirection='column'; }
  });
}
function showFeedback(msg,cls){const el=document.getElementById('feedback-msg');el.textContent=msg;el.className=cls;}
function showWordOverlay(){const o=document.getElementById('word-correct-overlay');o.classList.add('show');setTimeout(()=>o.classList.remove('show'),1000);}
function flashSpeedBonus(){const el=document.getElementById('time-bonus-flash');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1400);}
function showFlyingGem(isGain,amount=1){
  const ref=document.getElementById('q-label');
  const rect=ref.getBoundingClientRect();
  const el=document.createElement('span');
  el.className=`flying-gem ${isGain?'plus':'minus'}`;
  el.textContent=isGain?`+${amount}üíé`:`-${amount}üíé`;
  el.style.cssText=`left:${rect.left}px;top:${rect.top}px;`;
  document.body.appendChild(el);setTimeout(()=>el.remove(),900);
}
function createSparks(){
  const list=document.getElementById('sentence-list');
  const rect=list.getBoundingClientRect();
  const cx=rect.left+rect.width/2,cy=rect.top+rect.height/2;
  const cols=['#ffd700','#63b3ed','#68d391','#f6ad55','#b794f4'];
  for(let i=0;i<16;i++){
    const s=document.createElement('div');s.className='spark';
    const angle=(Math.PI*2*i)/16,v=55+Math.random()*45;
    s.style.cssText=`left:${cx}px;top:${cy}px;background:${cols[i%cols.length]};--tx:${Math.cos(angle)*v}px;--ty:${Math.sin(angle)*v}px;animation-delay:${Math.random()*0.08}s;`;
    document.body.appendChild(s);setTimeout(()=>s.remove(),800);
  }
}
function createConfetti(){
  const cols=['#ff1744','#00e5ff','#ffd600','#00e676','#d500f9','#ff6d00','#63b3ed'];
  for(let i=0;i<28;i++){
    const c=document.createElement('div');c.className='confetti-piece';
    c.style.cssText=`left:${5+Math.random()*90}%;top:${5+Math.random()*25}%;background:${cols[i%cols.length]};border-radius:${Math.random()>0.5?'50%':'2px'};animation-delay:${Math.random()*0.4}s;`;
    document.body.appendChild(c);setTimeout(()=>c.remove(),1800);
  }
}
</script>
</body>
</html>
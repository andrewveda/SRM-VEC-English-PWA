<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SRM VEC English ‚Äî Quest & Video Calendar</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7A0019">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary: #7A0019;
  --primary-dark: #5a0013;
  --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.1);
  --shadow-hard: 0 20px 60px rgba(0, 0, 0, 0.3);
  --radius-sm: 12px;
  --radius-md: 16px;
  --radius-lg: 24px;
}

body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
  background-attachment: fixed;
  min-height: 100vh; 
  padding: 20px;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.3), transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  color: white;
}

.loading-screen.show {
  display: flex;
}

.loading-screen h1 {
  font-size: 1.8rem;
  margin-bottom: 30px;
  text-align: center;
  padding: 0 20px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 4px solid rgba(255,255,255,0.2);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.credits {
  position: absolute;
  bottom: 40px;
  font-size: 0.95rem;
  opacity: 0.8;
  text-align: center;
  padding: 0 20px;
  font-weight: 300;
}

.name-input-container {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-lg);
  padding: 50px 40px;
  max-width: 500px;
  margin: 50px auto; 
  box-shadow: var(--shadow-hard);
  text-align: center;
  display: none;
  position: relative;
  z-index: 1;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.name-input-container.show {
  display: block;
  animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.name-input-container h1 {
  color: var(--primary);
  font-size: 2rem;
  margin-bottom: 10px;
  font-weight: 800;
  letter-spacing: -0.5px;
}

.name-input-container h2 {
  color: #555;
  font-size: 1.1rem;
  margin-bottom: 35px;
  font-weight: 400;
}

.name-input-container input {
  width: 100%;
  padding: 18px 20px;
  font-size: 1.05rem;
  border: 2px solid #e0e0e0;
  border-radius: var(--radius-md);
  margin-bottom: 20px;
  transition: all 0.3s ease;
  background: white;
}

.name-input-container input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(122, 0, 25, 0.1);
}

.name-input-container button, .name-input-container a button {
  width: 100%;
  padding: 18px;
  font-size: 1.05rem;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  margin-bottom: 12px;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  font-weight: 700;
  letter-spacing: 0.3px;
  position: relative;
  overflow: hidden;
}

.name-input-container a {
  text-decoration: none;
  display: block;
}

.name-input-container button::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.name-input-container button:hover::before {
  width: 300px;
  height: 300px;
}

.name-input-container button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.25);
}

.name-input-container button:active {
  transform: translateY(-1px);
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
}

.btn-vocab {
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  color: #1a1a1a;
}

.btn-mystic {
  background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  color: #1a1a1a;
}

.btn-wordle {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
}

.btn-leaderboard {
  background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  color: #1a1a1a;
}

.btn-elll {
  background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
  color: white;
}

.leaderboard-icon, .elll-icon, .profile-icon {
  position: fixed;
  left: 0;
  width: 100vw;
  height: 60px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: 0;         
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  cursor: pointer;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
  z-index: 1000;
  transition: all 0.3s ease;
  font-weight: 600;
  border-top: 1px solid rgba(0,0,0,0.05);
}

.leaderboard-icon {
  bottom: 120px;
}

.elll-icon {
  bottom: 60px;
}

.profile-icon {
  bottom: 0;
}

.leaderboard-icon:hover, .elll-icon:hover, .profile-icon:hover {
  background: rgba(255, 255, 255, 1);
  box-shadow: 0 -8px 30px rgba(0,0,0,0.2);
}

.profile-icon.show {
  display: flex;
}

.profile-drawer {
  position: fixed;
  top: 0;
  right: -380px;
  width: 380px;
  height: 100%;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  box-shadow: -8px 0 40px rgba(0,0,0,0.2);
  z-index: 999;
  transition: right 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow-y: auto;
  padding: 90px 25px 25px;
}

.profile-drawer.open {
  right: 0;
}

.profile-drawer h3 {
  color: var(--primary);
  margin-bottom: 25px;
  font-size: 1.5rem;
  font-weight: 700;
}

.drawer-item {
  padding: 18px;
  margin-bottom: 12px;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.3s ease;
}

.drawer-item:hover {
  transform: translateX(-5px);
  box-shadow: var(--shadow-soft);
}

.drawer-item a {
  text-decoration: none;
  color: #1a1a1a;
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
}

.close-drawer {
  position: absolute;
  top: 25px;
  right: 25px;
  font-size: 2rem;
  cursor: pointer;
  color: #666;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.close-drawer:hover {
  background: rgba(0,0,0,0.05);
  transform: rotate(90deg);
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(5px);
  z-index: 998;
  display: none;
  transition: opacity 0.3s ease;
}

.overlay.active {
  display: block;
}

.calendar-container {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-lg);
  padding: 25px;
  max-width: 800px;
  margin: 0 auto;
  box-shadow: var(--shadow-hard);
  display: none;
  max-height: calc(100vh - 40px);
  overflow: hidden;
  flex-direction: column;
  position: relative;
  z-index: 1;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.calendar-container.show {
  display: flex;
  animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.user-info {
  text-align: center;
  margin-bottom: 20px;
  flex-shrink: 0;
}

.user-info h2 {
  color: var(--primary);
  font-size: 1.8rem;
  margin-bottom: 18px;
  font-weight: 800;
  letter-spacing: -0.5px;
}

.stats {
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
  margin-bottom: 25px;
}

.stat-box {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 16px 28px;
  border-radius: var(--radius-md);
  font-weight: 700;
  box-shadow: var(--shadow-soft);
  transition: all 0.3s ease;
}

.stat-box:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
}

.type-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
  flex-shrink: 0;
}

.type-button {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 700;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  color: white;
  font-size: 0.95rem;
  box-shadow: var(--shadow-soft);
}

.type-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.type-button.active {
  transform: translateY(-6px) scale(1.08);
  box-shadow: 0 15px 35px rgba(0,0,0,0.4), 0 0 30px 8px currentColor;
  z-index: 2;
}

.calendar {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  flex-shrink: 0;
}

.calendar-header button {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-soft);
}

.calendar-header button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(122, 0, 25, 0.3);
}

.calendar-header div {
  font-size: 1.2rem;
  font-weight: 700;
  color: #1a1a1a;
}

.days-of-week {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  margin-bottom: 8px;
  font-weight: 700;
  text-align: center;
  color: #666;
  font-size: 0.9rem;
  flex-shrink: 0;
}

.dates {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  flex: 1;
  align-content: start;
  overflow: hidden;
}

.dates div {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  font-size: 0.95rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.dates div:hover:not(.disabled) {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.dates .done {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  color: white;
}

.dates .missed {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
  color: white;
}

.dates .disabled {
  background: #f5f5f5;
  color: #ccc;
  cursor: default;
  box-shadow: none;
}

.offline-banner {
  background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
  color: white;
  padding: 14px;
  text-align: center;
  border-radius: var(--radius-md);
  margin-bottom: 15px;
  font-weight: 700;
  display: none;
  flex-shrink: 0;
  font-size: 0.95rem;
  box-shadow: var(--shadow-soft);
}

.offline-banner.show {
  display: block;
}

.logout-btn {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
  color: white;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 700;
  margin-top: 20px;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-soft);
}

.logout-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(198, 40, 40, 0.4);
}

.custom-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}

.custom-modal-overlay.show {
  display: flex;
  opacity: 1;
}

.custom-modal {
  background: white;
  padding: 40px;
  border-radius: var(--radius-lg);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  width: 90%;
  max-width: 420px;
  text-align: center;
  transform: scale(0.9);
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.custom-modal-overlay.show .custom-modal {
  transform: scale(1);
}

.custom-modal p {
  font-size: 1.15rem;
  color: #333;
  margin-bottom: 30px;
  line-height: 1.6;
  font-weight: 500;
}

.modal-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.modal-btn {
  border: none;
  border-radius: var(--radius-md);
  padding: 14px 24px;
  font-size: 1.05rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  flex: 1;
}

.modal-btn-confirm {
  background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
  color: white;
  box-shadow: var(--shadow-soft);
}

.modal-btn-confirm:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(198, 40, 40, 0.4);
}

.modal-btn-cancel {
  background: #f0f0f0;
  color: #333;
}

.modal-btn-cancel:hover {
  background: #e0e0e0;
  transform: translateY(-3px);
}

.quotes-carousel {
  margin-top: 12px;
  text-align: center;
  color: var(--primary); 
  font-style: italic;
  font-size: 1rem;
  opacity: 0.85;
  transition: opacity 5s ease;
  min-height: 28px;
  font-weight: 500;
}

.level-dashboard {
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-lg);
  padding: 25px;
  color: white;
  text-align: center;
  box-shadow: var(--shadow-hard);
  margin: 0 auto 25px auto;
  max-width: 800px;
  animation: fadeIn 1s ease-out;
  border: 1px solid rgba(255, 255, 255, 0.3);
  position: relative;
  z-index: 1;
}

.level-dashboard h2 {
  font-size: 1.4rem;
  font-weight: 800;
  margin-bottom: 12px;
  letter-spacing: 0.5px;
  color: #ffe082;
  text-shadow: 0 2px 20px rgba(255, 224, 130, 0.5);
}

.xp-bar {
  background: rgba(255, 255, 255, 0.2);
  border-radius: var(--radius-sm);
  height: 14px;
  width: 100%;
  margin: 8px 0;
  overflow: hidden;
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
}

.xp-fill {
  height: 100%;
  background: linear-gradient(90deg, #ffcc33, #ff9100);
  border-radius: var(--radius-sm);
  transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 0 15px rgba(255, 204, 51, 0.6);
}

.xp-text {
  font-size: 0.85rem;
  color: #fff;
  margin-bottom: 18px;
  font-weight: 500;
}

.power-bar-deck {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-around;
  gap: 10px;
}

.power-item {
  display: flex;
  align-items: center;
  flex-direction: column;
  width: 70px;
  font-size: 0.85rem;
  color: #fff;
  font-weight: 600;
}

.power-bar {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 6px;
  margin: 4px 0;
  overflow: hidden;
  box-shadow: inset 0 1px 4px rgba(0,0,0,0.2);
}

.power-bar .fill {
  height: 100%;
  border-radius: 6px;
  transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 0 10px currentColor;
}

.power-item:nth-child(1) .fill { background: linear-gradient(90deg, gold, orange); }
.power-item:nth-child(2) .fill { background: linear-gradient(90deg, #2196F3, #21CBF3); }
.power-item:nth-child(3) .fill { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
.power-item:nth-child(4) .fill { background: linear-gradient(90deg, #FF5722, #FFC107); }

.power-value {
  margin-top: 3px;
  font-weight: 700;
  font-size: 0.85rem;
  text-shadow: 0 2px 8px rgba(0,0,0,0.4);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
  body {
    padding: 12px;
  }
 
  .calendar-container {
    padding: 15px;
    border-radius: var(--radius-md);
    max-height: calc(100vh - 24px);
  }
 
  .user-info h2 {
    font-size: 1.3rem;
    margin-bottom: 12px;
  }
 
  .type-button {
    padding: 10px 18px;
    font-size: 0.85rem;
  }
 
  .calendar-header button {
    padding: 8px 14px;
    font-size: 0.95rem;
  }
 
  .calendar-header div {
    font-size: 1rem;
  }
 
  .days-of-week {
    font-size: 0.75rem;
    gap: 4px;
  }
 
  .dates {
    gap: 4px;
  }
 
  .dates div {
    font-size: 0.8rem;
  }
 
  .profile-drawer {
    width: 100%;
    right: -100%;
  }
  
  .name-input-container {
    padding: 35px 25px;
  }
  
  .name-input-container h1 {
    font-size: 1.6rem;
  }
}

@media (min-width: 1025px) {
  .calendar-container {
    max-height: none;
    overflow: visible;
  }

  .dates div {
    aspect-ratio: auto;
    height: 80px;
  }

  .dates {
    overflow: visible;
  }

  .calendar {
    min-height: auto;
  }

  body {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 50px;
  }

  .calendar-container,
  .name-input-container,
  .level-dashboard {
    width: 900px;
    max-width: 90vw;
  }
}
</style>
</head>
<body>
<div id="miniPowerDeckTop"
   onclick="toggleTimeMode()"
     style="
       text-align:center;
       font-size:0.95rem;
       font-weight:600;
       color:white;
       padding:6px 0;
       margin-top:10px;
       margin-bottom:8px;
       border-radius:10px;
       width:90%;
       max-width:500px;
       margin-left:auto;
       margin-right:auto;
       background:rgba(0,0,0,0.25);
       backdrop-filter:blur(6px);
       box-shadow:0 3px 10px rgba(0,0,0,0.2);
     ">
</div>


<div class="loading-screen" id="loadingScreen">
  <h1>Loading your Quest Calendar...</h1>
  <div class="spinner"></div>
  <p class="credits"> Created with ‚ô•Ô∏è grit, nurtured with love and charged with passion by 
<a href="https://andrewveda.github.io/" 
   style="color:#7A0019; font-weight:600; text-decoration:none;" 
   target="_blank">
   Andrew Veda
</a> <br>SRM Valliammai Engineering College
</p>
</div>

<div class="name-input-container" id="nameInputContainer">
  <h1>SRM Valliammai Engineering College (Autonomous)</h1>
  <h2>Department of English</h2>
  <input type="text" id="nameInput" placeholder="Enter Your Name">
  <button class="btn-primary" onclick="saveAndLogin()">Get Started</button>
  <a href="https://sites.google.com/view/srm-vec-english/daily-vocabulary">
    <button class="btn-vocab">üìö Daily Vocabulary</button>
  </a>
  <a href="https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/brochure1">
    <button class="btn-mystic">üéØ Register for Mystic Summit</button>
  </a>
  <a href="https://andrewveda.github.io/Quiz/">
    <button class="btn-wordle">üëΩ WORDLE!</button>
  </a>
  <a href="https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/leaderboard">
    <button class="btn-leaderboard">üòé Leaderboard</button>
  </a>
  <a href="https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/ELLL.html">
    <button class="btn-elll">üìù ELLL Virtual Record‚ú® </button>
  </a>
</div>
<div class="profile-icon" id="profileIcon">üë§ Quick links </div>
<div class="leaderboard-icon" id="leaderboardIcon">üëëLeaderboard </div>
  <div class="elll-icon" id="elllIcon">Wordle üìú</div>
<div class="overlay" id="overlay"></div>
<div class="profile-drawer" id="profileDrawer">
  <span class="close-drawer" id="closeDrawer">&times;</span>

  <h3 id="drawerUserName">User Profile</h3>

  <!-- User stats removed as requested -->

  <h3 style="font-size:1.1rem; margin-bottom:15px; margin-top: 20px;">Quick Links</h3>

  <div class="drawer-item"><a href="https://andrewveda.github.io/V">üìö Daily Vocabulary</a></div>
  <div class="drawer-item"><a href="https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/brochure1">üéØ Mystic Summit</a></div>
  <div class="drawer-item"><a href="https://andrewveda.github.io/videoquest">üé• Video Quests</a></div>
  <div class="drawer-item"><a href="https://andrewveda.github.io/Quiz/">üëΩ Wordle</a></div>
  <div class="drawer-item"><a href="https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/leaderboard">üòé Leaderboard</a></div>
  <div class="drawer-item"><a href="https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/ELLL.html">üìù ELLL Record</a></div>

  <button class="logout-btn" onclick="logout()">üö™ Logout</button>

</div>
 
<!-- REMOVED level-dashboard DIV -->
<!-- <div class="level-dashboard" id="levelDashboard"> ... </div> -->


<div class="calendar-container" id="calendarContainer">
  <div class="offline-banner" id="offlineBanner">üì° Offline mode ‚Äî progress will sync when online.</div>
 
  <div class="user-info">
    <h2 id="userName"></h2>
  </div>

<div class="type-buttons">
  <button class="type-button active" style="background:#2196F3;" onclick="switchType('quest')">üìù Quest</button>
  <button class="type-button" style="background:#E53935;" onclick="switchType('video')">üé• Videos</button>
  <button class="type-button" style="background:#4CAF50;" onclick="switchType('story')">üìö Stories</button>
</div>

  <div class="calendar">
    <div class="calendar-header">
      <button onclick="changeMonth(-1)">‚óÄ</button>
      <div id="monthYear"></div>
      <button onclick="changeMonth(1)">‚ñ∂</button>
    </div>
    <div class="days-of-week">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
      <div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div class="dates" id="datesGrid"></div>
  </div>
 
<div class="quotes-carousel" id="quotesCarousel">
  <p>"Ever tried. Ever failed. No matter. Try again. Fail again. Fail better." <br> ‚Äî Samuel Beckett</p>
</div>
 
  <p style="text-align: center; font-size: 0.8rem; color: #888; margin-top: 15px; padding-bottom: 5px; flex-shrink: 0;">
    Created with ‚ô•Ô∏è grit, nurtured with love and charged with passion by 
<a href="https://andrewveda.github.io/" 
   style="color:#7A0019; font-weight:600; text-decoration:none;" 
   target="_blank">
   Andrew Veda
</a> <br>SRM Valliammai Engineering College
  </p>
</div>

<div id="customModal" class="custom-modal-overlay">
  <div class="custom-modal">
    <p id="modalMessage">Are you sure?</p>
    <div class="modal-buttons">
      <button id="modalCancel" class="modal-btn modal-btn-cancel">Cancel</button>
      <button id="modalConfirm" class="modal-btn modal-btn-confirm">OK</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // üî• GLOBAL RESET ‚Äî RUNS ONCE FOR ALL USERS
  const RESET_VERSION = "2025-11-29-v1";

  if (localStorage.getItem("RESET_VERSION") !== RESET_VERSION) {
      console.log("üî• Global reset triggered ‚Äî clearing old cached data.");

      // Remove all old cached data keys
      localStorage.removeItem("cachedProfileData");
      localStorage.removeItem("cachedUserData");
      localStorage.removeItem("userName");
      localStorage.removeItem("pendingSync");

      // Mark reset done
      localStorage.setItem("RESET_VERSION", RESET_VERSION);
  }

  const supabase = createClient(
    "https://ahezssoczvpbkteffcgz.supabase.co", 
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZXpzc29jenZwYmt0ZWZmY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTk1ODUsImV4cCI6MjA3ODQzNTU4NX0.2ZlqXnZxv0opkhynAT7OlK4S-xPygcc7ETUyTXRfGHE"
  );

let sessionStartTime = Date.now();
let totalTimeSpent = 0; // This is session time, not total
let userData = null;
let userProfileData = null;
  let showHHMMSS = false;

let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let currentType = 'quest';
const startDate = new Date(2025, 7, 25); // Note: Months are 0-indexed (7 = August)

const questLinks = {
  1: "https://andrewveda.github.io/SRM-VEC-English-PWA/quests/quest1", 2: "https://sites.google.com/view/srm-vec-english/quest/wh-questions-1",
  3: "https://sites.google.com/view/cys-english/self-introduction-1", 4: "https://sites.google.com/view/srm-vec-english/quest/one-word-substitution-1",
  5: "https://sites.google.com/view/cys-english/self-introduction-3", 6: "https://sites.google.com/view/srm-vec-english/quest/film-review",
  7: "https://sites.google.com/view/srm-vec-english/quest/pronouns-1", 8: "https://sites.google.com/view/srm-vec-english/quest/pronouns-2",
  9: "https://sites.google.com/view/srm-vec-english/quest/parts-of-speech-1", 10: "https://sites.google.com/view/srm-vec-english/quest/question-tags-1",
  11: "https://sites.google.com/view/srm-vec-english/quest/question-tags-2", 12: "https://sites.google.com/view/srm-vec-english/quest/subject-verb-agreement",
  13: "https://sites.google.com/view/srm-vec-english/quest/comparative-1", 14: "https://sites.google.com/view/srm-vec-english/quest/comparative-2",
  15: "https://sites.google.com/view/srm-vec-english/quest/discourse-markers", 16: "https://sites.google.com/view/srm-vec-english/quest/past-1",
  17: "https://sites.google.com/view/cys-english/questyesno1", 18: "https://sites.google.com/view/srm-vec-english/quest/yesno-2",
  19: "https://sites.google.com/view/srm-vec-english/quest/one-word-substitution-2", 20: "https://sites.google.com/view/cys-english/match1",
  21: "https://sites.google.com/view/cys-english/match2", 22: "https://sites.google.com/view/cys-english/past",
  23: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/Homophone1", 
  24: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/Homophone2",
  25: "https://sites.google.com/view/cys-english/comparisons1", 26: "https://sites.google.com/view/cys-english/comparisons2",
  27: "https://sites.google.com/view/cys-english/discoursemarkers", 
  28: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/article1",
  29: "https://sites.google.com/view/cys-english/synonym1", 30: "https://sites.google.com/view/cys-english/synonym2",
  31: "https://sites.google.com/view/cys-english/antonym1", 32: "https://sites.google.com/view/cys-english/antonym2",
  33: "https://sites.google.com/view/cys-english/prep1", 34: "https://sites.google.com/view/cys-english/prep2",
  35: "https://sites.google.com/view/cys-english/past2", 36: "https://sites.google.com/view/cys-english/prep3",
  37: "https://sites.google.com/view/cys-english/match3", 
  38: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/article2",
  39: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/article3", 
  40: "https://sites.google.com/view/cys-english/quest40", 
  41: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/present1", 
42: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/tense1", 
43: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/tense2", 
44: "https://sites.google.com/view/cys-english/quest44",
  45: "https://sites.google.com/view/cys-english/quest45", 46: "https://sites.google.com/view/cys-english/quest46",
  47: "https://sites.google.com/view/cys-english/quest47", 
  48: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/collocation1", 
  49: "https://sites.google.com/view/cys-english/quest49", 
  50: "https://sites.google.com/view/cys-english/quest50",
  51: "https://sites.google.com/view/cys-english/quest51", 
    52: "https://sites.google.com/view/cys-english/quest52",
    53: "https://sites.google.com/view/cys-english/quest53",
    54: "https://sites.google.com/view/cys-english/quest54",
    55: "https://sites.google.com/view/cys-english/quest55",
    56: "https://sites.google.com/view/cys-english/quest56",
    57: "https://sites.google.com/view/cys-english/quest57",
    58: "https://sites.google.com/view/cys-english/quest58",
    59: "https://sites.google.com/view/cys-english/quest59",
    60: "https://sites.google.com/view/cys-english/quest60",
    61: "https://sites.google.com/view/cys-english/quest61",
    62: "https://sites.google.com/view/cys-english/quest62",
    63: "https://sites.google.com/view/cys-english/full-streak-wh-questions", 
    64: "https://sites.google.com/view/cys-english/full-streak-single-word",
  65: "https://sites.google.com/view/cys-english/full-streak-3", 
  66: "https://sites.google.com/view/cys-english/full-streak-4",
  67: "https://sites.google.com/view/cys-english/full-streak-5", 
  68: "https://sites.google.com/view/cys-english/full-streak-6",
  69: "https://sites.google.com/view/cys-english/full-streak-7", 
  70: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/bookreview1", 
  71: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/bookreview2", 
  72: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/bookreview3", 
  73: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/bookreview4", 
  74: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog1", 
  75: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog2",
  76: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog3",
  77: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog4",
  78: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog5",
  79: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog6",
  80: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog7",
  81: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog8",
  82: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog9",
  83: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog10",
  84: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog11",
  85: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog12",
  86: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog13",
  87: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog14",
  88: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog15",
  89: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog16",
  90: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog17",
  91: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/blog18",
  92: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/instructions1",
  93: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/instructions2",
  94: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/expandcompoundnoun",
  95: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/report1",
  96: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/report2",
  97: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/report3",
  98: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/report4",
  99: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/report5",
  100: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/report6",
  101: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/report7",
  102: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/questions1",
  103: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/negative",
  104: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/compound",
  105: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/compound2",
  106: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/punctuation1",
  107: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/punctuation2",
  108: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/functionwords1",
  109: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/functionwords2",
  110: "https://andrewveda.github.io/3/Pygmalion",
  111: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/videoqueststed",
  112: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/videoquestspodcast",
  113: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/invention1",
  114: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/invention2",
  115: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/invention3",
  116: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/invention4",
  117: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/invention5",
  118: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/invention6",
  119: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/invention7",
  120: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/tensematch1",
  121: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/tensematch2",
  122: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/tensematch3",
  123: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/tensematch4",
  124: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/tensematch5",
  125: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/tensematch6",
  126: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/t4",
  127: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/t3",
  128: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/t2negquesprestense",
  129: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/homophonearticles",
  130: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/Quotes1",
  131: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/quotes2",
  132: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/idiom1",
  133: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/idiom2",
  134: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/idiom3",
  135: "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/MCQ/idiom4",
  

};
const videoLink = "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/videoquests";
const storyLinks = { 69: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story1", 
                    70: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story2", 
                    71: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story3", 
                    72: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story4", 
                    73: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story5", 
                    74: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story6", 
                    75: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story7", 
                    76: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story8",
                      77: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story9",
                      78: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story10",
                      79: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story11",
                      80: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story12",
                      81: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story13",
                      82: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story14",
                      83: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story15",
                      84: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story16",
                      85: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story17",
                      86: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story18",
                      87: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story19",
                      88: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story20",
                      89: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story21",
                      90: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story22",
                      91: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story23",
                      92: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story24",
                      93: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story25",
                      94: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story26",
                      95: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story27",
                      96: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story28",
                      97: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story29",
                      98: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story30",
                      99: "https://andrewveda.github.io/SRM-VEC-English-PWA/cloze/story31"
                      
                       
                      }

async function init() {
  const savedName = localStorage.getItem('userName');
  
  if (savedName) {
    const cachedUser = localStorage.getItem('cachedUserData');
    const cachedProfile = localStorage.getItem('cachedProfileData');
    
    if (cachedUser && cachedProfile) {
      // Load from cache for instant startup
      userData = JSON.parse(cachedUser);
      userProfileData = JSON.parse(cachedProfile);
      showCalendar(); // Show UI immediately
      
      // Refresh data in the background
      refreshData(savedName); 
    } else {
      // No cache, show loading screen and fetch
      document.getElementById('loadingScreen').classList.add('show');
      await fetchInitialData(savedName);
      showCalendar();
      document.getElementById('loadingScreen').classList.remove('show');
    }
  } else {
    // New user
    document.getElementById('nameInputContainer').classList.add('show');
  }
  
  setupEventListeners();
  checkOnlineStatus();
  trackInstall();
}

/**
 * Fetches all necessary data from Supabase. Used for initial login.
 * Shows loading screen.
 */
async function fetchInitialData(name) {
  console.log("Fetching initial data for:", name);
  try {
    const [summaryResult, leaderboardResult] = await Promise.all([
      supabase.from('summary_import').select('*'),
      supabase.from('leaderboard').select('*')
    ]);

    if (summaryResult.error) throw summaryResult.error;
    if (leaderboardResult.error) throw leaderboardResult.error;

    // Find user in summary data
   // Find user in summary data
userData = summaryResult.data.find(u => 
  u.student_name && u.student_name.toUpperCase().includes(name.toUpperCase())
) || { student_name: name.toUpperCase(), quest_list: "", video_list: "", story_list: "" }; // Default object

// üîç NEW LOG HERE
console.log("üîç INITIAL quest_list received:", userData.quest_list);
// Strict EXACT match ‚Äî no normalization
const profileUser = leaderboardResult.data.find(u =>
  u.Name &&
  u.Name.trim().toLowerCase() === name.trim().toLowerCase()
);

userProfileData = profileUser || {
  Name: name,
  Correct: 0,
  Wrong: 0,
  "Total Time (s)": 0,
  Rank: "-"
};


console.log("Loaded userProfileData (fetchInitialData):", userProfileData);
    // Cache results
    localStorage.setItem('cachedUserData', JSON.stringify(userData));
    localStorage.setItem('cachedProfileData', JSON.stringify(userProfileData));

  } catch (err) {
    console.error('Error loading initial data:', err);
    showModal('Error loading data. Please check your connection and try again.', () => {
      document.getElementById('loadingScreen').classList.remove('show');
      document.getElementById('nameInputContainer').classList.add('show');
    });
  }
}

/**
 * Refreshes data in the background without a loading screen.
 */
async function refreshData(name) {
  if (!name) return;
  console.log("Refreshing data in background for:", name);
  try {
    const [summaryResult, leaderboardResult] = await Promise.all([
      supabase.from('summary_import').select('*'),
      supabase.from('leaderboard').select('*')
    ]);

    if (summaryResult.error) throw summaryResult.error;
    if (leaderboardResult.error) throw leaderboardResult.error;

    // Find user in summary data
    const summaryUser = summaryResult.data.find(u => 
      u.student_name && u.student_name.toUpperCase().includes(name.toUpperCase())
    );
    if (summaryUser) {
      userData = summaryUser;
       console.log("üîç SUMMARY quest_list received:", summaryUser.quest_list);
      localStorage.setItem('cachedUserData', JSON.stringify(userData));
    }

    // Find user in leaderboard data
// Strict EXACT match ‚Äî no uppercase, no startsWith
const profileUser = leaderboardResult.data.find(u =>
  u.Name &&
  u.Name.trim().toLowerCase() === name.trim().toLowerCase()
);

if (profileUser) {
  userProfileData = profileUser;
  localStorage.setItem('cachedProfileData', JSON.stringify(userProfileData));
}
  
console.log("Loaded userProfileData (refreshData):", userProfileData);
    // Update UI with new data
    updateAllUI();

  } catch (err) {
    console.error('Error refreshing data:', err);
    // Don't show modal, just log error and keep using cached data
    document.getElementById('offlineBanner').classList.add('show');
  }
}


function setupEventListeners() {
  document.getElementById('profileIcon').addEventListener('click', toggleDrawer);
  document.getElementById('closeDrawer').addEventListener('click', toggleDrawer);
  document.getElementById('overlay').addEventListener('click', toggleDrawer);
 
  window.addEventListener('beforeunload', syncData);
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);

  document.addEventListener('visibilitychange', async () => {
    if (document.hidden) {
      syncData();
    } else {
      sessionStartTime = Date.now();
      // Refresh data when user returns to tab
      const savedName = localStorage.getItem("userName");
      if (savedName) {
        refreshData(savedName); 
      }
    }
  });
  
  // Removed session time tracking interval, handled by syncData on close

  document.getElementById('modalConfirm').addEventListener('click', () => {
    if (window.confirmCallback) {
      window.confirmCallback();
    }
    document.getElementById('customModal').classList.remove('show');
    window.confirmCallback = null;
  });

  document.getElementById('modalCancel').addEventListener('click', () => {
    document.getElementById('customModal').classList.remove('show');
    window.confirmCallback = null;
  });

  document.getElementById("leaderboardIcon").onclick = () => {
    window.location.href = "https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/leaderboard_live";
  };
  document.getElementById("elllIcon").onclick = () => {
    window.location.href = "https://andrewveda.github.io/Quiz/";
  };
}


function showModal(message, onConfirm) {
  const modal = document.getElementById('customModal');
  document.getElementById('modalMessage').textContent = message;
  modal.classList.add('show');
  window.confirmCallback = onConfirm;
}

function toggleDrawer() {
  const drawer = document.getElementById('profileDrawer');
  const overlay = document.getElementById('overlay');

  drawer.classList.toggle('open');
  overlay.classList.toggle('active');

  // Update name in drawer when opened (it might have been "Loading...")
  if (drawer.classList.contains('open')) {
    updateProfileDrawer();
  }
}


async function saveAndLogin() {
  const name = document.getElementById('nameInput').value.trim();
  if (!name) {
    showModal('Please enter your name!', () => {});
    return;
  }
 
  const upperCaseName = name.toUpperCase();
  localStorage.setItem('userName', upperCaseName);
 
  document.getElementById('nameInputContainer').classList.remove('show');
  document.getElementById('loadingScreen').classList.add('show');

  // Perform the first-time data fetch
  await fetchInitialData(upperCaseName);
  
  showCalendar();
  
  document.getElementById('loadingScreen').classList.remove('show');
}


function showCalendar() {
  document.getElementById('calendarContainer').classList.add('show');
  document.getElementById('profileIcon').classList.add('show');
  
  // Update all UI components that depend on data
  updateAllUI();
}
  
async function loadTotalTime(name) {
  const { data, error } = await supabase
    .from('report_card_view')
    .select('*')
    .ilike('name', `${name}%`);  

  if (error) {
    console.error("Error loading total_time:", error);
    return 0;
  }

  if (!data || data.length === 0) return 0;

  return data[0].total_time || 0;
}
  function toggleTimeMode() {
  showHHMMSS = !showHHMMSS;
  updateMiniPowerDeck();
}
window.toggleTimeMode = toggleTimeMode;
  async function updateMiniPowerDeck() {
  if (!userData || !userProfileData) return;
    
  const questCount = parseList(userData.quest_list).length;
  const videoCount = parseList(userData.video_list).length;
  const storyCount = parseList(userData.story_list).length;
  console.log("MiniDeck profile data:", userProfileData);
  console.log("total_time field value:", userProfileData?.total_time);
  // ‚≠ê The correct field from your Supabase report_card_view
 const totalTimeSeconds = await loadTotalTime(userProfileData.Name);
  // Convert to human-friendly m/s
  const minutes = Math.floor(totalTimeSeconds / 60);
  const seconds = totalTimeSeconds % 60;
let formattedTime;

if (!showHHMMSS) {
  formattedTime = `${totalTimeSeconds}s`;
} else {
  const h = Math.floor(totalTimeSeconds / 3600);
  const m = Math.floor((totalTimeSeconds % 3600) / 60);
  const s = totalTimeSeconds % 60;

  formattedTime =
    `${h.toString().padStart(2, '0')}h ` +
    `${m.toString().padStart(2, '0')}m ` +
    `${s.toString().padStart(2, '0')}s`;
}
  const text = `
    üìù ${questCount} &nbsp;&nbsp;&nbsp;
    üé• ${videoCount} &nbsp;&nbsp;&nbsp;
    üìö ${storyCount} &nbsp;&nbsp;&nbsp;
    ‚è±Ô∏è ${formattedTime}
  `;

  const topEl = document.getElementById("miniPowerDeckTop");
  if (topEl) topEl.innerHTML = text;
}


  function updateAllUI() {
  if (!userData || !userProfileData) return;
  
  const displayName = userProfileData?.Name || userData?.student_name || 'Unknown';
  document.getElementById('userName').textContent = displayName;

  updateProfileDrawer();
  updateMiniPowerDeck();
  renderCalendar(currentMonth, currentYear, currentType);
}

function parseList(raw) {
  if (!raw) return [];
  return raw
    .split(",")
    .map(x => x.trim())
    .filter(x => x.length > 0)
    .map(x => x.replace(/\s+/g, "").toLowerCase()); // Normalize: "Quest 1" -> "quest1"
}

/**
 * Updates the Profile Drawer (now just the name).
 */
function updateProfileDrawer() {
  if (!userData && !userProfileData) return;

  const name =
    userProfileData?.Name ||
    userData?.student_name ||
    "User";

  document.getElementById("drawerUserName").textContent = name;
  // All stat-related code removed.
}

/**
 * Updates the Level Dashboard with stats.
 */
// REMOVED entire updateLevelDashboard function
/*
function updateLevelDashboard() {
  if (!userData || !userProfileData) return;
...
  document.getElementById("powerTimeFill").style.width = `${Math.min(100, (timeMin / maxTime) * 100)}%`;
}
*/


function switchType(type) {
  currentType = type;
  document.querySelectorAll('.type-button').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  renderCalendar(currentMonth, currentYear, currentType);
}

function changeMonth(direction) {
  currentMonth += direction;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar(currentMonth, currentYear, currentType);
}

function renderCalendar(month, year, type) {
  // console.group(`üìÖ Calendar Debug ‚Äî ${type.toUpperCase()} ‚Äî ${month+1}/${year}`);
  
  const datesGrid = document.getElementById('datesGrid');
  const monthYear = document.getElementById('monthYear');

  const daysInMonth = new Date(year, month + 1, 0).getDate();
  monthYear.textContent = new Date(year, month).toLocaleString('default', {
    month: 'long'
  }) + ' ' + year;

  datesGrid.innerHTML = '';

  // Pad empty cells
  const firstDayOfMonth = new Date(year, month, 1).getDay();
  for (let i = 0; i < firstDayOfMonth; i++) {
    const empty = document.createElement('div');
    empty.className = 'disabled';
    datesGrid.appendChild(empty);
  }

  // --- 1. GET THE CORRECT LIST (RE-WRITTEN) ---
  // This single block replaces the two separate, complex blocks for
  // getting the challenge string. It's cleaner and handles fallbacks correctly.
  let challengesString = "";

  if (type === "quest") {
      challengesString = userData?.quest_list || userProfileData?.quest_list || userProfileData?.QuestList || "";
  } else if (type === "video") {
      challengesString = userData?.video_list || userProfileData?.video_list || userProfileData?.VideoList || "";
  } else if (type === "story") {
      challengesString = userData?.story_list || userProfileData?.story_list || userProfileData?.StoryList || "";
  }

  // --- 2. NORMALISE THE LIST (done by parseList) ---
  const normalizedList = parseList(challengesString);
  // console.log("‚û° RAW string:", challengesString);
  // console.log("‚û° Normalized List:", normalizedList);

  // --- 3. RENDER DATES ---
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  for (let d = 1; d <= daysInMonth; d++) {
    const currentDate = new Date(year, month, d);

    const diffDays = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
    const questNumber = diffDays >= 0 ? diffDays + 1 : null;

    const dayDiv = document.createElement('div');

    if (!questNumber) {
    dayDiv.className = 'disabled';
    dayDiv.textContent = d;
    datesGrid.appendChild(dayDiv);
    continue;
}
    // Build the name for matching (e.g., "quest47")
    // ORIGINAL BUG: This block always prefixed "video" or "story"
    // const normalizedType =
    //   type === "quest" ? "quest" :
    //   type === "video" ? "video" :
    //   "story";
    // const normalizedQuestName = `${normalizedType}${questNumber}`;

    // MINIMAL FIX: Conditionally add the prefix ONLY for 'quest'
    let normalizedQuestName;

if (type === 'quest') {
    // Quest format ‚Üí "quest1"
    normalizedQuestName = `quest${questNumber}`;
}
else if (type === 'video') {
    // Video stored as "Video 1" ‚Üí becomes "video1"
    normalizedQuestName = `video${questNumber}`;
}
else if (type === 'story') {
    // Story stored as "Story 70" ‚Üí becomes "story70"
    normalizedQuestName = `story${questNumber}`;
}

    // console.log(
    //   `Date: ${d} | Quest#: ${questNumber} | Check: ${normalizedQuestName} | Completed?`,
    //   normalizedList.includes(normalizedQuestName)
    // );

    const isCompleted = normalizedList.includes(normalizedQuestName);

    // --- Apply Classes ---
    if (isCompleted) {
      dayDiv.className = "done";
      dayDiv.textContent = `${d} üî•`;
    } else if (currentDate < today) {
      dayDiv.className = "missed";
      dayDiv.textContent = d;
    } else {
      // This is for today's date if not yet completed
      dayDiv.className = ""; // Today's available quest
      dayDiv.textContent = d;
      // Add a special style for "today"
      dayDiv.style.border = "2px solid #7A0019";
      dayDiv.style.fontWeight = "bold";
    }

    // --- Click Handler ---
    dayDiv.onclick = () => {
      let link = null;

      if (type === "quest") link = questLinks[questNumber];
      else if (type === "video") link = videoLink; // Video link is always the same
      else if (type === "story") link = storyLinks[questNumber];

      if (link) {
        window.location.href = link;
      } else {
        console.warn(`No link found for ${type} ${questNumber}`);
      }
    };

    datesGrid.appendChild(dayDiv);
  }
  // console.groupEnd();
}

async function syncData() {
  if (!userData) return;
 
  const sessionDuration = Math.floor((Date.now() - sessionStartTime) / 1000);
  if (sessionDuration < 10) return; // Don't sync very short sessions
  
  const analyticsData = {
    name: userData.student_name,
    sessionDuration: sessionDuration,
    lastActive: new Date().toISOString(),
    sessionStart: new Date(sessionStartTime).toISOString(),
    isOnline: navigator.onLine,
    department: userProfileData?.Department || userProfileData?.department || 'Unknown'
  };
 
  if (navigator.onLine) {
    try {
      await supabase.from('quest_submissions').insert([
        {
          student_name: analyticsData.name,
          time_spent: analyticsData.sessionDuration,
          quest_id: 'SessionSync',
          department: analyticsData.department
        }
      ]);
    } catch (err) {
      console.error("Error syncing session data:", err);
      savePendingSync(analyticsData); // Save to local if sync fails
    }
  } else {
    savePendingSync(analyticsData);
  }
}

function savePendingSync(data) {
  const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
  pending.push(data);
  localStorage.setItem('pendingSync', JSON.stringify(pending));
}

async function handleOnline() {
  document.getElementById('offlineBanner').classList.remove('show');
 
  const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
  if (pending.length > 0) {
    console.log(`Syncing ${pending.length} offline sessions...`);
    for (const data of pending) {
        try {
          await supabase.from('quest_submissions').insert([
            {
              student_name: data.name,
              time_spent: data.sessionDuration,
              quest_id: 'OfflineSync',
              department: data.department
            }
          ]);
        } catch (err) {
          console.error("Error submitting pending sync:", err);
        }
    }
    localStorage.removeItem('pendingSync');
  }
 
  // Refresh all data now that we are online
  const savedName = localStorage.getItem('userName');
  if (savedName) refreshData(savedName);
}

function handleOffline() {
  document.getElementById('offlineBanner').classList.add('show');
}

function checkOnlineStatus() {
  if (!navigator.onLine) {
    handleOffline();
  }
}

async function trackInstall() {
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    console.log('Install prompt captured');
    // We could log this to Supabase, but will wait for actual install
  });
  
  window.addEventListener('appinstalled', async () => {
    const installData = {
      name: localStorage.getItem('userName') || 'Unknown',
      event: 'app_installed',
      timestamp: new Date().toISOString()
    };
    try {
      await supabase.from('quest_submissions').insert([
        {
          student_name: installData.name,
          quest_id: installData.event,
          time_spent: 0,
          department: 'InstallEvent'
        }
      ]);
    } catch (err) {
      console.error('App install tracking error:', err);
    }
  });
}


function logout() {
  showModal('Are you sure you want to logout?', () => {
    syncData(); // Sync one last time
    localStorage.removeItem('userName');
    localStorage.removeItem('cachedUserData');
    localStorage.removeItem('cachedProfileData');
    // localStorage.removeItem('totalTimeSpent'); // This was session time, no longer needed
    window.location.reload();
  });
}

// IMPORTANT: Expose functions to window so HTML onclick attributes can see them
window.saveAndLogin = saveAndLogin;
window.switchType = switchType;
window.changeMonth = changeMonth;
window.toggleDrawer = toggleDrawer;
window.logout = logout;

// Initialize
supabase
  .channel('leaderboard-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'leaderboard' }, payload => {
    console.log('Leaderboard updated via realtime:', payload);
    const savedName = localStorage.getItem('userName');
    if (savedName) refreshData(savedName); // Refresh data on any change
  })
  .on('postgres_changes', { event: '*', schema: 'public', table: 'summary_import' }, payload => {
    console.log('Summary data updated via realtime:', payload);
    const savedName = localStorage.getItem('userName');
    if (savedName) refreshData(savedName); // Refresh data on any change
  })
  .subscribe();

init();

</script>

<script>
// This script doesn't need module-type, so it's separate.
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('‚úÖ Service worker registered:', reg.scope))
      .catch(err => console.error('‚ùå Service worker registration failed:', err));
  });
}

let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  console.log('üì≤ Install prompt captured');

  if (document.getElementById('installPwaBtn')) return;

  const installBtn = document.createElement('button');
  installBtn.id = 'installPwaBtn';
  installBtn.textContent = 'Install App';
 
  Object.assign(installBtn.style, {
    position: 'fixed',
    bottom: '20px',
    right: '20px',
    padding: '12px 20px',
    background: '#7A0019',
    color: 'white',
    border: 'none',
    borderRadius: '10px',
    cursor: 'pointer',
    zIndex: '9999',
    boxShadow: '0 5px 15px rgba(0,0,0,0.3)',
    fontWeight: '600',
    transition: 'transform 0.2s ease'
  });

  installBtn.onmouseover = () => installBtn.style.transform = 'translateY(-2px)';
  installBtn.onmouseout = () => installBtn.style.transform = 'translateY(0)';

  document.body.appendChild(installBtn);

  installBtn.addEventListener('click', async () => {
    installBtn.remove();
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`User response: ${outcome}`);
    deferredPrompt = null;
  });
});
</script>

<script>
// Quotes carousel script
const quotes = [
  `"Do or do not. There is no try." <br> ‚Äî Yoda`,
  `"Ever tried. Ever failed. No matter. Try again. Fail again. Fail better." <br> ‚Äî Samuel Beckett`,
  `"The opposite of a profound truth may well be another profound truth." <br> ‚Äî Niels Bohr`,
  `"The opposite of a good idea is another good idea." <br> ‚Äî Rory Sutherland`
];


let qIndex = 0;
setInterval(() => {
  const el = document.getElementById("quotesCarousel");
  if (!el) return;
  el.style.opacity = 0;
  setTimeout(() => {
    qIndex = (qIndex + 1) % quotes.length;
    el.innerHTML = `<p>${quotes[qIndex]}</p>`;
    el.style.opacity = 0.9;
  }, 1000);
}, 5000);
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Wordle Blitz ‚ö°</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:#080e1a;--card:#0d1525;--surface:#111e30;--text:#e8f0fe;--muted:#7a93b8;
  --absent:#2a2d35;--present:#c8920a;--correct:#1e8a4a;--danger:#e53935;
  --amber:#ff8f00;--accent:#00c6ff;--gold:#ffd700;--key:#1e2d45;--radius:8px;
  font-family:'Nunito',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);overflow-y:auto;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,198,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,198,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
canvas.fx{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;}
#particleCanvas{z-index:1;}#fireworkCanvas{z-index:4;}#confettiCanvas{z-index:5;}
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;padding:12px;}

/* INTRO */
#introScreen{background:linear-gradient(160deg,#080e1a 0%,#0d1a2e 100%);}
.intro-card{background:var(--card);border:1px solid rgba(0,198,255,0.15);border-radius:24px;padding:50px 40px;max-width:500px;width:100%;text-align:center;box-shadow:0 0 60px rgba(0,198,255,0.08),0 20px 60px rgba(0,0,0,0.5);animation:cardIn 0.7s cubic-bezier(0.34,1.56,0.64,1) forwards;}
@keyframes cardIn{from{opacity:0;transform:translateY(40px) scale(0.9);}to{opacity:1;transform:translateY(0) scale(1);}}
.blitz-logo{font-family:'Rajdhani',sans-serif;font-size:3.2rem;font-weight:700;background:linear-gradient(135deg,#00c6ff,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:2px;margin-bottom:6px;}
.blitz-sub{color:var(--muted);font-size:1rem;margin-bottom:28px;letter-spacing:1px;}
.rule-row{display:flex;align-items:center;gap:12px;margin:10px 0;font-size:1rem;color:#bcd3ef;text-align:left;}
.rule-icon{font-size:1.4rem;width:32px;text-align:center;flex-shrink:0;}
.rule-pts{background:rgba(0,198,255,0.12);border-radius:6px;padding:2px 8px;color:var(--accent);font-weight:700;font-size:0.9rem;margin-left:auto;}
.divider{height:1px;background:rgba(255,255,255,0.07);margin:20px 0;}
#startBtn{margin-top:28px;width:100%;padding:16px;font-family:'Rajdhani',sans-serif;font-size:1.6rem;font-weight:700;background:linear-gradient(135deg,#1e8a4a,#00c6ff);color:white;border:none;border-radius:14px;cursor:pointer;letter-spacing:2px;transition:transform 0.15s,box-shadow 0.15s;box-shadow:0 4px 20px rgba(0,198,255,0.3);}
#startBtn:hover{transform:scale(1.03);box-shadow:0 6px 30px rgba(0,198,255,0.5);}

/* GAME SCREEN ‚Äî flex column that fills the viewport */
#gameScreen{
  display:none;
  justify-content:flex-start;
  padding:8px 10px;
  padding-bottom:max(10px, env(safe-area-inset-bottom));
  gap:6px;
  overflow:hidden;
}
@supports (-webkit-touch-callout:none){#gameScreen{height:-webkit-fill-available;}}

/* Timer */
.timer-area{display:flex;align-items:center;gap:14px;background:var(--card);border:1px solid rgba(255,255,255,0.07);border-radius:16px;padding:8px 16px;width:100%;max-width:460px;flex-shrink:0;}
.timer-arc-wrap{position:relative;width:54px;height:54px;flex-shrink:0;}
#timerArc{transform:rotate(-90deg);}
.timer-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;font-size:1rem;font-weight:700;color:var(--text);transition:color 0.4s;}
.score-area{flex:1;}
.score-label{font-size:0.65rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.score-val{font-family:'Rajdhani',sans-serif;font-size:1.7rem;font-weight:700;color:var(--gold);line-height:1;}
.words-val{font-size:0.75rem;color:var(--muted);margin-top:1px;}
.streak-area{text-align:right;}
.streak-label{font-size:0.65rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.streak-val{font-family:'Rajdhani',sans-serif;font-size:1.3rem;font-weight:700;color:var(--amber);line-height:1;}

/* Board ‚Äî fills remaining height between timer and keyboard */
.board-wrap{
  position:relative;width:100%;max-width:460px;
  flex:1 1 auto;
  min-height:0; /* critical for flex shrink */
  overflow:hidden;
  display:flex;align-items:center;justify-content:center;
}
.board{
  display:grid;
  grid-template-rows:repeat(6,minmax(0,1fr));
  gap:7px;
  width:100%;height:100%;
  max-height:360px;
  transition:none;
}
@keyframes slideOutLeft{from{transform:translateX(0);opacity:1;}to{transform:translateX(-110%);opacity:0;}}
@keyframes slideInRight{from{transform:translateX(110%);opacity:0;}to{transform:translateX(0);opacity:1;}}
.board.slide-out{animation:slideOutLeft 0.35s ease-in forwards;}
.board.slide-in{animation:slideInRight 0.35s ease-out forwards;}
.row{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;}
.row.active-row{filter:drop-shadow(0 0 7px rgba(0,198,255,0.35));animation:rowPulse 2s ease-in-out infinite;}
@keyframes rowPulse{0%,100%{filter:drop-shadow(0 0 5px rgba(0,198,255,0.25));}50%{filter:drop-shadow(0 0 14px rgba(0,198,255,0.6));}}
.tile{display:flex;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:clamp(15px,4.2vw,22px);border-radius:var(--radius);background:#0e1928;color:var(--text);border:1px solid rgba(255,255,255,0.06);aspect-ratio:1;}
@keyframes tilePop{0%{transform:scale(1)}40%{transform:scale(1.18)}80%{transform:scale(0.94)}100%{transform:scale(1)}}
@keyframes tileFlip{0%{transform:rotateX(0)}50%{transform:rotateX(-90deg)}100%{transform:rotateX(0)}}
@keyframes tileShake{0%,100%{transform:translateX(0)}15%{transform:translateX(-7px)}30%{transform:translateX(7px)}45%{transform:translateX(-4px)}60%{transform:translateX(4px)}75%{transform:translateX(-2px)}90%{transform:translateX(2px)}}
@keyframes tileJump{0%,100%{transform:translateY(0) scale(1)}30%{transform:translateY(-16px) scale(1.1)}65%{transform:translateY(-6px) scale(1.03)}}
.tile.pop{animation:tilePop 0.18s ease-out;}
.tile.flip{animation:tileFlip 0.48s ease-in-out forwards;}
.tile.shake{animation:tileShake 0.45s ease-out;background:#2a1010!important;}
.tile.jump{animation:tileJump 0.55s ease-out;}
.tile.absent{background:var(--absent);border-color:transparent;}
.tile.present{background:var(--present);border-color:transparent;}
.tile.correct{background:var(--correct);border-color:transparent;}

/* Keyboard ‚Äî tall keys, easy to tap */
.keyboard{display:flex;flex-direction:column;gap:7px;width:100%;max-width:460px;flex-shrink:0;}
.krow{display:flex;gap:5px;justify-content:center;}
.key{
  flex:1;
  padding:18px 0;          /* tall touch target */
  border-radius:9px;text-align:center;user-select:none;
  background:#2e4a6e;color:#ffffff;
  font-family:'Rajdhani',sans-serif;font-weight:700;
  font-size:clamp(1rem,3.2vw,1.35rem);
  cursor:pointer;border:1px solid rgba(255,255,255,0.18);
  box-shadow:0 4px 0 rgba(0,0,0,0.45),inset 0 1px 0 rgba(255,255,255,0.12);
  transition:background-color 0.35s ease,transform 0.1s ease,box-shadow 0.1s ease;
  position:relative;overflow:hidden;
  text-shadow:0 1px 2px rgba(0,0,0,0.5);letter-spacing:0.5px;min-width:0;
}
.key:active,.key.pressed{transform:scale(0.88) translateY(2px);box-shadow:0 1px 0 rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.08);}
.key .ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,0.25);width:60px;height:60px;margin:-30px 0 0 -30px;transform:scale(0);animation:rippleA 0.4s linear;pointer-events:none;}
@keyframes rippleA{to{transform:scale(3.5);opacity:0;}}
.key.wide{flex:1.6;}
.key.k-enter{background:linear-gradient(135deg,#1a7a42,#22c55e);border-color:rgba(34,197,94,0.5);color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.4);animation:enterGlow 2.5s ease-in-out infinite;font-size:clamp(0.8rem,2.4vw,1.05rem);letter-spacing:0;}
@keyframes enterGlow{0%,100%{box-shadow:0 4px 0 rgba(0,0,0,0.45),0 0 8px rgba(34,197,94,0.4)}50%{box-shadow:0 4px 0 rgba(0,0,0,0.45),0 0 22px rgba(34,197,94,0.85),0 0 40px rgba(34,197,94,0.3)}}
.key.k-back{background:linear-gradient(135deg,#9b1c1c,#ef4444);border-color:rgba(239,68,68,0.4);box-shadow:0 4px 0 rgba(0,0,0,0.45),inset 0 1px 0 rgba(255,255,255,0.12);}

/* Bottom bar: hint + skip in one row */
.bottom-bar{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:460px;min-height:22px;flex-shrink:0;}
.hint-bar{font-size:12px;color:#9fb7db;flex:1;text-align:center;}
.skip-btn{font-size:11px;color:var(--muted);background:none;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:3px 10px;cursor:pointer;transition:color 0.2s,border-color 0.2s;flex-shrink:0;}
.skip-btn:hover{color:var(--text);border-color:rgba(255,255,255,0.3);}


#solvedFlash{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;z-index:30;opacity:0;}
.solved-word{font-family:'Rajdhani',sans-serif;font-size:3.5rem;font-weight:700;color:var(--gold);letter-spacing:4px;text-shadow:0 0 30px rgba(255,215,0,0.6);}
.solved-word.failed{color:var(--danger);text-shadow:0 0 30px rgba(229,57,53,0.7);}
.solved-pts{font-family:'Rajdhani',sans-serif;font-size:2rem;font-weight:700;color:#00c6ff;margin-top:6px;}
.solved-pts.failed{color:#ff6b6b;}
@keyframes solvedIn{0%{opacity:0;transform:scale(0.5)}40%{opacity:1;transform:scale(1.15)}70%{transform:scale(0.95)}100%{opacity:1;transform:scale(1)}}
@keyframes solvedOut{to{opacity:0;transform:scale(1.3)}}
.time-bonus-flash{position:fixed;top:80px;right:20px;font-family:'Rajdhani',sans-serif;font-size:1.6rem;font-weight:700;color:#00e676;pointer-events:none;z-index:40;animation:bonusFly 1.2s ease-out forwards;}
@keyframes bonusFly{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-60px)}}

/* END SCREEN */
#endScreen{display:none;overflow-y:auto;}
.end-card{background:var(--card);border:1px solid rgba(255,215,0,0.15);border-radius:24px;padding:36px 32px;max-width:480px;width:100%;box-shadow:0 0 60px rgba(255,215,0,0.08),0 20px 60px rgba(0,0,0,0.6);animation:cardIn 0.6s cubic-bezier(0.34,1.4,0.64,1) forwards;max-height:90vh;overflow-y:auto;}
.end-title{font-family:'Rajdhani',sans-serif;font-size:2.8rem;font-weight:700;text-align:center;color:var(--gold);text-shadow:0 0 20px rgba(255,215,0,0.4);animation:scaleIn 0.7s cubic-bezier(0.34,1.56,0.64,1) forwards;}
@keyframes scaleIn{from{transform:scale(0.2);opacity:0}60%{transform:scale(1.15);opacity:1}80%{transform:scale(0.95)}to{transform:scale(1)}}
.end-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:20px 0;}
.stat-box{background:var(--surface);border-radius:12px;padding:14px 8px;text-align:center;border:1px solid rgba(255,255,255,0.06);}
.stat-num{font-family:'Rajdhani',sans-serif;font-size:2.2rem;font-weight:700;color:var(--accent);line-height:1;}
.stat-lbl{font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px;}
.words-list{margin:16px 0;}
.words-list-title{font-size:0.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.word-entry{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;background:var(--surface);margin-bottom:6px;border:1px solid rgba(255,255,255,0.05);animation:entryIn 0.4s ease backwards;}
@keyframes entryIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
.word-entry .we-word{font-family:'Rajdhani',sans-serif;font-size:1.3rem;font-weight:700;color:var(--text);letter-spacing:2px;min-width:60px;}
.word-entry .we-grid{font-size:0.9rem;letter-spacing:1px;flex:1;}
.word-entry .we-pts{font-family:'Rajdhani',sans-serif;font-size:1.1rem;font-weight:700;color:var(--gold);white-space:nowrap;}
.end-name-row{display:flex;flex-direction:column;gap:8px;margin:16px 0;}
#playerIdentity{font-family:'Rajdhani',sans-serif;font-size:1.4rem;font-weight:700;color:var(--gold);letter-spacing:1px;margin-top:4px;transition:transform 0.25s ease,opacity 0.25s ease;}
.end-name-row input{padding:11px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:var(--surface);color:var(--text);font-size:15px;font-family:'Nunito',sans-serif;outline:none;transition:border-color 0.2s;}
.end-name-row input:focus{border-color:var(--accent);}
.end-name-row p{font-size:14px;color:var(--muted);text-align:center;}
.btn-row{display:flex;gap:10px;flex-wrap:wrap;}
.btn{flex:1;padding:14px 10px;border:none;border-radius:12px;font-family:'Rajdhani',sans-serif;font-size:1.1rem;font-weight:700;letter-spacing:1px;cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;}
.btn:hover{transform:scale(1.04);}
.btn-primary{background:linear-gradient(135deg,#1e8a4a,#00c6ff);color:white;box-shadow:0 4px 16px rgba(0,198,255,0.25);}
.btn-secondary{background:var(--surface);color:var(--text);border:1px solid rgba(255,255,255,0.1);}
.btn-wa{background:linear-gradient(135deg,#128c7e,#25d366);color:white;}
#fallbackDept{padding:11px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:var(--surface);color:var(--text);font-size:15px;font-family:'Nunito',sans-serif;outline:none;}
#fallbackDept:focus{border-color:var(--accent);}

.timer-area.amber .timer-text{color:var(--amber);}
.timer-area.danger .timer-text{color:var(--danger);animation:timerPulse 0.6s ease-in-out infinite;}
.timer-area.frantic .timer-text{color:var(--danger);animation:timerPulse 0.3s ease-in-out infinite;}
@keyframes timerPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

@media(max-width:380px){
  .blitz-logo{font-size:2rem;}
  .intro-card,.end-card{padding:24px 14px;}
  .end-title{font-size:1.9rem;}
  .stat-num{font-size:1.6rem;}
  .timer-arc-wrap{width:46px;height:46px;}
  .score-val{font-size:1.4rem;}
}
</style>
</head>
<body>

<canvas id="particleCanvas" class="fx"></canvas>
<canvas id="fireworkCanvas" class="fx"></canvas>
<canvas id="confettiCanvas" class="fx"></canvas>
<canvas id="statsCanvas" style="display:none;"></canvas>

<div id="solvedFlash">
  <div class="solved-word" id="solvedWordText"></div>
  <div class="solved-pts"  id="solvedPtsText"></div>
</div>

<!-- INTRO -->
<div class="screen" id="introScreen">
  <div class="intro-card">
    <div class="blitz-logo">‚ö° WORDLE BLITZ</div>
    <div class="blitz-sub">SPEED ROUND ¬∑ 5 MINUTES</div>
    <div class="divider"></div>
    <div class="rule-row"><span class="rule-icon">‚è±Ô∏è</span> 5 minute countdown ‚Äî solve as many words as you can!</div>
    <div class="rule-row"><span class="rule-icon">üéØ</span> Fewer guesses = more points<span class="rule-pts">1 try = 6 pts</span></div>
    <div class="rule-row"><span class="rule-icon">‚ö°</span> Solve fast for speed bonus<span class="rule-pts">+3 pts &lt;20s</span></div>
    <div class="rule-row"><span class="rule-icon">‚è∞</span> Fewer guesses = more time back<span class="rule-pts">+15s on 1 try</span></div>
    <div class="rule-row"><span class="rule-icon">üü©</span> Green = right place ¬∑ üü® Yellow = wrong place ¬∑ ‚¨õ Absent</div>
    <div class="divider"></div>
    <button id="startBtn">‚ö° START BLITZ</button>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="gameScreen">
  <div class="timer-area" id="timerArea">
    <div class="timer-arc-wrap">
      <!-- r=22 ‚Üí circumference = 2*PI*22 = 138.23 -->
      <svg id="timerArc" width="54" height="54" viewBox="0 0 54 54">
        <circle cx="27" cy="27" r="22" fill="none" stroke="rgba(255,255,255,0.07)" stroke-width="5"/>
        <circle id="arcPath" cx="27" cy="27" r="22" fill="none" stroke="#00c6ff" stroke-width="5"
          stroke-dasharray="138.2" stroke-dashoffset="0" stroke-linecap="round"
          style="transition:stroke-dashoffset 1s linear,stroke 0.5s ease;"/>
      </svg>
      <div class="timer-text" id="timerText">5:00</div>
    </div>
    <div class="score-area">
      <div class="score-label">Score</div>
      <div class="score-val" id="scoreVal">0</div>
      <div class="words-val" id="wordsVal">0 words solved</div>
    </div>
    <div class="streak-area">
      <div class="streak-label">Word #</div>
      <div class="streak-val" id="wordNumVal">1</div>
    </div>
  </div>

  <div class="board-wrap">
    <div id="board" class="board"></div>
  </div>

  <div class="keyboard" id="keyboard"></div>

  <div class="bottom-bar">
    <div class="hint-bar" id="hint"></div>
    <button class="skip-btn" id="skipBtn">‚è≠ Skip</button>
  </div>
</div>

<!-- END -->
<div class="screen" id="endScreen">
  <div class="end-card">
    <div class="end-title" id="endTitle">‚è±Ô∏è TIME'S UP!</div>
    <div class="end-stats">
      <div class="stat-box"><div class="stat-num" id="endScore">0</div><div class="stat-lbl">Score</div></div>
      <div class="stat-box"><div class="stat-num" id="endWords">0</div><div class="stat-lbl">Words</div></div>
      <div class="stat-box"><div class="stat-num" id="endAvg">‚Äì</div><div class="stat-lbl">Avg Tries</div></div>
    </div>
    <div class="words-list">
      <div class="words-list-title">Words Solved</div>
      <div id="wordsList"></div>
    </div>
    <div class="end-name-row">
      <div id="playerIdentity"></div>
      <input id="fallbackName" type="text" placeholder="Enter your name"/>
      <select id="fallbackDept">
        <option value="">-- Select Department --</option>
        <option>Cyber Security</option><option>EIE</option>
        <option>CSE-1</option><option>CSE-2</option><option>CSE-3</option>
        <option>Mechanical Engineering</option>
        <option>ECE-1</option><option>ECE-2</option><option>ECE-3</option>
        <option>AI DS-1</option><option>AI DS-2</option>
        <option>Agri and Civil</option><option>EEE</option>
        <option>Medical Electronics</option>
        <option>IT-1</option><option>IT-2</option>
      </select>
      <p id="leaderboardText"></p>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" id="playAgainBtn">‚ö° Play Again</button>
      <button class="btn btn-wa"      id="shareBtn">üì≤ WhatsApp</button>
      <button class="btn btn-secondary" id="leaderboardBtn">üèÜ Leaderboard</button>
    </div>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ */
const EDGE_URL = "https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/submit-quest";
const CSV_URL  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5Z6lmXH4jxHYMKUcimj_M-IV1pwtBUF72YKJIi_BO-KD_NYwWBJBQqni7m4NmQyU9NMdve4vGZ7rh/pub?gid=0&single=true&output=csv';
const NAME_KEY = "questPlayerName";
const DEPT_KEY = "questPlayerDept";
const TOTAL_TIME = 300;
const ARC_FULL   = 138.2; // 2*PI*22

const startBtn = document.getElementById('startBtn');
startBtn.disabled = true;
startBtn.textContent = "Loading words...";
startBtn.style.opacity = "0.6";

let WORDS = [], WORD_SET = new Set(), wordQueue = [], gameActive = false;
let timeLeft = TOTAL_TIME, timerInterval = null;
let score = 0, wordsSolved = 0, wordAttempts = 0, wordStartTime = 0, gameStartTime = 0;
let currentWord = '', guesses = [], currentInput = '';
let solvedLog = [];
let accepting = true, transitioning = false;
let totalAttempts = 0, perfectSolves = 0, fastestSolveSec = 999;
let totalTimeBonus = 0, longestStreak = 0, currentStreak = 0;
let _frozenStats = null;

/* Safety watchdog */
setInterval(()=>{
  if(gameActive && !accepting && !transitioning){ console.warn("‚ö†Ô∏è Watchdog unlock"); accepting=true; }
},2500);

/* ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ */
(function(){
  const c=document.getElementById('particleCanvas'),ctx=c.getContext('2d');
  let W,H,pts=[];
  function resize(){W=c.width=innerWidth;H=c.height=innerHeight;}
  resize();addEventListener('resize',resize);
  for(let i=0;i<50;i++)pts.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.8+0.4,dx:(Math.random()-.5)*.3,dy:-(Math.random()*.35+.08),a:Math.random()*.45+.1,col:Math.random()>.5?'0,198,255':'255,215,0'});
  (function loop(){ctx.clearRect(0,0,W,H);pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle=`rgba(${p.col},${p.a})`;ctx.fill();p.x+=p.dx;p.y+=p.dy;if(p.y<-5){p.y=H+5;p.x=Math.random()*W;}if(p.x<-5)p.x=W+5;if(p.x>W+5)p.x=-5;});requestAnimationFrame(loop);})();
})();

/* ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ */
const confC=document.getElementById('confettiCanvas'),confCtx=confC.getContext('2d');
let confPts=[],confRunning=false;
function resizeConf(){confC.width=innerWidth;confC.height=innerHeight;}resizeConf();addEventListener('resize',resizeConf);
function launchConfetti(){
  confRunning=true;confPts=[];
  const cols=['#1e8a4a','#c8920a','#ffffff','#00c6ff','#ff8f00','#e91e63','#7c4dff'];
  for(let i=0;i<180;i++){const a=Math.random()*Math.PI*2,s=Math.random()*10+3;confPts.push({x:confC.width/2,y:confC.height*.4,vx:Math.cos(a)*s,vy:Math.sin(a)*s-6,c:cols[Math.floor(Math.random()*cols.length)],w:Math.random()*11+4,h:Math.random()*5+2,rot:Math.random()*Math.PI*2,drot:(Math.random()-.5)*.28,g:.38,a:1,f:Math.random()*.01+.007});}
  (function loop(){if(!confRunning)return;confCtx.clearRect(0,0,confC.width,confC.height);confPts=confPts.filter(p=>p.a>0);if(!confPts.length){confRunning=false;return;}confPts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=p.g;p.vx*=.99;p.rot+=p.drot;p.a-=p.f;confCtx.save();confCtx.globalAlpha=Math.max(0,p.a);confCtx.translate(p.x,p.y);confCtx.rotate(p.rot);confCtx.fillStyle=p.c;confCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);confCtx.restore();});requestAnimationFrame(loop);})();
}

/* ‚îÄ‚îÄ FIREWORKS ‚îÄ‚îÄ */
const fwC=document.getElementById('fireworkCanvas'),fwCtx=fwC.getContext('2d');
let fwPts=[],fwRunning=false;
function resizeFw(){fwC.width=innerWidth;fwC.height=innerHeight;}resizeFw();addEventListener('resize',resizeFw);
function launchFireworks(cx,cy){
  fwRunning=true;
  const burst=(x,y,col)=>{for(let i=0;i<55;i++){const a=(i/55)*Math.PI*2,s=Math.random()*6+2;fwPts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,col,a:1,f:.018,r:Math.random()*2.5+.8,g:.07,tail:[]});}};
  burst(cx,cy,'#1e8a4a');setTimeout(()=>burst(cx-100,cy-30,'#ffd700'),220);setTimeout(()=>burst(cx+100,cy-30,'#00c6ff'),420);
  if(!fwRunning)(function loop(){if(!fwRunning)return;fwCtx.clearRect(0,0,fwC.width,fwC.height);fwPts=fwPts.filter(p=>p.a>0);if(!fwPts.length){fwRunning=false;return;}fwPts.forEach(p=>{p.tail.push({x:p.x,y:p.y,a:p.a});if(p.tail.length>5)p.tail.shift();p.x+=p.vx;p.y+=p.vy;p.vy+=p.g;p.vx*=.97;p.a-=p.f;p.tail.forEach((t,i)=>{fwCtx.beginPath();fwCtx.arc(t.x,t.y,p.r*(i/p.tail.length)*.5,0,Math.PI*2);fwCtx.fillStyle=p.col;fwCtx.globalAlpha=t.a*(i/p.tail.length)*.35;fwCtx.fill();});fwCtx.globalAlpha=Math.max(0,p.a);fwCtx.beginPath();fwCtx.arc(p.x,p.y,p.r,0,Math.PI*2);fwCtx.fillStyle=p.col;fwCtx.fill();fwCtx.globalAlpha=1;});requestAnimationFrame(loop);})();
  else fwRunning=true;
}

/* ‚îÄ‚îÄ CSV ‚îÄ‚îÄ */
function parseCSV(txt){
  const lines=txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  return Array.from(new Set(lines.map(l=>l.split(/,|\t/)[0].trim().toLowerCase()))).filter(w=>/^[a-z]{5}$/.test(w));
}
function shuffleArray(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

/* ‚îÄ‚îÄ STATS IMAGE ‚îÄ‚îÄ */
function generateStatsImage(s,playerName,playerDept){
  const canvas=document.getElementById('statsCanvas'),ctx=canvas.getContext('2d');
  canvas.width=1080;canvas.height=1920;
  const bg=ctx.createLinearGradient(0,0,0,canvas.height);bg.addColorStop(0,'#080e1a');bg.addColorStop(1,'#0d1a2e');
  ctx.fillStyle=bg;ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='rgba(0,198,255,0.03)';ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
  for(let y=0;y<canvas.height;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
  ctx.font='bold 80px Rajdhani,sans-serif';
  const tg=ctx.createLinearGradient(0,0,canvas.width,0);tg.addColorStop(0,'#00c6ff');tg.addColorStop(1,'#ffd700');
  ctx.fillStyle=tg;ctx.textAlign='center';ctx.fillText('‚ö° WORDLE BLITZ',canvas.width/2,120);
  ctx.font='32px Nunito,sans-serif';ctx.fillStyle='#7a93b8';ctx.fillText('5-MINUTE SPEED CHALLENGE',canvas.width/2,180);
  if(playerName&&playerDept){ctx.font='bold 40px Rajdhani,sans-serif';ctx.fillStyle='#ffd700';ctx.fillText(`üë§ ${playerName} ¬∑ ${playerDept}`,canvas.width/2,250);}
  const bY=320;ctx.fillStyle='rgba(13,21,37,0.8)';ctx.strokeStyle='rgba(0,198,255,0.3)';ctx.lineWidth=3;
  rrect(ctx,60,bY,canvas.width-120,300,20);ctx.fill();ctx.stroke();
  ctx.font='bold 120px Rajdhani,sans-serif';ctx.fillStyle='#ffd700';ctx.fillText(s.score,canvas.width/2,bY+130);
  ctx.font='32px Nunito,sans-serif';ctx.fillStyle='#7a93b8';ctx.fillText('TOTAL SCORE',canvas.width/2,bY+175);
  const sY=bY+250;ctx.font='bold 48px Rajdhani,sans-serif';ctx.fillStyle='#00c6ff';
  ctx.fillText(s.wordsSolved,canvas.width/2-250,sY);ctx.fillText(s.failedCount,canvas.width/2+250,sY);
  ctx.font='20px Nunito,sans-serif';ctx.fillStyle='#7a93b8';ctx.fillText('SOLVED',canvas.width/2-250,sY+35);ctx.fillText('FAILED',canvas.width/2+250,sY+35);
  const mY=680,ms=[{label:'Perfect Solves',value:s.perfectSolves,emoji:'üéØ'},{label:'Longest Streak',value:s.longestStreak,emoji:'üî•'},{label:'Fastest Solve',value:s.fastestSolveSec>0?s.fastestSolveSec+'s':'N/A',emoji:'‚ö°'},{label:'Time Bonus',value:'+'+s.totalTimeBonus+'s',emoji:'‚è∞'},{label:'Avg Attempts',value:s.wordsSolved>0?(s.totalAttempts/s.wordsSolved).toFixed(1):'N/A',emoji:'üìä'},{label:'Time Played',value:Math.floor(s.timeSpent/60)+'m '+(s.timeSpent%60)+'s',emoji:'‚è±Ô∏è'}];
  const nc=2,nr=Math.ceil(ms.length/nc),mW=450,mH=130,gX=80,gY=40,sX=(canvas.width-(nc*mW+(nc-1)*gX))/2;
  ms.forEach((m,i)=>{const col=i%nc,row=Math.floor(i/nc),x=sX+col*(mW+gX),y=mY+row*(mH+gY);ctx.fillStyle='rgba(17,30,48,0.8)';ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=2;rrect(ctx,x,y,mW,mH,15);ctx.fill();ctx.stroke();ctx.font='40px sans-serif';ctx.textAlign='left';ctx.fillText(m.emoji,x+25,y+65);ctx.font='bold 48px Rajdhani,sans-serif';ctx.fillStyle='#00c6ff';ctx.textAlign='right';ctx.fillText(String(m.value),x+mW-25,y+60);ctx.font='18px Nunito,sans-serif';ctx.fillStyle='#7a93b8';ctx.textAlign='right';ctx.fillText(m.label.toUpperCase(),x+mW-25,y+90);});
  const gY2=mY+nr*(mH+gY)+70;ctx.font='28px Nunito,sans-serif';ctx.fillStyle='#7a93b8';ctx.textAlign='center';ctx.fillText('SOLVED WORDS',canvas.width/2,gY2);
  s.solvedLog.filter(e=>!e.failed).slice(0,5).forEach((entry,i)=>{const wy=gY2+60+i*80;ctx.font='bold 36px Rajdhani,sans-serif';ctx.fillStyle='#e8f0fe';ctx.textAlign='left';ctx.fillText(entry.word.toUpperCase(),100,wy);ctx.font='32px monospace';ctx.textAlign='center';ctx.fillText(entry.grid.split('\n')[0],canvas.width/2+50,wy);ctx.font='bold 32px Rajdhani,sans-serif';ctx.fillStyle='#ffd700';ctx.textAlign='right';ctx.fillText('+'+entry.pts+' pts',canvas.width-100,wy);});
  ctx.font='26px Nunito,sans-serif';ctx.fillStyle='#7a93b8';ctx.textAlign='center';ctx.fillText('Play at: andrewveda.github.io/SRM-VEC-English-PWA/buttons/wordle',canvas.width/2,canvas.height-80);
  return canvas.toDataURL('image/png');
}
function rrect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}

/* ‚îÄ‚îÄ BOARD ‚îÄ‚îÄ */
function createBoard(){
  const b=document.getElementById('board');b.innerHTML='';
  for(let r=0;r<6;r++){
    const row=document.createElement('div');row.className='row'+(r===0?' active-row':'');
    for(let c=0;c<5;c++){const t=document.createElement('div');t.className='tile';row.appendChild(t);}
    b.appendChild(row);
  }
}
function updateActiveRow(){document.querySelectorAll('#board .row').forEach((r,i)=>r.classList.toggle('active-row',i===guesses.length));}
function renderKeyboard(){
  const kb=document.getElementById('keyboard');kb.innerHTML='';
  ['qwertyuiop','asdfghjkl','zxcvbnm'].forEach(rowStr=>{
    const r=document.createElement('div');r.className='krow';
    for(const ch of rowStr){r.appendChild(mkKey(ch,ch));}
    if(rowStr==='asdfghjkl')r.appendChild(mkKey('‚å´','Backspace','k-back wide'));
    if(rowStr==='zxcvbnm')  r.appendChild(mkKey('ENTER','Enter','k-enter wide'));
    kb.appendChild(r);
  });
}
function mkKey(label,val,extra=''){
  const k=document.createElement('div');k.className='key '+(extra||'');k.textContent=label;k.dataset.key=val;
  k.addEventListener('click',e=>{if(!gameActive||!accepting)return;addRipple(k,e);onKey(val);});
  return k;
}
function addRipple(el,e){
  const rp=document.createElement('span');rp.className='ripple';
  const rect=el.getBoundingClientRect();
  rp.style.left=(e&&e.clientX?(e.clientX-rect.left):rect.width/2)+'px';
  rp.style.top =(e&&e.clientY?(e.clientY-rect.top ):rect.height/2)+'px';
  el.appendChild(rp);setTimeout(()=>rp.remove(),450);
}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
function onKey(k){
  if(!gameActive||!accepting)return;
  if(k==='Enter')return submitGuess();
  if(k==='Backspace'){if(currentInput.length){currentInput=currentInput.slice(0,-1);renderInput();}return;}
  if(currentInput.length<5&&/^[a-zA-Z]$/.test(k)){
    currentInput+=k.toLowerCase();renderInput();
    const row=document.getElementById('board').children[guesses.length];
    if(row){const tile=row.children[currentInput.length-1];if(tile)anim(tile,'pop');}
  }
}
function keydownHandler(e){if(!gameActive||!accepting)return;if(e.key==='Enter'||e.key==='Backspace'||/^[a-zA-Z]$/.test(e.key))onKey(e.key);}
function renderInput(){
  const row=document.getElementById('board').children[guesses.length];if(!row)return;
  for(let c=0;c<5;c++){row.children[c].textContent=currentInput[c]||'';row.children[c].className='tile';}
}
function anim(el,cls,cb){
  el.classList.remove(cls);void el.offsetWidth;el.classList.add(cls);
  if(cb)el.addEventListener('animationend',cb,{once:true});
  else   el.addEventListener('animationend',()=>el.classList.remove(cls),{once:true});
}

function submitGuess(){
  if(!gameActive||!accepting||transitioning)return;
  if(currentInput.length!==5){showHint('Need 5 letters!');shakeRow();return;}
  if(!WORDS.length){showHint('Words still loading...');return;}
  if(!WORD_SET.has(currentInput)){showHint('Not a valid word!');shakeRow();return;}
  accepting=false;
  try{evaluateGuess(currentInput);}catch(e){console.error("‚ùå submitGuess:",e);accepting=true;}
  currentInput='';
}
function shakeRow(){
  const row=document.getElementById('board').children[guesses.length];if(!row)return;
  Array.from(row.children).forEach((t,i)=>setTimeout(()=>anim(t,'shake'),i*25));
}
function showHint(msg){const h=document.getElementById('hint');h.textContent=msg;setTimeout(()=>h.textContent='',2000);}

function evaluateGuess(guess){
  if(!currentWord){console.error("‚ùå no currentWord");accepting=true;return;}
  const row=document.getElementById('board').children[guesses.length];
  if(!row){console.error("‚ùå no row");accepting=true;return;}
  const aArr=currentWord.split(''),gArr=guess.split(''),result=Array(5).fill('absent'),freq={};
  aArr.forEach(c=>freq[c]=(freq[c]||0)+1);
  for(let i=0;i<5;i++)if(gArr[i]===aArr[i]){result[i]='correct';freq[gArr[i]]--;}
  for(let i=0;i<5;i++)if(result[i]!=='correct'&&freq[gArr[i]]>0){result[i]='present';freq[gArr[i]]--;}
  gArr.forEach((ch,i)=>{
    const tile=row.children[i];if(!tile)return;
    tile.textContent=ch;
    setTimeout(()=>{tile.classList.add('flip');tile.addEventListener('animationend',()=>{tile.classList.remove('flip');tile.classList.add(result[i]);},{once:true});},i*110);
  });
  setTimeout(()=>{
    try{
      updateKeyColors(gArr,result);guesses.push(guess);updateActiveRow();
      const won=guess===currentWord,lost=!won&&guesses.length>=6;
      if(won)onWordSolved();else if(lost)onWordFailed();else accepting=true;
    }catch(e){console.error("‚ùå post-eval:",e);accepting=true;}
  },5*110+480);
}

function updateKeyColors(letters,results){
  const kb=document.getElementById('keyboard');
  letters.forEach((ch,i)=>{
    kb.querySelectorAll('[data-key]').forEach(k=>{
      if(k.dataset.key!==ch)return;
      if(results[i]==='correct'){k.style.background='linear-gradient(135deg,#1a7a42,#22c55e)';k.style.borderColor='rgba(34,197,94,0.6)';k.style.color='#fff';}
      else if(results[i]==='present'&&!k.style.background?.includes('22c55e')){k.style.background='linear-gradient(135deg,#92600a,#f59e0b)';k.style.borderColor='rgba(245,158,11,0.5)';k.style.color='#fff';}
      else if(results[i]==='absent'&&!k.style.background){k.style.background='#1a1f2b';k.style.borderColor='rgba(255,255,255,0.06)';k.style.color='#4a5568';}
    });
  });
}

/* ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ */
function calcScore(tries,sec){const base=[0,6,5,4,3,2,1][tries]||0;return base+(sec<20?3:sec<40?1:0);}
function calcTimeBonus(tries){return[0,15,10,7,5,3,0][tries]||0;}
function buildGrid(word,guessList){
  return guessList.map(g=>{
    const a=word.split(''),gg=g.split(''),res=Array(5).fill('‚¨ú'),f={};
    a.forEach(c=>f[c]=(f[c]||0)+1);
    for(let i=0;i<5;i++)if(gg[i]===a[i]){res[i]='üü©';f[gg[i]]--;}
    for(let i=0;i<5;i++)if(res[i]==='‚¨ú'&&f[gg[i]]>0){res[i]='üü®';f[gg[i]]--;}
    return res.join('');
  }).join('\n');
}

/* ‚îÄ‚îÄ WORD SOLVED ‚îÄ‚îÄ */
function onWordSolved(){
  const elapsed=Math.round((Date.now()-wordStartTime)/1000),tries=guesses.length;
  totalAttempts+=tries;if(tries===1)perfectSolves++;
  fastestSolveSec=Math.min(fastestSolveSec,elapsed);
  const bonus=calcTimeBonus(tries);totalTimeBonus+=bonus;
  currentStreak++;longestStreak=Math.max(longestStreak,currentStreak);
  const pts=calcScore(tries,elapsed);score+=pts;wordsSolved++;wordAttempts+=tries;
  solvedLog.push({word:currentWord,guesses:[...guesses],pts,grid:buildGrid(currentWord,guesses)});
  const row=document.getElementById('board').children[tries-1];
  if(row)Array.from(row.children).forEach((t,i)=>setTimeout(()=>anim(t,'jump'),80+i*80));
  if(bonus>0){timeLeft=Math.min(timeLeft+bonus,TOTAL_TIME);updateArc();showTimeBonusFlash('+'+bonus+'s');}
  document.getElementById('scoreVal').textContent=score;
  document.getElementById('wordsVal').textContent=wordsSolved+' word'+(wordsSolved!==1?'s':'')+' solved';
  const br=document.getElementById('board').getBoundingClientRect();
  launchFireworks(br.left+br.width/2,br.top+br.height/2);setTimeout(launchConfetti,300);
  flashSolved(currentWord.toUpperCase(),pts,bonus);setTimeout(nextWord,1800);
}

function onWordFailed(){
  solvedLog.push({word:currentWord,guesses:[...guesses],pts:0,grid:buildGrid(currentWord,guesses),failed:true});
  currentStreak=0;totalAttempts+=Math.max(1,guesses.length);
  flashSolved(currentWord.toUpperCase(),0,0,true);
  setTimeout(nextWord,1800);
}

/* ‚îÄ‚îÄ NEXT WORD ‚Äî FIX: proper guard ordering ‚îÄ‚îÄ */
function nextWord(){
  if(!gameActive||transitioning)return;
  transitioning=true;accepting=false;
  const boardEl=document.getElementById('board');
  boardEl.classList.add('slide-out');
  boardEl.addEventListener('animationend',()=>{
    try{
      boardEl.classList.remove('slide-out');
      guesses=[];currentInput='';
      loadNextWord();createBoard();renderKeyboard();
      boardEl.classList.add('slide-in');
      document.getElementById('wordNumVal').textContent=wordsSolved+solvedLog.filter(e=>e.failed).length+1;
      boardEl.addEventListener('animationend',()=>{
        boardEl.classList.remove('slide-in');
        accepting=true;transitioning=false;
      },{once:true});
    }catch(e){console.error("‚ùå transition:",e);accepting=true;transitioning=false;}
  },{once:true});
}

function loadNextWord(){
  if(!WORDS.length){console.error("‚ùå WORDS empty");accepting=true;return;}
  if(!wordQueue.length)wordQueue=shuffleArray(WORDS);
  currentWord=wordQueue.pop()||WORDS[Math.floor(Math.random()*WORDS.length)];
  wordStartTime=Date.now();document.getElementById('hint').textContent='';
}

function flashSolved(word,pts,bonus,failed=false){
  const sf=document.getElementById('solvedFlash');
  const sw=document.getElementById('solvedWordText');
  const sp=document.getElementById('solvedPtsText');
  sw.textContent=word;
  sw.className='solved-word'+(failed?' failed':'');
  sp.textContent=failed?'‚úó not solved':'+'+pts+' pts'+(bonus>0?' ¬∑ +'+bonus+'s':'');
  sp.className='solved-pts'+(failed?' failed':'');
  sf.style.animation='';void sf.offsetWidth;
  sf.style.animation='solvedIn 0.45s cubic-bezier(0.34,1.56,0.64,1) forwards';sf.style.opacity='1';
  setTimeout(()=>{sf.style.animation='solvedOut 0.35s ease-in forwards';setTimeout(()=>{sf.style.opacity='0';sf.style.animation='';},350);},1000);
}
function showTimeBonusFlash(text){
  const el=document.createElement('div');el.className='time-bonus-flash';el.textContent=text;
  document.body.appendChild(el);setTimeout(()=>el.remove(),1300);
}

/* ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ */
function updateArc(){
  const offset=ARC_FULL*(1-timeLeft/TOTAL_TIME);
  document.getElementById('arcPath').style.strokeDashoffset=offset;
  document.getElementById('arcPath').style.stroke=timeLeft>90?'#00c6ff':timeLeft>60?'#ff8f00':'#e53935';
  const ta=document.getElementById('timerArea');ta.classList.remove('amber','danger','frantic');
  if(timeLeft<=30)ta.classList.add('frantic');else if(timeLeft<=60)ta.classList.add('danger');else if(timeLeft<=90)ta.classList.add('amber');
}
function formatTime(s){return Math.floor(s/60)+':'+(s%60<10?'0':'')+s%60;}
function startTimer(){
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{if(!gameActive)return;timeLeft--;document.getElementById('timerText').textContent=formatTime(timeLeft);updateArc();if(timeLeft<=0)endGame();},1000);
}

/* ‚îÄ‚îÄ START GAME ‚îÄ‚îÄ */
function startGame(){
  transitioning=false;totalAttempts=0;perfectSolves=0;fastestSolveSec=999;
  totalTimeBonus=0;longestStreak=0;currentStreak=0;
  if(!WORDS.length){showHint("Words still loading...");return;}
  score=0;wordsSolved=0;wordAttempts=0;timeLeft=TOTAL_TIME;solvedLog=[];
  guesses=[];currentInput='';accepting=true;gameActive=true;
  wordQueue=shuffleArray(WORDS);loadNextWord();createBoard();renderKeyboard();
  document.getElementById('scoreVal').textContent='0';
  document.getElementById('wordsVal').textContent='0 words solved';
  document.getElementById('wordNumVal').textContent='1';
  document.getElementById('timerText').textContent='5:00';
  document.getElementById('arcPath').style.strokeDashoffset='0';
  document.getElementById('arcPath').style.stroke='#00c6ff';
  document.getElementById('timerArea').classList.remove('amber','danger','frantic');
  document.getElementById('hint').textContent='';
  document.getElementById('introScreen').style.display='none';
  document.getElementById('endScreen').style.display='none';
  document.getElementById('gameScreen').style.display='flex';
  clearInterval(timerInterval);gameStartTime=Date.now();startTimer();
  document.addEventListener('keydown',keydownHandler);
}

/* ‚îÄ‚îÄ END GAME ‚Äî FIX: don't double-log word already in solvedLog ‚îÄ‚îÄ */
function endGame(){
  gameActive=false;clearInterval(timerInterval);document.removeEventListener('keydown',keydownHandler);
  /* Only push as failed if this word was never logged */
  const alreadyLogged=solvedLog.some(e=>e.word===currentWord);
  if(currentWord&&!alreadyLogged&&guesses.length<6){
    solvedLog.push({word:currentWord,guesses:[...guesses],pts:0,grid:buildGrid(currentWord,guesses),failed:true});
    currentStreak=0;totalAttempts+=Math.max(1,guesses.length);
  }
  const failedCount=solvedLog.filter(e=>e.failed).length;
  _frozenStats=Object.freeze({
    score:Number(score)||0,wordsSolved:Number(wordsSolved)||0,wordAttempts:Number(wordAttempts)||0,
    totalAttempts:Number(totalAttempts)||0,perfectSolves:Number(perfectSolves)||0,
    fastestSolveSec:fastestSolveSec===999?0:Number(fastestSolveSec),
    totalTimeBonus:Number(totalTimeBonus)||0,longestStreak:Number(longestStreak)||0,
    failedCount:Number(failedCount)||0,timeSpent:Math.round((Date.now()-gameStartTime)/1000),solvedLog:[...solvedLog]
  });
  setTimeout(showEndScreen,600);
}

/* ‚îÄ‚îÄ END SCREEN ‚îÄ‚îÄ */
function showEndScreen(){
  const s=_frozenStats;
  document.getElementById('gameScreen').style.display='none';
  document.getElementById('endScreen').style.display='flex';
  let d=0;const step=Math.max(1,Math.ceil(s.score/40));
  const iv=setInterval(()=>{d=Math.min(d+step,s.score);document.getElementById('endScore').textContent=d;if(d>=s.score)clearInterval(iv);},30);
  document.getElementById('endWords').textContent=s.wordsSolved;
  document.getElementById('endAvg').textContent=s.wordsSolved>0?(s.wordAttempts/s.wordsSolved).toFixed(1):'‚Äì';
  const titles=['‚è±Ô∏è TIME\'S UP!','üî• BLITZ DONE!','‚ö° NICE RUN!'];
  document.getElementById('endTitle').textContent=s.wordsSolved>=8?'üèÜ LEGENDARY!':s.wordsSolved>=5?'üî• ON FIRE!':titles[Math.floor(Math.random()*titles.length)];
  const list=document.getElementById('wordsList');list.innerHTML='';
  if(!s.solvedLog.length)list.innerHTML='<p style="color:var(--muted);text-align:center;padding:10px;">No words solved ‚Äî try again!</p>';
  s.solvedLog.forEach((entry,i)=>{
    const div=document.createElement('div');div.className='word-entry';div.style.animationDelay=(i*0.07)+'s';
    div.innerHTML=`<span class="we-word">${entry.word.toUpperCase()}</span><span class="we-grid">${entry.grid.split('\n')[0]}${entry.guesses.length>1?'‚Ä¶':''}</span><span class="we-pts">${entry.failed?'<span style="color:var(--danger)">‚úó</span>':'+'+entry.pts+' pts'}</span>`;
    list.appendChild(div);
  });
  const sName=localStorage.getItem(NAME_KEY),sDept=localStorage.getItem(DEPT_KEY);
  const badge=document.getElementById('playerIdentity'),nameBox=document.getElementById('fallbackName'),deptBox=document.getElementById('fallbackDept');
  if(sName&&sDept){
    nameBox.style.display="none";deptBox.style.display="none";
    badge.style.opacity=0;badge.style.transform="translateY(-4px)";
    setTimeout(()=>{badge.textContent=`üë§ ${sName} ¬∑ ${sDept}`;badge.style.opacity=1;badge.style.transform="translateY(0)";},180);
    document.getElementById('leaderboardText').textContent=`Score recorded for ${sName}`;
    submitScore(sName,sDept,s);
  }else{
    badge.textContent="üë§ New Player";nameBox.style.display="block";deptBox.style.display="block";
    nameBox.value='';deptBox.value='';nameBox.focus();
    nameBox.onchange=()=>saveFallbackIdentity(s);deptBox.onchange=()=>saveFallbackIdentity(s);
  }
  launchFireworks(innerWidth/2,innerHeight/3);
  document.getElementById('playAgainBtn').onclick=startGame;
  document.getElementById('leaderboardBtn').onclick=()=>window.open('https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/wordleleaderboard','_blank');
  document.getElementById('shareBtn').onclick=()=>shareOnWhatsApp(s,sName,sDept);
}

function saveFallbackIdentity(fs){
  const name=document.getElementById('fallbackName').value.trim(),dept=document.getElementById('fallbackDept').value;
  if(!name||!dept)return;
  localStorage.setItem(NAME_KEY,name);localStorage.setItem(DEPT_KEY,dept);
  document.getElementById('fallbackName').style.display="none";document.getElementById('fallbackDept').style.display="none";
  const badge=document.getElementById('playerIdentity');badge.style.opacity=0;badge.style.transform="translateY(-4px)";
  setTimeout(()=>{badge.textContent=`üë§ ${name} ¬∑ ${dept}`;badge.style.opacity=1;badge.style.transform="translateY(0)";},180);
  document.getElementById('leaderboardText').textContent=`Score recorded for ${name}`;
  submitScore(name,dept,fs);
}

function submitScore(name,dept,s){
  const p={student_name:name,department:dept,score:Number(s.score),correct:Number(s.wordsSolved),wrong:Number(s.failedCount),time_spent:Number(s.timeSpent),total_attempts:Number(s.totalAttempts),perfect_solves:Number(s.perfectSolves),fastest_solve_sec:Number(s.fastestSolveSec),total_time_bonus:Number(s.totalTimeBonus),longest_streak:Number(s.longestStreak),quest_id:"Wordleblitz"};
  fetch(EDGE_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)})
    .then(r=>r.json()).then(d=>console.log("‚úÖ Submitted:",d)).catch(e=>console.error("‚ùå Submit:",e));
}

/* ‚îÄ‚îÄ SHARE ‚îÄ‚îÄ */
function shareOnWhatsApp(s,playerName,playerDept){
  generateStatsImage(s,playerName,playerDept); // draws to canvas
  document.getElementById('statsCanvas').toBlob(blob=>{
    if(!blob){fallbackShare(s);return;}
    const file=new File([blob],'wordle-blitz-stats.png',{type:'image/png'});
    if(navigator.share&&navigator.canShare?.({files:[file]})){
      const grids=s.solvedLog.filter(e=>!e.failed).map(e=>`${e.word.toUpperCase()}: ${e.grid.split('\n')[0]}`).join('\n');
      navigator.share({title:'Wordle Blitz Stats',text:`‚ö° Wordle Blitz ‚Äî I solved ${s.wordsSolved} words and scored ${s.score} pts!\n\n${grids}\n\nüéØ Try it: https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/wordle`,files:[file]}).catch(()=>fallbackShare(s));
    }else{
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='wordle-blitz-stats.png';a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),5000);
      fallbackShare(s);
    }
  },'image/png');
}
function fallbackShare(s){
  const grids=s.solvedLog.filter(e=>!e.failed).map(e=>`${e.word.toUpperCase()}: ${e.grid.split('\n')[0]}`).join('\n');
  window.open(`https://wa.me/?text=${encodeURIComponent(`‚ö° Wordle Blitz ‚Äî I solved ${s.wordsSolved} words and scored ${s.score} pts!\n\n${grids}\n\nüéØ Try it: https://andrewveda.github.io/SRM-VEC-English-PWA/buttons/wordle`)}`,'_blank');
}

/* ‚îÄ‚îÄ SKIP ‚Äî FIX: guard transitioning immediately, not inside timeout ‚îÄ‚îÄ */
document.getElementById('skipBtn').onclick=()=>{
  if(!gameActive||!accepting||transitioning)return;
  solvedLog.push({word:currentWord,guesses:[...guesses],pts:0,grid:buildGrid(currentWord,guesses),failed:true});
  currentStreak=0;
  flashSolved(currentWord.toUpperCase(),0,0,true);
  accepting=false;
  transitioning=true; // set immediately ‚Äî blocks any race condition
  setTimeout(()=>{transitioning=false;nextWord();},700);
};

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
document.getElementById('startBtn').onclick=startGame;
(async function init(){
  try{
    const r=await fetch(CSV_URL);const txt=await r.text();
    WORDS=parseCSV(txt);WORD_SET=new Set(WORDS);
    if(!WORDS.length){startBtn.textContent="‚ö†Ô∏è Word list failed";return;}
    startBtn.disabled=false;startBtn.textContent="‚ö° START BLITZ";startBtn.style.opacity="1";
    console.log("‚úÖ WORDS loaded:",WORDS.length);
  }catch(e){console.error("‚ùå CSV load:",e);startBtn.textContent="‚ö†Ô∏è Load failed";}
})();
</script>
</body>
</html>
